<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drink Packages — Break-Even Calculator • In the Wake</title>

  <!-- Inline skin -->
  <style id="itw-skin-v3.010">
  :root{
    --sea:#0a3d62;--foam:#e6f4f8;--rope:#d9b382;--ink:#083041;--sky:#f7fdff;--accent:#0e6e8e;
    --shadow:0 2px 6px rgba(8,48,65,.08); --shadow-lg:0 10px 28px rgba(8,48,65,.14);
    --rail:320px; --bd:#e5e7eb; --good:#047857;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0}
  body{font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--sky)}
  img{max-width:100%;height:auto;display:block}
  a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:1100px;margin:0 auto;padding:20px 14px 36px}
  .card{background:#fff;border:2px solid var(--rope);border-radius:14px;padding:1rem;margin:.8rem 0;box-shadow:var(--shadow)}
  h1,h2,h3{color:var(--sea)} .tiny{font-size:.9rem;color:#456} .small{font-size:.88rem;color:#334}
  .muted{opacity:.75}
  .sr-only{position:absolute;left:-9999px}

  /* Header / Nav */
  .hero-header{position:relative;z-index:0;border-bottom:6px double var(--rope);background:#eaf6f6;overflow:visible}
  .navbar{max-width:1100px;margin:0 auto;display:flex;gap:.6rem;padding:.35rem .9rem .6rem;align-items:center}
  .brand{display:flex;align-items:center;gap:.6rem}
  .brand img{height:40px;width:auto}
  .version-badge{font-size:.72rem;opacity:.8}
  .itw-nav{display:flex;gap:.5rem;flex:1 1 auto;align-items:center;justify-content:center;white-space:nowrap}
  .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.35rem .7rem;border-radius:10px;background:#fff;
    border:1px solid var(--rope);color:var(--accent);font-size:.95rem;cursor:pointer;text-decoration:none}

  /* Dropdown (portal style) */
  .itw-nav .nav-item{position:relative}
  .menu{position:absolute;left:0;top:100%;transform:translateY(.4rem);min-width:240px;max-width:min(90vw,360px);
    background:#fff;border:1px solid var(--rope);border-radius:12px;box-shadow:var(--shadow-lg);padding:.6rem;
    display:none;visibility:hidden;opacity:0;pointer-events:none;z-index:2100;transition:opacity .18s ease}
  .nav-item.open>.menu{display:block;visibility:visible;opacity:1;pointer-events:auto}
  .menu a{display:block;padding:.45rem .6rem;border-radius:.6rem;color:var(--ink);text-decoration:none}
  .menu a:hover{background:#f2f7fa;text-decoration:none}

  /* Hero */
  .hero{position:relative;width:100%;min-height:clamp(200px,24vw,340px);
    background:url('/assets/index_hero.jpg?v=3.010.070') center 38%/cover no-repeat;
    display:flex;align-items:flex-end;overflow:hidden;margin-top:.15rem}
  .hero-title{position:absolute;left:min(3vw,1rem);bottom:clamp(.6rem,2vw,1.4rem);
    display:flex;flex-direction:column;gap:.35rem;text-shadow:0 2px 6px rgba(0,0,0,.45)}
  .hero-title .logo{width:clamp(189px,23.1vw,378px);max-width:min(90vw,520px);filter:drop-shadow(0 3px 8px rgba(0,0,0,.45))}
  .tagline{font-weight:700;letter-spacing:.2px;color:#e6f4f8;font-size:clamp(.9rem,1.5vw,1.35rem);white-space:nowrap}
  .hero-compass{position:absolute;right:min(3vw,1rem);top:.5rem;width:86px;opacity:.95}
  .hero-credit{position:absolute;right:.85rem;bottom:.85rem;z-index:2}
  .pill{display:inline-block;padding:.45rem .75rem;border:1px solid var(--rope);border-radius:14px;background:#fff;line-height:1.1}

  /* Grid */
  .page-grid{display:grid;grid-template-columns:minmax(0,1fr) minmax(260px,var(--rail));gap:2rem;align-items:start}
  @media (max-width:979.98px){.page-grid{grid-template-columns:1fr}}

  /* Right rail */
  .rail-list{display:grid;gap:1rem}
  .rail-card{display:grid;grid-template-columns:72px 1fr;gap:.6rem;align-items:center;border:1px solid #e2e9ed;border-radius:12px;padding:.6rem;background:#fff}
  .rail-card .thumb{width:72px;height:48px;border-radius:10px;overflow:hidden;background:#eef4f6;border:1px solid #dfe7ea}

  /* Personas */
  .persona-grid{display:grid;grid-template-columns:1fr;gap:.45rem}
  .persona{display:flex;align-items:center;gap:.55rem;padding:.45rem .6rem;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer}
  .persona:hover{background:#f7fbfd}
  .persona .tag{font-size:.75rem;border:1px solid #dbe7ec;border-radius:999px;padding:.1rem .5rem;background:#f8fbfd}

  /* Calculator bits */
  .banner{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;margin:0 0 .75rem}
  .banner #best-chip{font-weight:800;color:var(--sea)}
  .pkg{border:1px solid var(--bd);border-radius:12px;padding:.8rem 1rem;margin:.6rem 0;background:#fff}
  .pkg .phd{display:flex;align-items:center;gap:.5rem;font-weight:800}
  .inc-badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:.35rem}
  .inc-badge{display:inline-block;background:#ecfeff;border:1px solid #a5f3fc;border-radius:999px;padding:.15rem .55rem;font-size:.8rem}
  .winner{outline:3px solid #86efac}
  .calc-card{overflow:visible}
  .row{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center}
  .row--stepper{grid-template-columns:1fr auto}
  .input-stepper{display:inline-grid;grid-template-columns:auto 60px auto;border:1px solid var(--bd);border-radius:8px;overflow:hidden}
  .input-stepper input{width:60px;height:34px;border:0;text-align:center}
  .btn-step{height:34px;border:0;background:#f8fafc;padding:0 .6rem;cursor:pointer}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  tbody td{background:#fff;padding:.5rem .6rem;border:1px solid var(--bd)}
  tbody td:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
  tbody td:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}

  /* Chart sizing fix */
  .chart-wrap{position:relative;height:260px}
  #breakeven-chart{width:100% !important;height:100% !important;max-height:260px;display:block}
  </style>
</head>

<body>
  <!-- Header + Hero -->
  <header class="hero-header" role="banner">
    <div class="navbar">
      <div class="brand">
        <img src="/assets/logo_wake.png?v=3.010.070" width="256" height="64" alt="In the Wake">
        <span class="tiny version-badge">v3.010.070</span>
      </div>

      <nav class="itw-nav" aria-label="Primary">
        <div class="nav-item"><a class="chip" href="/">Home</a></div>

        <div class="nav-item" aria-haspopup="menu">
          <button class="chip" type="button" aria-expanded="false" aria-haspopup="menu" aria-controls="menu-planning">Planning ▾</button>
          <div id="menu-planning" class="menu" aria-label="Planning">
            <a href="/planning.html">Planning (overview)</a>
            <a href="/ships.html">Ships</a>
            <a href="/restaurants.html">Restaurants &amp; Menus</a>
            <a href="/ports.html">Ports</a>
            <a href="/drink-packages.html">Drink Packages</a>
            <a href="/packing-lists.html">Packing Lists</a>
            <a href="/accessibility.html">Accessibility</a>
          </div>
        </div>

        <div class="nav-item" aria-haspopup="menu">
          <button class="chip" type="button" aria-expanded="false" aria-haspopup="menu" aria-controls="menu-travel">Travel ▾</button>
          <div id="menu-travel" class="menu" aria-label="Travel">
            <a href="/travel.html">Travel (overview)</a>
            <a href="/solo.html">Solo</a>
          </div>
        </div>

        <div class="nav-item"><a class="chip" href="/about-us.html">About</a></div>
      </nav>
    </div>

    <div class="hero" role="img" aria-label="Ship wake at sunrise">
      <div class="hero-title">
        <img class="logo" src="/assets/logo_wake.png?v=3.010.070" width="560" height="144" alt="In the Wake">
        <div class="tagline">A Cruise Traveler’s Logbook</div>
      </div>
      <img class="hero-compass" src="/assets/compass_rose.svg?v=3.010.070" width="180" height="180" alt="" aria-hidden="true">
      <div class="hero-credit">
        <a class="pill" href="https://instagram.com/flickersofmajesty" target="_blank" rel="noopener">Photo © Flickers of Majesty</a>
      </div>
    </div>
  </header>

  <!-- Main grid -->
  <main class="wrap page-grid" role="main" aria-label="Calculator and articles">
    <!-- LEFT: Calculator -->
    <section class="card calc-card" id="calc-root">
      <h1 style="margin-top:.2rem">Drink Packages — Break-Even Calculator</h1>
      <p class="tiny muted">
        Compare à-la-carte vs Soda, Refreshment, and Deluxe. Add minors (50% off), sea/port weighting, and currency display. Works offline.
      </p>

      <div class="banner">
        <strong id="best-chip">Best value: —</strong>
        <span id="best-text" class="small muted">—</span>
        <span class="small muted" id="totals" style="margin-left:auto"></span>
      </div>

      <p class="tiny muted">
        Rates as of · <span id="currency-note">—</span> ·
        <span id="offline-chip" class="pill" style="display:none">Offline</span>
        • display only; onboard charges in USD
      </p>

      <!-- Package cards -->
      <div class="pkg" id="pkg-soda" data-card="soda">
        <div class="phd">
          <span>Soda</span>
          <span class="inc-badge">Price: <strong data-pkg-price="soda">—/day</strong></span>
          <button class="chip tiny" type="button" onclick="togglePriceEdit('soda')">Edit</button>
        </div>
        <div class="inc-badges">
          <span class="inc-badge">Included value: <strong data-inc="soda">—/day</strong></span>
        </div>
        <form id="edit-soda" hidden class="small" onsubmit="event.preventDefault();savePackagePrice('soda')">
          <label>New price/day <input id="edit-soda-val" type="text" inputmode="decimal" style="width:100px"></label>
          <button type="submit" class="chip tiny">Save</button>
          <button type="button" class="chip tiny" onclick="togglePriceEdit('soda',true)">Cancel</button>
        </form>
        <div id="soda-breakeven" class="small muted" style="margin-top:.4rem"></div>
      </div>

      <div class="pkg" id="pkg-refresh" data-card="refresh">
        <div class="phd">
          <span>Refreshment</span>
          <span class="inc-badge">Price: <strong data-pkg-price="refresh">—/day</strong></span>
          <button class="chip tiny" type="button" onclick="togglePriceEdit('refresh')">Edit</button>
        </div>
        <div class="inc-badges">
          <span class="inc-badge">Included value: <strong data-inc="refresh">—/day</strong></span>
        </div>
        <form id="edit-refresh" hidden class="small" onsubmit="event.preventDefault();savePackagePrice('refresh')">
          <label>New price/day <input id="edit-refresh-val" type="text" inputmode="decimal" style="width:100px"></label>
          <button type="submit" class="chip tiny">Save</button>
          <button type="button" class="chip tiny" onclick="togglePriceEdit('refresh',true)">Cancel</button>
        </form>
        <div id="refresh-breakeven" class="small muted" style="margin-top:.4rem"></div>
      </div>

      <div class="pkg" id="pkg-deluxe" data-card="deluxe">
        <div class="phd">
          <span>Deluxe</span>
          <span class="inc-badge">Price: <strong data-pkg-price="deluxe">—/day</strong></span>
          <button class="chip tiny" type="button" onclick="togglePriceEdit('deluxe')">Edit</button>
        </div>
        <div class="inc-badges">
          <span class="inc-badge">Included value: <strong data-inc="deluxe">—/day</strong></span>
          <span class="inc-badge">Over-cap est: <strong id="overcap-est">—/day</strong></span>
          <span class="inc-badge">Cap: <strong id="cap-badge">$14.00</strong></span>
          <button class="chip tiny" type="button" onclick="toggleCapEdit()">Edit cap</button>
        </div>
        <form id="edit-cap" hidden class="small" onsubmit="event.preventDefault();saveCap()">
          <label>Deluxe cap <input id="edit-cap-val" type="text" inputmode="decimal" style="width:100px" value="14.00"></label>
          <button type="submit" class="chip tiny">Save</button>
          <button type="button" class="chip tiny" onclick="toggleCapEdit(true)">Cancel</button>
        </form>
        <div id="deluxe-breakeven" class="small muted" style="margin-top:.4rem"></div>
      </div>

      <!-- Chart -->
      <div class="card" style="border-color:#e5e7eb">
        <div class="chart-wrap"><canvas id="breakeven-chart"></canvas></div>
        <div id="range-note" class="tiny muted" style="margin-top:.35rem"></div>
      </div>

      <!-- Controls -->
      <fieldset class="card" style="border-color:#e5e7eb">
        <legend class="tiny">Trip setup</legend>
        <div class="row">
          <label class="small">Days</label>
          <input id="input-days" data-input="days" type="text" inputmode="numeric" value="7" />
        </div>
        <div class="row">
          <label class="small">Sea days</label>
          <input id="input-seadays" data-input="seadays" type="text" inputmode="numeric" value="3" />
        </div>
        <div class="row" id="sea-toggle-row">
          <label class="small">Weight sea/port <span id="sea-weight-val">20%</span></label>
          <div>
            <label class="small"><input id="sea-toggle" data-input="seaapply" type="checkbox" checked /> apply</label>
            <input style="vertical-align:middle;margin-left:.5rem" type="range" min="0" max="40" step="1" value="20" data-input="seaweight" />
          </div>
        </div>
        <div class="row">
          <label class="small">Adults</label>
          <input id="input-adults" data-input="adults" type="text" inputmode="numeric" value="1" />
        </div>
        <div class="row">
          <label class="small">Minors</label>
          <input id="input-minors" data-input="minors" type="text" inputmode="numeric" value="0" />
        </div>
        <div class="row">
          <label class="small">Mode</label>
          <div class="small">
            <label><input id="mode-simple" type="radio" name="mode" checked /> Simple</label>
            &nbsp; &nbsp;
            <label><input id="mode-itinerary" type="radio" name="mode" /> Itinerary (per-day)</label>
            &nbsp; &nbsp;
            <button id="jump-winner" type="button" class="chip tiny">Jump to Best Value</button>
          </div>
        </div>
        <div id="itinerary-inputs" style="display:none"></div>
      </fieldset>

      <!-- Per-drink inputs -->
      <fieldset class="card" style="border-color:#e5e7eb">
        <legend class="tiny">Daily picks (average)</legend>

        <div class="row row--stepper">
          <label class="small">Soda avg</label>
          <div class="input-stepper">
            <button type="button" class="btn-step" onclick="stepInput('soda',-1)">−</button>
            <input type="text" data-input="soda" value="0" inputmode="decimal">
            <button type="button" class="btn-step" onclick="stepInput('soda',+1)">+</button>
          </div>
          <span class="tiny muted" data-price-pill="soda" style="grid-column:1/-1"></span>
        </div>

        <div class="row row--stepper">
          <label class="small">Coffee</label>
          <div class="input-stepper">
            <button type="button" class="btn-step" onclick="stepInput('coffee',-1)">−</button>
            <input type="text" data-input="coffee" value="0" inputmode="decimal">
            <button type="button" class="btn-step" onclick="stepInput('coffee',+1)">+</button>
          </div>
          <span class="tiny muted" data-price-pill="coffee" style="grid-column:1/-1"></span>
        </div>

        <div class="row row--stepper">
          <label class="small">Cocktail</label>
          <div class="input-stepper">
            <button type="button" class="btn-step" onclick="stepInput('cocktail',-1)">−</button>
            <input type="text" data-input="cocktail" value="0" inputmode="decimal">
            <button type="button" class="btn-step" onclick="stepInput('cocktail',+1)">+</button>
          </div>
          <span class="tiny muted" data-price-pill="cocktail" style="grid-column:1/-1"></span>
        </div>
      </fieldset>

      <!-- Actions -->
      <div class="small" style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button type="button" class="chip tiny" onclick="resetInputs()">Reset</button>
        <button type="button" class="chip tiny" onclick="shareScenario()">Share Scenario</button>
        <button type="button" class="chip tiny" onclick="printResults()">Print</button>

        <label class="small" style="margin-left:auto">Currency
          <select id="currency-select">
            <option>USD</option><option>GBP</option><option>EUR</option><option>CAD</option>
            <option>AUD</option><option>INR</option><option>CNY</option><option>MXN</option><option>BRL</option>
          </select>
        </label>
      </div>

      <!-- Group breakdown -->
      <section id="group-breakdown" class="card" style="border-color:#e5e7eb" hidden>
        <h3 class="tiny" style="margin-top:0">Group breakdown</h3>
        <div class="small muted" style="margin-bottom:.4rem">Per-person totals and trip totals</div>
        <table>
          <thead class="tiny muted"><tr><th align="left">Who</th><th align="left">Package</th><th align="right">Per-day</th><th align="right">Trip</th></tr></thead>
          <tbody id="group-table-body"></tbody>
        </table>
      </section>

      <div id="fallback-banner" class="tiny" hidden>Using built-in fallback data.</div>
      <div id="a11y-status" class="tiny sr-only" aria-live="polite">—</div>
    </section>

    <!-- RIGHT: Rails -->
    <aside aria-label="Recent articles, personas & author">
      <!-- Personas (Presets) -->
      <section class="card" id="personas-card">
        <h2 class="tiny" style="margin:.25rem 0 .5rem;color:#0a3d62">Personas</h2>
        <div class="persona-grid" id="persona-list" aria-live="polite"></div>
        <p class="tiny muted" style="margin:.5rem 0 0">Click a preset to pre-fill the calculator.</p>
      </section>

      <section class="card">
        <h2 class="tiny" style="margin:.25rem 0 .5rem;color:#0a3d62">Recent Articles</h2>
        <div id="recent-rail" class="rail-list" aria-live="polite"></div>
      </section>

      <section class="card">
        <h2 class="tiny" style="margin:.25rem 0 .5rem;color:#0a3d62">About the Author</h2>
        <div id="author-rail" style="display:flex;gap:.75rem;align-items:center"></div>
      </section>
    </aside>
  </main>

  <!-- JS deps -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="" crossorigin="anonymous"></script>

  <!-- Your calculator app -->
  <script defer src="/assets/js/drink-calculator.app.js?v=9.000.004"></script>

  <!-- Integration glue: dropdowns, rails, personas, Top-20 override -->
  <script>
  (function(){
    "use strict";

    /* ===== Dropdowns (portal behavior) ===== */
    (function(){
      const root=document.querySelector('.itw-nav'); if(!root) return;
      const items=[...root.querySelectorAll('.nav-item[aria-haspopup]')];
      function setOpen(g,on){ g.classList.toggle('open',!!on); const b=g.querySelector('button[aria-controls]'); if(b) b.setAttribute('aria-expanded',on?'true':'false'); }
      function closeAll(except){ items.forEach(g=>{ if(g!==except) setOpen(g,false); }); }
      items.forEach(g=>{
        const btn=g.querySelector('button[aria-controls]'); const menu=g.querySelector('.menu'); if(!btn||!menu) return;
        btn.addEventListener('click',e=>{ e.preventDefault(); e.stopPropagation(); const open=g.classList.contains('open'); closeAll(g); setOpen(g,!open); if(!open) (menu.querySelector('a,button,[tabindex]:not([tabindex="-1"])')||btn).focus({preventScroll:true}); });
        btn.addEventListener('keydown',e=>{ if(e.key==='ArrowDown'||e.key==='ArrowUp'){ e.preventDefault(); setOpen(g,true); (menu.querySelector('a,button,[tabindex]:not([tabindex="-1"])')||btn).focus({preventScroll:true}); } else if(e.key==='Escape'){ setOpen(g,false); btn.focus({preventScroll:true}); }});
        menu.addEventListener('focusout',()=>{ setTimeout(()=>{ if(!g.contains(document.activeElement)) setOpen(g,false); },0); });
      });
      document.addEventListener('click',e=>{ if(!e.target.closest('.itw-nav')) closeAll(); });
      window.addEventListener('blur',()=>closeAll());
    })();

    /* ===== Author rail ===== */
    (function(){
      const host=document.getElementById('author-rail'); if(!host) return;
      host.innerHTML = `
<picture>
  <source type="image/webp" srcset="/authors/img/ken1.webp?v=3.010.070">
  <img src="/authors/img/ken1.jpg?v=3.010.070" width="64" height="64" alt="Author — Ken Baker"
       style="width:64px;height:64px;border-radius:12px;object-fit:cover;display:block">
</picture>
<div class="small">
  <strong><a href="/authors/ken-baker.html">Ken Baker</a></strong><br>
  Founder of <em>In the Wake</em>; writer and editor of the logbook.<br>
  <a href="https://www.flickersofmajesty.com" target="_blank" rel="noopener">Flickers of Majesty</a> ·
  <a href="https://instagram.com/flickersofmajesty" target="_blank" rel="noopener">@flickersofmajesty</a>
</div>`;
    })();

    /* ===== Personas (presets that write to inputs) ===== */
    (function(){
      const listEl = document.getElementById('persona-list'); if(!listEl) return;

      // Helper: set value for an input wired by data-input and emit events your app listens for
      function setByKey(key, val){
        const el = document.querySelector(`[data-input="${key}"]`);
        if(!el) return;
        el.value = String(val);
        el.dispatchEvent(new Event('input', {bubbles:true}));
        el.dispatchEvent(new Event('change', {bubbles:true}));
      }
      function setRange(key, val){
        const el = document.querySelector(`[data-input="${key}"]`);
        if(!el) return;
        el.value = String(val);
        el.dispatchEvent(new Event('input', {bubbles:true}));
      }
      function setChecked(id, on){
        const el = document.getElementById(id);
        if(!el) return;
        el.checked = !!on;
        el.dispatchEvent(new Event('change', {bubbles:true}));
      }

      // Persona definitions (tune as you like)
      const PERSONAS = [
        {
          id:'solo', name:'Solo traveler', tag:'independent',
          set:()=>{ setByKey('adults',1); setByKey('minors',0); setByKey('soda',1); setByKey('coffee',1); setByKey('cocktail',1); setChecked('mode-simple', true); }
        },
        {
          id:'girls', name:'Girls’ trip', tag:'group fun',
          set:()=>{ setByKey('adults',4); setByKey('minors',0); setByKey('soda',1); setByKey('coffee',1); setByKey('cocktail',3); setRange('seaweight',15); document.getElementById('sea-weight-val').textContent='15%'; }
        },
        {
          id:'heavy', name:'Heavy drinker', tag:'deluxe-leaning',
          set:()=>{ setByKey('adults',2); setByKey('minors',0); setByKey('cocktail',5); setByKey('beer',2); setByKey('wine',2); setByKey('coffee',1); }
        },
        {
          id:'mocktails', name:'Mocktails + Coffee', tag:'refreshment',
          set:()=>{ setByKey('adults',2); setByKey('minors',0); setByKey('mocktail',3); setByKey('coffee',2); setByKey('soda',1); }
        },
        {
          id:'family', name:'Family with teens', tag:'50% minors',
          set:()=>{ setByKey('adults',2); setByKey('minors',2); setByKey('soda',3); setByKey('mocktail',1); setByKey('coffee',1); }
        },
        {
          id:'teetotal', name:'Teetotal', tag:'à-la-carte',
          set:()=>{ ['cocktail','beer','wine','mocktail'].forEach(k=>setByKey(k,0)); setByKey('soda',1); setByKey('coffee',1); }
        },
        {
          id:'beerlover', name:'Beer lover', tag:'casual',
          set:()=>{ setByKey('beer',4); setByKey('cocktail',1); setByKey('wine',1); }
        },
        {
          id:'coffee', name:'Coffee fiend', tag:'latte life',
          set:()=>{ setByKey('coffee',4); setByKey('soda',1); }
        }
      ];

      listEl.innerHTML = PERSONAS.map(p => `
        <button class="persona" type="button" data-id="${p.id}">
          <span class="tag">${p.tag}</span>
          <strong class="small">${p.name}</strong>
        </button>`).join('');

      listEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('.persona'); if(!btn) return;
        const p = PERSONAS.find(x => x.id === btn.dataset.id); if(!p) return;
        p.set();
        // Optional: jump banner into view for feedback
        document.querySelector('#best-chip')?.scrollIntoView({behavior:'smooth',block:'nearest'});
      });
    })();

    /* ===== Recent Articles + Top-20 cover override ===== */
    (async function recentRail(){
      const rail=document.getElementById('recent-rail'); if(!rail) return;

      function cb(u){ return u ? (u+(u.includes('?')?'&':'?')+'v=3.010.070') : u; }
      function pick(o, keys, d=null){ for(const k of keys){ if(o && o[k]!=null) return o[k]; } return d; }
      function isTop20(s){ s=(s||'').toLowerCase(); return /top[\s-]*20/.test(s) && /first.*cruise.*questions/.test(s); }
      const TOP20_IMG='/assets/articles/top-20-questions/cover.jpg';

      function setImgFallback(img, primary, alts=[]){
        if(!img) return;
        const q=[primary,...alts].filter(Boolean).map(cb); const tried=new Set();
        function next(){ const n=q.shift(); if(!n){ img.onerror=null; return; } if(tried.has(n)) return next(); tried.add(n); img.src=n; }
        img.onerror=next; next();
      }

      async function get(u){
        try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw 0; return await r.json(); }
        catch(_){ return null; }
      }
      const raw = await (async ()=>{
        for (const u of ['/assets/data/articles/index.json','/assets/data/articles.json']) {
          const j=await get(u); if(j) return j;
        }
        return null;
      })();

      const list = Array.isArray(raw?.articles)? raw.articles : (Array.isArray(raw)? raw : []);
      rail.innerHTML = (list.slice(0,6)).map(p=>{
        const href = pick(p,['url','path'],'#');
        const title= pick(p,['title','name'],'Article');
        return `
          <a class="rail-card" href="${href}">
            <div class="thumb"><img alt="" style="width:100%;height:100%;object-fit:cover"></div>
            <div class="tiny" style="line-height:1.35">${title}</div>
          </a>`;
      }).join('');

      [...rail.querySelectorAll('.rail-card')].forEach((a,i)=>{
        const p=list[i]||{}; const img=a.querySelector('img');
        const href=(pick(p,['url','path'],'')||'').toLowerCase(); const title=(pick(p,['title','name'],'')||'').toLowerCase();
        let primary = pick(p,['image','cover','img','thumb','thumbnail'], null);
        if (isTop20(href) || isTop20(title)) primary = TOP20_IMG;
        if(!primary){
          if(/freedom-of-your-own-wake/.test(href)||/freedom of your own wake/.test(title)) primary='/assets/articles/freedom-of-your-own-wake/cover.jpg';
          else if(/why-i-started-solo-cruising/.test(href)||/why i started solo cruising/.test(title)) primary='/assets/articles/why-i-started-solo-cruising.jpg';
        }
        const alts = primary ? [primary.replace(/\.(jpg|jpeg|png|webp)$/i,'.jpeg'),
                                primary.replace(/\.(jpg|jpeg|png|webp)$/i,'.webp'),
                                primary.replace(/\.(jpg|jpeg|png|webp)$/i,'.png')] : [];
        setImgFallback(img, primary || '/assets/index_hero.jpg', alts);
      });
    })();
  })();
  </script>
</body>
</html>
