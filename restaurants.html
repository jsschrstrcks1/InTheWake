<!doctype html>
<html lang="en">
<head>
  <!--
    In the Wake — Restaurants & Menus
    Standards v3.006c — full upgrade drop-in
    Soli Deo Gloria.
  -->

  <!-- Analytics -->
  <script defer src="https://cloud.umami.is/script.js" data-website-id="9661a449-3ba9-49ea-88e8-4493363578d2"></script>

  <!-- Standards: absolute URL + origin normalizer -->
  <script>
  (function(){
    const ORIGIN=(location.origin||(location.protocol+"//"+location.host)).replace(/\/$/,'');
    window._abs=p=>{p=String(p||'');if(!p.startsWith('/'))p='/'+p;return ORIGIN+p};
    document.addEventListener('DOMContentLoaded',()=>{
      const sel=[
        'a[href^="https://www.cruisinginthewake.com/"]',
        'img[src^="https://www.cruisinginthewake.com/"]',
        'link[href^="https://www.cruisinginthewake.com/"]',
        'script[src^="https://www.cruisinginthewake.com/"]'
      ].join(',');
      document.querySelectorAll(sel).forEach(el=>{
        const attr=el.hasAttribute('href')?'href':'src';
        try{const u=new URL(el.getAttribute(attr)); el.setAttribute(attr, ORIGIN+u.pathname+u.search+u.hash);}catch(_){}
      });
    },{once:true});
  })();
  </script>

  <!-- External link hardening -->
  <script>
  document.addEventListener('click',e=>{
    const a=e.target.closest&&e.target.closest('a[href]'); if(!a) return;
    try{ const u=new URL(a.href,location.href); if(u.origin!==location.origin){ a.target='_blank'; a.rel='noopener'; } }catch(_){}
  },{capture:true});
  </script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Restaurants &amp; Menus | In the Wake (v3.006c)</title>
  <meta name="version" content="v3.006c"/>
  <meta name="description" content="Premium & complimentary dining across the fleet — menus, prices, accessibility notes."/>
  <meta name="robots" content="index,follow"/>

  <!-- Canonical / OG / Twitter -->
  <link rel="canonical" href="https://www.cruisinginthewake.com/restaurants.html"/>
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="In the Wake"/>
  <meta property="og:url" content="https://www.cruisinginthewake.com/restaurants.html"/>
  <meta property="og:title" content="Restaurants &amp; Menus | In the Wake"/>
  <meta property="og:description" content="Premium & complimentary dining across the fleet — menus, prices, accessibility notes."/>
  <meta property="og:image" content="https://www.cruisinginthewake.com/assets/social/restaurants-hero.jpg?v=3.006c"/>
  <meta name="twitter:card" content="summary_large_image"/>

  <!-- Structured Data -->
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[
    {"@type":"ListItem","position":1,"name":"Home","item":"https://www.cruisinginthewake.com/"},
    {"@type":"ListItem","position":2,"name":"Restaurants & Menus","item":"https://www.cruisinginthewake.com/restaurants.html"}
  ]}
  </script>

  <!-- SiteCache + SW -->
  <script src="/assets/js/site-cache.js" defer></script>
  <script>
  if('serviceWorker' in navigator){
    addEventListener('load',()=>navigator.serviceWorker.register('/sw.js').catch(()=>{}));
  }
  </script>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/styles.css?v=3.006c"/>
  <link rel="preload" as="image" href="/assets/compass_rose.svg"/>

  <!-- Page styles (hero + watermark + cards grid) -->
  <style>
    :root{ --rope:#D9B382; --ink:#0f2a3a; --foam:#eef7fb; --accent:#0e6e8e; }
    body.restaurants-page{ background:linear-gradient(var(--foam),#fff 240px); color:var(--ink); }
    .hero{ background:url('/assets/index_hero.jpg') center/cover no-repeat!important;
           filter:saturate(1.28) contrast(1.08) brightness(1.05) }
    .hero::before,.hero::after{ content:none!important }
    body::before{ content:""; position:fixed; inset:0;
      background:url("/assets/watermark.png") no-repeat center right/420px auto;
      opacity:.06; pointer-events:none; z-index:0; }
    body>*{ position:relative; z-index:1; }

    .section{ position:relative; margin:0 auto; max-width:1160px; padding:0 16px 1rem; }
    .divider{ height:12px; background:var(--rope);
      -webkit-mask:linear-gradient(90deg,#000 60%,transparent 60%) repeat-x;
              mask:linear-gradient(90deg,#000 60%,transparent 60%) repeat-x;
      background-repeat:repeat-x; margin:.5rem 0 1.25rem; }

    .grid{ display:grid; gap:1rem; }
    #grid-complimentary,#grid-premium,#grid-activity{ grid-template-columns:1fr; }
    @media (min-width:680px){ #grid-complimentary,#grid-premium,#grid-activity{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (min-width:1024px){ #grid-complimentary,#grid-premium,#grid-activity{ grid-template-columns:repeat(3,minmax(0,1fr)); } }

    .card{ border-radius:18px; box-shadow:0 2px 8px rgba(0,0,0,.06), inset 0 0 0 1px rgba(255,255,255,.7);
           background:#fff; border:2px solid var(--rope); padding:.9rem; display:flex; flex-direction:column; height:100%; }
    .card a{ display:block; color:inherit; text-decoration:none; }
    .card a strong{ color:#0a3d62; }
    .ship-pills{ margin-top:.55rem; display:flex; flex-wrap:wrap; gap:.35rem; }
    .ship-pills .chip{ font-size:.75rem; padding:.25rem .5rem; border:1px solid var(--rope); border-radius:999px; background:#fff; }
    .is-hidden{ display:none !important; }

    /* Header bits */
    .topbar{display:flex;align-items:center;gap:.6rem;padding:.35rem .75rem}
    .topbar .logo-sm img{height:24px;width:auto;display:block}
    .topbar .ver{color:#355;opacity:.7;font-weight:600;font-size:.95rem}
    .pill-nav.pills{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}

    /* Skip link */
    .skip-link{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
    .skip-link:focus{ position:fixed; left:12px; top:12px; width:auto; height:auto; padding:.45rem .7rem;
      background:#fff; border:2px solid var(--accent); border-radius:10px; z-index:9999; }

    /* Focus ring for custom UI */
    .pill,.chip,.pillbtn,#clearBtn{ outline:none; }
    .pill:focus-visible,.chip:focus-visible,.pillbtn:focus-visible,#clearBtn:focus-visible{
      outline:3px solid var(--accent); outline-offset:2px; box-shadow:0 0 0 3px rgba(14,110,142,.2); border-radius:8px;
    }
    @media (prefers-reduced-motion: reduce){
      *{ animation-duration:0.001ms !important; animation-iteration-count:1 !important; transition-duration:0.001ms !important; }
    }
    @media (forced-colors: active){
      .pill:focus-visible,.chip:focus-visible,.pillbtn:focus-visible,#clearBtn:focus-visible{ outline:2px solid CanvasText; box-shadow:none; }
    }
  </style>

  <!-- Canon UI styles -->
  <style id="restaurants-canon-ui">
    #search-wrap{ max-width:1160px; margin:.75rem auto 0; padding:0 16px; }
    #q{ width:100%; padding:.65rem .85rem; border-radius:12px; border:1px solid #cfe1ea; font-size:1rem; }
    #q:focus{ border-color:#0e6e8e; box-shadow:0 0 0 3px rgba(14,110,142,.15); }
    #search-meta{ margin:.45rem 16px 0; color:#355; font-size:.9rem; }

    .filters{ max-width:1160px; margin:.4rem auto 0; padding:0 16px; }
    .filters .filter-row{ display:flex; gap:.4rem; flex-wrap:wrap; align-items:center; }
    .chip{ padding:.35rem .6rem; border:1px dashed var(--rope,#D9B382); border-radius:999px; background:#fff; font-size:.85rem; cursor:pointer; user-select:none; }
    .chip[aria-pressed="true"]{ background:#0e6e8e; color:#fff; border-color:#0e6e8e; box-shadow:0 1px 6px rgba(0,0,0,.12); }

    #brandbar{ position:relative; z-index:60; max-width:1160px; margin:.4rem auto 0; padding:0 16px; }
    #brandbar .row{ display:flex; gap:.4rem; flex-wrap:wrap; align-items:center; }
    #brandbar .pillbtn{ padding:.38rem .65rem; border:1px dashed var(--rope,#D9B382); border-radius:999px; background:#fff; font-size:.9rem; cursor:pointer; }
    #brandbar .pillbtn[aria-pressed="true"]{ background:#0e6e8e; color:#fff; border-color:#0e6e8e; }
    #brandbar .tray{ position:absolute; top:100%; left:16px; right:16px; display:none; background:#fff; border:2px solid var(--rope,#D9B382);
                     border-radius:14px; padding:.6rem; margin-top:.35rem; box-shadow:0 8px 28px rgba(8,48,65,.18); }
    #brandbar .tray.on{ display:block; }
    #brandbar .tray .group{ display:flex; gap:.4rem; flex-wrap:wrap; }
  </style>
</head>

<body class="restaurants-page">
  <a class="skip-link" href="#content">Skip to main content</a>

  <header class="site-header hero-header">
    <div class="topbar">
      <a class="logo-sm" href="/"><img src="/assets/logo_wake.png" alt="In the Wake"/></a>
      <span class="ver">v3.006c</span>
      <nav class="pill-nav pills" aria-label="Primary">
        <a href="/">Home</a>
        <a href="/ships/">Ships</a>
        <a href="/restaurants.html" aria-current="page">Restaurants &amp; Menus</a>
        <a href="/ports.html">Ports</a>
        <a href="/disability-at-sea.html">Disability at Sea</a>
        <a href="/drink-packages.html">Drink Packages</a>
        <a href="/packing-lists.html">Packing Lists</a>
        <a href="/cruise-lines/">Cruise Lines</a>
        <a href="/solo.html">Solo</a>
        <a href="/planning.html">Planning</a>
        <a href="/travel.html">Travel</a>
      </nav>
    </div>

    <div class="hero" role="img" aria-label="Sunset wake hero image">
      <div class="latlon-grid" aria-hidden="true"></div>
      <img class="hero-compass" src="/assets/compass_rose.svg" alt="" aria-hidden="true"/>
      <div class="hero-title"><img class="logo" src="/assets/logo_wake.png" alt="In the Wake"></div>
      <p class="tagline">A Cruise Traveler’s Logbook</p>
      <div class="hero-credit">
        <a class="pill long" href="https://www.instagram.com/flickersofmajesty/" target="_blank" rel="noopener">Photo by Flickers of Majesty — Instagram</a>
      </div>
    </div>

    <!-- Filters canon (markup) -->
    <div id="search-wrap" role="search">
      <input id="q" type="search" inputmode="search"
             placeholder="Type to filter… (e.g., chops, sushi, suite, diamond)"
             aria-label="Filter restaurants by name, type, access, or tag">
    </div>
    <div id="search-meta" class="tiny" aria-live="polite">Loading venues…</div>

    <div id="filters" class="filters" role="group" aria-label="Filter by category">
      <div class="filter-row">
        <span class="label tiny">Categories:</span>
        <button type="button" class="chip" data-kind="cat" data-val="premium" aria-pressed="false">Premium</button>
        <button type="button" class="chip" data-kind="cat" data-val="complimentary" aria-pressed="false">Complimentary</button>
        <button type="button" class="chip" data-kind="cat" data-val="activity" aria-pressed="false">Activities</button>
      </div>
    </div>

    <nav id="brandbar" aria-label="Filter by brand, class, ship, or venue">
      <div class="row">
        <span class="label tiny">Show only:</span>
        <button class="pillbtn" id="brandBtn" aria-expanded="false" aria-controls="tray-brand">Cruise Line</button>
        <button class="pillbtn" id="classBtn" aria-expanded="false" aria-controls="tray-class">Ship Class</button>
        <button class="pillbtn" id="shipBtn"  aria-expanded="false" aria-controls="tray-ship">Ship</button>
        <button class="pillbtn" id="venueBtn" aria-expanded="false" aria-controls="tray-venue">Venue</button>
        <button class="pillbtn" id="clearBtn" type="button" aria-label="Clear all filters" title="Clear filters">Clear</button>
      </div>
      <div id="tray-brand" class="tray" role="menu"><div class="group" id="brands"></div></div>
      <div id="tray-class" class="tray" role="menu"><div class="group" id="classes"></div></div>
      <div id="tray-ship"  class="tray" role="menu"><div class="group" id="ships"></div></div>
      <div id="tray-venue" class="tray" role="menu"><div class="group" id="venues"></div></div>
    </nav>
  </header>

  <main id="content">
    <section class="section"><p class="pill"><strong>Note:</strong> Prices change by ship and sailing; some venues unavailable on select itineraries.</p></section>

    <section class="section" id="complimentary">
      <h2>Main Dining &amp; Complimentary</h2>
      <div class="divider" aria-hidden="true"></div>
      <div class="grid" id="grid-complimentary"></div>
    </section>

    <section class="section" id="premium">
      <h2>Specialty Dining</h2>
      <div class="divider" aria-hidden="true"></div>
      <div class="grid" id="grid-premium"></div>
    </section>

    <section class="section" id="activity">
      <h2>Dining Activities &amp; Classes</h2>
      <div class="divider" aria-hidden="true"></div>
      <div class="grid" id="grid-activity"></div>
    </section>

    <section class="section" id="by-ship">
      <h2>Quick Links by Ship</h2>
      <div class="divider" aria-hidden="true"></div>
      <div id="ship-links"></div>
    </section>

    <section class="section">
      <p class="pill"><strong>Accessibility:</strong> See each venue page and <a href="/disability-at-sea.html">Disability at Sea</a> for ship notes.</p>
    </section>
  </main>

  <footer class="wrap" role="contentinfo" style="text-align:center">
    © 2025 In the Wake — A Cruise Traveler’s Logbook · <a href="/accessibility.html">Accessibility &amp; WCAG 2.1 AA Commitment</a>
  </footer>

  <script>
/* ITW Restaurants — v3.006b interaction fix
   - Live search (no submit)
   - Category chips
   - Brand/Class/Ship/Venue trays
   - Fuzzy matching (<=1 edit), prefixes, synonyms
   - Reindex after paint + on DOM changes
*/
(function(){
  const $    = s => document.querySelector(s);
  const $$   = s => Array.from(document.querySelectorAll(s));
  const $q   = $('#q');                 // search input
  const meta = $('#search-meta');       // status line
  const rComp= $('#grid-complimentary');
  const rPrem= $('#grid-premium');
  const rAct = $('#grid-activity');

  const STATE = { cats:new Set(), query:'', brand:'rccl', klass:'', ship:'', venue:'' };
  let CARDS = []; // { el, slug, cat, brand, ships:Set, classes:Set, text }

  // ---------- a11y status ----------
  function setStatus(s){ if(meta){ meta.textContent = s; } }

  // ---------- string helpers ----------
  function norm(s){
    return String(s||'').toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[’‘]/g,"'")
      .replace(/[-_/]/g,' ')
      .replace(/\s+/g,' ')
      .trim();
  }
  // <=1 edit distance (Damerau-lite)
  function near(a,b){
    if(a===b) return true;
    if(!a||!b) return false;
    const la=a.length, lb=b.length;
    if(Math.abs(la-lb)>1) return false;
    let i=0,j=0, edits=0;
    while(i<la && j<lb){
      if(a[i]===b[j]){ i++; j++; continue; }
      edits++; if(edits>1) return false;
      if(la>lb) i++; else if(lb>la) j++; else { i++; j++; }
    }
    return true;
  }

  // synonyms (extendable)
  const SYN = {
    diamond:['diamond','diamond lounge','diamond club','diamond plus','crown & anchor diamond'],
    suite:['suite','suites','pinnacle','suite lounge','coastal kitchen','the grove'],
    premium:['premium','specialty','extra fee'],
    complimentary:['complimentary','included','free'],
  };

  function tokenMatch(text, tokens){
    if(!tokens.length) return true;
    const words = text.split(/\s+/);
    return tokens.every(tok=>{
      if(!tok) return true;
      if(text.includes(tok)) return true;                 // direct include
      if(SYN[tok]) for(const s of SYN[tok]) if(text.includes(norm(s))) return true; // synonyms
      // prefix or near-match on any single word
      for(const w of words){ if(w.startsWith(tok) || near(tok,w)) return true; }
      return false;
    });
  }

  // ---------- (re)index cards ----------
  function reindex(){
    CARDS = $$('.grid .card a').map(a=>{
      const slug   = a.getAttribute('data-slug')||'';
      const cat    = (a.getAttribute('data-cat')||'').toLowerCase();
      const brand  = (a.getAttribute('data-brand')||'rccl').toLowerCase();
      const ships  = new Set((a.getAttribute('data-ships')||'').toLowerCase().split(/\s+/).filter(Boolean));
      const klass  = new Set((a.getAttribute('data-classes')||'').toLowerCase().split(/\s+/).filter(Boolean));
      const text   = norm(a.textContent + ' ' + (a.getAttribute('data-tags')||'') + ' ' + (a.getAttribute('data-access')||''));
      return { el:a.closest('.card'), slug, cat, brand, ships, classes:klass, text };
    });
    apply(); // draw immediately with current state
  }

  // show/hide ship chips inside a card based on current class/ship filters
  function updateShipChips(card){
    const box = card.el.querySelector('.ship-pills');
    if(!box) return;
    const spans = box.querySelectorAll('[data-ship]');
    spans.forEach(sp=>{
      const ship = (sp.getAttribute('data-ship')||'').toLowerCase();
      const cls  = (sp.getAttribute('data-class')||'').toLowerCase();
      const okShip  = !STATE.ship  || STATE.ship===ship;
      const okClass = !STATE.klass || STATE.klass===cls;
      sp.classList.toggle('is-hidden', !(okShip && okClass));
    });
    const any = box.querySelectorAll('.chip:not(.is-hidden)').length>0;
    box.classList.toggle('is-hidden', !any);
  }

  function hideEmptySections(){
    [['#grid-complimentary','#complimentary'],['#grid-premium','#premium'],['#grid-activity','#activity']].forEach(([grid,sec])=>{
      const visible = document.querySelector(grid)?.querySelectorAll('.card:not(.is-hidden)')?.length || 0;
      const node = document.querySelector(sec);
      if(node) node.classList.toggle('is-hidden', visible===0);
    });
  }

  function apply(){
    const q = norm(STATE.query);
    const toks = q ? q.split(' ') : [];
    let shown = 0;
    CARDS.forEach(c=>{
      const tHit = tokenMatch(c.text, toks);
      const cHit = !STATE.cats.size || STATE.cats.has(c.cat);
      const bHit = !STATE.brand || c.brand===STATE.brand;
      const kHit = !STATE.klass || c.classes.has(STATE.klass);
      const sHit = !STATE.ship  || c.ships.has(STATE.ship);
      const vHit = !STATE.venue || c.slug===STATE.venue;
      const hit  = tHit && cHit && bHit && kHit && sHit && vHit;
      c.el.classList.toggle('is-hidden', !hit);
      if(hit) shown++;
      updateShipChips(c);
    });
    hideEmptySections();
    const total = CARDS.length;
    setStatus((q || STATE.cats.size || STATE.klass || STATE.ship || STATE.venue)
      ? `Showing ${shown} of ${total}` : `Showing all venues & activities.`);
  }

  // ---------- wire controls ----------
  function wireSearch(){
    if(!$q) return;
    let t=null;
    $q.addEventListener('input', ()=>{
      clearTimeout(t);
      const val = $q.value || '';
      t = setTimeout(()=>{ STATE.query = val; apply(); }, 80); // tiny debounce for perf
    });
    // keyboard focus helper
    window.addEventListener('keydown', e=>{
      if(e.key==='/' && document.activeElement!==$q){ e.preventDefault(); $q.focus(); }
    });
  }

  function wireCategoryChips(){
    $$('#filters .chip[data-kind="cat"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const val=(btn.getAttribute('data-val')||'').toLowerCase();
        const on = btn.getAttribute('aria-pressed')==='true';
        if(on) STATE.cats.delete(val); else STATE.cats.add(val);
        btn.setAttribute('aria-pressed', on?'false':'true');
        apply();
      });
    });
  }

  function wireBrandBar(db){
    const bBtn=$('#brandBtn'), cBtn=$('#classBtn'), sBtn=$('#shipBtn'), vBtn=$('#venueBtn'), clr=$('#clearBtn');
    const tB=$('#tray-brand'), tC=$('#tray-class'), tS=$('#tray-ship'), tV=$('#tray-venue');
    const $brands=$('#brands'), $classes=$('#classes'), $ships=$('#ships'), $venues=$('#venues');

    function closeAll(){ [tB,tC,tS,tV].forEach(x=>x&&x.classList.remove('on')); [bBtn,cBtn,sBtn,vBtn].forEach(b=>b&&b.setAttribute('aria-expanded','false')); }
    function toggle(btn,tray){ if(!btn||!tray) return; const open=tray.classList.contains('on'); closeAll(); if(!open){ tray.classList.add('on'); btn.setAttribute('aria-expanded','true'); } }

    bBtn?.addEventListener('click', ()=>toggle(bBtn,tB));
    cBtn?.addEventListener('click', ()=>toggle(cBtn,tC));
    sBtn?.addEventListener('click', ()=>toggle(sBtn,tS));
    vBtn?.addEventListener('click', ()=>toggle(vBtn,tV));
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAll(); });

    clr?.addEventListener('click', ()=>{
      STATE.klass=''; STATE.ship=''; STATE.venue=''; STATE.query=''; STATE.cats.clear();
      if($q) $q.value='';
      // reset toggled category chips
      $$('#filters .chip[aria-pressed="true"]').forEach(x=>x.setAttribute('aria-pressed','false'));
      apply(); closeAll();
      // move focus back to search for speed
      $q?.focus();
    });

    // brand
    if($brands){
      $brands.innerHTML = `<button class="pillbtn" data-brand="rccl" role="menuitem">Royal Caribbean</button>`;
      $brands.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', ()=>{
          STATE.brand = (b.getAttribute('data-brand')||'').toLowerCase();
          apply(); closeAll();
        });
      });
    }

    // classes (ordered large -> small)
    if($classes){
      const clean = s=>String(s||'').toLowerCase().replace(/\s*class\s*$/,'').trim();
      const CLASS_ORDER=['icon','oasis','quantum ultra','quantum','freedom','voyager','radiance','vision','sovereign','empress'];
      const classes = Array.from(new Set(Object.values(db.ships||{}).map(s=>clean(s.class)).filter(Boolean)))
        .sort((a,b)=> {
          const ai=CLASS_ORDER.indexOf(a), bi=CLASS_ORDER.indexOf(b);
          if(ai===-1 && bi===-1) return a.localeCompare(b);
          if(ai===-1) return 1; if(bi===-1) return -1; return ai-bi;
        });
      $classes.innerHTML = classes.map(k=>`<button class="pillbtn" data-class="${k}" role="menuitem">${k.replace(/\b\w/g,m=>m.toUpperCase())} Class</button>`).join('');
      $classes.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          STATE.klass=(btn.getAttribute('data-class')||'').toLowerCase(); STATE.ship='';
          apply(); closeAll(); fillShips(STATE.klass); toggle(sBtn,tS);
        });
      });
    }

    function fillShips(klass){
      if(!$ships) return;
      const clean=s=>String(s||'').toLowerCase().replace(/\s*class\s*$/,'').trim();
      const items = Object.entries(db.ships||{}).filter(([slug,p])=>!klass||clean(p.class)===klass)
        .sort((a,b)=> (a[1].name||a[0]).localeCompare(b[1].name||b[0]));
      $ships.innerHTML = items.map(([slug,p])=>`<button class="pillbtn" data-ship="${slug}" role="menuitem" title="Filter to ${p.name}">${p.name}</button>`).join('');
      $ships.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', ()=>{
          STATE.ship=(b.getAttribute('data-ship')||'').toLowerCase();
          apply(); closeAll();
          const top = $('#q')?.offsetTop || 0;
          window.scrollTo({top: Math.max(top-80,0), behavior:'smooth'});
        });
      });
    }
    fillShips('');

    // venues list
    if($venues){
      const vs = (db.venues||[]).slice().sort((a,b)=> (a.name||a.slug).localeCompare(b.name||b.slug));
      $venues.innerHTML = vs.map(v=>`<button class="pillbtn" data-venue="${v.slug}" role="menuitem">${v.name}</button>`).join('');
      $venues.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', ()=>{
          STATE.venue=(b.getAttribute('data-venue')||'').toLowerCase();
          apply(); closeAll();
          const top = $('#q')?.offsetTop || 0;
          window.scrollTo({top: Math.max(top-80,0), behavior:'smooth'});
        });
      });
    }
  }

  // ---------- boot once venues are painted ----------
  function safeBoot(){
    try{
      // cards present?
      if(!rComp || !rPrem || !rAct){ console.warn('[itw] grids missing'); return; }
      // if nothing painted yet, wait a microtask
      if(!document.querySelector('.grid .card a')){
        // observe until cards appear (renderer paints async)
        const mo = new MutationObserver(()=> {
          if(document.querySelector('.grid .card a')){ mo.disconnect(); afterPaint(); }
        });
        mo.observe(document.body, {subtree:true, childList:true});
        return;
      }
      afterPaint();
    }catch(err){ console.error('[itw] boot error', err); }
  }

  function afterPaint(){
    try{
      reindex();
      wireSearch();
      wireCategoryChips();
      // Pull db for trays from the dataset we already have on page
      // We reconstruct a minimal db: ships (with names/classes) + venues list
      const db = { ships:{}, venues:[] };
      // gather venues (from anchors)
      $$('.grid .card a').forEach(a=>{
        const slug=a.getAttribute('data-slug');
        const name=a.querySelector('strong')?.textContent?.trim() || slug;
        if(slug) db.venues.push({slug, name});
      });
      // gather ships from ship-pill data attributes embedded in HTML
      $$('.ship-pills .chip[data-ship]').forEach(chip=>{
        const slug=chip.getAttribute('data-ship');
        const name=chip.textContent.trim();
        const cls =chip.getAttribute('data-class')||'';
        if(slug && !db.ships[slug]) db.ships[slug]={name, class:cls};
      });
      wireBrandBar(db);

      // Re-index again if DOM changes (e.g., future live updates)
      const mo = new MutationObserver(()=> reindex());
      mo.observe(rComp, {childList:true, subtree:true});
      mo.observe(rPrem, {childList:true, subtree:true});
      mo.observe(rAct,  {childList:true, subtree:true});
    }catch(err){ console.error('[itw] afterPaint error', err); }
  }

  // Kick off after current task so any existing paint can run first
  (document.readyState==='loading'
    ? document.addEventListener('DOMContentLoaded', safeBoot, {once:true})
    : setTimeout(safeBoot, 0));
})();
</script>

  <!-- ================= Filters & Search Canon (hooks into the cards) ================= -->
  <script>
