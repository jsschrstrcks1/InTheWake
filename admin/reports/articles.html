<!--
Soli Deo Gloria
All work on this project is offered as a gift to God.
“Trust in the LORD with all your heart, and do not lean on your own understanding.” — Proverbs 3:5
“Whatever you do, work heartily, as for the Lord and not for men.” — Colossians 3:23
Page: /admin/reports/articles.html · v3.008 · Built: 2025-10-17T00:00:00Z
-->
<!doctype html>
<html lang="en">
<head>
  <!-- Core meta -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="referrer" content="no-referrer">
  <meta name="robots" content="noindex, nofollow">
  <meta name="version" content="3.008">
  <meta name="standards:baseline" content="3.008">
  <title>Articles Consistency Report (v3.008) — In the Wake</title>

  <!-- Canonical -->
  <link rel="canonical" href="https://www.cruisinginthewake.com/admin/reports/articles.html"/>

  <!-- CSS (versioned) -->
  <link rel="stylesheet" href="https://www.cruisinginthewake.com/assets/styles.css?v=3.008"/>
  <style>
    .scroll{max-height:48vh; overflow:auto}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .cards.stack .card.red{border-color:#b71c1c}
    .cards.stack .card.yellow{border-color:#8d6e00}
    .cards.stack .card.green{border-color:#1b5e20}
    .grid-3-tight{display:grid; gap:1rem}
    @media (min-width: 980px){ .grid-3-tight{grid-template-columns:repeat(3, minmax(0,1fr))} }
    .muted{opacity:.8}
    .btn.copy{display:inline-block; margin:.25rem 0 .5rem; padding:.35rem .6rem; border:1px solid #999; border-radius:6px}
    textarea.code{width:100%; min-height:140px; font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    details.patch{margin-top:.5rem}
    summary code{font-size:12px}
  </style>

  <!-- Absolute URL normalizer -->
  <script>
  (function(){
    const ORIGIN=(location.origin||(location.protocol+'//'+location.host)).replace(/\/$/,'');
    window._abs=function(p){ p=String(p||''); if(!p.startsWith('/')) p='/'+p; return ORIGIN+p; };
    function normalize(){
      const sel=[
        'a[href^="https://www.cruisinginthewake.com/"]',
        'img[src^="https://www.cruisinginthewake.com/"]',
        'link[href^="https://www.cruisinginthewake.com/"]',
        'script[src^="https://www.cruisinginthewake.com/"]'
      ].join(',');
      document.querySelectorAll(sel).forEach(el=>{
        const attr=el.hasAttribute('href')?'href':'src';
        try{ const u=new URL(el.getAttribute(attr)); el.setAttribute(attr, ORIGIN+u.pathname+u.search+u.hash); }catch(_){}
      });
    }
    if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', normalize, {once:true}); } else { normalize(); }
  })();
  </script>

  <!-- External link hardener -->
  <script>
  (function(){
    const here=location.hostname.replace(/^www\./,'');
    function upgrade(){
      document.querySelectorAll('a[href]').forEach(a=>{
        const href=a.getAttribute('href')||'';
        if (/^(#|mailto:|tel:)/i.test(href)) return;
        try{
          const u=new URL(href, location.href);
          const host=u.hostname.replace(/^www\./,'');
          if (host !== here){ a.target='_blank'; a.rel=['noopener','noreferrer',(a.rel||'')].join(' ').trim(); }
        }catch(_){}
      });
    }
    if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', upgrade, {once:true}); } else { upgrade(); }
  })();
  </script>
</head>
<body class="page">
  <a class="visually-hidden-focusable" href="#content">Skip to content</a>

  <header class="hero-header">
    <div class="navbar">
      <div class="brand">
        <img src="/assets/logo_wake.png?v=3.008" alt="In the Wake wordmark"/>
        <span class="version-badge">v3.008</span>
      </div>
      <nav class="pill-nav pills" aria-label="Primary">
        <a href="https://www.cruisinginthewake.com/">Home</a>
        <a href="https://www.cruisinginthewake.com/ships/">Ships</a>
        <a href="https://www.cruisinginthewake.com/restaurants.html">Restaurants &amp; Menus</a>
        <a href="https://www.cruisinginthewake.com/ports.html">Ports</a>
        <a href="https://www.cruisinginthewake.com/planning.html">Planning</a>
        <a href="https://www.cruisinginthewake.com/drink-packages.html">Drink Packages</a>
        <a href="https://www.cruisinginthewake.com/packing-lists.html">Packing Lists</a>
        <a href="https://www.cruisinginthewake.com/disability-at-sea.html">Accessibility</a>
        <a href="https://www.cruisinginthewake.com/cruise-lines.html">Cruise Lines</a>
        <a href="https://www.cruisinginthewake.com/solo.html">Solo</a>
        <a href="https://www.cruisinginthewake.com/travel.html">Travel</a>
        <a href="https://www.cruisinginthewake.com/admin/reports/articles.html" aria-current="page">Admin: Articles</a>
      </nav>
    </div>

    <div class="hero" role="img" aria-label="Watermark Header">
      <div class="hero-title">
        <img class="logo" src="/assets/logo_wake.png?v=3.008" alt="In the Wake">
        <div class="tagline">Articles Consistency Report</div>
      </div>
    </div>
  </header>

  <main class="wrap" id="content">
    <section class="cards stack">
      <article class="card">
        <h2>Diagnostics</h2>
        <div id="diag" class="tiny muted">Running…</div>
      </article>
    </section>
    <section class="cards stack grid-3-tight"></section>
  </main>

  <script>
  (function(){
    "use strict";

    const ORIGIN = (location.origin || (location.protocol + "//" + location.host));
    const PRECACHE_URL = "/precache-manifest.json";
    const SOLO_SITEMAP = "/solo/sitemap.xml";
    const SOLO_INDEX   = "/solo/articles/index.json?v=3.008";
    const GLOBAL_ARTS  = "/assets/data/articles.json?v=3.008";

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", start, { once:true });
    } else {
      start();
    }
    function start(){
      run().catch(err => setDiag("Hard failure: " + (err?.message || String(err))));
    }

    /** UI helpers **/
    function hostContainer(){
      let grid = document.querySelector(".grid-3-tight") || document.querySelector(".cards.stack");
      if (!grid) {
        const main = document.getElementById("content") || document.querySelector("main") || document.body;
        const sec = document.createElement("section");
        sec.className = "cards stack grid-3-tight";
        main.appendChild(sec);
        grid = sec;
      }
      return grid;
    }
    function needCard(id, title, desc, cls){
      let card = document.getElementById(id);
      if (card) return card;
      const grid = hostContainer();
      card = document.createElement("article");
      card.className = "card " + (cls||"");
      card.id = id;
      card.style.display = "none";
      card.innerHTML = `<h3>${title}</h3><p class="tiny muted">${desc||""}</p><div class="scroll"><ol id="${id}-list" class="list"></ol></div>`;
      grid.appendChild(card);
      return card;
    }
    function show(node){ node.style.display = ""; }
    function setDiag(msg){
      let d = document.getElementById("diag");
      if (!d) {
        const c = needCard("diag-card","Diagnostics","", "");
        show(c);
        c.innerHTML = `<h3>Diagnostics</h3><div id="diag" class="tiny muted"></div>`;
        d = document.getElementById("diag");
      }
      d.textContent = msg;
    }
    function li(ol, html){ const _li=document.createElement("li"); _li.innerHTML=html; ol.appendChild(_li); }
    function fmt(mono){ return `<span class="mono">${mono}</span>`; }
    function codeBlock(id, label, content){
      const wrap=document.createElement('details'); wrap.className='patch';
      const sum=document.createElement('summary'); sum.innerHTML = `<code>${label}</code>`;
      const btn=document.createElement('button'); btn.className='btn copy'; btn.type='button'; btn.textContent='Copy';
      const ta=document.createElement('textarea'); ta.className='code'; ta.readOnly=true; ta.id=id; ta.value=content;
      btn.addEventListener('click', ()=>{ ta.select(); document.execCommand('copy'); btn.textContent='Copied ✓'; setTimeout(()=>btn.textContent='Copy', 1200); });
      wrap.appendChild(sum); wrap.appendChild(btn); wrap.appendChild(ta);
      return wrap;
    }

    /** Fetch helpers **/
    async function fetchJson(url){
      const r = await fetch(url, { cache:"no-store" });
      if (!r.ok) throw new Error("HTTP " + r.status + " for " + url);
      return r.json();
    }
    async function fetchText(url){
      const r = await fetch(url, { cache:"no-store" });
      if (!r.ok) throw new Error("HTTP " + r.status + " for " + url);
      return r.text();
    }
    async function exists(url){
      try{
        const r = await fetch(url, { cache:"no-store", redirect:"follow" });
        return r.ok;
      }catch(_){ return false; }
    }

    /** Mining **/
    function flattenManifestUrls(m){
      if (Array.isArray(m)) {
        return m.map(x => typeof x === "string" ? x : (x && (x.url || x.href))).filter(Boolean);
      }
      if (!m || typeof m !== "object") return [];
      const out = [];
      ["pages","assets","images","sitemaps","urls","files"].forEach(k=>{
        if (Array.isArray(m[k])) m[k].forEach(v => out.push(typeof v === "string" ? v : (v && (v.url || v.href))));
      });
      return out.filter(Boolean);
    }
    function slugsFromManifest(list, prefix, excludePrefixes){
      const out = new Set();
      const ex = Array.isArray(excludePrefixes) ? excludePrefixes : [];
      for (const u of list) {
        try{
          const url = new URL(u, ORIGIN);
          let p = url.pathname;
          if (!p.startsWith("/")) p = "/" + p;
          if (!p.startsWith(prefix)) continue;
          if (ex.some(ep => p.startsWith(ep))) continue;
          if (!/\.html$/i.test(p)) continue;
          const slug = p.split("/").pop().replace(/\.html$/i,"");
          if (slug && slug !== "solo" && slug !== "sitemap") out.add(slug);
        }catch(_){}
      }
      return out;
    }
    function slugsFromSitemap(xml){
      const out = new Set();
      try{
        const dom = new DOMParser().parseFromString(xml, "application/xml");
        const locs = Array.from(dom.querySelectorAll("url > loc")).map(n=>n.textContent.trim());
        for (const loc of locs) {
          try{
            const u = new URL(loc, ORIGIN);
            if (!/\/solo\/[^/]+\.html$/i.test(u.pathname)) continue;
            const slug = u.pathname.split("/").pop().replace(/\.html$/i,"");
            if (slug && slug !== "solo") out.add(slug);
          }catch(_){}
        }
      }catch(_){}
      return out;
    }
    function slugsFromJsonList(list){
      // Accepts either {articles:[{url,title,...}]} or an array of {url,...}
      const arr = Array.isArray(list) ? list : (list && Array.isArray(list.articles) ? list.articles : []);
      const out = new Set();
      for (const a of arr){
        const url = a && (a.url || a.permalink || "");
        if (!url) continue;
        try{
          const u = new URL(url, ORIGIN);
          const m = u.pathname.match(/^\/solo(?:\/articles)?\/([^/]+)\.html$/i);
          if (m && m[1]) out.add(m[1]);
        }catch(_){}
      }
      return out;
    }

    /** Patch builders **/
    function titleFromSlug(slug){
      return slug.replace(/[-_]+/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
    }
    function buildGlobalArticlesPatch(slugs){
      // Appends objects into { "articles": [ ... ] }
      const entries = Array.from(slugs).sort().map(s=>({
        title: titleFromSlug(s),
        url: `/solo/${s}.html`,
        source: "solo",
        tags: [],
        summary: "TBD — short deck for rail.",
        published: null,   // ISO date e.g., "2025-10-12"
        updated: null
      }));
      const json = JSON.stringify(entries, null, 2);
      return `// Append to /assets/data/articles.json → "articles" array\n${json}`;
    }
    function buildSoloIndexPatch(slugs){
      // Appends into array or {articles:[...]} of solo fragments
      const entries = Array.from(slugs).sort().map(s=>({
        title: titleFromSlug(s),
        url: `/solo/articles/${s}.html`
      }));
      return `// Append to /solo/articles/index.json\n${JSON.stringify(entries, null, 2)}`;
    }
    function buildSitemapPatch(slugs){
      const now = new Date().toISOString().slice(0,10);
      const lines = Array.from(slugs).sort().map(s=>[
        '  <url>',
        `    <loc>https://www.cruisinginthewake.com/solo/${s}.html</loc>`,
        `    <lastmod>${now}</lastmod>`,
        '    <changefreq>weekly</changefreq>',
        '    <priority>0.5</priority>',
        '  </url>'
      ].join('\n')).join('\n');
      return `<!-- Insert each <url> block into /solo/sitemap.xml within <urlset> -->\n${lines}`;
    }
    function buildPrecachePatchPages(slugs){
      const arr = Array.from(slugs).sort().map(s=>(`/solo/${s}.html`));
      return `// Add to "pages" (or appropriate array) in /precache-manifest.json\n${JSON.stringify(arr, null, 2)}`;
    }
    function buildPrecachePatchFrags(slugs){
      const arr = Array.from(slugs).sort().map(s=>(`/solo/articles/${s}.html`));
      return `// Add to "pages" (or appropriate array) in /precache-manifest.json\n${JSON.stringify(arr, null, 2)}`;
    }

    /** Main **/
    async function run(){
      setDiag("Fetching precache, solo sitemap, solo index, and global articles…");

      const [pre, sm, soloIdx, glob] = await Promise.allSettled([
        fetchJson(PRECACHE_URL),
        fetchText(SOLO_SITEMAP),
        fetchJson(SOLO_INDEX),
        fetchJson(GLOBAL_ARTS)
      ]);

      const precacheUrls = (pre.status==='fulfilled') ? flattenManifestUrls(pre.value) : [];
      const preOk = precacheUrls.length>0;

      const sitemapSlugs = (sm.status==='fulfilled') ? slugsFromSitemap(sm.value) : new Set();
      const sitemapOk = (sm.status==='fulfilled');

      const soloIndexSlugs = (soloIdx.status==='fulfilled') ? slugsFromJsonList(soloIdx.value) : new Set();
      const globalArticleSlugs = (glob.status==='fulfilled') ? slugsFromJsonList(glob.value) : new Set();

      const preSoloPages = preOk ? slugsFromManifest(precacheUrls, "/solo/", ["/solo/articles/"]) : new Set();
      const preSoloFrags = preOk ? slugsFromManifest(precacheUrls, "/solo/articles/") : new Set();

      const candidates = new Set([
        ...sitemapSlugs, ...soloIndexSlugs, ...globalArticleSlugs, ...preSoloPages, ...preSoloFrags
      ]);

      const bits = [
        preOk ? `precache ok (${precacheUrls.length} URLs)` : "precache missing/unreadable",
        `precache pages: ${preSoloPages.size}`,
        `precache frags: ${preSoloFrags.size}`,
        sitemapOk ? `sitemap ok (${sitemapSlugs.size} solo URLs)` : "sitemap missing/unreadable",
        `solo index slugs: ${soloIndexSlugs.size}`,
        `global articles slugs: ${globalArticleSlugs.size}`,
        `candidates: ${candidates.size}`
      ];
      setDiag(bits.join(" · "));

      if (!candidates.size) return;

      // Disk existence checks
      const diskSolo = new Set();
      const diskFrag = new Set();
      await Promise.all(Array.from(candidates).map(async slug=>{
        const page = `/solo/${encodeURIComponent(slug)}.html`;
        const frag = `/solo/articles/${encodeURIComponent(slug)}.html`;
        if (await exists(page)) diskSolo.add(slug);
        if (await exists(frag)) diskFrag.add(slug);
      }));

      const missing = {
        diskPage: new Set(),
        diskFrag: new Set(),
        sitemap: new Set(),
        precachePage: new Set(),
        precacheFrag: new Set(),
        globalManifest: new Set(),
        soloIndex: new Set()
      };

      candidates.forEach(slug=>{
        if (!diskSolo.has(slug))           missing.diskPage.add(slug);
        if (!diskFrag.has(slug))           missing.diskFrag.add(slug);
        if (!sitemapSlugs.has(slug))       missing.sitemap.add(slug);
        if (!preSoloPages.has(slug))       missing.precachePage.add(slug);
        if (!preSoloFrags.has(slug))       missing.precacheFrag.add(slug);
        if (!globalArticleSlugs.has(slug)) missing.globalManifest.add(slug);
        if (!soloIndexSlugs.has(slug))     missing.soloIndex.add(slug);
      });

      const anyIssue = Object.values(missing).some(s=>s.size);

      function renderSet(id, title, desc, klass, set, prefix){
        if (!set.size) return;
        const card = needCard(id, title, desc, klass);
        const ol = card.querySelector(`#${id}-list`);
        ol.innerHTML = "";
        Array.from(set).sort().forEach(slug=>{
          const page = `${prefix.replace('%s', slug)}`;
          li(ol, fmt(page));
        });
        // Patch blocks
        if (id === 'missing-global-manifest'){
          card.appendChild(codeBlock('patch-global', 'articles.json patch', buildGlobalArticlesPatch(set)));
        }
        if (id === 'missing-solo-index'){
          card.appendChild(codeBlock('patch-solo-idx', 'solo/articles/index.json patch', buildSoloIndexPatch(set)));
        }
        if (id === 'missing-sitemap'){
          card.appendChild(codeBlock('patch-sitemap', 'solo/sitemap.xml patch', buildSitemapPatch(set)));
        }
        if (id === 'missing-precache-pages'){
          card.appendChild(codeBlock('patch-precache-pages', 'precache-manifest pages patch', buildPrecachePatchPages(set)));
        }
        if (id === 'missing-precache-frags'){
          card.appendChild(codeBlock('patch-precache-frags', 'precache-manifest fragments patch', buildPrecachePatchFrags(set)));
        }
        show(card);
      }

      renderSet("missing-disk-pages","Missing on disk: /solo/<slug>.html",
        "These slugs do not resolve as full pages.", "red", missing.diskPage, "/solo/%s.html");
      renderSet("missing-disk-frags","Missing on disk: /solo/articles/<slug>.html",
        "These slugs do not resolve as fragments.", "red", missing.diskFrag, "/solo/articles/%s.html");

      renderSet("missing-sitemap","Missing from /solo/sitemap.xml",
        "Add these full pages to the Solo sitemap.", "yellow", missing.sitemap, "/solo/%s.html");

      renderSet("missing-precache-pages","Missing in precache (pages)",
        "Add to /precache-manifest.json under 'pages' or 'urls'.", "yellow", missing.precachePage, "/solo/%s.html");
      renderSet("missing-precache-frags","Missing in precache (fragments)",
        "Add to /precache-manifest.json under 'pages' or 'urls'.", "yellow", missing.precacheFrag, "/solo/articles/%s.html");

      renderSet("missing-global-manifest","Missing in global articles manifest",
        "Add entries to /assets/data/articles.json so sitewide rails can discover them.", "yellow", missing.globalManifest, "/solo/%s.html");

      renderSet("missing-solo-index","Missing in Solo index",
        "Add entries to /solo/articles/index.json for Solo area features.", "yellow", missing.soloIndex, "/solo/articles/%s.html");

      if (!anyIssue && candidates.size > 0) {
        const ok = document.getElementById("all-clear") || needCard("all-clear","All Clear",
          "All sources agree for all detected slugs.","green");
        const list = ok.querySelector("#all-clear-list");
        if (list) list.parentElement.innerHTML =
          `<div class="tiny muted">Slugs: ${Array.from(candidates).sort().map(s=>fmt(s)).join(", ")}</div>`;
        show(ok);
      }
    }
  })();
  </script>

  <footer class="wrap tiny">
    <p class="center">Soli Deo Gloria — All work on this project is offered to God.</p>
  </footer>
</body>
</html>
