<!-- ships/index.html — v3.006 (standards-compliant, two-JSON fallback, cache-first images) -->
<!doctype html>
<html lang="en">
<head>
  <!-- Analytics -->
  <script defer src="https://cloud.umami.is/script.js" data-website-id="9661a449-3ba9-49ea-88e8-4493363578d2"></script>

  <!-- Standards: absolute URL + origin normalizer -->
  <script>
  (function(){
    const ORIGIN=(location.origin||(location.protocol+'//'+location.host)).replace(/\/$/,'');
    window._abs=function(path){ path=String(path||''); if(!path.startsWith('/')) path='/'+path; return ORIGIN+path; };
    document.addEventListener('DOMContentLoaded', function(){
      const sel=[
        'a[href^="https://www.cruisinginthewake.com/"]',
        'img[src^="https://www.cruisinginthewake.com/"]',
        'link[href^="https://www.cruisinginthewake.com/"]',
        'script[src^="https://www.cruisinginthewake.com/"]'
      ].join(',');
      document.querySelectorAll(sel).forEach(el=>{
        const attr=el.hasAttribute('href')?'href':'src';
        try{ const u=new URL(el.getAttribute(attr));
             el.setAttribute(attr, ORIGIN+u.pathname+u.search+u.hash);
        }catch(_){}
      });
    },{once:true});
  })();
  </script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Royal Caribbean Fleet — In the Wake (v3.006)</title>
  <meta name="version" content="v3.006"/>
  <meta name="description" content="Browse Royal Caribbean’s ‘of the Seas’ ships with verified imagery. Each card links to its ship page."/>
  <meta name="referrer" content="no-referrer"/>
  <meta name="robots" content="index, follow"/>

  <!-- Canonical & Social -->
  <link rel="canonical" href="https://www.cruisinginthewake.com/ships/index.html"/>
  <meta property="og:url" content="https://www.cruisinginthewake.com/ships/index.html"/>
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="In the Wake"/>
  <meta property="og:title" content="Royal Caribbean Fleet — In the Wake"/>
  <meta property="og:description" content="Explore completed ship pages with verified imagery."/>
  <meta property="og:image" content="https://www.cruisinginthewake.com/assets/ships/radiance-of-the-seas1.jpg?v=3.006"/>
  <meta name="twitter:card" content="summary_large_image"/>

  <!-- Site CSS -->
  <link rel="stylesheet" href="/assets/styles.css?v=3.006"/>

  <!-- Page micro-tweaks (scoped, no collisions) -->
  <style>
    .hidden{display:none!important}
    .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;}
    .card.clickable{cursor:pointer;transition:transform .06s ease-in-out;}
    .card.clickable:hover{transform:translateY(-1px);}
    .card .thumb{width:100%;aspect-ratio:16/9;background:#eef5f7;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center;}
    .card .thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .tiny-quiet{font-size:.9rem;color:#456}
    /* gentle watermark under content only */
    body::before{content:"";position:fixed;inset:0;background:url("/assets/watermark.png") center right/420px auto no-repeat;opacity:.06;pointer-events:none;z-index:0;}
    body>*{position:relative;z-index:1;}
    /* Hero re-use */
    .hero{ background:url('/assets/index_hero.jpg') 50% 50%/cover no-repeat; }
  </style>

  <!-- Preload small asset -->
  <link rel="preload" as="image" href="/assets/compass_rose.svg"/>

  <!-- Site cache util + SW (standards) -->
  <script src="/assets/js/site-cache.js" defer></script>
  <script>
    if('serviceWorker' in navigator){
      window.addEventListener('load', function(){
        navigator.serviceWorker.register('/sw.js').catch(function(){});
      });
    }
  </script>

  <!-- Floating Share Bar (auto-injected) -->
  <script src="/assets/js/share-bar.js" defer></script>
</head>
<body class="page no-hero-filter">
  <!-- Skip link (WCAG 2.4.1) -->
  <a class="skip-link" href="#content">Skip to main content</a>

  <!-- Header -->
  <header class="site-header hero-header">
    <div class="navbar">
      <div class="brand">
        <img src="/assets/logo_wake.png" width="256" height="64" alt="In the Wake wordmark"/>
        <span class="version-badge">v3.006</span>
      </div>
      <nav class="pill-nav pills" aria-label="Primary">
        <a href="/">Home</a>
        <a href="/ships/" aria-current="page">Ships</a>
        <a href="/restaurants.html">Restaurants &amp; Menus</a>
        <a href="/drink-packages.html">Drink Packages</a>
      </nav>
    </div>
    <div class="hero" role="img" aria-label="Open ocean at sunrise with grid overlay">
      <div class="latlon-grid" aria-hidden="true">
        <svg viewBox="0 0 100 60" preserveAspectRatio="none">
          <g class="grid-lines" stroke-width="0.35">
            <line x1="10" y1="0" x2="10" y2="60"/><line x1="20" y1="0" x2="20" y2="60"/>
            <line x1="30" y1="0" x2="30" y2="60"/><line x1="40" y1="0" x2="40" y2="60"/>
            <line x1="50" y1="0" x2="50" y2="60"/><line x1="60" y1="0" x2="60" y2="60"/>
            <line x1="70" y1="0" x2="70" y2="60"/><line x1="80" y1="0" x2="80" y2="60"/>
            <line x1="90" y1="0" x2="90" y2="60"/>
            <line x1="0" y1="10" x2="100" y2="10"/><line x1="0" y1="20" x2="100" y2="20"/>
            <line x1="0" y1="30" x2="100" y2="30"/><line x1="0" y1="40" x2="100" y2="40"/>
          </g>
        </svg>
      </div>
      <img class="hero-compass" src="/assets/compass_rose.svg" width="160" height="160" alt="" aria-hidden="true"/>
      <div class="hero-title">
        <img class="logo" src="/assets/logo_wake.png" width="256" height="64" alt="In the Wake"/>
        <div class="tagline">A Cruise Traveler’s Logbook</div>
      </div>
      <div class="hero-credit">
        <a class="pill long" href="https://instagram.com/flickersofmajesty" target="_blank" rel="noopener">Photo © Flickers of Majesty</a>
      </div>
    </div>
  </header>

  <main class="wrap" id="content">
    <section class="card" aria-labelledby="title">
      <h1 id="title">Royal Caribbean Fleet</h1>
      <p>Explore the completed ship pages for Royal Caribbean International. Each ship below links to its dedicated page. Only pages with verified imagery appear for now; more ships are added as pages are finished.</p>
    </section>

    <section class="card" aria-labelledby="otsHeading">
      <h2 id="otsHeading">‘…of the Seas’ (image-verified)</h2>
      <div id="fleetGrid" class="cards-grid" role="list"></div>
      <p id="fleetEmpty" class="tiny-quiet hidden" role="status" aria-live="polite">No completed ship pages found yet.</p>
      <p id="fleetError" class="tiny-quiet hidden" role="status" aria-live="polite">Failed to load fleet data.</p>
    </section>

    <section class="card" aria-labelledby="dataHeading">
      <h2 id="dataHeading">Data</h2>
      <p id="meta" class="tiny">Data sources: <code>rc-fleet-index.json</code> / <code>rcl_of_the_seas.json</code></p>
    </section>
  </main>

  <footer class="wrap center">© <span id="yr"></span> In the Wake — A Cruise Traveler’s Logbook</footer>
  <script>document.getElementById('yr').textContent=new Date().getFullYear();</script>

  <!-- Fleet loader (placed at end to guarantee DOM is ready) -->
  <script>
  (function(){
    const abs = (p)=> (typeof window._abs==='function'? _abs(p): p);

    // Primary + fallback JSONs (no merging, just fallback)
    const JSON_SOURCES = [
      abs('/ships/assets/data/rc-fleet-index.json'),
      abs('/data/rcl_of_the_seas.json')
    ];

    // Verified image candidates by slug (Allure fixed here)
    const IMAGE_CANDIDATES = {
      'adventure-of-the-seas': [
        '/ships/rcl/images/Adventure_of_the_Seas1.jpeg',
        '/ships/rcl/images/Adventure_of_the_Seas2.jpg',
        '/ships/rcl/images/Adventure_of_the_Seas3.jpg',
        '/ships/rcl/images/Adventure_of_the_Seas_docked_in_Aruba_2024.jpg',
        '/ships/rcl/images/Adventure_of_the_Seas_pool_area.jpg',
        '/ships/rcl/images/Adventure_of_the_seas_in_Willemstad.jpg'
      ],
      'allure-of-the-seas': [
        '/ships/assets/images/allure-of-the-seas-3.jpg',
        '/ships/assets/images/allure2.jpg',
        '/ships/assets/images/allure3.jpg'
      ],
      'enchantment-of-the-seas': [
        '/ships/assets/enchantment-of-the-seas1.jpg',
        '/ships/assets/images/Enchantment_of_the_Seas.jpeg',
        '/images/Enchantment_of_the_Seas.jpeg',
        '/images/enchantment-of-the-seas2.jpeg',
        '/ships/assets/images/Enchantment_of_the_Seas,_San_Juan Medium.jpeg'
      ],
      'grandeur-of-the-seas': [
        '/ships/assets/grandeur-of-the-seas1.jpg'
      ],
      'radiance-of-the-seas': [
        // add whenever you have radiance images locally
      ],
      'rhapsody-of-the-seas': [
        '/ships/assets/rhapsody-of-the-seas1.jpg',
        '/ships/assets/images/Rhapsody_of_the_Seas_2 Medium.jpeg',
        '/ships/assets/images/Rhapsody_of_the_Seas_(2)_(6451158929) Medium.jpeg',
        '/ships/assets/images/Rhapsody_of_the_Seas_(3731959629) Medium.jpeg'
      ],
      'sovereign-of-the-seas': [
        '/ships/assets/sovereign-of-the-seas1.jpg',
        '/ships/assets/sovereign-of-the-seas2.jpg',
        '/ships/assets/sovereign-of-the-seas3.jpg'
      ],
      'vision-of-the-seas': [
        '/ships/assets/vision-of-the-seas1.jpg'
      ]
    };

    const el = {
      grid: document.getElementById('fleetGrid'),
      empty: document.getElementById('fleetEmpty'),
      error: document.getElementById('fleetError'),
      meta: document.getElementById('meta')
    };

    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    async function cacheFirst(urls){
      if(!('caches' in window)) return urls[0] || '';
      // try cache
      for(const u of urls){
        try{
          const hit = await caches.match(u, { ignoreSearch:true });
          if (hit) return u;
        }catch(_){}
      }
      // fallback to first available URL
      return urls[0] || '';
    }

    async function loadFleetJSON(){
      for(const url of JSON_SOURCES){
        try{
          const r = await fetch(url, { cache:'no-store' });
          if (r.ok) { const json = await r.json(); return { json, url }; }
        }catch(e){ /* try next */ }
      }
      throw new Error('fleet-json-unavailable');
    }

    function normalizeShipsShape(data){
      // Your files use: { ships:[{ name, slug, ... }] }
      const ships = Array.isArray(data?.ships) ? data.ships : [];
      return ships.map(s=>({
        name: s.name || '',
        slug: s.slug || (s.name||'').toLowerCase().replace(/\s+/g,'-'),
        status: s.status || '',
        class: s.class || '',
        year: (typeof s.year==='number')? s.year : (s.year? Number(s.year): null),
        gt: (s.gt==null)? null : Number(s.gt),
        capacity: (s.capacity==null)? null : Number(s.capacity)
      }));
    }

    function isOfTheSeas(name){ return /\bof the seas\b/i.test(String(name||'')); }

    function renderCards(list){
      const cards = [];
      list.forEach(s=>{
        const cand = (IMAGE_CANDIDATES[s.slug]||[]).filter(Boolean);
        if (!cand.length) return; // image-verified only
        cards.push({ ship:s, cand });
      });

      if (!cards.length){
        el.empty.classList.remove('hidden');
        el.grid.innerHTML='';
        return;
      }

      el.empty.classList.add('hidden');

      // Build DOM
      const frag = document.createDocumentFragment();
      cards.forEach(item=>{
        const a = document.createElement('a');
        a.className='card clickable';
        a.setAttribute('role','listitem');
        a.href = abs(`/ships/rcl/${item.ship.slug}.html`);
        a.innerHTML = `
          <div class="thumb"><img alt="${item.ship.name}"/></div>
          <div class="body">
            <h3 class="card-title">${item.ship.name}</h3>
            <p class="small muted">${item.ship.class? item.ship.class+' Class' : ''}</p>
          </div>
        `;
        frag.appendChild(a);

        // choose image: cache-first among candidates, then random
        (async ()=>{
          const chosen = await cacheFirst(item.cand);
          const finalSrc = chosen || pickRandom(item.cand);
          const img = a.querySelector('img');
          if (finalSrc) img.src = abs(finalSrc);
          else a.remove(); // belt & suspenders: if nothing, remove card
        })();
      });
      el.grid.innerHTML='';
      el.grid.appendChild(frag);
    }

    async function init(){
      try{
        const { json, url } = await loadFleetJSON();
        const ships = normalizeShipsShape(json)
          .filter(s => isOfTheSeas(s.name)); // ‘…of the Seas’

        // stamp meta
        const when = json.generated || json.updated || (json.meta && json.meta.updated);
        const ver  = json.version || (json.meta && json.meta.version);
        el.meta.textContent = `Data: ${ver?('v'+ver):''}${ver&&when?' • ':''}${when?String(when).slice(0,10):''} • Source: ${url}`;

        renderCards(ships);
      }catch(e){
        console.error('fleet load failed', e);
        el.error.classList.remove('hidden');
        el.empty.classList.add('hidden');
      }
    }

    // Progressive card reveal (IO)
    (function reveal(){
      const IO=('IntersectionObserver' in window) ? new IntersectionObserver((ents)=>{
        ents.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('visible'); IO.unobserve(e.target);} });
      }, {rootMargin:'80px 0px'}) : null;
      document.querySelectorAll('.card').forEach(c=>{
        if(IO){ IO.observe(c);} else { c.classList.add('visible'); }
      });
    })();

    // Warm SW cache with known assets
    (function warm(){
      try { fetch('/assets/compass_rose.svg', {cache:'no-store',mode:'no-cors'}); } catch(_){}
      try { fetch('/assets/watermark.png', {cache:'no-store',mode:'no-cors'}); } catch(_){}
      try { fetch('/assets/index_hero.jpg', {cache:'no-store',mode:'no-cors'}); } catch(_){}
    })();

    // Start
    if (document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded', init, {once:true});
    } else { init(); }
  })();
  </script>
</body>
</html>
