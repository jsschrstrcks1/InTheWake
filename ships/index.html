<!-- ships/index.html — v3.006 (Standards-compliant, RC '...of the Seas' only, image-verified) -->
<!doctype html>
<html lang="en">
<head>
  <!-- Analytics -->
  <script defer src="https://cloud.umami.is/script.js" data-website-id="9661a449-3ba9-49ea-88e8-4493363578d2"></script>

  <!-- Standards v3.006: absolute URL + origin normalizer -->
  <script>
  (function(){
    const ORIGIN=(location.origin||(location.protocol+'//'+location.host)).replace(/\/$/,'');
    window._abs=function(path){ path=String(path||''); if(!path.startsWith('/')) path='/'+path; return ORIGIN+path; };
    document.addEventListener('DOMContentLoaded', function(){
      const sel=[
        'a[href^="https://www.cruisinginthewake.com/"]',
        'img[src^="https://www.cruisinginthewake.com/"]',
        'link[href^="https://www.cruisinginthewake.com/"]',
        'script[src^="https://www.cruisinginthewake.com/"]'
      ].join(',');
      document.querySelectorAll(sel).forEach(el=>{
        const attr=el.hasAttribute('href')?'href':'src';
        try{ const u=new URL(el.getAttribute(attr)); el.setAttribute(attr, ORIGIN+u.pathname+u.search+u.hash); }catch(_){}
      });
    }, {once:true});
  })();
  </script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Royal Caribbean Fleet — ‘…of the Seas’ | In the Wake (v3.006)</title>
  <meta name="version" content="v3.006"/>
  <meta name="description" content="Browse finished Royal Caribbean ‘…of the Seas’ ship pages. Only ships with verified images (completed pages) appear here."/>
  <meta name="robots" content="index, follow"/>
  <meta name="referrer" content="no-referrer"/>

  <!-- Canonical & Social -->
  <link rel="canonical" href="https://www.cruisinginthewake.com/ships/index.html"/>
  <meta property="og:url" content="https://www.cruisinginthewake.com/ships/index.html"/>
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="In the Wake"/>
  <meta property="og:title" content="Royal Caribbean ‘…of the Seas’ — In the Wake"/>
  <meta property="og:description" content="Finished ship pages for Royal Caribbean ‘…of the Seas’. Only image-verified pages are shown."/>
  <meta property="og:image" content="https://www.cruisinginthewake.com/assets/ships/radiance-of-the-seas1.jpg?v=3.006"/>
  <meta name="twitter:card" content="summary_large_image"/>

  <!-- Site CSS (versioned) -->
  <link rel="stylesheet" href="/assets/styles.css?v=3.006"/>

  <!-- Page-scoped tweaks (non-global names to avoid collisions) -->
  <style>
    .hidden{display:none!important}
    .cards-grid{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:1.2rem; }
    @media (max-width:900px){ .cards-grid{ grid-template-columns:1fr; } }
    .card.clickable{ cursor:pointer; transition:transform .06s ease-in-out; }
    .card.clickable:hover{ transform:translateY(-1px); }
    .card .thumb{ width:100%; aspect-ratio:16/9; background:#eef5f7; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .card .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .tiny-quiet{ font-size:.95rem; color:#456; }
    /* Gentle watermark is provided globally via styles.css (body::before); ensure stacking */
    body > * { position:relative; z-index:1; }
  </style>

  <!-- Preload small asset used in hero -->
  <link rel="preload" as="image" href="/assets/compass_rose.svg"/>

  <!-- Standards v3.006: SiteCache util + SW + Share bar -->
  <script src="/assets/js/site-cache.js" defer></script>
  <script>
    if('serviceWorker' in navigator){
      window.addEventListener('load', function(){
        navigator.serviceWorker.register('/sw.js').catch(function(){});
      });
    }
  </script>
  <script src="/assets/js/share-bar.js" defer></script>
</head>

<body class="page no-hero-filter">
  <!-- Skip link (WCAG 2.4.1) -->
  <a class="skip-link" href="#content">Skip to main content</a>

  <!-- Shared Header / Hero -->
  <header class="site-header hero-header">
    <div class="navbar">
      <div class="brand">
        <img src="/assets/logo_wake.png" width="256" height="64" alt="In the Wake wordmark"/>
        <span class="version-badge">v3.006</span>
      </div>
      <nav class="pill-nav pills" aria-label="Primary">
        <a href="/">Home</a>
        <a href="/ships/" aria-current="page">Ships</a>
        <a href="/restaurants.html">Restaurants &amp; Menus</a>
        <a href="/ports.html">Ports</a>
        <a href="/disability-at-sea.html">Disability at Sea</a>
        <a href="/drink-packages.html">Drink Packages</a>
        <a href="/packing-lists.html">Packing Lists</a>
        <a href="/planning.html">Planning</a>
        <a href="/solo.html">Solo</a>
        <a href="/travel.html">Travel</a>
      </nav>
    </div>

    <div class="hero" role="img" aria-label="Ship wake at sunrise">
      <!-- Lat/Lon grid -->
      <div class="latlon-grid" aria-hidden="true">
        <svg viewBox="0 0 100 60" preserveAspectRatio="none" width="100%" height="100%">
          <g class="grid-lines" stroke-width="0.35">
            <line x1="10" y1="0" x2="10" y2="60"/><line x1="20" y1="0" x2="20" y2="60"/>
            <line x1="30" y1="0" x2="30" y2="60"/><line x1="40" y1="0" x2="40" y2="60"/>
            <line x1="50" y1="0" x2="50" y2="60"/><line x1="60" y1="0" x2="60" y2="60"/>
            <line x1="70" y1="0" x2="70" y2="60"/><line x1="80" y1="0" x2="80" y2="60"/>
            <line x1="90" y1="0" x2="90" y2="60"/>
            <line x1="0" y1="10" x2="100" y2="10"/><line x1="0" y1="20" x2="100" y2="20"/>
            <line x1="0" y1="30" x2="100" y2="30"/><line x1="0" y1="40" x2="100" y2="40"/>
          </g>
        </svg>
      </div>
      <img class="hero-compass" src="/assets/compass_rose.svg" width="180" height="180" alt="" aria-hidden="true"/>
      <div class="hero-title">
        <img class="logo" src="/assets/logo_wake.png" width="256" height="64" alt="In the Wake"/>
        <div class="tagline">A Cruise Traveler’s Logbook</div>
      </div>
      <div class="hero-credit">
        <a class="pill long" href="https://instagram.com/flickersofmajesty" target="_blank" rel="noopener">Photo © Flickers of Majesty</a>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="wrap" id="content">
    <section class="card" aria-labelledby="title">
      <h1 id="title">Royal Caribbean Fleet</h1>
      <p>Explore the completed ship pages for Royal Caribbean International. Each ship below links to its dedicated page. Only pages with verified imagery appear for now; more ships are added as pages are finished.</p>
    </section>

    <!-- Fleet grid -->
    <section class="card" aria-labelledby="fleetHeading">
      <h2 id="fleetHeading" class="card-title">‘…of the Seas’ (image-verified)</h2>
      <div id="fleetGrid" class="cards-grid" role="list"></div>
      <p id="fleetEmpty" class="tiny-quiet" role="status" aria-live="polite" style="margin-top:.5rem">No completed ship pages found yet.</p>
    </section>

    <!-- Data meta -->
    <section class="card" aria-labelledby="dataHeading">
      <h2 id="dataHeading" class="card-title">Data</h2>
      <p id="meta" class="tiny">Data sources: rc-fleet-index.json / rcl_of_the_seas.json</p>
    </section>
  </main>

  <footer class="wrap center">© <span id="yr"></span> In the Wake — A Cruise Traveler’s Logbook · <a href="/accessibility.html">Accessibility &amp; WCAG 2.1 AA Commitment</a></footer>
  <script>document.getElementById('yr').textContent=new Date().getFullYear();</script>

  <!-- Page logic (v3.006): two JSONs w/ fallback; RC '...of the Seas' only; cache-first image verification; random image pick -->
  <script>
  (async function(){
    const abs=(p)=> (typeof window._abs==='function'? _abs(p): p);

    // Primary then fallback
    const SOURCES=[ abs('/ships/assets/data/rc-fleet-index.json'), abs('/data/rcl_of_the_seas.json') ];

    // Known, curated image pools per slug (expandable). Only ships with at least one *verified* image will render.
    const IMAGE_CANDIDATES = {
      'adventure-of-the-seas': [
        '/ships/rcl/images/Adventure_of_the_Seas1.jpeg',
        '/ships/rcl/images/Adventure_of_the_Seas2.jpg',
        '/ships/rcl/images/Adventure_of_the_Seas3.jpg',
        '/ships/rcl/images/Adventure_of_the_Seas_docked_in_Aruba_2024.jpg',
        '/ships/rcl/images/Adventure_of_the_Seas_pool_area.jpg',
        '/ships/rcl/images/Adventure_of_the_seas_in_Willemstad.jpg'
      ],
      'enchantment-of-the-seas': [
        '/ships/assets/enchantment-of-the-seas1.jpg',
        '/ships/assets/images/Enchantment_of_the_Seas.jpeg',
        '/images/Enchantment_of_the_Seas.jpeg',
        '/images/enchantment-of-the-seas2.jpeg',
        '/ships/assets/images/Enchantment_of_the_Seas,_San_Juan Medium.jpeg'
      ],
      'grandeur-of-the-seas': [
        '/ships/assets/grandeur-of-the-seas1.jpg'
      ],
      'radiance-of-the-seas': [
        '/ships/assets/images/allure2.jpg', /* temp holding if radiance hero not yet in /assets */
        '/ships/assets/images/allure3.jpg'
      ],
      'rhapsody-of-the-seas': [
        '/ships/assets/rhapsody-of-the-seas1.jpg',
        '/ships/assets/images/Rhapsody_of_the_Seas_2 Medium.jpeg',
        '/ships/assets/images/Rhapsody_of_the_Seas_(2)_(6451158929) Medium.jpeg',
        '/ships/assets/images/Rhapsody_of_the_Seas_(3731959629) Medium.jpeg'
      ],
      'sovereign-of-the-seas': [
        '/ships/assets/sovereign-of-the-seas1.jpg',
        '/ships/assets/sovereign-of-the-seas2.jpg',
        '/ships/assets/sovereign-of-the-seas3.jpg'
      ],
      'vision-of-the-seas': [
        '/ships/assets/vision-of-the-seas1.jpg'
      ]
    };

    // Also nudge SW to cache-manifest items (safe no-ops if absent)
    try { fetch('/assets/cache-manifest.json', {cache:'no-store'}).catch(()=>{}); } catch(_){}

    async function loadFleetJSON(){
      for(const url of SOURCES){
        try{
          const r = await fetch(url, {cache:'no-store'});
          if (r.ok) { const json=await r.json(); annotateMeta(json, url); return json; }
        }catch(_){}
      }
      throw new Error('Fleet data unavailable');
    }

    function annotateMeta(json, url){
      const el=document.getElementById('meta');
      const when=json.generated || json.updated || (json.meta && json.meta.updated);
      const ver =json.version || (json.meta && json.meta.version) || '—';
      el.textContent = `Data: v${ver} • ${when? String(when).slice(0,10): 'unknown'} • Source: ${url}`;
    }

    // Normalize: accept both array-of-lines and keyed-object forms.
    function normalizeShips(raw){
      const out=[];
      const lines = raw.cruise_lines;
      if (Array.isArray(lines)){
        for(const L of lines){
          const lineSlug=(L.slug || L.line_slug || '').toLowerCase();
          for(const s of (L.ships||[])){
            out.push({
              name: s.name || '',
              slug: (s.slug || '').toLowerCase(),
              line: lineSlug,
              year: parseInt(String(s.year_built_or_entered||'').replace(/[^\d]/g,'')) || null,
              class: String(s.class||s.ship_class||'').toLowerCase(),
              gt: parseInt(String(s.gt||'').replace(/[^\d]/g,'')) || null,
              guests: parseInt(String(s.capacity||'').replace(/[^\d]/g,'')) || null
            });
          }
        }
      } else if (lines && typeof lines==='object'){
        for(const [lineId, ships] of Object.entries(lines)){
          if(!Array.isArray(ships)) continue;
          for(const s of ships){
            out.push({
              name: s.name || '',
              slug: String(s.slug||'').toLowerCase(),
              line: String(lineId||'').toLowerCase(),
              year: parseInt(String(s.year_built_or_entered||'').replace(/[^\d]/g,'')) || null,
              class: String(s.class||s.ship_class||'').toLowerCase(),
              gt: parseInt(String(s.gt||'').replace(/[^\d]/g,'')) || null,
              guests: parseInt(String(s.capacity||'').replace(/[^\d]/g,'')) || null
            });
          }
        }
      } else if (Array.isArray(raw.ships)){ // flat fallback
        for(const s of raw.ships){
          const a=s.attributes||s;
          out.push({
            name:a.name||a.title||a.ship||'',
            slug:String(a.slug||a.id||'').toLowerCase(),
            line:String(a.line || a.brand || a.cruise_line || '').toLowerCase(),
            year:parseInt(String(a.entered_service||a.launched||a.year_built_or_entered||'').replace(/[^\d]/g,''))||null,
            class:String(a.class||a.ship_class||'').toLowerCase(),
            gt:parseInt(String(a.gt||a.gross_tonnage||'').replace(/[^\d]/g,''))||null,
            guests:parseInt(String(a.capacity||a.passengers||'').replace(/[^\d]/g,''))||null
          });
        }
      }
      return out;
    }

    // Repair dirty line: if ‘…of the seas’, force Royal Caribbean
    function enforceRoyalForOfTheSeas(list){
      return list.map(s=>{
        const isOTS = /\bof the seas\b/i.test(s.name) || /-of-the-seas$/.test(s.slug||'');
        if (isOTS) return {...s, line:'royal-caribbean'};
        return s;
      });
    }

    // Cache-first verify whether an image exists
    async function imgExists(url){
      const absUrl=abs(url);
      try{
        if('caches' in window){
          const hit = await caches.match(absUrl, {ignoreSearch:true});
          if (hit) return true;
        }
      }catch(_){}
      try{
        // Prefer HEAD; fall back to GET if HEAD blocked.
        const r = await fetch(absUrl, {method:'HEAD', cache:'no-store'});
        if (r.ok) return true;
      }catch(_){}
      try{
        const rg = await fetch(absUrl, {method:'GET', cache:'no-store'});
        return rg.ok;
      }catch(_){ return false; }
    }

    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    async function pickVerifiedImage(slug){
      const cand = (IMAGE_CANDIDATES[slug]||[]).map(abs);
      for (let i=0; i<cand.length; i++){
        // shuffle-on-the-fly by sampling random remaining
        const j = Math.floor(Math.random()*(cand.length-i)) + i;
        const tmp=cand[i]; cand[i]=cand[j]; cand[j]=tmp;
      }
      for (const u of cand){
        if (await imgExists(u)) return u;
      }
      return ''; // none verified
    }

    // Render
    const grid = document.getElementById('fleetGrid');
    const empty = document.getElementById('fleetEmpty');

    try{
      const raw   = await loadFleetJSON();
      const all   = enforceRoyalForOfTheSeas(normalizeShips(raw));
      const rcOTS = all.filter(s => s.line==='royal-caribbean' && (/\bof the seas\b/i.test(s.name) || /-of-the-seas$/.test(s.slug||'')));

      // Only include ships for which we can verify at least one image
      const out = [];
      for (const s of rcOTS){
        const slug = s.slug || String(s.name||'').toLowerCase().replace(/\s+/g,'-').replace(/’/g,"'").replace(/-+/g,'-');
        const img = await pickVerifiedImage(slug);
        if (!img) continue;
        out.push({ ship:s, slug, img });
      }

      // Build cards
      grid.innerHTML = out.map(({ship, slug, img})=>{
        const href = abs(`/ships/rcl/${slug}.html`);
        return `
          <a class="card clickable" role="listitem" href="${href}" aria-label="${ship.name}">
            <div class="thumb"><img src="${img}" alt="${ship.name}"/></div>
            <div class="body">
              <h3 class="card-title">${ship.name}</h3>
              <p class="tiny-quiet">${ship.year ? ('Year: '+ship.year) : ''}</p>
            </div>
          </a>`;
      }).join('');

      empty.classList.toggle('hidden', grid.children.length>0);
    }catch(e){
      console.error('fleet page init failed', e);
      empty.textContent = 'Failed to load fleet data.';
    }
  })();
  </script>

  <!-- Progressive card reveal -->
  <script>
  (function(){
    const IO=('IntersectionObserver' in window) ? new IntersectionObserver((ents)=>{
      ents.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('visible'); IO.unobserve(e.target);} });
    },{rootMargin:'80px 0px'}) : null;
    document.querySelectorAll('.card').forEach(c=>{ if(IO){ IO.observe(c); } else { c.classList.add('visible'); } });
  })();
  </script>
</body>
</html>
