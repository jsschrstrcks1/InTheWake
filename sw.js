// /sw.js â€” In the Wake unified cache (v0.7-stable)
const CACHE='itw-img-v0.7';const MAX_ITEMS=200;
self.addEventListener('install',e=>self.skipWaiting());
self.addEventListener('activate',e=>{e.waitUntil((async()=>{await self.clients.claim();const n=await caches.keys();await Promise.all(n.filter(x=>x.startsWith('itw-img-')&&x!==CACHE).map(x=>caches.delete(x)));try{const r=await fetch('/assets/cache-manifest.json',{cache:'no-store'});if(r.ok){const c=await caches.open(CACHE);await c.put('/assets/cache-manifest.json',r.clone());}}catch{}})());});
self.addEventListener('message',e=>{if(e.data&&e.data.type==='SKIP_WAITING')self.skipWaiting();});
self.addEventListener('fetch',e=>{const r=e.request;if(r.method!=='GET')return;const u=new URL(r.url);if(u.origin!==location.origin)return;const i=r.destination==='image'||/\.(?:jpg|jpeg|png|webp|gif|avif|svg)(\?.*)?$/i.test(u.pathname);if(!i)return;e.respondWith((async()=>{const c=await caches.open(CACHE);const n=new URL(u.href);n.search='';n.hash='';const a=new Request(n.href,{method:'GET'});const h=await c.match(a);(async()=>{try{const f=await fetch(r,{cache:'no-store'});if(f&&(f.ok||f.type==='opaque')){await c.put(a,f.clone());const k=await c.keys();if(k.length>MAX_ITEMS)await c.delete(k[0]);}}catch{}})();if(h)return h;try{const f=await fetch(r,{cache:'no-store'});if(f&&f.ok){await c.put(a,f.clone());const k=await c.keys();if(k.length>MAX_ITEMS)await c.delete(k[0]);return f;}}catch{}const px='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=';return fetch(px);})());});
