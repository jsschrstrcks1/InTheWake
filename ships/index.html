<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Royal Caribbean Fleet — In the Wake (v3.005d)</title>
  <meta name="description" content="Browse Royal Caribbean's 'of the Seas' ships — Radiance, Enchantment, Grandeur, and more."/>
  <meta name="referrer" content="no-referrer"/>
  <link rel="stylesheet" href="/assets/styles.css?v=3.004"/>
  <script src="/assets/js/share-bar.js" defer></script>

  <script>
  (async function(){
    // ---------- 1) Data (fallback-only, no merge) ----------
    const DATA_SOURCES = [
      '/ships/assets/data/rc-fleet-index.json',
      '/data/rcl_of_the_seas.json'
    ];

    async function loadFleet() {
      for (const url of DATA_SOURCES) {
        try {
          const r = await fetch(url, { cache: 'no-store' });
          if (r.ok) return await r.json();
        } catch (_) {}
      }
      throw new Error('Fleet data unavailable');
    }

    // ---------- 2) Image candidates ----------
    // Only these ships should render; map to a pool of possible image URLs.
    // We’ll probe cache first, then network; pick a random working one.
    const IMAGE_CANDIDATES = {
      'adventure-of-the-seas': [
        '/ships/rcl/images/Adventure_of_the_Seas1.jpeg',
        '/ships/rcl/images/Adventure_of_the_Seas2.jpg',
        '/ships/rcl/images/Adventure_of_the_Seas3.jpg',
        '/ships/rcl/images/Adventure_of_the_Seas_docked_in_Aruba_2024.jpg',
        '/ships/rcl/images/Adventure_of_the_Seas_pool_area.jpg',
        '/ships/rcl/images/Adventure_of_the_seas_in_Willemstad.jpg'
      ],
      'enchantment-of-the-seas': [
        '/ships/assets/enchantment-of-the-seas1.jpg',
        '/ships/assets/images/Enchantment_of_the_Seas.jpeg',
        '/ships/assets/images/Enchantment_of_the_Seas,_San_Juan Medium.jpeg',
        '/images/Enchantment_of_the_Seas.jpeg',
        '/images/enchantment-of-the-seas2.jpeg'
      ],
      'grandeur-of-the-seas': [
        '/ships/assets/grandeur-of-the-seas1.jpg'
      ],
      'radiance-of-the-seas': [
        // (removed the .json entry that broke things)
        '/ships/assets/images/allure3.jpg',   /* safe fallback artwork you listed */
        '/ships/assets/images/allure2.jpg'
      ],
      'rhapsody-of-the-seas': [
        '/ships/assets/rhapsody-of-the-seas1.jpg',
        '/ships/assets/images/Rhapsody_of_the_Seas_(3731959629) Medium.jpeg',
        '/ships/assets/images/Rhapsody_of_the_Seas_(2)_(6451158929) Medium.jpeg',
        '/ships/assets/images/Rhapsody_of_the_Seas_2 Medium.jpeg'
      ],
      'sovereign-of-the-seas': [
        '/ships/assets/sovereign-of-the-seas1.jpg',
        '/ships/assets/sovereign-of-the-seas2.jpg',
        '/ships/assets/sovereign-of-the-seas3.jpg'
      ],
      'vision-of-the-seas': [
        '/ships/assets/vision-of-the-seas1.jpg'
      ]
    };

    // helper: normalize slug
    const toSlug = (s) => String(s||'')
      .toLowerCase()
      .replace(/’/g,"'")
      .replace(/\s+/g,'-')
      .replace(/-+/g,'-')
      .trim();

    // ---------- 3) Cache-first image probe ----------
    async function exists(url) {
      const safe = encodeURI(url);
      // cache first
      if ('caches' in window) {
        try {
          const hit = await caches.match(safe, { ignoreSearch: true });
          if (hit) return safe;
        } catch(_) {}
      }
      // then network (HEAD preferred, fallback GET)
      try {
        const h = await fetch(safe, { method: 'HEAD', cache: 'no-store' });
        if (h.ok) return safe;
      } catch(_) {}
      try {
        const g = await fetch(safe, { method: 'GET', cache: 'no-store' });
        if (g.ok) return safe;
      } catch(_) {}
      return '';
    }

    async function pickWorkingImage(slug) {
      const pool = (IMAGE_CANDIDATES[slug] || []).slice();
      // also try generic slug patterns as last resort
      pool.push(`/ships/assets/${slug}1.jpg`,
                `/ships/assets/${slug}2.jpg`,
                `/ships/assets/${slug}3.jpg`);
      // randomize order
      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      for (const candidate of pool) {
        const ok = await exists(candidate);
        if (ok) return ok;
      }
      return ''; // none worked
    }

    // ---------- 4) Flatten either JSON shape ----------
    function flattenShips(raw) {
      // If it’s already a flat list
      if (Array.isArray(raw?.ships)) return raw.ships.slice();

      // If it’s keyed object of lines -> ships[]
      if (raw && typeof raw.cruise_lines === 'object' && !Array.isArray(raw.cruise_lines)) {
        const out = [];
        for (const [lineId, list] of Object.entries(raw.cruise_lines)) {
          (list || []).forEach(s => out.push({ ...s, line_slug: lineId }));
        }
        return out;
      }

      // If it’s an array of cruise_line objects with .ships
      if (Array.isArray(raw?.cruise_lines)) {
        const out = [];
        for (const L of raw.cruise_lines) {
          (L.ships || []).forEach(s => out.push({ ...s, line_slug: L.slug || L.line_slug || '' }));
        }
        return out;
      }

      return [];
    }

    // ---------- 5) Render ----------
    const data = await loadFleet();
    const flat = flattenShips(data);

    // include anything that is clearly RCI "* of the Seas"
    const rciOfTheSeas = flat.filter(s => /\bof the seas\b/i.test(s?.name||''))
      .map(s => {
        // coerce line if missing/dirty
        const line = (s.line_slug || s.cruise_line || '').toString().toLowerCase();
        const coercedLine = line && !/unknown|^$/.test(line) ? line : 'royal-caribbean';
        const slug = toSlug(s.slug || s.name).replace(/(?<!-of)-the-seas$/, '-of-the-seas'); // try to be nice
        return {
          name: s.name,
          slug,
          line_slug: coercedLine,
          url: s.url || `/ships/rcl/${slug}.html`,
          gt: s.gt || s.gross_tonnage || null,
          guests: s.capacity || s.passengers || null,
          year: s.year_built_or_entered || s.entered_service || s.launched || null
        };
      });

    const grid = document.getElementById('fleet-grid');
    // sequentially probe images and render only those that have one
    for (const ship of rciOfTheSeas) {
      const img = await pickWorkingImage(ship.slug);
      if (!img) continue; // do not show if no resolvable image
      const card = document.createElement('a');
      card.className = 'card';
      card.href = ship.url;
      card.innerHTML = `
        <div class="thumb" style="width:100%;aspect-ratio:16/9;background:#eef5f7;border-radius:10px;overflow:hidden">
          <img src="${img}" alt="${ship.name}" style="width:100%;height:100%;object-fit:cover"/>
        </div>
        <h3 style="margin:.6rem 0 0">${ship.name}</h3>
      `;
      grid.appendChild(card);
    }

    // Soft hint if nothing rendered
    if (!grid.children.length) {
      const empty = document.createElement('p');
      empty.className = 'tiny-quiet';
      empty.textContent = 'No completed ship pages found yet.';
      grid.parentElement.appendChild(empty);
    }
  })();
  </script>
</head>

<body>
  <header class="site-header hero-header">
    <div class="navbar">
      <div class="brand"><img src="/assets/logo_wake.png" alt="In the Wake"/></div>
      <nav class="pill-nav pills" aria-label="Primary">
        <a href="/">Home</a>
        <a href="/ships/" aria-current="page">Ships</a>
        <a href="/restaurants.html">Restaurants</a>
        <a href="/drink-packages.html">Drink Packages</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="card visible">
      <h1>Royal Caribbean Fleet</h1>
      <p>Explore the completed ship pages for Royal Caribbean International. Each ship below links to its dedicated page. More ships coming soon.</p>
    </section>
    <section id="fleet-grid" class="grid-3"></section>
  </main>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
