<!doctype html>
<html lang="en">
<head>
  <!-- Absolute URL helper + hard-coded origin normalizer (same as other pages) -->
  <script>
  (function(){
    var ORIGIN=(location.origin||(location.protocol+'//'+location.host)).replace(/\/$/,'');
    window._abs=function(path){ path=String(path||''); if(!path.startsWith('/')) path='/'+path; return ORIGIN+path; };
    document.addEventListener('DOMContentLoaded', function(){
      var sel=['a[href^="https://www.cruisinginthewake.com/"]','img[src^="https://www.cruisinginthewake.com/"]','link[href^="https://www.cruisinginthewake.com/"]','script[src^="https://www.cruisinginthewake.com/"]'].join(',');
      document.querySelectorAll(sel).forEach(function(el){
        var attr=el.hasAttribute('href')?'href':'src';
        try{ var u=new URL(el.getAttribute(attr)); el.setAttribute(attr, ORIGIN+u.pathname+u.search+u.hash); }catch(e){}
      });
    }, {once:true});
  })();
  </script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Browse Ships — Line → Class → Ship | In the Wake (v2.245)</title>
  <meta name="description" content="Explore ships by cruise line and class. Click Royal Caribbean, pick a class, then open any ship’s detail page."/>
  <meta name="version" content="2.245"/>

  <!-- Canonical & Social -->
  <link rel="canonical" href="https://www.cruisinginthewake.com/ships/browse.html"/>
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="In the Wake"/>
  <meta property="og:url" content="https://www.cruisinginthewake.com/ships/browse.html"/>
  <meta property="og:title" content="Browse Ships — In the Wake"/>
  <meta property="og:description" content="Explore ships by cruise line and class."/>
  <meta property="og:image" content="https://www.cruisinginthewake.com/assets/ships/radiance-of-the-seas-hero.jpg?v=2.245"/>
  <meta name="twitter:card" content="summary_large_image"/>

  <!-- Site CSS -->
  <link rel="stylesheet" href="https://www.cruisinginthewake.com/assets/styles.css?v=2.245"/>

  <!-- Page micro-tweaks to match your style -->
  <style>
    .hidden{display:none!important}
    .wrap{ max-width:1100px; margin:0 auto; padding:20px 14px 36px; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:.9rem; }
    .card.clickable{ cursor:pointer; transition:transform .06s ease-in-out; }
    .card.clickable:hover{ transform:translateY(-1px); }
    .card .thumb{ width:100%; aspect-ratio:16/9; background:#eef5f7; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .card .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pill.badge{ margin-left:.35rem; }
    .crumbs{ display:flex; flex-wrap:wrap; gap:.35rem; align-items:center; margin:.25rem 0 1rem; justify-content:center; }
    .crumbs .sep{ opacity:.6; }
    .crumbs a,.crumbs button{ color:#064; text-decoration:underline; background:none; border:none; padding:0; cursor:pointer; }
    .center{text-align:center}
    .tiny-quiet{ font-size:.9rem; color:#456; }
    /* Watermark (same across site) */
    body::before{ content:""; position:fixed; inset:0; background:url("https://www.cruisinginthewake.com/assets/watermark.png") center right / 420px auto no-repeat; opacity:.06; pointer-events:none; z-index:0; }
    body > * { position:relative; z-index:1; }
  </style>
</head>
<body class="page no-hero-filter">

  <!-- Shared Header (matches restaurants & ship pages) -->
  <header class="hero-header">
    <div class="navbar">
      <div class="brand">
        <img src="https://www.cruisinginthewake.com/assets/logo_wake.png" alt="In the Wake wordmark"/>
        <span class="version-badge">v2.245</span>
      </div>
      <nav class="pills" aria-label="Site">
        <style>
          .pills{ display:flex; flex-wrap:nowrap; gap:.6rem; white-space:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
          .pills::-webkit-scrollbar{ display:none; }
          .pills a{ flex:0 0 auto; }
          @media (min-width:980px){ .pills{ justify-content:center; overflow:visible; } }
        </style>
        <a href="https://www.cruisinginthewake.com/index.html">Home</a>
        <a href="https://www.cruisinginthewake.com/ships/ships.html">Ships</a>
        <a href="https://www.cruisinginthewake.com/restaurants.html">Restaurants &amp; Menus</a>
        <a href="https://www.cruisinginthewake.com/ports.html">Ports</a>
        <a href="https://www.cruisinginthewake.com/disability-at-sea.html">Disability at Sea</a>
        <a href="https://www.cruisinginthewake.com/drink-packages.html">Drink Packages</a>
        <a href="https://www.cruisinginthewake.com/packing-lists.html">Packing Lists</a>
        <a href="https://www.cruisinginthewake.com/cruise-lines/royal-caribbean.html">Cruise Lines</a>
        <a href="https://www.cruisinginthewake.com/solo.html">Solo</a>
        <a href="https://www.cruisinginthewake.com/travel.html">Travel</a>
      </nav>
    </div>

    <div class="hero" role="img" aria-label="Ships hub hero">
      <div class="latlon-grid" aria-hidden="true">
        <svg viewBox="0 0 100 60" preserveAspectRatio="none">
          <g class="grid-lines" stroke-width="0.35">
            <line x1="10" y1="0" x2="10" y2="60"/><line x1="20" y1="0" x2="20" y2="60"/>
            <line x1="30" y1="0" x2="30" y2="60"/><line x1="40" y1="0" x2="40" y2="60"/>
            <line x1="50" y1="0" x2="50" y2="60"/><line x1="60" y1="0" x2="60" y2="60"/>
            <line x1="70" y1="0" x2="70" y2="60"/><line x1="80" y1="0" x2="80" y2="60"/>
            <line x1="90" y1="0" x2="90" y2="60"/>
            <line x1="0" y1="10" x2="100" y2="10"/><line x1="0" y1="20" x2="100" y2="20"/>
            <line x1="0" y1="30" x2="100" y2="30"/><line x1="0" y1="40" x2="100" y2="40"/>
          </g>
        </svg>
      </div>
      <img class="hero-compass" src="https://www.cruisinginthewake.com/assets/compass_rose.svg" alt="" aria-hidden="true"/>
      <div class="hero-title">
        <img class="logo" src="https://www.cruisinginthewake.com/assets/logo_wake.png" alt="In the Wake"/>
        <div class="tagline">A Cruise Traveler’s Logbook</div>
      </div>
    </div>
  </header>

  <main class="wrap" id="content">
    <nav class="crumbs" aria-label="Breadcrumb">
      <span id="crumb-line-wrap" class="hidden"><button id="crumb-line" type="button"></button> <span class="sep">›</span></span>
      <span id="crumb-class-wrap" class="hidden"><button id="crumb-class" type="button"></button> <span class="sep">›</span></span>
      <strong id="crumb-here">Choose a cruise line</strong>
    </nav>

    <section class="card" aria-labelledby="linesHeading">
      <h2 id="linesHeading" class="card-title">Cruise Lines</h2>
      <div id="linesGrid" class="grid" role="list"></div>
      <p id="linesEmpty" class="tiny-quiet hidden">No cruise lines found.</p>
    </section>

    <section id="classesSection" class="card hidden" aria-labelledby="classesHeading">
      <h2 id="classesHeading" class="card-title">Classes</h2>
      <div id="classesGrid" class="grid" role="list"></div>
      <p id="classesEmpty" class="tiny-quiet hidden">No classes found for this line.</p>
    </section>

    <section id="shipsSection" class="card hidden" aria-labelledby="shipsHeading">
      <h2 id="shipsHeading" class="card-title">Ships</h2>
      <div id="shipsGrid" class="grid" role="list"></div>
      <p id="shipsEmpty" class="tiny-quiet hidden">No ships found in this class (yet).</p>
    </section>

    <section class="card" aria-labelledby="dataHeading">
      <h2 id="dataHeading" class="card-title">Data</h2>
      <p id="meta" class="tiny">Data source: fleet_index.json</p>
    </section>
  </main>

  <footer class="wrap center">© <span id="yr"></span> In the Wake — A Cruise Traveler’s Logbook</footer>
  <script>document.getElementById('yr').textContent=new Date().getFullYear();</script>

<script>
/* ships-browse (v1.7, auto image discovery)
   - Data: /assets/data/fleet_index.json
   - Image policy: only show ships with at least one discoverable image.
   - Randomize 1 of N images each load. Prefer assets/ships/thumbs/.
*/
(function(){
  const abs = (p)=> (typeof window._abs==='function' ? _abs(p) : p);
  const SOURCE = abs('/assets/data/fleet_index.json');

  const el = {
    linesGrid:   document.getElementById('linesGrid'),
    linesEmpty:  document.getElementById('linesEmpty'),
    classesSec:  document.getElementById('classesSection'),
    classesGrid: document.getElementById('classesGrid'),
    classesEmpty:document.getElementById('classesEmpty'),
    shipsSec:    document.getElementById('shipsSection'),
    shipsGrid:   document.getElementById('shipsGrid'),
    shipsEmpty:  document.getElementById('shipsEmpty'),
    meta:        document.getElementById('meta'),
    crumbLineWrap: document.getElementById('crumb-line-wrap'),
    crumbLine:     document.getElementById('crumb-line'),
    crumbClassWrap:document.getElementById('crumb-class-wrap'),
    crumbClass:    document.getElementById('crumb-class'),
    crumbHere:     document.getElementById('crumb-here')
  };

  const STATE = { line:null, classId:null };
  const WORLD = { byLine:{} };

  const norm = s => String(s||'').toLowerCase().replace(/’/g,"'").trim();
  const titleCase = s => String(s||'').replace(/(^|[-_ ])([a-z])/g, (_,sp,ch)=> (sp?sp:'')+ch.toUpperCase());
  const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&lt;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
  const toNumMaybe = v => {
    if(v==null||v==="N/A") return null;
    const n=Number(String(v).replace(/[^\d.]/g,''));
    return Number.isFinite(n)?n:null;
  };

  // ---------- Data normalization ----------
  function normalizeFromFlat(json){
    const raw = (json && json.ships) || [];
    return raw.map(x=>{
      const a = x.attributes || x;
      return {
        name: a.name || a.title || a.ship || '',
        slug: a.slug || a.id || '',
        line: norm(a.line || a.brand || a.cruise_line || ''),
        class: norm(a.class || a.ship_class || ''),
        year: toNumMaybe(a.entered_service || a.inaugural || a.launched || a.year_built_or_entered),
        gt: toNumMaybe(a.gt || a.gross_tonnage || a.tonnage),
        guests: toNumMaybe(a.capacity || a.passengers || a.guests),
        // image resolved later
        detail_url: a.detail_url || a.url || (a.slug && a.line ? `/ships/${a.line}/${a.slug}.html` : '')
      };
    }).filter(s=> s.name && s.line);
  }

  function inferClassFromNotes(notes){
    const m = String(notes||'').match(/([A-Za-z][A-Za-z \-']+)-class/i);
    return m ? norm(m[1]) : '';
  }

  function normalizeFromCruiseLines(json){
    const out = [];
    const lines = Array.isArray(json?.cruise_lines) ? json.cruise_lines : [];
    for(const L of lines){
      const lineLabel = L.name || '';
      const lineSlug  = norm(L.slug || lineLabel);
      const ships = Array.isArray(L.ships) ? L.ships : [];
      for(const s of ships){
        out.push({
          name: s.name || '',
          slug: s.slug || '',
          line: lineSlug || norm(lineLabel),
          class: norm(s.class || s.ship_class || inferClassFromNotes(s.notes)),
          year: toNumMaybe(s.year_built_or_entered || s.entered_service || s.launched),
          gt: toNumMaybe(s.gt),
          guests: toNumMaybe(s.capacity),
          detail_url: s.url || (lineSlug && s.slug ? `/ships/${lineSlug}/${s.slug}.html` : '')
        });
      }
    }
    return out.filter(s=> s.name && s.line);
  }

  function groupByLineAndClass(list){
    const byLine = {};
    for(const s of list){
      const line = s.line;
      const klass = s.class || 'unknown';
      if(!byLine[line]) byLine[line] = {};
      if(!byLine[line][klass]) byLine[line][klass] = [];
      byLine[line][klass].push(s);
    }
    return byLine;
  }

  // ---------- Image discovery (preferred → fallback roots) ----------
  // Note: these are *directories* relative to the site root
  const IMAGE_ROOTS = [
    'assets/ships/thumbs',    // preferred (already thumbnails)
    'assets/ships',
    'assets',
    'images',
    'ships',
    'ships/assets',
    'ships/rcl/images'
  ];
  const EXTS = ['jpeg','jpg','png'];
  const SUFFIXES = ['','1','2','3']; // plain + numbered variants

  // Cache: slug -> array of discovered image URLs
  const IMG_CACHE = new Map();

  async function headOK(url){
    try{
      const r = await fetch(url, { method:'HEAD', cache:'no-store' });
      if (r.ok) return true;
      // Some hosts deny HEAD; fall back to GET but don't hold body
      const g = await fetch(url, { method:'GET', cache:'no-store' });
      return g.ok;
    }catch{ return false; }
  }

  async function discoverImagesForSlug(slug){
    if (IMG_CACHE.has(slug)) return IMG_CACHE.get(slug);

    const candidates = [];
    for (const root of IMAGE_ROOTS){
      for (const suf of SUFFIXES){
        for (const ext of EXTS){
          candidates.push(`/${root}/${slug}${suf ? suf : ''}.${ext}`);
        }
      }
    }

    const found = [];
    // Try preferred roots first, bail once we have 3 (randomize among them later)
    for (let i=0; i<candidates.length && found.length<3; i++){
      const url = abs(candidates[i]);
      // de-dupe in case roots overlap
      if (found.indexOf(url) !== -1) continue;
      /* eslint-disable no-await-in-loop */
      const ok = await headOK(url);
      if (ok) found.push(url);
      /* eslint-enable no-await-in-loop */
    }
    IMG_CACHE.set(slug, found);
    return found;
  }

  // Throttled batch (limits parallel fetches so we don’t hammer the server)
  async function batchDiscover(slugs, concurrency=6){
    const results = new Map();
    let i = 0;
    async function worker(){
      while (i < slugs.length){
        const idx = i++;
        const slug = slugs[idx];
        const imgs = await discoverImagesForSlug(slug);
        results.set(slug, imgs);
      }
    }
    const workers = Array.from({length: Math.min(concurrency, slugs.length)}, worker);
    await Promise.all(workers);
    return results;
  }

  function pickRandom(arr){
    return (arr && arr.length) ? arr[Math.floor(Math.random()*arr.length)] : '';
  }

  // ---------- Rendering ----------
  function lineDisplay(id){
    const map = {
      'rcl':'Royal Caribbean International',
      'royal-caribbean':'Royal Caribbean International',
      'royal-caribbean-international':'Royal Caribbean International'
    };
    return map[id] || titleCase(id.replace(/-/g,' '));
  }

  function classDisplay(id){
    const label = titleCase(id.replace(/-?class$/,'').replace(/-/g,' '));
    return label && label!=='Unknown' ? `${label} Class` : 'Class';
  }

  function lineCard(lineId, classes){
    const count = Object.values(classes).reduce((n,arr)=> n+(arr?arr.length:0), 0);
    const logo = (/(^|-)rcl($|-)|royal/.test(lineId)) ? '/assets/lines/rcl.png' : '/assets/logo_wake.png';
    return `
      <article class="card clickable" role="button" tabindex="0" data-line="${esc(lineId)}" aria-label="${esc(lineDisplay(lineId))}">
        <div class="thumb">
          <img src="${abs(logo)}" alt="${esc(lineDisplay(lineId))} logo" loading="lazy"
               onerror="this.src='${abs('/assets/logo_wake.png')}'"/>
        </div>
        <div class="body">
          <h3 class="card-title">${esc(lineDisplay(lineId))} <span class="pill badge">${count} ships</span></h3>
          <p class="small muted">${Object.keys(classes).length} classes</p>
        </div>
      </article>`;
  }

  function classCard(lineId, classId, shipCount){
    const guess1 = abs(`/assets/classes/${lineId}/${classId}.jpeg`);
    const guess2 = abs(`/assets/classes/${classId}.jpeg`);
    return `
      <article class="card clickable" role="button" tabindex="0" data-class="${esc(classId)}" aria-label="${esc(classDisplay(classId))}">
        <div class="thumb">
          <img src="${guess1}" alt="${esc(classDisplay(classId))}" loading="lazy"
               onerror="(function(i){var fb=['${guess2}','${abs('/assets/ships/radiance-of-the-seas1.jpeg')}']; i._f=(i._f||0); if(i._f<fb.length){ i.src=fb[i._f++]; } })(this)"/>
        </div>
        <div class="body">
          <h3 class="card-title">${esc(classDisplay(classId))} <span class="pill badge">${shipCount}</span></h3>
          <p class="small muted">Tap to see ships</p>
        </div>
      </article>`;
  }

  function shipCard(s, imgUrl){
    const href = s.detail_url ? abs(s.detail_url) : '#';
    return `
      <article class="card" role="article" data-slug="${esc(s.slug)}">
        <div class="thumb">
          <img src="${imgUrl}" alt="${esc(s.name)}" loading="lazy"/>
        </div>
        <div class="body">
          <h3 class="card-title">${esc(s.name)}</h3>
          <div class="stats-mini" style="display:grid;grid-template-columns:1fr 1fr;gap:.25rem .75rem;font-size:.92rem">
            <div><span class="k">GT:</span> ${s.gt? s.gt.toLocaleString() : '—'}</div>
            <div><span class="k">Guests:</span> ${s.guests? s.guests.toLocaleString() : '—'}</div>
            <div><span class="k">Year:</span> ${s.year || '—'}</div>
          </div>
          <p style="margin-top:.5rem"><a class="btn" href="${href}">Open Ship Page →</a></p>
        </div>
      </article>`;
  }

  function renderLines(byLine){
    const ids = Object.keys(byLine).sort();
    el.linesGrid.innerHTML = ids.map(id => lineCard(id, byLine[id])).join('');
    if (!ids.length) el.linesEmpty.classList.remove('hidden'); else el.linesEmpty.classList.add('hidden');
    el.linesGrid.querySelectorAll('[data-line]').forEach(btn=>{
      btn.addEventListener('click', ()=> selectLine(btn.getAttribute('data-line')));
    });
  }

  function renderClasses(lineId, classes){
    el.classesSec.classList.remove('hidden');
    const ids = Object.keys(classes).sort();
    el.classesGrid.innerHTML = ids.map(id => classCard(lineId, id, (classes[id]||[]).length)).join('');
    if (!ids.length) el.classesEmpty.classList.remove('hidden'); else el.classesEmpty.classList.add('hidden');
    el.classesGrid.querySelectorAll('[data-class]').forEach(btn=>{
      btn.addEventListener('click', ()=> selectClass(btn.getAttribute('data-class')));
    });
  }

  async function renderShips(lineId, classId, list){
    el.shipsSec.classList.remove('hidden');
    const arr = (list||[]).slice().sort((a,b)=> a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));

    // Discover images for this set (throttled)
    const slugs = arr.map(s=>s.slug).filter(Boolean);
    const discovered = await batchDiscover(slugs, 6);

    // Filter out ships with no image; pick random image for each
    const withImgs = arr
      .map(s => {
        const imgs = discovered.get(s.slug) || [];
        return imgs.length ? { ship:s, img: pickRandom(imgs) } : null;
      })
      .filter(Boolean);

    el.shipsGrid.innerHTML = withImgs.map(({ship, img}) => shipCard(ship, img)).join('');
    if (!withImgs.length) el.shipsEmpty.classList.remove('hidden'); else el.shipsEmpty.classList.add('hidden');
  }

  // ---------- Selection + crumbs ----------
  function selectLine(lineId){
    STATE.line=lineId; STATE.classId=null;
    el.crumbLine.textContent = lineDisplay(lineId);
    el.crumbLineWrap.classList.remove('hidden');
    el.crumbClassWrap.classList.add('hidden');
    el.crumbHere.textContent='Choose a class';
    renderClasses(lineId, WORLD.byLine[lineId] || {});
    el.shipsSec.classList.add('hidden'); el.shipsGrid.innerHTML='';
    history.replaceState(null,'', location.pathname + '#'+encodeURIComponent(lineId));
  }
  async function selectClass(classId){
    STATE.classId=classId;
    el.crumbClass.textContent = classDisplay(classId);
    el.crumbClassWrap.classList.remove('hidden');
    el.crumbHere.textContent='Choose a ship';
    await renderShips(STATE.line, classId, (WORLD.byLine[STATE.line]||{})[classId]);
    history.replaceState(null,'', location.pathname + '#'+encodeURIComponent(STATE.line)+'/'+encodeURIComponent(classId));
  }
  el.crumbLine.addEventListener('click', ()=> { if(STATE.line) selectLine(STATE.line); });
  el.crumbClass.addEventListener('click', ()=> { if(STATE.line && STATE.classId) selectClass(STATE.classId); });

  // ---------- Boot ----------
  (async function init(){
    try{
      const r = await fetch(SOURCE, {cache:'no-store'});
      if(!r.ok) throw new Error(r.status);
      const raw = await r.json();

      const ships = raw?.cruise_lines ? normalizeFromCruiseLines(raw) : normalizeFromFlat(raw);
      WORLD.byLine = groupByLineAndClass(ships);

      const when = raw.generated || raw.updated || (raw.meta && raw.meta.updated);
      const ver  = raw.version || (raw.meta && raw.meta.version);
      el.meta.textContent = (ver||when) ? `Data: ${ver?('v'+ver):''}${ver&&when?' • ':''}${when?String(when).slice(0,10):''}` : 'Data source: fleet_index.json';

      renderLines(WORLD.byLine);

      // Default to Royal if present
      const royalKey = Object.keys(WORLD.byLine).find(k => /royal|rcl/.test(k));
      if (!location.hash && royalKey) selectLine(royalKey);

      // Deep-link restore
      const hash = (location.hash||'').slice(1);
      if (hash){
        const [line,classId] = hash.split('/').map(s=>decodeURIComponent(s||''));
        if (line && WORLD.byLine[line]) {
          selectLine(line);
          if (classId && (WORLD.byLine[line][classId])) selectClass(classId);
        }
      }
    }catch(e){
      console.error('browse init failed', e);
      el.linesEmpty.classList.remove('hidden');
    }
  })();
})();
</script>
</body>
</html>
