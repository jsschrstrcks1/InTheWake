<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- was: content="v=.9.001.011" -->
<meta name="version" content=".9.001.012"/>
<title>Royal Caribbean Drink Package Calculator 2025 | Is It Worth It?</title>
<meta name="description" content="Free Royal Caribbean drink calculator with Crown & Anchor support, sea/port day weighting, and break-even analysis. Plan your cruise drink budget."/>
<link rel="canonical" href="https://cruisinginthewake.com/drink-calculator.html"/>
  <link rel="preload" as="image" href="/assets/index_hero.jpg?v=3.010.071" imagesrcset="/assets/index_hero.jpg?v=3.010.071" fetchpriority="high">
<!-- Favicon / PWA -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/in_the_wake_icon_32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/in_the_wake_icon_192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/in_the_wake_icon_180x180.png">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0e6e8e">

<!-- Performance -->
<link rel="preconnect" href="https://api.frankfurter.app">
<link rel="preconnect" href="https://api.exchangerate.host">

<!-- Social -->
<meta property="og:type" content="website"/>
<meta property="og:title" content="Royal Caribbean Drink Package Calculator"/>
<meta property="og:description" content="Break-even chart + sea/port day weighting. Find out if a package saves money."/>
<meta property="og:url" content="https://cruisinginthewake.com/drink-calculator.html"/>
<meta property="og:image" content="https://cruisinginthewake.com/assets/social/drink-calculator-2025.jpg"/>
<meta name="twitter:card" content="summary_large_image"/>

<!-- Structured data (condensed) -->
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://cruisinginthewake.com/"},{"@type":"ListItem","position":2,"name":"Drink Calculator","item":"https://cruisinginthewake.com/drink-calculator.html"}]}
</script>

<style>
:root{
  --sea:#0a3d62;--foam:#e6f4f8;--rope:#d9b382;--ink:#083041;--sky:#f7fdff;
  --accent:#0e6e8e;--shadow:0 2px 6px rgba(8,48,65,.08);--shadow-lg:0 10px 28px rgba(8,48,65,.14);
  --rail-width:320px;--bg:#f8fbfc;--card:#fff;--bd:#e5e7eb;--muted:#525a66;
  --good:#10b981;--warn:#f59e0b;--bad:#ef4444;
}
*{box-sizing:border-box}
html{scrollbar-gutter:stable both-edges}
body{margin:0;background:var(--sky);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
a{color:var(--accent);text-decoration:none}a:hover{text-decoration:underline}
img{max-width:100%;height:auto;display:block}
.wrap{max-width:1100px;margin:0 auto;padding:20px 14px 36px}
.card{background:var(--card);border:2px solid var(--rope);border-radius:12px;padding:1rem;margin:.8rem 0;box-shadow:var(--shadow)}
h1,h2,h3{color:var(--sea)}.tiny{font-size:.88rem;color:#456}.small{font-size:.9rem;color:#475569}.muted{color:var(--muted)}
.sr-only{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}

/* Header / hero - FIXED: 42vh max, horizon centered */
.hero-header{position:relative;border-bottom:6px double var(--rope);background:#eaf6f6}
.navbar{max-width:1100px;margin:0 auto;display:flex;gap:.6rem;padding:.35rem .9rem .75rem;align-items:center;min-height:56px}
.brand{display:flex;align-items:center;gap:.6rem}
.brand img{height:40px;width:auto;max-width:min(42vw,240px)}
.version-badge{font-size:.72rem;opacity:.8;margin-left:.35rem}

.itw-nav{display:flex;gap:.5rem;flex:1 1 auto;align-items:center;justify-content:center;white-space:nowrap}
.itw-nav .nav-item{position:relative}
.itw-nav .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.35rem .7rem;border-radius:10px;background:#fff;border:1px solid var(--rope);color:var(--accent);font-size:.95rem;cursor:pointer;transition:all .2s ease}
.itw-nav .chip:hover{background:var(--foam);transform:translateY(-1px)}
.itw-nav .nav-item>a.chip{text-decoration:none}
.itw-nav .chip[aria-current="page"]{outline:3px dashed var(--rope);outline-offset:2px}
.itw-nav .menu{position:absolute;left:0;top:100%;transform:translateY(.35rem);min-width:240px;max-width:min(90vw,360px);background:#fff;border:1px solid var(--rope);border-radius:12px;box-shadow:var(--shadow-lg);padding:.6rem;display:none;visibility:hidden;opacity:0;pointer-events:none;z-index:100;transition:opacity .18s ease}
.itw-nav .nav-item.open>.menu{display:block;visibility:visible;opacity:1;pointer-events:auto}
.itw-nav .menu .label{font-weight:700;color:#234;margin:.15rem .2rem .35rem;font-size:.9rem}
.itw-nav .menu a{display:block;padding:.45rem .6rem;border-radius:.6rem;color:var(--ink);transition:background .15s}
.itw-nav .menu a:hover{background:#f2f7fa;text-decoration:none}

/* Hero: 40vh to match Planning, horizon at midpoint, logo never clips */
.hero{
  position:relative;width:100%;height:40vh;min-height:280px;max-height:440px;
  background:url('/assets/index_hero.jpg?v=3.010.071') center 50%/cover no-repeat;
  display:flex;align-items:flex-end;overflow:hidden;
}
.hero-title{
  position:absolute;left:clamp(.75rem,3vw,1rem);bottom:clamp(1rem,4vh,2rem);
  display:flex;flex-direction:column;gap:.35rem;text-shadow:0 2px 6px rgba(0,0,0,.45);
}
.hero-title .logo{width:clamp(160px,20vw,340px);max-width:min(85vw,480px);filter:drop-shadow(0 3px 8px rgba(0,0,0,.45))}
.tagline{font-weight:700;letter-spacing:.2px;color:#e6f4f8;font-size:clamp(.85rem,1.4vw,1.25rem);white-space:nowrap}
.hero-compass{position:absolute;right:clamp(.75rem,3vw,1rem);top:.5rem;width:76px;opacity:.9;filter:invert(39%) sepia(9%) saturate(1063%) hue-rotate(151deg) brightness(92%) contrast(89%)}
.hero-credit{position:absolute;right:.75rem;bottom:.75rem;z-index:2;font-size:.75rem;opacity:.85;background:rgba(0,0,0,.4);padding:.25rem .5rem;border-radius:4px;color:#fff}

.page-grid{display:grid;grid-template-columns:minmax(0,1.6fr) minmax(260px,var(--rail-width));gap:2rem;align-items:start}
@media (max-width:979.98px){.page-grid{grid-template-columns:1fr}}

.rail-list{display:grid;gap:1rem}
.author-card{display:flex;gap:.75rem;align-items:center}
.author-avatar{display:block;width:56px;height:56px;border-radius:12px;object-fit:cover;flex:0 0 56px}

.inputs .row{display:grid;grid-template-columns:1fr 140px;align-items:center;padding:10px 0;border-bottom:1px dashed var(--bd);gap:10px}
.inputs .row:last-child{border-bottom:0}
.inputs .row> :not(:first-child){justify-self:end}
.inputs input[type="text"],.inputs input[type="number"]{width:110px;padding:6px 8px;border:1px solid var(--bd);border-radius:8px;font:inherit;background:#fff;min-height:44px;font-size:16px}
.inputs select{padding:6px 8px;border:1px solid var(--bd);border-radius:8px;background:var(--card);color:var(--ink)}
.controls-inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.badge{background:#fbbf24;color:#78350f;padding:4px 10px;border-radius:999px;font-weight:800;font-size:.85rem}
.btn{cursor:pointer;padding:8px 12px;border:1px solid var(--bd);border-radius:8px;background:#0f172a;color:#fff;font-weight:700;min-height:44px;font-size:1rem;transition:all .2s}
.btn:hover{background:#1e293b;transform:scale(1.02)}
.btn.ghost{background:#fff;color:#0f172a}

/* FIXED: Preset section with persona cards */
.qs{background:#fde68a20;border:1px solid #f59e0b50;border-radius:12px;padding:14px 16px;margin:16px 0}
.qs .qs-hd{font-weight:800;color:#7c2d12;margin:0 0 6px 0}
.qs .qs-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:8px}
.persona-btn{background:#fff;border:2px solid var(--rope);border-radius:10px;padding:12px;cursor:pointer;transition:all .2s;text-align:left}
.persona-btn:hover{background:var(--foam);border-color:var(--accent);transform:translateY(-2px);box-shadow:var(--shadow)}
.persona-btn .persona-icon{font-size:2rem;margin-bottom:6px}
.persona-btn .persona-name{font-weight:800;color:var(--sea);font-size:.95rem;margin-bottom:4px}
.persona-btn .persona-desc{font-size:.8rem;color:var(--muted);line-height:1.3}

/* FIXED: Chart legend and tooltip */
.chart-legend{display:flex;gap:1.5rem;flex-wrap:wrap;margin:10px 0;padding:10px;background:var(--foam);border-radius:8px;font-size:.85rem}
.chart-legend-item{display:flex;align-items:center;gap:.5rem}
.chart-legend-color{width:16px;height:16px;border-radius:3px}
.chart-help{font-size:.85rem;color:var(--muted);margin-top:8px;padding:8px;background:var(--foam);border-radius:6px;border-left:3px solid var(--accent)}

/* FIXED: Per-category summary table */
.category-summary{margin:12px 0;padding:12px;background:var(--foam);border-radius:8px;border:1px solid var(--rope)}
.category-summary h4{margin:0 0 8px 0;color:var(--sea);font-size:.95rem}
.category-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;font-size:.85rem}
.category-item{display:flex;justify-content:space-between;padding:6px 8px;background:#fff;border-radius:4px}
.category-item .cat-name{font-weight:600;color:var(--ink)}
.category-item .cat-cost{font-weight:700;color:var(--accent)}

/* FIXED: Packages rail with inclusion bullets */
.package-card{border:1px solid var(--bd);border-radius:8px;padding:12px;margin:8px 0;background:#fff}
.package-card h4{margin:0 0 8px 0;color:var(--sea);font-size:1rem}
.package-price{font-size:1.25rem;font-weight:800;color:var(--accent);margin-bottom:8px}
.package-inclusions{font-size:.8rem;margin:0;padding-left:20px;color:var(--muted)}
.package-inclusions li{margin:4px 0}

/* Weighting tooltip - FIXED: visible ? icon */
.tooltip-trigger{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:var(--accent);color:#fff;font-weight:700;font-size:.75rem;cursor:help;margin-left:6px}
.tooltip-trigger:hover,.tooltip-trigger:focus{background:var(--sea);outline:2px dashed var(--rope);outline-offset:2px}

#breakeven-wrap{margin-top:18px;position:relative;line-height:0}
#breakeven-chart{width:100%!important;max-width:100%;height:320px;border:1px dashed var(--bd);border-radius:10px;background:#fff;display:block}
#voucher-badge{position:absolute;top:-8px;right:0;transform:translateY(-100%)}

/* QUIZ MODAL - Lean, embedded */
#quiz-modal{display:none;position:fixed;inset:0;background:rgba(8,48,65,.92);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(4px);animation:fadeIn .3s}
#quiz-modal.show{display:flex}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.quiz-container{background:#fff;border:2px solid var(--rope);border-radius:16px;max-width:560px;width:90vw;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:slideUp .4s cubic-bezier(.34,1.56,.64,1)}
@keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
.quiz-header{background:linear-gradient(135deg,var(--sea) 0%,var(--accent) 100%);color:#fff;padding:1.5rem;border-radius:14px 14px 0 0;position:relative}
.quiz-header h2{margin:0 0 .5rem 0;font-size:1.5rem}
.quiz-header p{margin:0;opacity:.9;font-size:.9rem}
.quiz-progress{position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(255,255,255,.2)}
.quiz-progress-bar{height:100%;background:var(--good);transition:width .3s;box-shadow:0 0 10px rgba(16,185,129,.5)}
.quiz-body{padding:1.5rem}
.quiz-question{animation:questionSlide .3s}
@keyframes questionSlide{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.quiz-question h3{color:var(--sea);margin:0 0 1rem 0;font-size:1.15rem}
.quiz-options{display:flex;flex-direction:column;gap:.75rem}
.quiz-option{position:relative;background:var(--foam);border:2px solid var(--rope);border-radius:10px;padding:1rem;cursor:pointer;transition:all .2s}
.quiz-option:hover{background:#e6f4f8;border-color:var(--accent);transform:translateX(4px)}
.quiz-option.selected{background:var(--accent);border-color:var(--accent);color:#fff}
.quiz-option input{position:absolute;opacity:0;width:0;height:0}
.quiz-option-label{display:flex;align-items:center;gap:.75rem;font-weight:600}
.quiz-option-icon{width:22px;height:22px;border-radius:50%;border:2px solid currentColor;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.quiz-option.selected .quiz-option-icon::after{content:'‚úì';font-size:13px;font-weight:800}
.quiz-option-desc{font-size:.85rem;opacity:.85;margin-top:.25rem;margin-left:30px;font-weight:400}
.quiz-footer{padding:1rem;border-top:2px solid var(--foam);display:flex;gap:.75rem;justify-content:space-between}
.quiz-btn{padding:.75rem 1.25rem;border-radius:8px;font-weight:700;cursor:pointer;border:none;font-size:.95rem;min-height:44px;transition:all .2s}
.quiz-btn-primary{background:var(--accent);color:#fff;flex:1}
.quiz-btn-primary:hover{background:var(--sea);transform:scale(1.02)}
.quiz-btn-primary:disabled{background:#cbd5e1;cursor:not-allowed}
.quiz-btn-secondary{background:#fff;color:var(--ink);border:2px solid var(--rope)}
.quiz-skip{text-align:center;padding:.75rem;border-top:1px dashed var(--rope)}
.quiz-skip button{background:none;border:none;color:#64748b;text-decoration:underline;cursor:pointer;font-size:.85rem}

/* Print */
@media print{
  body{font-size:12pt;background:var(--card)}
  header.hero-header,.qs,.banner,.rail,.card:not(.inputs),#quiz-modal,footer{display:none}
  .card{border:none;box-shadow:none}
  #breakeven-chart{border-color:#ccc}
}

/* Force light */
@media (prefers-color-scheme:dark){
  :root{color-scheme:light}
  body,.card{background:var(--sky)!important;color:var(--ink)!important}
}
  .inputs.card { border-color: var(--rope); }
  /* Winner badge (non-obstructive) */
#best-stamp{
  position:absolute; top:-10px; right:8px;
  background:#10b981; color:#063;
  border:2px solid #065f46; border-radius:999px;
  padding:.25rem .5rem; font-weight:800; font-size:.8rem;
  box-shadow:0 4px 12px rgba(0,0,0,.12); display:none; z-index:3;
}
</style>
<style id="reduced-motion">
/* Respect prefers-reduced-motion: pause slide/blur and micro-animations */
@media (prefers-reduced-motion: reduce){
  html:focus-within { scroll-behavior: auto; }
  *, *::before, *::after { animation: none !important; transition: none !important; }

  /* Quiz: kill modal fade-in, container slide-up, question slide */
  #quiz-modal { animation: none !important; backdrop-filter: none !important; }
  .quiz-container { animation: none !important; }
  .quiz-question { animation: none !important; }
  .quiz-progress-bar { transition: none !important; }

  /* Small hover nudges elsewhere */
  .quiz-option:hover,
  .itw-nav .chip:hover { transform: none !important; }
}
</style>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://api.frankfurter.app">
<link rel="dns-prefetch" href="https://api.exchangerate.host">

<!-- Chart loader -->
<!-- Chart + App loader (version-synced with <meta name="version">) -->
<script>
(function(){
  const VER = document.querySelector('meta[name="version"]')?.content || '.9.001.012';
  const local = "/vendor/chart.umd.min.js?v=" + VER;
  const cdn   = "https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js";

  function add(src, cb){
    var s = document.createElement('script');
    s.src = src; s.defer = true; s.onload = cb;
    s.onerror = function(){ if(src !== cdn) add(cdn, cb); };
    document.head.appendChild(s);
  }

  function loadApp(){
    // wire math by version
    const m = document.createElement('script');
    m.type = "module";
    m.textContent = `
      import { compute as baseCompute, computeWithVouchers } 
      from '/assets/js/drink-math.js?v=${VER}';
      window.ITW_MATH = { compute: baseCompute, computeWithVouchers };
    `;
    document.head.appendChild(m);

    // keep app.js external (per instruction)
    const app = document.createElement('script');
    app.src = "/assets/js/drink-calculator.app.js?v=" + VER;
    app.defer = true;
    document.head.appendChild(app);
  }

  window.Chart ? loadApp() : add(local, loadApp);
})();
</script>
</head>
<body>
<a href="#content" class="sr-only">Skip to main content</a>

<!-- QUIZ MODAL -->
<div id="quiz-modal" role="dialog" aria-modal="true"
     aria-labelledby="quiz-title" aria-describedby="quiz-subtitle">
  <div class="quiz-container">
    <div class="quiz-header">
      <h2 id="quiz-title">‚ú® Discover Your Cruise Style</h2>
      <p id="quiz-subtitle">Quick 6-question quiz to personalize defaults</p>
      <div class="quiz-progress"><div id="quiz-progress-bar" class="quiz-progress-bar" style="width:0%"></div></div>
    </div>
    <div class="quiz-body"><div id="quiz-content"></div></div>
    <div class="quiz-footer">
      <button id="quiz-back" type="button" class="quiz-btn quiz-btn-secondary" style="display:none">‚Üê Back</button>
      <button id="quiz-next" type="button" class="quiz-btn quiz-btn-primary" disabled>Next ‚Üí</button>
    </div>
    <div class="quiz-skip"><button type="button" onclick="window.quizSkip()">Skip and enter manually</button></div>
  </div>
</div>

<header class="hero-header" role="banner">
  <div class="navbar">
    <div class="brand">
      <img src="/assets/logo_wake.png" width="256" height="64" alt="In the Wake">
      <span class="tiny version-badge">v.9.001.012</span>
    </div>
    <nav class="itw-nav" aria-label="Primary">
      <div class="nav-item"><a class="chip" href="/">Home</a></div>
      <div class="nav-item">
        <button class="chip" aria-haspopup="menu" aria-expanded="false" aria-controls="menu-planning">Planning ‚ñæ</button>
        <div id="menu-planning" class="menu">
          <div class="label">Plan your cruise</div>
          <a href="/planning.html">Planning</a>
          <a href="/ships.html">Ships</a>
          <a href="/restaurants.html">Restaurants</a>
          <a href="/ports.html">Ports</a>
          <a href="/drink-calculator.html" aria-current="page">Drink Packages</a>
          <a href="/packing-lists.html">Packing Lists</a>
        </div>
      </div>
      <div class="nav-item">
        <button class="chip" aria-haspopup="menu" aria-expanded="false" aria-controls="menu-travel">Travel ‚ñæ</button>
        <div id="menu-travel" class="menu">
          <div class="label">On the way</div>
          <a href="/travel.html">Travel</a>
          <a href="/solo.html">Solo</a>
        </div>
      </div>
      <div class="nav-item"><a class="chip" href="/about-us.html">About</a></div>
    </nav>
  </div>
  <div class="hero" role="img" aria-label="Ship wake at sunrise">
    <div class="hero-title">
      <img class="logo" src="/assets/logo_wake.png" alt="In the Wake">
      <div class="tagline">A Cruise Traveler's Logbook</div>
    </div>
    <img class="hero-compass" src="/assets/compass_rose.svg" alt="" onerror="this.src='/assets/compass_rose.png'">
    <div class="hero-credit">Photo ¬© Flickers of Majesty</div>
  </div>
</header>

<main class="wrap page-grid" id="content">
 <h1 class="sr-only">Royal Caribbean Drink Package Calculator (2025)</h1>
  <section aria-label="Calculator">
    <!-- FIXED: Preset Personas with descriptions -->
    <section class="qs" aria-labelledby="qs-title">
      <h2 id="qs-title" class="qs-hd">üöÄ Quick Start: Choose Your Style</h2>
      <p class="small" style="margin-bottom:8px">Select a persona to auto-fill or take the quiz for personalized defaults</p>
      <div class="qs-grid" id="qs-preset-buttons">
        <!-- Will be populated by app.js, but provide fallback -->
        <button class="persona-btn" data-persona="light">
          <div class="persona-icon">üßò</div>
          <div class="persona-name">Light & Chill</div>
          <div class="persona-desc">Mostly non-alcoholic, 1-2 drinks/day</div>
        </button>
        <button class="persona-btn" data-persona="moderate">
          <div class="persona-icon">ü•Ç</div>
          <div class="persona-name">Balanced & Social</div>
          <div class="persona-desc">Mix of everything, 3-5 drinks/day</div>
        </button>
        <button class="persona-btn" data-persona="party">
          <div class="persona-icon">üéâ</div>
          <div class="persona-name">Lively Celebration</div>
          <div class="persona-desc">Living it up, 6+ drinks/day</div>
        </button>
        <button class="persona-btn" data-persona="coffee">
          <div class="persona-icon">‚òï</div>
          <div class="persona-name">Coffee Lover</div>
          <div class="persona-desc">Multiple specialty coffees daily</div>
        </button>
      </div>
      <div style="text-align:center;margin-top:12px">
        <button class="btn" onclick="window.quizStart()" style="background:var(--accent)">Or Take 2-Min Quiz ‚Üí</button>
      </div>
    </section>

    <div class="banner" role="status" aria-live="polite" style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;padding:10px;background:var(--foam);border-radius:8px;margin:.6rem 0">
      <span id="best-chip" class="badge">Best value: √†-la-carte</span>
      <span id="best-text" class="small">Your daily picks are cheapest without a package.</span>
      <button id="jump-winner" class="btn ghost" type="button" style="min-height:36px;padding:6px 12px">Jump to Best</button>
    </div>

    <p id="fallback-banner" hidden class="small" style="background:#fff7ed;border:1px solid #fed7aa;border-radius:6px;padding:.5rem">‚ö†Ô∏è Live prices unavailable; using defaults</p>

    <section class="card inputs" aria-labelledby="calc-title">
      <h2 id="calc-title" class="hd">
        <span id="totals" aria-live="polite">Calculating...</span>
        <small class="small"> ‚Äî includes 18% gratuity</small>
      </h2>

      <div class="bd">
        <div class="controls-inline" style="margin-top:8px">
          <label class="small" for="currency-select" style="font-weight:800">Display currency</label>
          <select id="currency-select" class="small" style="font-weight:700;padding:4px 6px;border-radius:6px">
            <option value="USD">USD $</option>
            <option value="GBP">GBP ¬£</option>
            <option value="EUR">EUR ‚Ç¨</option>
            <option value="CAD">CAD $</option>
            <option value="AUD">AUD $</option>
          </select>
          <span id="offline-chip" class="badge" hidden style="background:#fde68a;color:#7c2d12">Offline rates</span>
        </div>
        <span id="currency-note" class="small" style="display:block;margin-top:6px;font-weight:600"></span>
        <hr style="border:0;border-top:1px dashed var(--bd);margin:12px 0"/>

        <div class="row"><label for="input-days">Cruise days</label><input id="input-days" type="text" inputmode="numeric" value="7" data-input="days"></div>

        <!-- FIXED: Weighting with visible ? tooltip -->
        <fieldset style="border:1px solid var(--bd);padding:12px;border-radius:10px;margin-top:8px">
          <legend style="font-weight:800;padding:0 6px;display:flex;align-items:center">
            Sea/Port variability
            <span class="tooltip-trigger" tabindex="0" aria-describedby="sea-tip">?</span>
<span id="sea-tip" class="sr-only" role="tooltip">
  Sea days often mean more drinks (relaxing by the pool). Port days often mean fewer (off exploring).
  This setting adjusts estimates accordingly.
</span>
          </legend>
          <div class="row"><label for="input-seadays">Sea days</label><input id="input-seadays" type="text" inputmode="numeric" value="3" data-input="seadays"></div>
          <div class="row" style="grid-template-columns:1fr 1fr">
  <label class="small">
    <input type="checkbox" id="sea-toggle" checked data-input="seaapply" aria-describedby="sea-weighting-help">
    Apply weighting
  </label>
  <div class="controls-inline">
    <label for="sea-weight" class="small">¬±%</label>
    <input id="sea-weight" type="range" min="0" max="40" value="20" data-input="seaweight" aria-describedby="sea-weighting-help">
    <span id="sea-weight-val" class="small">20%</span>
  </div>
</div>
<p id="sea-weighting-help" class="tiny" style="margin:.25rem 0 0;color:#475569;max-width:60ch">
  Sea days will be increased by this percentage; port days decreased by the same amount, then averaged over your itinerary.
</p>
        </fieldset>

        <fieldset style="border:1px solid var(--bd);padding:12px;border-radius:10px;margin-top:12px">
          <legend style="font-weight:800;padding:0 6px">Group in stateroom</legend>
          <div class="row"><label for="input-adults">Adults (21+)</label><input id="input-adults" type="text" inputmode="numeric" value="1" data-input="adults"></div>
          <div class="row">
            <label for="input-minors">
              Minors (under 21)
              <a href="/faq.html#minors-deluxe" class="tiny" style="display:block;margin-top:2px">(Why no Deluxe for minors?)</a>
            </label>
            <input id="input-minors" type="text" inputmode="numeric" value="0" data-input="minors">
          </div>
        </fieldset>

        <!-- FIXED: Voucher with face value input -->
        <details id="cna-vouchers" class="small" style="border:2px solid var(--rope);border-radius:10px;padding:0;margin-top:12px;background:var(--foam)">
          <summary style="cursor:pointer;font-weight:700;padding:1rem;list-style:none">
            üëë Diamond or higher? Apply free drink vouchers
            <div class="tiny muted" style="font-weight:400;margin-top:4px">Crown & Anchor perks. Minors get non-alcoholic value only.</div>
          </summary>
          <div style="padding:0 1rem 1rem">
            <div class="small" style="margin-bottom:10px;background:#fff3cd;border-left:3px solid var(--warn);padding:8px;border-radius:4px">
              <strong>Voucher face value:</strong>
              <input type="text" id="voucher-value" inputmode="decimal" value="12.00" style="width:70px;margin-left:6px;padding:4px;border:1px solid var(--bd);border-radius:4px"> USD
              <div class="tiny" style="margin-top:4px">May vary by sailing. Check your Crown & Anchor details.</div>
            </div>
            <fieldset style="border:1px solid var(--bd);padding:10px;border-radius:8px">
              <legend style="font-weight:700;padding:0 6px">Adult Vouchers</legend>
              <div class="row"><label for="v-adult-d">Diamond (4/day)</label><input id="v-adult-d" type="text" inputmode="numeric" value="0" data-voucher="adult-d"></div>
              <div class="row"><label for="v-adult-dp">Diamond+ (5/day)</label><input id="v-adult-dp" type="text" inputmode="numeric" value="0" data-voucher="adult-dp"></div>
              <div class="row"><label for="v-adult-p">Pinnacle (5/day)</label><input id="v-adult-p" type="text" inputmode="numeric" value="0" data-voucher="adult-p"></div>
            </fieldset>
            <fieldset style="border:1px solid var(--bd);padding:10px;border-radius:8px;margin-top:10px">
              <legend style="font-weight:700;padding:0 6px">Minor Vouchers (Non-Alc)</legend>
              <div class="row"><label for="v-minor-d">Diamond (4/day)</label><input id="v-minor-d" type="text" inputmode="numeric" value="0" data-voucher="minor-d"></div>
              <div class="row"><label for="v-minor-dp">Diamond+ (5/day)</label><input id="v-minor-dp" type="text" inputmode="numeric" value="0" data-voucher="minor-dp"></div>
              <div class="row"><label for="v-minor-p">Pinnacle (5/day)</label><input id="v-minor-p" type="text" inputmode="numeric" value="0" data-voucher="minor-p"></div>
            </fieldset>
          </div>
        </details>

        <fieldset style="border:1px solid var(--bd);padding:12px;border-radius:10px;margin-top:12px">
          <legend style="font-weight:800;padding:0 6px" id="mode-legend">Calculation Mode: Daily Averages</legend>
          <div class="controls-inline">
            <label class="small"><input type="radio" name="calc-mode" id="mode-simple" value="simple" checked> Daily Averages</label>
            <label class="small"><input type="radio" name="calc-mode" id="mode-itinerary" value="itinerary"> Day-by-Day</label>
          </div>
        </fieldset>

        <script>
        // Mode toggle - actually switches between simple and itinerary inputs
        (function(){
          const simple = document.getElementById('simple-inputs');
          const itin   = document.getElementById('itinerary-inputs');
          const rs = document.getElementById('mode-simple');
          const ri = document.getElementById('mode-itinerary');
          const legend = document.getElementById('mode-legend');

          function toggle(mode){
            if(mode==='itinerary'){ 
              simple.style.display='none'; 
              itin.style.display=''; 
              if(legend) legend.textContent = 'Calculation Mode: Day-by-Day';
            } else { 
              simple.style.display=''; 
              itin.style.display='none'; 
              if(legend) legend.textContent = 'Calculation Mode: Daily Averages';
            }
            document.dispatchEvent(new Event('itw:mode-changed'));
          }
          
          if(rs && ri){
            rs.addEventListener('change', ()=>toggle('simple'));
            ri.addEventListener('change', ()=>toggle('itinerary'));
          }
          
          // Default to simple
          toggle('simple');
        })();
        </script>

        <div id="simple-inputs" style="margin-top:6px">
          <div class="row"><label>Soda <span class="tiny muted">(avg/day)</span></label><input data-input="soda" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Specialty coffee</label><input data-input="coffee" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Premium tea</label><input data-input="teaprem" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Fresh juice/smoothie</label><input data-input="freshjuice" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Mocktail</label><input data-input="mocktail" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Energy drink</label><input data-input="energy" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Milkshake</label><input data-input="milkshake" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Bottled water (500ml)</label><input data-input="bottledwater" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Beer</label><input data-input="beer" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Wine</label><input data-input="wine" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Cocktail</label><input data-input="cocktail" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Spirits/shot</label><input data-input="spirits" type="text" inputmode="decimal" value="0"></div>
        </div>

        <div id="itinerary-inputs" style="margin-top:12px"></div>

        <!-- FIXED: Chart with enhanced legend and help text -->
        <div id="breakeven-wrap">
          <div class="chart-legend">
            <div class="chart-legend-item">
              <div class="chart-legend-color" style="background:#0e6e8e"></div>
              <span>Your √†-la-carte cost</span>
            </div>
            <div class="chart-legend-item">
              <div class="chart-legend-color" style="background:#cbd5e1"></div>
              <span>Soda Package</span>
            </div>
            <div class="chart-legend-item">
              <div class="chart-legend-color" style="background:#a7e0f0"></div>
              <span>Refreshment Package</span>
            </div>
            <div class="chart-legend-item">
              <div class="chart-legend-color" style="background:#f7b4a2"></div>
              <span>Deluxe Package</span>
            </div>
            <div class="chart-legend-item">
              <span class="tiny muted">üìä Bars show price range (min-max)</span>
            </div>
          </div>
          <table id="chart-desc" class="sr-only">
  <caption>Daily cost comparison</caption>
  <thead><tr><th>Option</th><th>Cost per day</th></tr></thead>
  <tbody>
    <tr><td>√Ä-la-carte</td><td id="sr-alc">$0.00</td></tr>
    <tr><td>Soda</td><td id="sr-soda">$0.00</td></tr>
    <tr><td>Refreshment</td><td id="sr-refresh">$0.00</td></tr>
    <tr><td>Deluxe</td><td id="sr-deluxe">$0.00</td></tr>
  </tbody>
</table>
      <canvas id="breakeven-chart" width="900" height="320"
  aria-label="Package comparison chart"
  aria-describedby="chart-desc"><div id="best-stamp" aria-hidden="true">Best value</div></canvas>
          <div class="chart-help">
            <strong>üí° How to read:</strong> Blue bar = your actual drinking cost per day (including 18% gratuity). 
            Gray bars = what you'd pay for each package. <strong>Lower = better value.</strong>
            Hover over bars to see exact dollar amounts.
          </div>
        </div>
       

        <!-- FIXED: Per-category summary -->
        <div class="category-summary" id="category-breakdown" hidden>
          <h4>üí∞ Where Your Money Goes (per day)</h4>
          <div class="category-grid" id="category-grid"></div>
        </div>

        <div class="controls-inline" style="margin-top:16px">
          <button class="btn" type="button" onclick="window.print()">Print Results</button>
          <button class="btn ghost" type="button" onclick="shareScenario()">Share</button>
          <button class="btn" type="button" onclick="resetAll()" style="background:var(--bad)">Reset</button>
        </div>
      </div>
    </section>

    <!-- FIXED: Group Breakdown -->
    <section class="card" id="group-breakdown" hidden>
      <h2 style="margin:0 0 1rem 0;color:var(--sea)">Group Breakdown (Per Person)</h2>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;min-width:500px">
          <thead style="text-align:left;border-bottom:2px solid var(--rope)">
            <tr><th style="padding:8px">Traveler</th><th>Package</th><th>Daily Cost</th><th>Trip Total</th></tr>
          </thead>
          <tbody id="group-table-body"></tbody>
        </table>
      </div>
    </section>

    <section class="card small" style="background:var(--foam);border-color:var(--rope)">
      <p><strong>Stewardship:</strong> This calculator helps you plan wisely‚Äînot encourage excess. Packages include far more than alcohol. Hydrate, pace yourself, look after your crew. <em>Moderation honors wallet, body, and spirit.</em></p>
      <p class="tiny" style="margin-top:.75rem"><strong>Pricing:</strong> Estimates based on recent community data. Actual prices vary by ship/itinerary. Always verify in Cruise Planner. Not financial advice.</p>
    </section>
  </section>

  <aside class="rail">
    <section class="card">
      <div class="author-card">
        <picture>
          <source type="image/webp" srcset="/authors/img/ken1.webp">
          <img class="author-avatar" src="/authors/img/ken1.jpg" alt="Ken Baker" onerror="this.src='/assets/logo_wake.png'">
        </picture>
        <div>
          <strong><a href="/authors/ken-baker.html">Ken Baker</a></strong><br>
          <span class="tiny">Founder of In the Wake; calculator builder and data steward.</span>
        </div>
      </div>
      
      <!-- STRATEGIC: Planning Pass CTA -->
      <div class="pass-cta small" style="margin-top:1rem;padding-top:1rem;border-top:2px solid var(--rope)">
        <strong style="color:var(--sea);display:block;margin-bottom:.5rem">Get your free Cruise Planning Pass</strong>
        <ul style="margin:0;padding-left:1.1rem;line-height:1.6">
          <li><a href="https://flickersofmajesty.com" target="_blank" rel="noopener">Photo tips & galleries</a></li>
          <li><a href="https://ken-baker.com" target="_blank" rel="noopener">Planning checklists & resources</a></li>
        </ul>
      </div>
    </section>

    <section class="card" style="background:var(--foam);border-color:var(--rope)">
      <h3 style="margin-top:0">Get Our Free Cruise Checklist!</h3>
      <p class="small">Join for exclusive tips and instant PDF</p>
      <form id="email-form" method="POST" style="margin-top:10px">
        <input type="text" name="b_email" tabindex="-1" style="position:absolute;left:-9999px" aria-hidden="true">
        <div style="display:flex;gap:6px">
          <input type="email" name="EMAIL" placeholder="your@email.com" required autocomplete="email" inputmode="email" style="flex:1;padding:8px;border:1px solid var(--bd);border-radius:6px;font-size:16px">
          <button type="submit" class="btn">Get List</button>
        </div>
        <label class="small" style="display:flex;gap:.5rem;margin-top:.75rem">
          <input type="checkbox" name="OPT_IN" required>
          <span>I agree. <a href="/privacy.html">Privacy</a> | <a href="/gdpr-rights.html">Rights</a></span>
        </label>
        <label class="small" style="display:flex;gap:.5rem;margin-top:.5rem">
          <input type="checkbox" name="PLANNING_PASS_OPT_IN" value="1">
          <span><strong>Bonus:</strong> Also join the <em>Planning Pass</em> for photo tips from Flickers of Majesty.</span>
        </label>
        <input type="hidden" name="SAVINGS" id="email-savings">
        <input type="hidden" name="REC" id="email-rec">
        <div id="signup-message" class="small" style="margin-top:6px;font-weight:700"></div>
      </form>
    </section>

    <!-- FIXED: Packages rail with inclusions -->
    <section class="card">
      <h3 style="margin-top:0">Packages</h3>
      <div id="packages" style="margin-top:10px">
        <!-- Fallback if app doesn't populate -->
        <div class="package-card">
          <h4>ü•§ Soda Package</h4>
          <div class="package-price">~$15/day</div>
          <ul class="package-inclusions">
            <li>Coca-Cola Freestyle sodas</li>
            <li>Juices & lemonade</li>
            <li>Refillable cup</li>
          </ul>
        </div>
        <div class="package-card">
          <h4>üßÉ Refreshment Package</h4>
          <div class="package-price">~$38/day</div>
          <ul class="package-inclusions">
            <li>Everything in Soda</li>
            <li>Specialty coffees & teas</li>
            <li>Fresh juices & smoothies</li>
            <li>Bottled water</li>
            <li>Milkshakes & mocktails</li>
          </ul>
        </div>
        <div class="package-card">
          <h4>üçπ Deluxe Beverage Package</h4>
          <div class="package-price">~$88/day</div>
          <ul class="package-inclusions">
            <li>Everything in Refreshment</li>
            <li>Beer, wine, cocktails (up to $15)</li>
            <li>Premium spirits</li>
            <li>Bottles of wine up to $100</li>
            <li>15 drink limit per day</li>
          </ul>
        </div>
      </div>
      <p class="tiny muted" style="margin-top:10px">Prices vary. Check Cruise Planner for your sailing.</p>
    </section>

    <section class="card">
      <h3 class="tiny" style="margin:0 0 .5rem;color:var(--sea)">Recent Articles</h3>
      <div id="recent-rail" class="rail-list">
        <p class="tiny muted">Loading...</p>
      </div>
    </section>
  </aside>
</main>

<footer class="wrap" style="border-top:2px solid var(--bd);padding-top:1.5rem;text-align:center">
  <p>¬© <span id="year">2025</span> In the Wake. All rights reserved.</p>
  <p class="tiny" style="margin-top:.75rem"><a href="/terms.html">Terms</a> | <a href="/privacy.html">Privacy</a> | <a href="/gdpr-rights.html">GDPR</a></p>
</footer>

<script>
// LEAN QUIZ SYSTEM v2.0 - WITH CASCADE, VOUCHER LOCK, FOCUS TRAP, ESC CLOSE
(function(){
'use strict';

const QUIZ_CONFIG={storageKey:'itw_quiz_v2',expiryDays:90};
const QUIZ_QUESTIONS=[
  {
    id:'vibe',type:'radio',
    q:'What best describes your cruise style?',
    icon:'üé≠',
    opts:[
      {v:'chill',l:'Chill & Relaxed',d:'Mostly non-alc, 1-2 drinks/day',e:'üßò'},
      {v:'balanced',l:'Balanced & Social',d:'Mix of everything, 3-5/day',e:'ü•Ç'},
      {v:'lively',l:'Lively Celebration',d:'Living it up, 6+/day',e:'üéâ'}
    ],
    impact:a=>({drinks:{},profile:a,mult:a==='lively'?1.4:a==='chill'?.65:1})
  },
  {
    id:'coffee',type:'radio',q:'Morning caffeine?',icon:'‚òï',
    opts:[
      {v:'none',l:'Skip it',e:'üö´'},
      {v:'basic',l:'Basic coffee',e:'‚òï'},
      {v:'fancy',l:'Specialty lattes/teas',e:'üçµ'},
      {v:'multi',l:'Multiple per day',e:'‚ö°'}
    ],
    impact:a=>({drinks:{coffee:a==='multi'?3:a==='fancy'?2:a==='basic'?1:0,teaprem:a==='fancy'||a==='multi'?1:0}})
  },
  {
    id:'nonalc',type:'radio',q:'Soft drinks (soda, juice)?',icon:'ü•§',
    opts:[
      {v:'none',l:'Rarely',e:'üíß'},
      {v:'some',l:'1-2/day',e:'ü•§'},
      {v:'reg',l:'3-4/day',e:'üßÉ'},
      {v:'lots',l:'All day',e:'ü•§'}
    ],
    impact:a=>({drinks:{soda:a==='lots'?4:a==='reg'?3:a==='some'?1.5:.5,freshjuice:a==='reg'||a==='lots'?1:0}})
  },
  {
    id:'alc',type:'multi',q:'Alcoholic drinks you enjoy?',icon:'üç∑',
    opts:[
      {v:'none',l:'None/Rarely',e:'üö´'},
      {v:'beer',l:'Beer',e:'üç∫'},
      {v:'wine',l:'Wine',e:'üç∑'},
      {v:'cocktail',l:'Cocktails',e:'üçπ'},
      {v:'spirits',l:'Spirits',e:'ü•É'}
    ],
    impact:ans=>{
      const has=v=>ans.includes(v);
      return{drinks:{beer:has('beer')?1.5:0,wine:has('wine')?1.5:0,cocktail:has('cocktail')?1.5:0,spirits:has('spirits')?1:0},alcScore:has('none')?'none':ans.length>2?'high':'mod'};
    }
  },
  {
    id:'group',type:'radio',q:'Who\'s cruising?',icon:'üë•',
    opts:[
      {v:'solo',l:'Solo',e:'üß≥'},
      {v:'couple',l:'Couple',e:'üíë'},
      {v:'family',l:'Family (kids)',e:'üë®‚Äçüë©‚Äçüëß'},
      {v:'friends',l:'Friends',e:'üëØ'}
    ],
    cascade:true,
    impact:a=>({adults:a==='solo'?1:a==='couple'?2:a==='family'?2:3,minors:a==='family'?2:0,groupType:a})
  },
  {
    id:'crown',type:'radio',q:'Crown & Anchor status?',icon:'üëë',
    showIf:ans=>ans.group!=='solo',
    opts:[
      {v:'none',l:'Not Diamond+',e:'‚öì'},
      {v:'diamond',l:'Diamond (4 vouchers)',e:'üíé'},
      {v:'diamondplus',l:'Diamond+ (5)',e:'üíé'},
      {v:'pinnacle',l:'Pinnacle (5)',e:'üëë'}
    ],
    impact:a=>{
      if(a==='none')return{};
      const cnt=a==='diamond'?4:5;
      return{vouchers:{level:a,count:cnt,adultD:a==='diamond'?1:0,adultDP:a==='diamondplus'?1:0,adultP:a==='pinnacle'?1:0}};
    }
  }
];

let state={idx:0,ans:{},start:Date.now()};

// ------- Focus trap helpers -------
let lastFocus=null;
function getFocusable(){
  const m=document.getElementById('quiz-modal');
  return [...m.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')]
    .filter(el=>!el.hasAttribute('disabled') && el.offsetParent !== null);
}
function trapKeydown(e){
  const modal=document.getElementById('quiz-modal');
  if(!modal.classList.contains('show')) return;
  const f=getFocusable();
  if(!f.length) return;
  const first=f[0], last=f[f.length-1];

  if(e.key==='Tab'){
    if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
  }else if(e.key==='Escape'){
    // Close on Esc
    modal.classList.remove('show');
    document.removeEventListener('keydown',trapKeydown,true);
    if(lastFocus) lastFocus.focus();
  }
}

// ------- Init / show / render -------
function init(){
  const saved=load();
  if(saved&&!expired(saved)){
    applyProfile(saved);
    return;
  }
  const visited=localStorage.getItem('calc_visited');
  if(!visited){
    localStorage.setItem('calc_visited','1');
    show();
  }
}

function show(){
  state={idx:0,ans:{},start:Date.now()};
  const modal=document.getElementById('quiz-modal');
  lastFocus=document.activeElement;
  modal.classList.add('show');
  document.addEventListener('keydown',trapKeydown,true);
  render();
  // Move focus into modal
  (document.getElementById('quiz-next') || document.getElementById('quiz-title')).focus();
}

function render(){
  const q=QUIZ_QUESTIONS[state.idx];
  if(!q){finish();return;}
  if(q.showIf&&!q.showIf(state.ans)){ state.idx++; render(); return; }

  const prog=(state.idx+1)/QUIZ_QUESTIONS.length*100;
  document.getElementById('quiz-progress-bar').style.width=prog+'%';

  let html=`<div class="quiz-question"><h3>${q.icon} ${q.q}</h3><div class="quiz-options">`;
  if(q.type==='radio'){
    q.opts.forEach(o=>{
      const sel=state.ans[q.id]===o.v;
      html+=`<div class="quiz-option${sel?' selected':''}" data-q="${q.id}" data-v="${o.v}">
        <div class="quiz-option-label">
          <div class="quiz-option-icon">${o.e||''}</div>
          <div><div>${o.l}</div>${o.d?`<div class="quiz-option-desc">${o.d}</div>`:''}</div>
        </div></div>`;
    });
  }else{
    q.opts.forEach(o=>{
      const sel=(state.ans[q.id]||[]).includes(o.v);
      html+=`<div class="quiz-option${sel?' selected':''}" data-q="${q.id}" data-v="${o.v}" data-multi="1">
        <div class="quiz-option-label"><div class="quiz-option-icon">${o.e||''}</div><div>${o.l}</div></div>
      </div>`;
    });
  }
  html+='</div></div>';
  document.getElementById('quiz-content').innerHTML=html;

  document.querySelectorAll('.quiz-option').forEach(el=>{ el.onclick=()=>select(el); });

  document.getElementById('quiz-back').style.display=state.idx>0?'':'none';
  document.getElementById('quiz-next').disabled=!state.ans[q.id];
  document.getElementById('quiz-next').textContent=state.idx===QUIZ_QUESTIONS.length-1?'Finish ‚ú®':'Next ‚Üí';
}

// ------- Select / nav -------
function select(el){
  const q=el.dataset.q, v=el.dataset.v, multi=el.dataset.multi;
  if(multi){
    if(!state.ans[q])state.ans[q]=[];
    if(v==='none'){
      state.ans[q]=['none'];
      el.parentElement.querySelectorAll('.quiz-option').forEach(o=>o.classList.remove('selected'));
      el.classList.add('selected');
    }else{
      state.ans[q]=state.ans[q].filter(x=>x!=='none');
      if(state.ans[q].includes(v)){ state.ans[q]=state.ans[q].filter(x=>x!==v); el.classList.remove('selected'); }
      else{ state.ans[q].push(v); el.classList.add('selected'); }
    }
  }else{
    state.ans[q]=v;
    el.parentElement.querySelectorAll('.quiz-option').forEach(o=>o.classList.remove('selected'));
    el.classList.add('selected');
    setTimeout(()=>{ if(state.idx<QUIZ_QUESTIONS.length-1) next(); },300);
  }
  document.getElementById('quiz-next').disabled=!state.ans[q]||state.ans[q].length===0;
}
function next(){ state.idx++; render(); }
function back(){ state.idx--; render(); }

// ------- Finish / compute -------
function finish(){
  const profile=calc(state.ans);
  save(profile);
  applyProfile(profile);
  const modal=document.getElementById('quiz-modal');
  modal.classList.remove('show');
  document.removeEventListener('keydown',trapKeydown,true);
  if(lastFocus) lastFocus.focus();
}

function calc(ans){
  let drinks={}, meta={};
  QUIZ_QUESTIONS.forEach(q=>{
    const a=ans[q.id]; if(!a)return;
    const imp=q.impact(a);
    if(imp.drinks){ Object.keys(imp.drinks).forEach(k=>{ drinks[k]=(drinks[k]||0)+imp.drinks[k]; }); }
    Object.assign(meta,imp);
  });
  const mult=meta.mult||1;
  Object.keys(drinks).forEach(k=>{drinks[k]=Math.round(drinks[k]*mult*10)/10;});
  return{ v:'2.0', ts:Date.now(), dur:Date.now()-state.start, profile:meta.profile||'balanced',
          drinks, adults:meta.adults||1, minors:meta.minors||0, vouchers:meta.vouchers||null, answers:ans };
}

// ------- Storage / public -------
function applyProfile(p){
  const get=id=>document.getElementById(id);
  if(!get('input-days')){console.error('Calculator inputs not found');return;}
  get('input-adults').value=p.adults||1;
  get('input-minors').value=p.minors||0;
  Object.entries(p.drinks||{}).forEach(([k,v])=>{
    const inp=document.querySelector(`[data-input="${k}"]`); if(inp) inp.value=v;
  });
  if(p.vouchers){
    const cna=get('cna-vouchers');
    if(cna){
      cna.open=true;
      if(p.vouchers.adultD)get('v-adult-d').value=p.vouchers.adultD;
      if(p.vouchers.adultDP)get('v-adult-dp').value=p.vouchers.adultDP;
      if(p.vouchers.adultP)get('v-adult-p').value=p.vouchers.adultP;
    }
  }
  if(window.scheduleCalc)window.scheduleCalc();
  if(window.announce)window.announce(`‚ú® ${p.profile} profile loaded!`);
}
function save(p){ try{localStorage.setItem(QUIZ_CONFIG.storageKey,JSON.stringify(p));}catch(e){} }
function load(){ try{return JSON.parse(localStorage.getItem(QUIZ_CONFIG.storageKey));}catch(e){return null;} }
function expired(p){ if(!p||!p.ts)return true; return Date.now()-p.ts>QUIZ_CONFIG.expiryDays*86400000; }
function skip(){
  localStorage.setItem(QUIZ_CONFIG.storageKey,JSON.stringify({skipped:true,ts:Date.now()}));
  const modal=document.getElementById('quiz-modal');
  modal.classList.remove('show');
  document.removeEventListener('keydown',trapKeydown,true);
  if(lastFocus) lastFocus.focus();
}

// Buttons
document.getElementById('quiz-next').onclick=next;
document.getElementById('quiz-back').onclick=back;

// Public API
window.quizStart=show;
window.quizSkip=skip;
window.quizReset=()=>{localStorage.removeItem(QUIZ_CONFIG.storageKey);location.reload();};

// Auto-init
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',init); }
else{ init(); }

})();
</script>
  <script>
(function authorRailImageOverride(){
  const rail = document.getElementById('recent-rail');
  if(!rail) return;
  const HEADS = {
    "Tina": { webp: "/authors/img/tina1.webp",  jpg: "/authors/img/tina1.jpg", alt: "Author ‚Äî Tina" },
    "Ken":  { webp: "/authors/img/ken1.webp",   jpg: "/authors/img/ken1.jpg",  alt: "Author ‚Äî Ken Baker" }
  };
  function apply(){
    const cards = rail.querySelectorAll('a, article, .card, .rail-item');
    cards.forEach(card=>{
      const txt = (card.textContent || "");
      const m = txt.match(/By\s+([A-Za-z]+)/i);
      const name = m && m[1] ? m[1] : null;
      const head = name && HEADS[name] ? HEADS[name] : null;
      if(!head) return;
      const img = card.querySelector('img');
      if(!img) return;
      img.src = head.jpg;
      if (head.webp) img.srcset = head.webp + " 1x";
      img.alt = head.alt;
      img.width = img.width || 44;
      img.height = img.height || 44;
      img.style.borderRadius = '12px';
      img.style.objectFit = 'cover';
      img.style.objectPosition = 'center';
    });
  }
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(apply, 350);
  } else {
    window.addEventListener('DOMContentLoaded', ()=> setTimeout(apply, 350));
  }
})();
</script>
  <script>
(function(){
  function fillTelemetry(){
    try{
      const f = document.getElementById('email-form'); 
      if(!f) return;

      // --- dynamic tags: Planning Pass
      const pass = f.querySelector('input[name="PLANNING_PASS_OPT_IN"]');
      // Dedupe any previous dynamic tag
      f.querySelectorAll('input[name="tags[]"][value="planning-pass"]').forEach(n=>n.remove());
      if(pass && pass.checked){
        const tag = document.createElement('input');
        tag.type = 'hidden';
        tag.name = 'tags[]';
        tag.value = 'planning-pass';
        f.appendChild(tag);
      }

      // --- telemetry fields (best-effort, won‚Äôt throw)
      const byId = id => document.getElementById(id);
      const recEl = byId('email-rec');
      const savEl = byId('email-savings');

      // read from global app state if present
      const best = (window.ITW && window.ITW.best) || (window.ITW_BEST);
      const inputs = (window.ITW && window.ITW.inputs) || null;

      if (recEl) {
        recEl.value = (best && best.name) ? String(best.name) : '';
      }
      if (savEl) {
        const delta = (best && typeof best.delta === 'number') ? best.delta : '';
        savEl.value = String(delta);
      }

      // include days + URL if present
      let daysVal = '';
      const daysInput = document.querySelector('[data-input="days"]');
      if (inputs && inputs.days) daysVal = String(inputs.days);
      else if (daysInput) daysVal = String(daysInput.value || '');

      let urlField = f.querySelector('input[name="CALC_URL"]');
      if (!urlField) {
        urlField = document.createElement('input');
        urlField.type = 'hidden';
        urlField.name = 'CALC_URL';
        f.appendChild(urlField);
      }
      urlField.value = location.href;

      let daysField = f.querySelector('input[name="CRUISE_DAYS"]');
      if (!daysField) {
        daysField = document.createElement('input');
        daysField.type = 'hidden';
        daysField.name = 'CRUISE_DAYS';
        f.appendChild(daysField);
      }
      daysField.value = daysVal;

    }catch(e){
      console.error('Email telemetry failed:', e);
    }
  }

  const form = document.getElementById('email-form');
  if(form){
    form.addEventListener('submit', fillTelemetry, {capture: true});
  }
})();
</script>
  <script>
// Safety shims so buttons never error if app.js wiring changes
(function(){
  if (typeof window.shareScenario !== 'function') {
    window.shareScenario = function(){
      try {
        if (typeof window.syncURL === 'function') window.syncURL();
        const url = location.href;
        if (navigator.share) {
          navigator.share({ title: document.title, url }).catch(()=>{});
        } else if (navigator.clipboard) {
          navigator.clipboard.writeText(url);
          const msg = document.getElementById('signup-message');
          if (msg) { msg.textContent = '‚úÖ Link copied!'; setTimeout(()=>msg.textContent='', 2000); }
        } else {
          alert('Share not supported; copy the URL from your browser.');
        }
      } catch(e) { console.error('shareScenario fallback failed:', e); }
    };
  }

  if (typeof window.resetAll !== 'function') {
    window.resetAll = function(){
      try {
        // Prefer the app.js reset if present
        if (typeof window.resetInputs === 'function') return window.resetInputs();
        // Fallback: soft reload this page path (clears local state)
        location.href = location.pathname;
      } catch(e) {
        location.href = location.pathname;
      }
    };
  }
})();
</script>
  <script>
(function(){
  const nav=document.querySelector('.itw-nav'); if(!nav) return;
  const items=[...nav.querySelectorAll('.nav-item')].filter(
    g => g.querySelector('button[aria-haspopup="menu"]')
  );

  function setOpen(g,on){
    g.classList.toggle('open',on);
    const b=g.querySelector('button');
    if(b) b.setAttribute('aria-expanded', on ? 'true' : 'false');
  }
  function closeAll(except){ items.forEach(g=>{ if(g!==except) setOpen(g,false); }); }

  items.forEach(g=>{
    const btn=g.querySelector('button'), menu=g.querySelector('.menu'); if(!btn||!menu) return;

    // Toggle on click
    btn.onclick=e=>{
      e.preventDefault(); e.stopPropagation();
      const open=g.classList.contains('open');
      closeAll(g);
      setOpen(g,!open);
      if(!open){
        // focus first link for keyboard users
        const firstLink=menu.querySelector('a,button,[tabindex]:not([tabindex="-1"])');
        if(firstLink) firstLink.focus();
      }
    };

    // Close when a menu link is activated
    menu.onclick=e=>{ if(e.target.closest('a')) closeAll(); };

    // Close with Escape when focus is on the button
    btn.onkeydown=e=>{ if(e.key==='Escape'){ setOpen(g,false); btn.focus(); } };

    // Close with Escape when focus is inside the menu
    menu.onkeydown=e=>{
      if(e.key==='Escape'){
        setOpen(g,false);
        btn.focus();
      }
    };

    // Close when focus leaves the nav-item
    menu.addEventListener('focusout',()=>{
      setTimeout(()=>{ if(!g.contains(document.activeElement)) setOpen(g,false); },0);
    });
  });

  // Click outside closes any open menu
  document.addEventListener('click', e=>{ if(!e.target.closest('.itw-nav')) closeAll(); });
})();
</script>
  <script>
(function top20CoverOverride(){
  const rail = document.getElementById('recent-rail');
  if(!rail) return;

  const TITLE_MATCH = /Top\s*20/i; // adjust to your exact title if needed
  const OVERRIDE = {
    webp: "/assets/covers/top-20.webp",
    jpg:  "/assets/covers/top-20.jpg",
    alt:  "Top 20 Royal Caribbean Picks"
  };

  function apply(){
    const cards = rail.querySelectorAll('a, article, .card, .rail-item');
    cards.forEach(card=>{
      const titleEl = card.querySelector('h3, h4, .title, .post-title, strong, b');
      const title = (titleEl?.textContent || card.textContent || "").trim();
      if (!TITLE_MATCH.test(title)) return;
      const img = card.querySelector('img');
      if (!img) return;
      img.src = OVERRIDE.jpg;
      img.srcset = OVERRIDE.webp ? (OVERRIDE.webp + " 1x") : "";
      img.alt = OVERRIDE.alt;
      img.width = img.width || 320;
      img.height = img.height || 180;
      img.style.objectFit = 'cover';
      img.style.borderRadius = '12px';
    });
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(apply, 400);
  } else {
    window.addEventListener('DOMContentLoaded', ()=> setTimeout(apply, 400));
  }
})();
</script>
  <script>
(function ensureCategoryBreakdownUpdates(){
  const grid = document.getElementById('category-grid');
  const section = document.getElementById('category-breakdown');
  if(!grid || !section) return;

  const updateEvt = new Event('itw:inputs-changed');
  // Broadcast on common user interactions as a fallback
  ['input','change'].forEach(t=>{
    document.addEventListener(t, e=>{
      if (e.target && e.target.matches('[data-input], [data-voucher], #voucher-value')) {
        document.dispatchEvent(updateEvt);
      }
    }, {capture:true});
  });
})();
</script>
  <script>
/* Chart sizing + AR fix */
(function(){
  const wrap = document.getElementById('breakeven-wrap');
  const cv   = document.getElementById('breakeven-chart');
  if (!wrap || !cv) return;

  // strip hard attrs that fight CSS sizing
  cv.removeAttribute('width'); 
  cv.removeAttribute('height');

  function tune(chart){
    try{
      chart.options.responsive = true;
      chart.options.maintainAspectRatio = false;
      chart.resize();
    }catch(_){}
  }

  function hook(){
    const c = (window.ITW && window.ITW.chart) || cv._chart || cv.__chartist || null;
    if (!c || !c.resize) return false;
    tune(c);
    return true;
  }

  // try now and a few times after app.js mounts
  if (!hook()){
    let tries = 0; const t = setInterval(()=>{ if (hook() || ++tries>20) clearInterval(t); }, 150);
  }

  new ResizeObserver(()=>hook()).observe(wrap);
})();
</script>
  <script>
/* Winner ring + badge */
(function(){
  const cv = document.getElementById('breakeven-chart');
  const badge = document.getElementById('best-stamp');
  if (!cv || !badge) return;

  const WINNER = { idx: null };

  const ringPlugin = {
    id: 'itwWinnerRing',
    afterDatasetsDraw(chart){
      if (WINNER.idx == null) return;
      // find an element for the winner index from any visible dataset
      let el = null;
      chart.data.datasets.some((ds, i)=>{
        const meta = chart.getDatasetMeta(i);
        const e = meta?.data?.[WINNER.idx];
        if (e){ el = e; return true; }
      });
      if (!el) return;

      const {x,y,width,height} = el.getProps(['x','y','width','height'], true);
      const ctx = chart.ctx;
      ctx.save();
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 4;
      ctx.setLineDash([6,4]);
      const pad = 6;
      ctx.strokeRect(x - width/2 - pad, y - height - pad, width + pad*2, height + pad*2);
      ctx.restore();
    }
  };

  function pickWinner(chart){
    // find smallest positive value across the four category indices
    const ds = chart.data.datasets || [];
    const N  = ds[0]?.data?.length || 0;
    let best = {idx:null, val:Infinity};

    for (let i=0;i<N;i++){
      let min = Infinity;
      ds.forEach(d=>{
        const v = (Array.isArray(d.data) && typeof d.data[i]==='number') ? d.data[i] : Infinity;
        if (v>0 && v<min) min = v;
      });
      if (min < best.val){ best = {idx:i, val:min}; }
    }

    WINNER.idx = best.idx;
    badge.style.display = (WINNER.idx==null) ? 'none' : '';
  }

  function hook(){
    const chart = (window.ITW && window.ITW.chart) || cv._chart || cv.__chartist || null;
    if (!chart || !chart.data) return false;
    chart.config.plugins = chart.config.plugins || [];
    if (!chart.config.plugins.includes(ringPlugin)) chart.config.plugins.push(ringPlugin);
    pickWinner(chart);
    chart.update();

    // re-evaluate on any app recalculation
    document.addEventListener('itw:calc-updated', ()=>{ try{ pickWinner(chart); chart.update(); }catch(_){}} );
    return true;
  }

  if (!hook()){
    let tries = 0; const t = setInterval(()=>{ if (hook() || ++tries>20) clearInterval(t); }, 150);
  }

  // ‚ÄúJump to Best‚Äù focus/scroll helper
  (function(){
    const btn = document.getElementById('jump-winner');
    if (!btn) return;
    btn.addEventListener('click', ()=>{
      document.getElementById('breakeven-wrap').scrollIntoView({behavior:'smooth', block:'center'});
    });
  })();
})();
</script>
  <script>
(function(){
  const rail = document.querySelector('aside.rail');
  if (!rail) return;
  const author = rail.querySelector('.author-card')?.closest('.card');
  if (author) rail.appendChild(author);
})();
</script>
  <script>
(function(){
  const form = document.getElementById('email-form');
  if(!form) return;
  const labels = [...form.querySelectorAll('label.small')];
  const agree = labels.find(l=>/I\s*agree/i.test(l.textContent||''));
  const bonus = labels.find(l=>/Bonus:/i.test(l.textContent||''));
  if(agree && bonus && agree.previousElementSibling !== bonus){
    agree.parentNode.insertBefore(bonus, agree); // bonus first, agree below it
  }
})();
</script>
</body>
</html>
