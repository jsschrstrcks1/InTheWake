<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Royal Caribbean Drink Package Calculator - In the Wake</title>
  
  <!-- 
    ‚úùÔ∏è Soli Deo Gloria - v11.1.0 P0-CRITICAL-FIXES
    
    CRITICAL FIXES:
    - Build-time static nonce (no runtime mutation)
    - strict-dynamic for child scripts
    - Service Worker integrity verification
    - Worker result validation
    - All inline styles moved to CSS
    
    BUILD-TIME PLACEHOLDER: BUILD_TIME_NONCE_PLACEHOLDER
    This gets replaced during your build process.
  -->
  
  <!-- FIXED CSP - Build-time nonce + strict-dynamic -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'nonce-BUILD_TIME_NONCE_PLACEHOLDER' 'strict-dynamic';
    worker-src 'self';
    style-src 'self';
    img-src 'self' data:;
    connect-src 'self' https://api.frankfurter.app;
    font-src 'self';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    report-to itw-csp;
    upgrade-insecure-requests;
  "/>
  
  <!-- Reporting API (optional but recommended) -->
  <meta http-equiv="Report-To" content='{"group":"itw-csp","max_age":10886400,"endpoints":[{"url":"https://cruisinginthewake.com/csp-report"}]}' />
  
  <meta name="description" content="Calculate if Royal Caribbean drink packages save you money. Honest, transparent calculator for cruise travelers.">
  <link rel="stylesheet" href="/assets/css/drink-calculator.css?v=11.1.0">
  <link rel="manifest" href="/manifest.webmanifest">
</head>
<body>
  <!-- App container -->
  <div id="app">
    <header>
      <h1>Royal Caribbean Drink Package Calculator</h1>
      <p>Find out if a drink package saves you money</p>
    </header>
    
    <main id="calculator-main">
      <!-- Calculator UI will be injected here by calculator.ui.js -->
      <div id="loading">
        <p>Loading calculator...</p>
      </div>
    </main>
    
    <footer>
      <p>‚úùÔ∏è Soli Deo Gloria | <a href="/privacy">Privacy</a> | <a href="/terms">Terms</a></p>
    </footer>
  </div>

  <!-- Security Lockdown Banner (hidden by default, shown on breach) -->
  <!-- NOW USES CSS CLASSES - NO INLINE STYLES -->
  <div id="itw-security-lockdown"></div>

  <!-- ==================== CONFIGURATION ==================== -->
  <script nonce="BUILD_TIME_NONCE_PLACEHOLDER">
    /**
     * Application Configuration
     * Version: 11.1.0 - P0 Critical Fixes
     * Soli Deo Gloria ‚úùÔ∏è
     * 
     * IMPORTANT: Hashes are injected at BUILD TIME
     * Run: node build-hashes.js before deployment
     */
    window.ITW_CFG = {
      version: '11.1.0',
      
      // Worker integrity (INJECTED AT BUILD TIME)
      worker: {
        expectedHash: 'BUILD_WORKER_HASH_PLACEHOLDER',
        url: '/assets/js/drink-worker.js?v=11.1.0'
      },
      
      // Service Worker integrity (INJECTED AT BUILD TIME)
      sw: {
        expectedHash: 'BUILD_SW_HASH_PLACEHOLDER',
        url: '/sw.js?v=11.1.0'
      },
      
      // Math module integrity (INJECTED AT BUILD TIME)
      math: {
        expectedHash: 'BUILD_MATH_HASH_PLACEHOLDER',
        url: '/assets/js/drink-math.js?v=11.1.0'
      },
      
      // Security settings
      security: {
        enableTelemetry: true,
        enableIntegrityChecks: true,
        enableAnomalyDetection: true,
        enableHoneypots: true,
        threatScoreThreshold: 100
      },
      
      // API endpoints
      api: {
        fxRates: 'https://api.frankfurter.app/latest?from=USD',
        dataset: '/assets/data/drink-prices.json?v=11.1.0'
      }
    };
    
    console.log('[Config] ‚úì ITW_CFG loaded v' + window.ITW_CFG.version);
  </script>

  <!-- ==================== UTILITY: parseQty ==================== -->
  <script nonce="BUILD_TIME_NONCE_PLACEHOLDER">
    /**
     * Parse user input to safe number
     * Handles ranges (2-4 -> 3), clamps to safe values
     * Soli Deo Gloria ‚úùÔ∏è
     */
    window.parseQty = function(val) {
      if (typeof val === 'number') {
        return Math.max(0, val);
      }
      
      const str = String(val || '').trim();
      
      // Length limit (P0 fix)
      if (str.length > 20) {
        return 0;
      }
      
      // Handle range (2-4)
      if (str.includes('-') && /^\d+\s*-\s*\d+$/.test(str)) {
        const parts = str.split('-').map(p => parseFloat(p.trim()));
        const min = Math.max(0, parts[0] || 0);
        const max = Math.max(min, parts[1] || 0);
        return (min + max) / 2;
      }
      
      // Parse number - ALLOW-LIST approach (only digits and dots)
      const cleaned = str.replace(/[^\d.]/g, '');
      const num = parseFloat(cleaned);
      
      return Number.isFinite(num) ? Math.max(0, num) : 0;
    };
    
    console.log('[Utils] ‚úì parseQty loaded');
  </script>

  <!-- ==================== HELPER: createScript ==================== -->
  <script nonce="BUILD_TIME_NONCE_PLACEHOLDER">
    /**
     * Helper to create scripts (no nonce needed with strict-dynamic)
     * strict-dynamic allows scripts created by nonced scripts
     */
    window.createScript = function(src, options = {}) {
      const script = document.createElement('script');
      script.src = src;
      script.defer = true;
      
      if (options.type) script.type = options.type;
      if (options.onload) script.onload = options.onload;
      if (options.onerror) script.onerror = options.onerror;
      
      return script;
    };
    
    console.log('[Utils] ‚úì createScript helper loaded');
  </script>

  <!-- ==================== LOAD SECURITY LAYER ==================== -->
  <script nonce="BUILD_TIME_NONCE_PLACEHOLDER">
    (function loadSecurityLayer() {
      const VER = window.ITW_CFG.version;
      
      // 1. Enhanced Security Module
      const security = window.createScript('/assets/js/security-enhanced-v11.js?v=' + VER);
      security.onload = function() {
        console.log('[Security] ‚úì Enhanced security loaded v' + VER);
        
        // 2. Worker Integrity Loader
        const workerLoader = window.createScript('/assets/js/worker-integrity-loader.js?v=' + VER);
        workerLoader.onload = function() {
          console.log('[WorkerLoader] ‚úì Integrity loader ready');
          
          // 3. Math Engine (ESM)
          const math = window.createScript('/assets/js/drink-math.js?v=' + VER);
          math.type = 'module';
          math.onload = function() {
            console.log('[Math] ‚úì Engine loaded v' + VER);
            
            // 4. Load Application Core
            loadApplicationCore();
          };
          document.head.appendChild(math);
        };
        document.head.appendChild(workerLoader);
      };
      document.head.appendChild(security);
    })();
  </script>

  <!-- ==================== APPLICATION CORE LOADER ==================== -->
  <script nonce="BUILD_TIME_NONCE_PLACEHOLDER">
    function loadApplicationCore() {
      const VER = window.ITW_CFG.version;
      
      // 1. App Core (creates store, loads worker with integrity check)
      const app = window.createScript('/assets/js/drink-calculator.app.js?v=' + VER);
      app.onload = function() {
        console.log('[App] ‚úì Core loaded v' + VER);
        
        // 2. Bridge (exports store API)
        const bridge = window.createScript('/assets/js/calculator.ui-bridge.js?v=' + VER);
        bridge.onload = function() {
          console.log('[Bridge] ‚úì API ready');
          
          // 3. UI Layer
          const ui = window.createScript('/assets/js/calculator.ui.js?v=' + VER);
          ui.onload = function() {
            console.log('[UI] ‚úì Loaded v' + VER);
            
            // 4. Editors (inline price editing)
            const editors = window.createScript('/assets/js/calculator.ui-editors.js?v=' + VER);
            editors.onload = function() {
              console.log('[Editors] ‚úì Ready');
              
              // 5. Install (PWA prompt)
              const install = window.createScript('/assets/js/install.js?v=' + VER);
              install.onload = function() {
                console.log('[Install] ‚úì PWA ready');
                console.log('[ITW] üöÄ Calculator ready - Soli Deo Gloria ‚úùÔ∏è');
              };
              document.head.appendChild(install);
            };
            document.head.appendChild(editors);
          };
          document.head.appendChild(ui);
        };
        document.head.appendChild(bridge);
      };
      document.head.appendChild(app);
    }
  </script>

  <!-- ==================== SERVICE WORKER REGISTRATION (WITH INTEGRITY) ==================== -->
  <script nonce="BUILD_TIME_NONCE_PLACEHOLDER">
    /**
     * P0 CRITICAL FIX: Service Worker Integrity Verification
     * 
     * Service Workers are network-level MitM - they can intercept ALL fetches.
     * We MUST verify integrity before registration.
     * 
     * Soli Deo Gloria ‚úùÔ∏è
     */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          console.log('[SW] Starting integrity verification...');
          
          const swURL = window.ITW_CFG.sw.url;
          const expectedHash = window.ITW_CFG.sw.expectedHash;
          
          // Check if hash is configured
          if (!expectedHash || expectedHash.includes('PLACEHOLDER')) {
            console.warn('[SW] ‚ö†Ô∏è No hash configured - skipping registration');
            console.warn('[SW] Run: node build-hashes.js to generate hash');
            return;
          }
          
          // Fetch Service Worker file
          const response = await fetch(swURL);
          if (!response.ok) {
            throw new Error('SW fetch failed: ' + response.status);
          }
          
          const swText = await response.text();
          
          // Compute SHA-256 hash
          const encoder = new TextEncoder();
          const data = encoder.encode(swText);
          const hashBuffer = await crypto.subtle.digest('SHA-256', data);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          const actualHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
          
          console.log('[SW] Expected hash:', expectedHash.substring(0, 16) + '...');
          console.log('[SW] Actual hash:  ', actualHash.substring(0, 16) + '...');
          
          // Verify integrity
          if (actualHash !== expectedHash) {
            console.error('[SW] ‚ùå INTEGRITY CHECK FAILED');
            console.error('[SW] Service Worker has been tampered with!');
            
            // Show banner to user (using CSS class)
            const banner = document.createElement('div');
            banner.className = 'itw-banner itw-banner--error';
            banner.textContent = '‚ö†Ô∏è Security error. Please refresh the page or contact support.';
            document.body.insertBefore(banner, document.body.firstChild);
            
            // Emit security event
            if (window.SecurityEvents) {
              window.SecurityEvents.emit('integrity_check_failed', {
                target: 'service_worker',
                expectedHash: expectedHash.substring(0, 16),
                actualHash: actualHash.substring(0, 16)
              });
            }
            
            // Trigger lockdown
            if (window.Security) {
              window.Security.lockdown('sw_integrity_failed');
            }
            
            return; // DO NOT REGISTER
          }
          
          console.log('[SW] ‚úì Integrity verified');
          
          // Register Service Worker
          const registration = await navigator.serviceWorker.register(swURL);
          console.log('[SW] ‚úì Registered:', registration.scope);
          
        } catch (err) {
          console.error('[SW] Registration failed:', err);
          
          // Show user-friendly error
          const banner = document.createElement('div');
          banner.className = 'itw-banner itw-banner--warning';
          banner.textContent = 'Offline features unavailable. Calculator will still work.';
          document.body.insertBefore(banner, document.body.firstChild);
          
          // Remove banner after 5 seconds
          setTimeout(() => banner.remove(), 5000);
        }
      });
    }
  </script>
</body>
</html>
