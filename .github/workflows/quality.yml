# Quality checks workflow for In The Wake
# Runs link checking, validation, and placeholder detection
name: Quality Checks

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Link checking with Lychee
  link-check:
    name: Check Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Link Checker (Lychee)
        uses: lycheeverse/lychee-action@v2.1.0
        with:
          args: >-
            --verbose
            --no-progress
            --accept 200,204,206,301,302,307,308
            --exclude-mail
            --exclude "^https://www.facebook.com"
            --exclude "^https://twitter.com"
            --exclude "^https://x.com"
            --exclude "^https://www.instagram.com"
            --exclude "localhost"
            --exclude "127.0.0.1"
            --timeout 30
            --max-concurrency 10
            './**/*.html'
          fail: false  # Don't fail workflow on broken links (report only)
          output: ./lychee-report.md
          version: v0.18.0  # Pin to stable version

      - name: Upload Link Check Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lychee-report
          path: ./lychee-report.md
          retention-days: 30

  # Check for Unknown placeholders
  placeholder-check:
    name: Check Placeholders
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Unknown placeholders
        run: |
          echo "üîç Checking for 'Unknown' placeholders in HTML files..."

          # Patterns that indicate incomplete content
          PATTERNS=(
            "Unknown ship"
            "Unknown photographer"
            "Cruise Line: Unknown"
            "Photo by: Unknown"
            "Attribution: Unknown"
            ">Unknown<"
          )

          FOUND_ISSUES=0

          for pattern in "${PATTERNS[@]}"; do
            echo ""
            echo "Checking for: $pattern"
            if grep -r --include="*.html" "$pattern" . 2>/dev/null; then
              echo "‚ö†Ô∏è  Found instances of: $pattern"
              FOUND_ISSUES=1
            else
              echo "‚úì No instances found"
            fi
          done

          echo ""
          if [ $FOUND_ISSUES -eq 1 ]; then
            echo "‚ö†Ô∏è  Warning: Found 'Unknown' placeholders that should be filled in"
            echo "These indicate incomplete content that needs attention."
            # Don't fail - just warn
          else
            echo "‚úì No placeholder issues found"
          fi

  # Validate changed HTML files
  validate-html:
    name: Validate HTML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check theological requirements
        run: |
          echo "üôè Checking theological requirements in HTML files..."

          ERRORS=0

          # Check for Soli Deo Gloria
          echo ""
          echo "Checking for 'Soli Deo Gloria' invocation..."
          HTML_COUNT=$(find . -name "*.html" -type f | wc -l)
          SDG_COUNT=$(grep -r --include="*.html" -l "Soli Deo Gloria" . 2>/dev/null | wc -l)

          echo "Found $SDG_COUNT / $HTML_COUNT HTML files with Soli Deo Gloria"

          if [ "$SDG_COUNT" -lt "$HTML_COUNT" ]; then
            MISSING=$((HTML_COUNT - SDG_COUNT))
            echo "‚ö†Ô∏è  $MISSING files missing Soli Deo Gloria invocation"
          fi

          # Check for ICP-Lite ai-summary
          echo ""
          echo "Checking for ICP-Lite ai-summary meta tags..."
          AI_SUMMARY_COUNT=$(grep -r --include="*.html" -l 'name="ai-summary"' . 2>/dev/null | wc -l)

          echo "Found $AI_SUMMARY_COUNT / $HTML_COUNT HTML files with ai-summary"

          echo ""
          echo "‚úì Theological check complete"

      - name: Check HTML structure
        run: |
          echo "üèóÔ∏è Checking HTML structure..."

          ERRORS=0

          # Check for DOCTYPE
          echo "Checking DOCTYPE declarations..."
          find . -name "*.html" -type f | while read file; do
            if ! grep -qi "<!doctype html>" "$file"; then
              echo "‚ö†Ô∏è  Missing DOCTYPE: $file"
            fi
          done

          # Check div balance (sample check on a few files)
          echo ""
          echo "Checking div tag balance (sampling)..."
          for file in $(find . -name "*.html" -type f | head -20); do
            OPEN=$(grep -o "<div" "$file" 2>/dev/null | wc -l || echo 0)
            CLOSE=$(grep -o "</div>" "$file" 2>/dev/null | wc -l || echo 0)
            if [ "$OPEN" -ne "$CLOSE" ]; then
              echo "‚ö†Ô∏è  Unbalanced divs in $file: $OPEN open, $CLOSE close"
              ERRORS=1
            fi
          done

          if [ $ERRORS -eq 0 ]; then
            echo "‚úì HTML structure checks passed"
          fi

  # Summary job
  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [link-check, placeholder-check, validate-html]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Link Check | ${{ needs.link-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Placeholder Check | ${{ needs.placeholder-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| HTML Validation | ${{ needs.validate-html.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job logs for details." >> $GITHUB_STEP_SUMMARY
