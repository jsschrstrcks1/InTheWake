<!doctype html>
<html lang="en">
<head>
  <!-- Soli Deo Gloria — offered as worship. v3.010.104 (drink-packages) -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="version" content="v3.010.104"/>
  <title>Drink Packages Calculator — In the Wake (v3.010.104)</title>
  <link rel="canonical" href="https://cruisinginthewake.com/drink-packages.html"/>

  <!-- ===== Inline CSS (scoped; no global stylesheet) ===== -->
  <style>
  :root{
    --sea:#0a3d62;--foam:#e6f4f8;--rope:#d9b382;--ink:#083041;--sky:#f7fdff;--accent:#0e6e8e;--good:#0b7a43;
    --muted:#5f6b72;--line:#d8e2e6;
    --shadow:0 2px 6px rgba(8,48,65,.08); --shadow-lg:0 10px 28px rgba(8,48,65,.14);
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;overflow-x:hidden;background:var(--sky);color:var(--ink)}
  html{scrollbar-gutter:stable both-edges}
  body{font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  img{max-width:100%;height:auto;display:block}
  a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:1100px;margin:0 auto;padding:20px 14px 36px}
  .tiny{font-size:.9rem;color:#456}.muted{opacity:.85}.center{text-align:center}
  .pill{display:inline-block;padding:.45rem .75rem;border:1px solid var(--rope);border-radius:999px;background:#fff;line-height:1.1}
  .card{background:#fff;border:2px solid var(--rope);border-radius:14px;padding:1rem;box-shadow:var(--shadow);position:relative;overflow:hidden}
  .card.soft{border-color:#ead8b6}
  .card::after{content:"";position:absolute;inset:0;margin:auto;width:min(60%,420px);height:min(60%,420px);
    background:url('/assets/anchor_watermark.png?v=3.010.070') center/contain no-repeat;opacity:.06;pointer-events:none}
  h1,h2,h3,h4{color:var(--sea);margin:.25rem 0 .5rem}

  /* ===== Header / Portal’d Unified Nav ===== */
  .hero-header{position:relative;border-bottom:6px double var(--rope);background:#eaf6f6}
  .navbar{max-width:1100px;margin:0 auto;display:flex;gap:.6rem;padding:.35rem .9rem .75rem;align-items:center;min-height:56px}
  .brand{display:flex;align-items:center;gap:.6rem}
  .brand img{height:40px;width:auto}
  .version-badge{font-size:.72rem;opacity:.8;margin-left:.35rem}
  .itw-nav{display:flex;gap:.5rem;flex:1;align-items:center;justify-content:center;white-space:nowrap}
  .itw-nav .nav-item{position:relative}
  .itw-nav .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.35rem .7rem;border-radius:10px;background:#fff;border:1px solid var(--rope);color:var(--accent);font-size:.95rem;cursor:pointer}
  .itw-nav .chip[aria-current="page"]{outline:3px dashed var(--rope);outline-offset:2px;box-shadow:0 0 0 3px rgba(200,163,106,.15) inset}
  .itw-nav .menu{position:absolute;left:0;top:100%;transform:translateY(.35rem);min-width:240px;max-width:min(90vw,360px);background:#fff;
    border:1px solid var(--rope);border-radius:12px;box-shadow:var(--shadow-lg);padding:.6rem;display:none;visibility:hidden;opacity:0;pointer-events:none;z-index:100;transition:opacity .18s ease}
  .itw-nav .nav-item.open>.menu{display:block;visibility:visible;opacity:1;pointer-events:auto}
  .itw-nav .menu .label{font-weight:600;color:#234;margin:.15rem .2rem .35rem;font-size:.9rem}
  .itw-nav .menu a{display:block;padding:.45rem .6rem;border-radius:.6rem;color:var(--ink)} .itw-nav .menu a:hover{background:#f2f7fa;text-decoration:none}

  /* ===== Hero ===== */
  .hero{position:relative;width:100%;min-height:clamp(200px,24vw,340px);
    background:url('/assets/index_hero.jpg?v=3.010.071') center 38%/cover no-repeat;display:flex;align-items:flex-end;overflow:hidden}
  .hero-title{position:absolute;left:min(3vw,1rem);bottom:clamp(.6rem,2vw,1.4rem);display:flex;flex-direction:column;gap:.35rem;text-shadow:0 2px 6px rgba(0,0,0,.45)}
  .hero-title .logo{width:clamp(189px,23.1vw,378px);max-width:min(90vw,520px);filter:drop-shadow(0 3px 8px rgba(0,0,0,.45))}
  .tagline{font-weight:700;letter-spacing:.2px;color:#e6f4f8;font-size:clamp(.9rem,1.5vw,1.35rem)}
  .hero-compass{position:absolute;right:min(3vw,1rem);top:.5rem;width:86px;opacity:.95;
    filter:invert(39%) sepia(9%) saturate(1063%) hue-rotate(151deg) brightness(92%) contrast(89%)}

  /* ===== Layout ===== */
  .grid{display:grid;gap:1.2rem}
  @media(min-width:1060px){.grid.twocol{grid-template-columns:minmax(0,1fr) 360px}}

  /* ===== Calculator specific ===== */
  .section-title{margin:.4rem 0 .35rem}
  .meta-line{font-size:.92rem;color:#456}
  .flex-row{display:flex;gap:.6rem;flex-wrap:wrap}
  .calc-wrap{display:grid;gap:1rem}
  .inputs-grid{display:grid;gap:1rem}
  @media(min-width:860px){.inputs-grid{grid-template-columns:1fr 1fr}}
  .mini-help{font-size:.86rem;color:#456;margin-top:.35rem}

  .beverage-card{position:relative}
  .beverage-row{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center;margin:.4rem 0}
  .beverage-price{font-size:.9rem;color:#456}
  .qty{width:5.5rem;padding:.45rem .55rem;border:1px solid var(--line);border-radius:10px;font:inherit;background:#fff}

  .packages-grid{display:grid;gap:1rem}
  @media(min-width:820px){.packages-grid{grid-template-columns:repeat(3,1fr)}}
  .pkg{position:relative}
  .pkg header{display:grid;grid-template-columns:1fr minmax(7.5ch,auto);align-items:start;gap:.5rem;margin-bottom:.25rem}
  .pkg .pkg-title{min-height:2.75em;display:flex;flex-direction:column;gap:.15rem}
  .pkg .price{white-space:nowrap;justify-self:end;font-weight:700}
  .pkg .ribbon{position:absolute;top:.65rem;right:-.4rem;transform:rotate(12deg);background:var(--good);color:#fff;padding:.25rem .6rem;border-radius:6px;font-size:.78rem;box-shadow:0 2px 6px rgba(0,0,0,.12);display:none}
  .pkg.highlight{outline:2.5px solid var(--good);outline-offset:3px}
  .pkg.highlight .ribbon{display:inline-block}
  .edit-btn{display:inline-block;margin-top:.45rem}

  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
  </style>
</head>

<body class="page">
  <a class="sr-only" href="#content">Skip to main content</a>

  <!-- ===== Header / Nav (portal’d) ===== -->
  <header class="hero-header" role="banner" style="padding-top:.15rem">
    <div class="navbar">
      <div class="brand">
        <img src="/assets/logo_wake.png?v=3.010.070" width="256" height="64" alt="In the Wake wordmark">
        <span class="tiny version-badge">v3.010.104</span>
      </div>

      <nav class="itw-nav" aria-label="Primary">
        <div class="nav-item"><a class="chip" href="/">Home</a></div>

        <div class="nav-item" aria-haspopup="menu">
          <button class="chip" type="button" aria-expanded="false" aria-haspopup="menu" aria-controls="menu-planning">
            Planning <span class="caret">▾</span>
          </button>
          <div id="menu-planning" class="menu" aria-label="Planning">
            <div class="label tiny">Plan your cruise</div>
            <a href="/planning.html">Planning (overview)</a>
            <a href="/ports.html">Ports</a>
            <a href="/restaurants.html">Restaurants &amp; Menus</a>
            <a href="/ships.html">Ships</a>
            <a href="/drink-packages.html" aria-current="page">Drink Packages</a>
            <a href="/cruise-lines.html">Cruise Lines</a>
            <a href="/packing-lists.html">Packing Lists</a>
            <a href="/accessibility.html">Accessibility</a>
          </div>
        </div>

        <div class="nav-item" aria-haspopup="menu">
          <button class="chip" type="button" aria-expanded="false" aria-haspopup="menu" aria-controls="menu-travel">
            Travel <span class="caret">▾</span>
          </button>
          <div id="menu-travel" class="menu" aria-label="Travel">
            <div class="label tiny">On the move</div>
            <a href="/travel.html">Travel (overview)</a>
            <a href="/solo.html">Solo</a>
          </div>
        </div>

        <div class="nav-item"><a class="chip" href="/about-us.html">About</a></div>
      </nav>
    </div>

    <div class="hero" role="img" aria-label="Ship wake at sunrise">
      <div class="hero-title">
        <img class="logo" src="/assets/logo_wake.png?v=3.010.070" width="256" height="64" alt="In the Wake">
        <div class="tagline">A Cruise Traveler’s Logbook</div>
      </div>
      <img class="hero-compass" src="/assets/compass_rose.svg?v=3.010.070" width="180" height="180" alt="" aria-hidden="true">
    </div>
  </header>

  <!-- Sharebar -->
  <div id="sharebar" class="wrap" aria-label="Share this page"></div>

  <!-- ===== Main ===== -->
  <main id="content" class="wrap grid twocol" role="main">
    <!-- LEFT: Calculator -->
    <section aria-labelledby="calc-title">
      <h1 id="calc-title" class="section-title">Beverage Calculator</h1>
      <p class="muted">Pick your daily drinks and we’ll compare à-la-carte vs. packages.</p>

      <!-- Line pills (future-proofed) -->
      <div class="flex-row" style="margin:.35rem 0 .6rem">
        <button id="pill-rccl" class="pill" data-src="/assets/data/lines/royal-caribbean.json" aria-current="true">Royal Caribbean</button>
      </div>

      <!-- Trip length + running totals (card) -->
      <div class="card soft" style="margin:.6rem 0 1rem">
        <div class="flex-row" style="align-items:center;gap:.9rem;flex-wrap:wrap">
          <label for="days"><strong>Trip length</strong></label>
          <input id="days" class="qty" type="number" inputmode="decimal" pattern="[0-9]*" min="1" step="1" value="7" aria-describedby="days-help">
          <div id="days-help" class="tiny muted">People often book 5–7 nights. Adjust as needed.</div>
        </div>
        <p id="totals" class="meta-line" style="margin:.6rem 0 0">Daily total (à la carte): $0.00 · Trip total: $0.00</p>
        <p id="totals-line" class="tiny muted" style="margin:.2rem 0 0">Tip: Override package prices to match the sale you see in your planner.</p>
      </div>

      <!-- Your picks (two column cards) -->
      <h2 class="section-title">Your Daily Picks</h2>
      <div class="inputs-grid">
        <div class="card beverage-card" id="inputs-col-a"></div>
        <div class="card beverage-card" id="inputs-col-b"></div>
      </div>

      <!-- Packages intro / combined instructions -->
      <h2 id="packages-title" class="section-title" style="margin-top:1rem">Beverage Packages</h2>
      <div id="packages-expl" class="tiny muted" style="margin:-.25rem 0 .6rem"></div>

      <!-- Packages -->
      <div class="packages-grid" id="package-cards"></div>
    </section>

    <!-- RIGHT RAIL -->
    <aside aria-labelledby="rr-title">
      <h2 id="rr-title" class="sr-only">Related</h2>

      <section class="card" aria-labelledby="read-title">
        <h3 id="read-title">Recommended Reading</h3>
        <ul class="tiny" style="list-style:none;padding:0;margin:.2rem 0 0">
          <li><a href="/articles/should-you-buy-the-deluxe-package.html" data-prefetch="hover">Should you buy the Deluxe package?</a></li>
          <li><a href="/articles/how-gratuities-work-on-drink-packages.html" data-prefetch="hover">How drink gratuities really work</a></li>
          <li><a href="/articles/mocktails-and-kids-soda-plans.html" data-prefetch="hover">Mocktails &amp; kids’ soda plans</a></li>
        </ul>
      </section>

      <section class="card" aria-labelledby="author-title">
        <h3 id="author-title">About the Author</h3>
        <article class="rail-item" role="article" style="display:flex;gap:.8rem;align-items:flex-start">
          <img src="/authors/img/ken1.jpg?v=3.010.070" width="96" height="96" alt="Ken Baker" style="border-radius:12px">
          <div>
            <h4 style="margin:.1rem 0 .25rem"><a href="/authors/ken-baker.html">Ken Baker</a></h4>
            <p class="tiny muted">Pastor, coder, cruiser. I test these tools so you don’t waste money onboard.</p>
            <p class="tiny"><a href="/solo.html">Solo</a> · <a href="/travel.html">Travel</a></p>
          </div>
        </article>
      </section>
    </aside>
  </main>

  <footer class="wrap" role="contentinfo">
    © 2025 In the Wake — <a href="/accessibility.html">Accessibility &amp; WCAG 2.1 AA Commitment</a>
    <p class="tiny center" style="margin-top:.5rem">Soli Deo Gloria.</p>
  </footer>

  <!-- ===== Minimal SW + hover prefetch hooks (safe/guarded) ===== -->
  <script>
  (function(){
    // Register service worker if present; avoid loops/panics.
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }
    // Hover/focus prefetch for rails via site-cache hook (if loaded elsewhere)
    (function(){
      const seed=(urls)=>{ try{ window.itwSeedSW && window.itwSeedSW(urls,'low'); }catch(_){ } };
      const seen=new Set();
      function onOver(e){
        const a=e.currentTarget, href=a.getAttribute('href'); if(!href||seen.has(href)) return;
        seen.add(href); seed([href]);
      }
      document.querySelectorAll('[data-prefetch="hover"]').forEach(a=>{
        a.addEventListener('mouseenter', onOver, {once:true, passive:true});
        a.addEventListener('focus', onOver, {once:true, passive:true});
      });
    })();
  })();
  </script>

  <!-- ===== Sharebar mount (your existing runtime) ===== -->
  <script src="/assets/js/sharebar.js?v=3.010.070" defer></script>
  <script>
    (function(){
      if(!document.getElementById('sharebar')) return;
      if(typeof window.initSharebar==='function'){ window.initSharebar('#sharebar'); }
      else{ window.addEventListener('load',()=>window.initSharebar&&window.initSharebar('#sharebar')); }
    })();
  </script>

  <!-- ===== Calculator Runtime ===== -->
  <script>
  (function(){
    "use strict";

    const PAGE_VERSION = document.querySelector('meta[name="version"]')?.content || 'v0';

    // ---- State ----
    const state = {
      days: 7,
      epsilon: 0.02, // tie within 2¢ → prefer more inclusive
      items: new Map(),   // id -> { meta, qtyPerDay }
      order: [],          // array of ids
      sets: { soda:new Set(), refresh:new Set(), alcohol:new Set() },
      packages: new Map(), // id -> { meta }
      lineId: '', lineTitle: ''
    };

    // ---- Elements ----
    const els = {
      colA: document.getElementById('inputs-col-a'),
      colB: document.getElementById('inputs-col-b'),
      packageHost: document.getElementById('package-cards'),
      packagesTitle: document.getElementById('packages-title'),
      packagesExpl: document.getElementById('packages-expl'),
      totals: document.getElementById('totals'),
      totalsLine: document.getElementById('totals-line'),
      days: document.getElementById('days'),
      pillRccl: document.getElementById('pill-rccl')
    };

    const fmt = n => {
      if (!Number.isFinite(n)) return '$—';
      const s = Math.abs(n).toFixed(2);
      return (n<0?'-':'') + '$' + s;
    };
    const getLS = (k,d)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch(_){ return d; } };
    const setLS = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } };

    function sanitizedHTML(str=''){
      const div=document.createElement('div'); div.innerHTML=str;
      div.querySelectorAll('script,style').forEach(n=>n.remove());
      return div.innerHTML;
    }

    // -------- Inputs UI (two cards) --------
    function renderInputs(){
      const left=[], right=[];
      state.order.forEach((id,idx)=>{
        const it = state.items.get(id);
        const priceNote = it.meta.free ? `<span class="tiny muted">(included · $0)</span>`
                                       : `<span class="beverage-price">avg ${fmt(it.meta.avgPrice)}</span>`;
        const row = `
          <div class="beverage-row">
            <label for="qty-${id}">${it.meta.name}<div class="tiny">${priceNote}</div></label>
            <input id="qty-${id}" class="qty" type="number" inputmode="decimal" pattern="[0-9]*" min="0" step="1"
                   value="${it.qtyPerDay||0}" data-item="${id}">
          </div>`;
        (idx%2===0?left:right).push(row);
      });
      els.colA.innerHTML = left.join('');
      els.colB.innerHTML = right.join('');
      document.querySelectorAll('.qty[data-item]').forEach(inp=>{
        // simple debounce
        let t; inp.addEventListener('input', ()=>{
          clearTimeout(t); t=setTimeout(()=>{
            const id=inp.dataset.item; const ent=state.items.get(id);
            const v = Number(inp.value); ent.qtyPerDay = Number.isFinite(v) && v>=0 ? Math.floor(v) : 0;
            computeAndRender();
          },120);
        });
      });
    }

    // -------- Packages UI --------
    function pkgPriceDisplay(pmeta){
      const key='pkgOverride:'+state.lineId+':'+pmeta.id;
      const ov=getLS(key,null);
      const base = Number(pmeta.price ?? pmeta.avg ?? pmeta.priceRange?.[0] ?? 0);
      return { value: ov!=null ? Number(ov) : base, overridden: ov!=null };
    }

    function renderPackages(view){
      const host = els.packageHost; host.innerHTML='';
      state.packages.forEach(p=>{
        const { value, overridden } = pkgPriceDisplay(p.meta);
        const includeVal = view.includedDaily[p.meta.id] ?? 0;
        const strategyCost = view[p.meta.id+'Daily'];
        const range = p.meta.priceRange ? ` (${fmt(p.meta.priceRange[0])}–${fmt(p.meta.priceRange[1])})` : '';

        const article = document.createElement('article');
        article.className = `pkg card ${view.bestIds.has(p.meta.id)?'highlight':''}`;
        article.innerHTML = `
          <span class="ribbon" role="status">Best value</span>
          <header>
            <div class="pkg-title">
              <strong>${p.meta.name}</strong>
              <span class="tiny muted">${range}</span>
            </div>
            <div class="price" data-price="${p.meta.id}">${fmt(value)}/day</div>
          </header>
          <div class="tiny" style="margin:.15rem 0 .5rem">
            Included value (your picks): <strong>${fmt(includeVal)}</strong> /day ·
            With this package you’d pay <strong>${strategyCost!=null?fmt(strategyCost):'—'}</strong> /day
          </div>
          <button class="pill edit-btn" data-ov="${p.meta.id}" type="button">${overridden?'Edit Price (overridden)':'Edit Price'}</button>
          ${Array.isArray(p.meta.description)&&p.meta.description.length
             ? `<ul class="tiny" style="margin:.5rem 0 0 1.25rem">${p.meta.description.map(d=>`<li>${d}</li>`).join('')}</ul>` : '' }
        `;
        host.appendChild(article);
      });

      host.querySelectorAll('button[data-ov]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.ov;
          const key='pkgOverride:'+state.lineId+':'+id;
          const pmeta = state.packages.get(id).meta;
          const suggested = getLS(key, null) ?? (Number(pmeta.price ?? pmeta.avg ?? 0));
          const v = prompt('Enter your package price per person per day (USD).', String(suggested));
          if (v==null) return;
          const num = Number(v); if (!Number.isFinite(num) || num<0) { alert('Please enter a valid non-negative number.'); return; }
          setLS(key, num); computeAndRender();
        });
      });
    }

    // -------- Compute --------
    function computeAndRender(){
      let dailyTotal=0, sodaSpend=0, refreshSpend=0, alcoholSpend=0;

      state.items.forEach((it,id)=>{
        const spend = (it.meta.avgPrice||0) * (it.qtyPerDay||0);
        dailyTotal += spend;
        if (state.sets.soda.has(id))    sodaSpend    += spend;
        if (state.sets.refresh.has(id)) refreshSpend += spend;
        if (state.sets.alcohol.has(id)) alcoholSpend += spend;
      });

      const days = Math.max(1, parseInt(els.days.value||'1',10)); state.days=days;
      els.totals.textContent = `Daily total (à la carte): ${fmt(dailyTotal)} · Trip total: ${fmt(dailyTotal*days)}`;
      els.totalsLine.textContent = `Tip: Override package prices to match the sale you see in your planner.`;

      const pkgVal = {};
      ['soda','refreshment','deluxe'].forEach(pid=>{
        const meta = state.packages.get(pid)?.meta;
        pkgVal[pid] = meta ? pkgPriceDisplay(meta).value : Infinity;
      });

      const noneDaily    = dailyTotal;
      const sodaDaily    = (pkgVal.soda ?? Infinity) + (dailyTotal - sodaSpend);
      const refreshDaily = (pkgVal.refreshment ?? Infinity) + alcoholSpend; // refresh covers non-alcohol set
      const deluxeDaily  = (pkgVal.deluxe ?? Infinity); // deluxe covers all

      const includedDaily = {
        soda: sodaSpend,
        refreshment: refreshSpend,
        deluxe: dailyTotal
      };

      const entries = [
        {id:'none', cost:noneDaily, rank:0},
        {id:'soda', cost:sodaDaily, rank:1},
        {id:'refreshment', cost:refreshDaily, rank:2},
        {id:'deluxe', cost:deluxeDaily, rank:3}
      ].sort((a,b)=>{
        if (Math.abs(a.cost-b.cost) <= state.epsilon) return b.rank - a.rank;
        return a.cost - b.cost;
      });
      const bestCost = entries[0].cost;
      const bestIds = new Set(entries.filter(e=>Math.abs(e.cost-bestCost) <= state.epsilon).map(e=>e.id));

      renderPackages({ noneDaily, sodaDaily, refreshDaily, deluxeDaily, includedDaily, bestIds });
    }

    function parseRange(s){
      if (!s || typeof s!=='string') return null;
      const m = s.match(/(\d+(?:\.\d+)?)\s*[-–]\s*(\d+(?:\.\d+)?)/);
      if (m){ const a=Number(m[1]), b=Number(m[2]); if (Number.isFinite(a)&&Number.isFinite(b)) return [Math.min(a,b), Math.max(a,b)]; }
      const single = Number(s); return Number.isFinite(single) ? [single,single] : null;
    }

    // -------- Dataset loader --------
    async function loadDataset(src){
      try{
        const r = await fetch(src + (src.includes('?')?'&':'?') + 'v=' + encodeURIComponent(PAGE_VERSION), { cache:'default', credentials:'omit' });
        if(!r.ok) throw new Error('Bad response');
        const data = await r.json();

        state.lineId   = data.lineId || data.line || 'unknown-line';
        state.lineTitle= data.text?.lineTitle || data.text?.line || 'Cruise Line';
        els.packagesTitle.textContent = data.text?.packagesTitle || (state.lineTitle + ' Beverage Packages');
        // Combined instructions — consistent with house style
        const defaultExpl = `
          <ul style="margin:.35rem 0 0 1.1rem">
            <li>Package prices already include gratuity.</li>
            <li>À-la-carte purchases add 18% gratuity automatically.</li>
            <li>Deluxe covers everything up to the menu cap (pay the difference above).</li>
          </ul>`;
        els.packagesExpl.innerHTML = sanitizedHTML(data.text?.packagesExplHtml || defaultExpl);

        if (typeof data.rules?.epsilon === 'number') state.epsilon = data.rules.epsilon;

        // Items
        state.items = new Map();
        (data.items||[]).forEach(it=>{
          state.items.set(it.id, {
            meta:{
              id:it.id, name:it.label||it.name||it.id,
              avgPrice:Number(it.price||it.avgPrice||0),
              free:!!it.free, notes:it.notes||''
            },
            qtyPerDay:0
          });
        });

        // Input order
        const paid=[], free=[];
        state.items.forEach((v,k)=> (v.meta.free?free:paid).push([k,v]));
        paid.sort((a,b)=> (b[1].meta.avgPrice - a[1].meta.avgPrice));
        free.sort((a,b)=> a[1].meta.name.localeCompare(b[1].meta.name));
        state.order = [...paid.map(x=>x[0]), ...free.map(x=>x[0])];

        // Sets (authoritative JSON with safe default for refreshment)
        const DEFAULT_REFRESH = ['soda','premium-coffee','premium-tea','fresh-juice','mocktail','bottled-water'];
        state.sets = {
          soda:    new Set(data.sets?.soda    || ['soda']),
          refresh: new Set(data.sets?.refresh || DEFAULT_REFRESH),
          alcohol: new Set(data.sets?.alcohol || [])
        };

        // Packages
        state.packages = new Map();
        const pkgObj = data.packages || {};
        Object.keys(pkgObj).forEach(k=>{
          const p = pkgObj[k];
          const pr = parseRange(p.range || p.price);
          const nameNorm =
            k==='soda'         ? (p.name || 'Classic Soda Package') :
            k==='refreshment'  ? (p.name || 'Refreshment Package') :
            k==='deluxe'       ? (p.name || 'Deluxe Beverage Package') :
                                 (p.name || k);
          state.packages.set(k, {
            meta:{
              id:k, name:nameNorm,
              price:Number(p.price ?? p.avg ?? 0),
              priceRange:pr,
              description: Array.isArray(p.includes) ? p.includes.slice() : []
            }
          });
        });

        renderInputs();
        computeAndRender();
      }catch(err){
        console.warn('Dataset load failed:', err?.message||err);
        els.packagesExpl.textContent = 'Could not load data. Try refreshing the page.';
      }
    }

    // Events
    els.days.addEventListener('input', ()=>{ computeAndRender(); });

    document.getElementById('pill-rccl').addEventListener('click', (e)=>{
      document.querySelectorAll('.pill').forEach(p=>p.setAttribute('aria-current','false'));
      e.currentTarget.setAttribute('aria-current','true');
      const src=e.currentTarget.getAttribute('data-src'); loadDataset(src);
    });

    // Boot
    loadDataset(els.pillRccl.getAttribute('data-src'));
  })();
  </script>

  <!-- Nav behavior (portal’d) -->
  <script>
  (function(){
    const root=document.querySelector('.itw-nav'); if(!root) return;
    const items=[...root.querySelectorAll('.nav-item[aria-haspopup]')];
    function setOpen(g,on){ g.classList.toggle('open',!!on); const b=g.querySelector('button[aria-controls]'); if(b) b.setAttribute('aria-expanded',on?'true':'false'); }
    function closeAll(ex){ items.forEach(g=>{ if(g!==ex) setOpen(g,false); }); }
    function firstFocusable(el){ return el && el.querySelector('a,button,[tabindex]:not([tabindex="-1"])'); }
    items.forEach(group=>{
      const btn=group.querySelector('button[aria-controls]'); const menu=group.querySelector('.menu'); if(!btn||!menu) return;
      btn.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); const open=group.classList.contains('open'); closeAll(group); setOpen(group,!open); if(!open){ (firstFocusable(menu)||btn).focus({preventScroll:true}); }});
      btn.addEventListener('keydown',(e)=>{ if(e.key==='ArrowDown'||e.key==='ArrowUp'){ e.preventDefault(); setOpen(group,true); (firstFocusable(menu)||btn).focus({preventScroll:true}); } else if(e.key==='Escape'){ setOpen(group,false); btn.focus({preventScroll:true}); }});
      group.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ setOpen(group,false); btn.focus({preventScroll:true}); }});
      menu.addEventListener('focusout',()=>{ setTimeout(()=>{ if(!group.contains(document.activeElement)) setOpen(group,false); },0); });
    });
    document.addEventListener('click',(e)=>{ if(!e.target.closest('.itw-nav')) closeAll(); });
    window.addEventListener('blur',()=> closeAll());
  })();
  </script>
</body>
</html>
