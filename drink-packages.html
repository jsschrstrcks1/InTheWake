<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Drink Packages Calculator • In the Wake</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --ink:#0a3d62; --muted:#5f6b72; --bg:#f7f9fa; --card:#ffffff; --line:#dfe7ea; --accent:#0e6e8e; --good:#0b7a43;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink); background:var(--bg);
    }
    header.wrap, main.wrap, footer.wrap{
      max-width:980px; margin:0 auto; padding:1rem 1rem 1.25rem;
    }
    header.wrap{ padding-top:1.25rem }
    h1{ margin:0 0 .35rem; font-size:clamp(1.25rem, 2.4vw, 1.75rem) }
    .muted{ color:var(--muted) }
    .tiny{ font-size:.88rem }
    .pill-row{ display:flex; gap:.5rem; flex-wrap:wrap; margin:.35rem 0 .75rem }
    .pill{
      border:1px solid var(--line); background:#fff; color:var(--ink);
      padding:.35rem .6rem; border-radius:999px; cursor:pointer; font-weight:600;
    }
    .pill[aria-current="true"]{ background:var(--accent); color:#fff; border-color:var(--accent) }
    .grid{
      display:grid; grid-template-columns:repeat(12, 1fr); gap:1rem; align-items:start;
    }
    .col-5{ grid-column:span 5 }
    .col-7{ grid-column:span 7 }
    @media (max-width:900px){ .col-5, .col-7{ grid-column:1 / -1 } }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:12px;
      padding:1rem; box-shadow:0 1px 2px rgba(10,61,98,0.04);
    }
    .calc-row{
      display:grid; grid-template-columns:1fr auto; gap:.5rem; align-items:center;
    }
    input[type="number"]{
      width:6rem; font:inherit; padding:.4rem .5rem; border-radius:8px;
      border:1px solid var(--line); background:#fff;
    }
    #beverage-inputs .card{ margin-bottom:.6rem }
    .price{ font-weight:700 }
    #package-cards{ display:grid; gap:.75rem }
    @media (min-width:720px){ #package-cards{ grid-template-columns:repeat(3, 1fr) } }
    article.pkg{ position:relative; overflow:hidden }
    .pkg .ribbon{
      position:absolute; top:.75rem; right:-.5rem; transform:rotate(12deg);
      background:var(--good); color:#fff; padding:.25rem .65rem; border-radius:6px;
      font-size:.8rem; box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
    .pkg.highlight{ outline:2px solid var(--good); }
    .pkg header{ display:flex; align-items:flex-start; justify-content:space-between; gap:.65rem; margin-bottom:.35rem }
    .pkg header .price{ white-space:nowrap }
    .pkg .body{ color:var(--ink) }
    .override{ margin-top:.35rem }
    button{
      background:#fff; border:1px solid var(--line); border-radius:999px; padding:.4rem .65rem;
      color:var(--ink); font-weight:600; cursor:pointer;
    }
    button.override{ border-color:var(--accent); color:var(--accent); }
    button.override:hover{ background:rgba(14,110,142,.06) }
    .hr{ height:1px; background:var(--line); margin:.75rem 0 }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  </style>
</head>
<body>
  <header class="wrap" role="banner">
    <h1>Beverage Calculator</h1>
    <p class="muted tiny">Pick your daily drinks and we’ll compare à-la-carte vs. packages.</p>

    <div class="pill-row">
      <button id="pill-rccl" class="pill" data-src="/assets/data/lines/royal-caribbean.json" aria-current="true">
        Royal Caribbean
      </button>
      <!-- Future lines can be added here as more JSONs land -->
    </div>

    <div class="calc-row" style="max-width:420px">
      <label for="days"><strong>Trip length</strong></label>
      <input id="days" type="number" inputmode="numeric" min="1" step="1" value="7" aria-describedby="days-help" />
    </div>
    <!-- You asked “where does this go?” — right here under the day selector: -->
    <div id="totals" class="tiny" aria-live="polite" style="margin-top:.35rem"></div>
    <div id="totals-line" class="tiny muted" aria-live="polite" style="margin-top:.15rem"></div>
  </header>

  <main class="wrap" role="main">
    <div class="grid">
      <section class="col-5">
        <h2 class="sr-only">Your picks</h2>
        <div id="beverage-inputs"></div>
      </section>

      <section class="col-7">
        <h2 id="packages-title">Beverage Packages</h2>
        <div class="tiny muted" id="packages-expl" style="margin:-.35rem 0 .5rem"></div>
        <div id="package-cards"></div>
      </section>
    </div>
  </main>

  <footer class="wrap muted tiny" role="contentinfo">
    © In the Wake — <a href="/accessibility.html">Accessibility</a>
  </footer>

  <script>
  (function(){
    "use strict";

    // --- App State ----------------------------------------------------------
    const state = {
      days: 7,
      epsilon: 0.02,            // tie threshold (can be overridden by dataset.rules.epsilon)
      items: new Map(),         // id -> { meta, qtyPerDay }
      order: [],                // input ordering
      sets: { soda: new Set(), refresh: new Set(), alcohol: new Set() },
      packages: new Map(),      // id -> { meta }
      lineId: '',
      lineTitle: ''
    };

    // --- Elements -----------------------------------------------------------
    const els = {
      inputsHost:  document.getElementById('beverage-inputs'),
      packageHost: document.getElementById('package-cards'),
      packagesTitle: document.getElementById('packages-title'),
      packagesExpl: document.getElementById('packages-expl'),
      totals:      document.getElementById('totals'),
      totalsLine:  document.getElementById('totals-line'),
      days:        document.getElementById('days'),
      pillRccl:    document.getElementById('pill-rccl')
    };

    // --- Utils --------------------------------------------------------------
    const fmt = n => '$' + (Math.round(n * 100) / 100).toFixed(2);
    const getLS = (k,d)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch(_){ return d; } };
    const setLS = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } };

    // If site-cache.js is present it exposes window.itwSeedSW; otherwise no-op
    const seedSW = (urls, priority='normal')=>{
      try{ if (window.itwSeedSW) window.itwSeedSW(urls, priority); }catch(_){}
    };

    function sanitizedHTML(str=''){
      // very light sanitizer for known-safe snippets we control
      const div = document.createElement('div');
      div.innerHTML = str;
      // strip script/style
      div.querySelectorAll('script,style').forEach(n=>n.remove());
      return div.innerHTML;
    }

    // --- Rendering ----------------------------------------------------------
    function renderInputs(){
      els.inputsHost.innerHTML = state.order.map(id=>{
        const it = state.items.get(id);
        const priceNote = it.meta.free
          ? '<span class="muted">(included · $0)</span>'
          : `<span class="price tiny">avg ${fmt(it.meta.avgPrice)}</span>`;
        return `
          <div class="card" style="padding:.7rem .8rem">
            <div class="calc-row">
              <label for="qty-${id}">${it.meta.name}</label>
              <input id="qty-${id}" type="number" inputmode="numeric" min="0" step="1" value="${it.qtyPerDay||0}" data-item="${id}" aria-describedby="help-${id}" />
              <div class="tiny muted" id="help-${id}">${priceNote}</div>
            </div>
            ${it.meta.notes ? `<div class="tiny muted" style="margin-top:.35rem">${it.meta.notes}</div>` : ``}
          </div>`;
      }).join('');

      els.inputsHost.querySelectorAll('input[type="number"]').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const id = inp.dataset.item;
          const ent = state.items.get(id);
          ent.qtyPerDay = Math.max(0, parseInt(inp.value || '0', 10));
          computeAndRender();
        });
      });
    }

    function pkgPriceDisplay(pmeta){
      const key = 'pkgOverride:'+state.lineId+':'+pmeta.id;
      const ov = getLS(key, null);
      // choose: override → avg → lower bound → 0
      const value = ov!=null ? Number(ov) : (Number(pmeta.avg) || (pmeta.priceRange?.[0] ?? 0));
      return { value, overridden: ov!=null };
    }

    function renderPackages(view){
      const frag = document.createDocumentFragment();

      state.packages.forEach(p=>{
        const { value, overridden } = pkgPriceDisplay(p.meta);
        const range = p.meta.priceRange ? ` (${fmt(p.meta.priceRange[0])}–${fmt(p.meta.priceRange[1])})` : '';
        const strategyCost = view[p.meta.id+'Daily'] ?? null;

        const includeVal = view.includedDaily[p.meta.id] ?? 0;
        const qualifies = includeVal >= value - 1e-6;

        const el = document.createElement('article');
        el.className = `pkg card ${view.bestIds.has(p.meta.id)?'highlight':''}`;
        el.id = `pkg-${p.meta.id}`;
        el.setAttribute('aria-live','polite');

        const descList = Array.isArray(p.meta.description)&&p.meta.description.length
          ? `<ul class="tiny" style="margin:.5rem 0 0 1.25rem">${p.meta.description.map(d=>`<li>${d}</li>`).join('')}</ul>`
          : '';

        el.innerHTML = `
          <span class="ribbon" role="status" style="display:${view.bestIds.has(p.meta.id)?'inline-block':'none'}">Best value</span>
          <header>
            <div><strong>${p.meta.name}</strong> <span class="tiny muted">${range}</span></div>
            <div class="price" data-price="${p.meta.id}">${fmt(value)}</div>
          </header>
          <div class="body">
            <div class="tiny" style="margin:.1rem 0 .4rem">
              Included value (your picks): <strong>${fmt(includeVal)}</strong> /day
              ${strategyCost!=null ? `<span class="muted">· With this package you’d pay <strong>${fmt(strategyCost)}</strong> /day</span>` : ``}
            </div>
            <button class="pill override" data-ov="${p.meta.id}" type="button">${overridden?'Edit Price (overridden)':'Edit Price'}</button>
            ${descList}
          </div>`;

        frag.appendChild(el);
      });

      els.packageHost.innerHTML = '';
      els.packageHost.appendChild(frag);

      els.packageHost.querySelectorAll('button[data-ov]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.ov;
          const key = 'pkgOverride:'+state.lineId+':'+id;
          const pmeta = state.packages.get(id).meta;
          const suggested = getLS(key, null) ?? (Number(pmeta.avg) || (pmeta.priceRange?.[0] ?? 0));
          const v = prompt('Enter your package price per person per day (USD).', String(suggested));
          if (v==null) return;
          const num = Number(v);
          if (!Number.isFinite(num) || num<0) { alert('Please enter a valid non-negative number.'); return; }
          setLS(key, num);
          computeAndRender();
        });
      });
    }

    function computeAndRender(){
      // daily spend by item
      let dailyTotal = 0;
      let sodaSpend = 0, refreshNonAlcoholSpend = 0, alcoholSpend = 0;

      state.items.forEach((it,id)=>{
        const spend = (it.meta.avgPrice||0) * (it.qtyPerDay||0);
        dailyTotal += spend;
        if (state.sets.soda.has(id))     sodaSpend += spend;
        if (state.sets.refresh.has(id))  refreshNonAlcoholSpend += spend;
        if (state.sets.alcohol.has(id))  alcoholSpend += spend;
      });

      const days = Math.max(1, parseInt(els.days.value||'1',10));
      state.days = days;
      const tripTotal = dailyTotal * days;
      els.totals.textContent = `Daily total (à la carte): ${fmt(dailyTotal)} · Trip total: ${fmt(tripTotal)}`;
      els.totalsLine.textContent = `Tip: You can override package prices to match the sale you see in your planner.`;

      const pkg = {};
      ['soda','refreshment','deluxe'].forEach(pid=>{
        const meta = state.packages.get(pid)?.meta;
        if (meta) pkg[pid] = pkgPriceDisplay(meta).value;
      });

      const noneDaily    = dailyTotal;
      const sodaDaily    = (pkg.soda ?? Infinity) + (dailyTotal - sodaSpend);
      const refreshDaily = (pkg.refreshment ?? Infinity) + alcoholSpend; // refresh covers refresh set only
      const deluxeDaily  = (pkg.deluxe ?? Infinity); // deluxe covers all

      const includedDaily = {
        soda: sodaSpend,
        refreshment: refreshNonAlcoholSpend,
        deluxe: dailyTotal
      };

      const entries = [
        {id:'none',        cost:noneDaily,       rank:0},
        {id:'soda',        cost:sodaDaily,       rank:1},
        {id:'refreshment', cost:refreshDaily,    rank:2},
        {id:'deluxe',      cost:deluxeDaily,     rank:3}
      ];

      entries.sort((a,b)=>{
        if (Math.abs(a.cost-b.cost) <= state.epsilon) return b.rank - a.rank; // prefer more inclusive on tie
        return a.cost - b.cost;
      });
      const bestCost = entries[0].cost;
      const bestIds = new Set(entries.filter(e=>Math.abs(e.cost-bestCost) <= state.epsilon).map(e=>e.id));

      renderPackages({ noneDaily, sodaDaily, refreshDaily, deluxeDaily, includedDaily, bestIds });
    }

    // --- Dataset Loader (adapts your JSON schema) ---------------------------
    async function loadDataset(src){
      try{
        let data = null;
        if (src && src.startsWith('#')){
          const tag = document.querySelector(src);
          if (!tag) throw new Error('missing inline JSON');
          data = JSON.parse(tag.textContent);
        }else{
          const r = await fetch(src, { cache:'no-store', credentials:'omit' });
          if(!r.ok) throw new Error('Bad response');
          data = await r.json();
        }

        // titles / text
        state.lineId   = data.lineId || data.line || 'unknown-line';
        state.lineTitle= data.text?.lineTitle || data.text?.line || 'Cruise Line';
        els.packagesTitle.textContent = data.text?.packagesTitle || (state.lineTitle + ' Beverage Packages');
        els.packagesExpl.innerHTML = sanitizedHTML(data.text?.packagesExplHtml || '');

        // epsilon (tie preference)
        if (typeof data.rules?.epsilon === 'number') state.epsilon = data.rules.epsilon;

        // items: adapt from {id, label, price, free?}
        state.items = new Map();
        const baseItems = [...(data.items || [])];

        // Map to internal
        baseItems.forEach(it=>{
          state.items.set(it.id, {
            meta: {
              id: it.id,
              name: it.label || it.name || it.id,
              avgPrice: Number(it.price || it.avgPrice || 0),
              free: !!it.free,
              notes: it.notes || ''
            },
            qtyPerDay: 0
          });
        });

        // input order: paid items first (descending price), then free alpha
        const paid = [], free = [];
        state.items.forEach((v,k)=> (v.meta.free?free:paid).push([k,v]));
        paid.sort((a,b)=> (b[1].meta.avgPrice - a[1].meta.avgPrice));
        free.sort((a,b)=> a[1].meta.name.localeCompare(b[1].meta.name));
        state.order = [...paid.map(x=>x[0]), ...free.map(x=>x[0])];

        // sets
        state.sets = {
          soda:    new Set(data.sets?.soda    || ['soda']),
          refresh: new Set(data.sets?.refresh || []),
          alcohol: new Set(data.sets?.alcohol || [])
        };

        // packages (object keyed by id)
        state.packages = new Map();
        const pkgObj = data.packages || {};
        Object.keys(pkgObj).forEach(k=>{
          const p = pkgObj[k];
          const pr = parseRange(p.range);
          state.packages.set(k, {
            meta: {
              id: k,
              name: p.name || k,
              avg: Number(p.price || p.avg || 0),
              priceRange: pr,
              // Let description be a nice blend of their "includes"
              description: Array.isArray(p.includes) ? p.includes.slice() : []
            }
          });
        });

        // seed SW with the dataset + likely next pages/images (low priority)
        seedSW([typeof src==='string' ? src : location.pathname + src], 'low');

        renderInputs();
        computeAndRender();
      }catch(err){
        console.warn('Dataset load failed:', err?.message||err);
        els.packagesExpl.textContent = 'Could not load data. Try refreshing the page.';
      }
    }

    function parseRange(s){
      if (!s || typeof s!=='string') return null;
      const m = s.match(/(\d+(\.\d+)?)\s*[–-]\s*(\d+(\.\d+)?)/);
      if (!m) return null;
      const a = Number(m[1]), b = Number(m[3]);
      if (!Number.isFinite(a) || !Number.isFinite(b)) return null;
      return [Math.min(a,b), Math.max(a,b)];
    }

    // --- Events -------------------------------------------------------------
    els.days.addEventListener('input', computeAndRender);

    document.getElementById('pill-rccl').addEventListener('click', (e)=>{
      document.querySelectorAll('.pill-row .pill').forEach(p=>p.setAttribute('aria-current','false'));
      e.currentTarget.setAttribute('aria-current','true');
      const src = e.currentTarget.getAttribute('data-src');
      // pre-warm this dataset & page
      seedSW([src, '/drink-packages.html'], 'high');
      loadDataset(src);
    });

    // --- Boot with Royal dataset -------------------------------------------
    loadDataset(els.pillRccl.getAttribute('data-src'));
  })();
  </script>
</body>
</html>
