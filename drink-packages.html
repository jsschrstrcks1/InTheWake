<!doctype html>
<html lang="en">
<head>
  <!--
  Soli Deo Gloria — every pixel and paragraph offered in gratitude.

  PAGE: /drink-packages.html
  VERSION: v3.010.104 (self-contained)
  STANDARDS: Every Page v3.010 · Unified Nav v3.010 (portal’d) · Right-Rail v3.008.025
             A11y/WCAG Addendum v3.100 · JSON authoritative
  -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="version" content="3.010.104"/>
  <title>Drink Packages Calculator — In the Wake (v3.010.104)</title>
  <link rel="canonical" href="https://cruisinginthewake.com/drink-packages.html"/>

  <!-- ===== Inline CSS (scoped, consistent with /planning.html) ===== -->
  <style>
  :root{
    --sea:#0a3d62;--foam:#e6f4f8;--rope:#d9b382;--ink:#083041;--sky:#f7fdff;--accent:#0e6e8e;--good:#0b7a43;
    --shadow:0 2px 6px rgba(8,48,65,.08);--shadow-lg:0 10px 28px rgba(8,48,65,.14);
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;overflow-x:hidden}
  html{scrollbar-gutter:stable both-edges}
  body{font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--sky)}
  img{max-width:100%;height:auto;display:block}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  .wrap{max-width:1100px;margin:0 auto;padding:20px 14px 36px}
  .tiny{font-size:.9rem;color:#456}.muted{opacity:.85}
  .pill{display:inline-block;padding:.45rem .75rem;border:1px solid var(--rope);border-radius:999px;background:#fff;line-height:1.1}
  .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.35rem .7rem;border-radius:10px;background:#fff;border:1px solid var(--rope);color:var(--accent)}
  .card{background:#fff;border:2px solid var(--rope);border-radius:14px;padding:1rem;box-shadow:var(--shadow);margin:.8rem 0;position:relative;overflow:hidden}
  .card::after{content:"";position:absolute;inset:0;margin:auto;width:min(60%,360px);height:min(60%,360px);
    background:url('/assets/watermark.png?v=3.010.071') center/contain no-repeat;opacity:.06;pointer-events:none}
  h1,h2,h3,h4{color:var(--sea);margin:.25rem 0 .5rem}

  /* ===== Header / Nav (PORTAL’D) ===== */
  .hero-header{position:relative;z-index:0;border-bottom:6px double var(--rope);background:#eaf6f6;overflow:visible}
  .navbar{max-width:1100px;margin:0 auto;display:flex;gap:.6rem;padding:.35rem .9rem .75rem;align-items:center;
    position:relative;z-index:10;min-height:56px;background:#eaf6f6;overflow:visible}
  .brand{display:flex;align-items:center;gap:.6rem}
  .brand img{height:40px;width:auto;display:block}
  .version-badge{font-size:.72rem;opacity:.8;margin-left:.35rem}

  .itw-nav{display:flex;gap:.5rem;flex:1 1 auto;align-items:center;justify-content:center;white-space:nowrap;
    overflow:visible;padding-inline:.75rem;padding-bottom:1px;scrollbar-width:thin}
  .itw-nav .nav-item{position:relative}
  .itw-nav .nav-item>a.chip{text-decoration:none}
  .itw-nav .chip[aria-current="page"]{outline:3px dashed var(--rope);outline-offset:2px;box-shadow:0 0 0 3px rgba(200,163,106,.15) inset}

  .itw-nav .menu{
    position:absolute; left:0; top:100%; transform:translateY(.35rem);
    min-width:240px; max-width:min(90vw,360px);
    background:#fff; border:1px solid var(--rope); border-radius:12px; box-shadow:var(--shadow-lg);
    padding:.6rem; display:none; visibility:hidden; opacity:0; pointer-events:none; z-index:100; transition:opacity .18s ease;
  }
  .itw-nav .nav-item.open > .menu{display:block; visibility:visible; opacity:1; pointer-events:auto}
  .itw-nav .menu .label{font-weight:600;color:#234;margin:.15rem .2rem .35rem;font-size:.9rem}
  .itw-nav .menu a{display:block;padding:.45rem .6rem;border-radius:.6rem;color:var(--ink);text-decoration:none}
  .itw-nav .menu a:hover{background:#f2f7fa;text-decoration:none}

  /* ===== Hero (compact) ===== */
  .hero{position:relative;width:100%;min-height:clamp(160px,18vw,260px);
    background:url('/assets/index_hero.jpg?v=3.010.071') center 38%/cover no-repeat;
    display:flex;align-items:flex-end;overflow:hidden;margin-top:.15rem;z-index:0}
  .hero-title{position:absolute;left:min(3vw,1rem);bottom:clamp(.6rem,2vw,1.2rem);display:flex;flex-direction:column;gap:.35rem;text-shadow:0 2px 6px rgba(0,0,0,.45)}
  .hero-title .logo{width:clamp(176px,20vw,320px);max-width:min(90vw,420px);filter:drop-shadow(0 3px 8px rgba(0,0,0,.45))}
  .tagline{font-weight:700;letter-spacing:.2px;color:#e6f4f8;font-size:clamp(.86rem,1.2vw,1.2rem);white-space:nowrap}

  /* ===== Layout: content + right rail ===== */
  .grid{display:grid;gap:1.2rem}
  @media(min-width:1060px){.grid{grid-template-columns:minmax(0,1fr) 360px}}
  .rail section.card + section.card{margin-top:.8rem}

  /* ===== Calculator UI ===== */
  .pill-row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.35rem 0 .6rem}
  .twocol{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.6rem}
  @media(max-width:640px){.twocol{grid-template-columns:1fr}}
  .input-card{display:grid;grid-template-columns:1fr auto;gap:.5rem;align-items:center}
  input[type="number"]{width:6.5rem;font:inherit;padding:.5rem .6rem;border-radius:10px;border:1px solid var(--rope);background:#fff}
  input[type="number"][aria-invalid="true"]{border-color:#b00020;outline:2px solid rgba(176,0,32,.25)}
  .pkg-grid{display:grid;gap:.75rem}
  @media(min-width:860px){.pkg-grid{grid-template-columns:repeat(3,1fr)}}
  article.pkg{position:relative;overflow:hidden}
  .ribbon{position:absolute;top:.6rem;right:-.35rem;transform:rotate(12deg);background:var(--good);color:#fff;padding:.25rem .65rem;border-radius:6px;font-size:.8rem;box-shadow:0 2px 6px rgba(0,0,0,.12)}
  .pkg.highlight{outline:2px solid var(--good);outline-offset:2px}
  .pkg header{display:flex;align-items:flex-start;justify-content:space-between;gap:.65rem;margin-bottom:.35rem}
  .pkg .price{white-space:nowrap}
  .edit-btn{border:1px solid var(--rope);background:#fff;border-radius:999px;padding:.4rem .65rem;color:var(--accent);font-weight:600;cursor:pointer}
  .edit-btn:hover{background:#f2f7fa}

  /* ===== Inline modal for price override ===== */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:999}
  .modal.open{display:flex}
  .modal .sheet{background:#fff;border-radius:14px;border:2px solid var(--rope);box-shadow:var(--shadow-lg);padding:1rem;max-width:340px;width:92%}
  .modal .row{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.65rem}
  .btn{border:1px solid var(--rope);background:#fff;border-radius:10px;padding:.45rem .8rem;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}

  /* ===== Share bar (mount) ===== */
  #sharebar{margin-top:.2rem}

  /* Visually hidden (focusable) for skip link parity */
  .visually-hidden-focusable{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  .visually-hidden-focusable:focus{position:static;width:auto;height:auto;padding:.4rem .6rem;background:#083041;color:#fff;border-radius:8px;margin:.5rem}
  </style>

  <!-- ===== Social / OpenGraph (absolute on apex) ===== -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Drink Packages Calculator — In the Wake">
  <meta property="og:description" content="Enter your daily drinks; we’ll compare à-la-carte vs. packages.">
  <meta property="og:url" content="https://cruisinginthewake.com/drink-packages.html">
  <meta property="og:image" content="https://cruisinginthewake.com/assets/index_hero.jpg?v=3.010.071">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Drink Packages Calculator — In the Wake">
  <meta name="twitter:description" content="A quick way to check if a cruise drink package pays off for you.">
  <meta name="twitter:image" content="https://cruisinginthewake.com/assets/index_hero.jpg?v=3.010.071">

  <!-- ===== JSON-LD (authoritative absolute URL) ===== -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"Drink Packages Calculator",
    "url":"https://cruisinginthewake.com/drink-packages.html",
    "description":"Compare à-la-carte drink costs vs package prices on your cruise.",
    "isPartOf":{"@type":"WebSite","name":"In the Wake","url":"https://cruisinginthewake.com/"}
  }
  </script>
</head>

<body class="page">
  <a class="visually-hidden-focusable" href="#content">Skip to main content</a>

  <!-- ===== Header (Portal’d Unified Nav) ===== -->
  <header class="hero-header" role="banner" style="padding-top:.15rem">
    <div class="navbar">
      <div class="brand">
        <img src="/assets/logo_wake.png?v=3.010.071" width="256" height="64" alt="In the Wake wordmark">
        <span class="tiny version-badge">v3.010.104</span>
      </div>

      <nav class="itw-nav" aria-label="Primary">
        <div class="nav-item"><a class="chip" href="/">Home</a></div>

        <div class="nav-item" aria-haspopup="menu">
          <button class="chip" type="button" aria-expanded="false" aria-haspopup="menu" aria-controls="menu-planning">
            Planning <span class="caret">▾</span>
          </button>
          <div id="menu-planning" class="menu" aria-label="Planning">
            <div class="label tiny">Plan your cruise</div>
            <a href="/planning.html">Planning (overview)</a>
            <a href="/ports.html">Ports</a>
            <a href="/restaurants.html">Restaurants &amp; Menus</a>
            <a href="/drink-packages.html" aria-current="page">Drink Packages</a>
            <a href="/cruise-lines.html">Cruise Lines</a>
            <a href="/packing-lists.html">Packing Lists</a>
            <a href="/accessibility.html">Accessibility</a>
          </div>
        </div>

        <div class="nav-item" aria-haspopup="menu">
          <button class="chip" type="button" aria-expanded="false" aria-haspopup="menu" aria-controls="menu-travel">
            Travel <span class="caret">▾</span>
          </button>
          <div id="menu-travel" class="menu" aria-label="Travel">
            <div class="label tiny">On the move</div>
            <a href="/travel.html">Travel (overview)</a>
            <a href="/solo.html">Solo</a>
          </div>
        </div>

        <div class="nav-item"><a class="chip" href="/about-us.html">About</a></div>
      </nav>
    </div>

    <!-- Compact hero -->
    <div class="hero" role="img" aria-label="Ship wake at sunrise">
      <div class="hero-title">
        <img class="logo" src="/assets/logo_wake.png?v=3.010.071" width="256" height="64" alt="In the Wake">
        <div class="tagline">A Cruise Traveler’s Logbook</div>
      </div>
    </div>
  </header>

  <!-- Social share bar -->
  <div id="sharebar" class="wrap" aria-label="Share this page"></div>

  <!-- ===== Main: calculator + RIGHT RAIL ===== -->
  <main id="content" class="wrap grid" role="main">
    <!-- LEFT / Calculator -->
    <section aria-labelledby="calc-title">
      <h1 id="calc-title">Beverage Calculator</h1>
      <p class="tiny muted">Pick your daily drinks and we’ll compare à-la-carte vs. packages.</p>

      <!-- Cruise line pills -->
      <div class="pill-row" role="tablist" aria-label="Cruise line">
        <button id="pill-rccl" class="pill" data-src="/assets/data/lines/royal-caribbean.json" aria-current="true" role="tab">Royal Caribbean</button>
        <!-- Add more lines as they land -->
      </div>

      <!-- Inputs header: days + quick picks in same row -->
      <div class="card">
        <div class="twocol">
          <div class="input-card">
            <label for="days"><strong>Trip length</strong></label>
            <input id="days" type="number" inputmode="decimal" pattern="[0-9]*" min="1" step="1" value="7" aria-describedby="days-help"/>
          </div>
          <div>
            <div id="days-help" class="tiny muted" style="margin-top:.25rem">People often book 5–7 nights. Adjust as needed.</div>
          </div>
        </div>
        <div id="totals" class="tiny" aria-live="polite" style="margin-top:.35rem"></div>
        <div id="totals-line" class="tiny muted" aria-live="polite" style="margin-top:.15rem"></div>
      </div>

      <!-- Beverage inputs (two columns on wide) -->
      <section class="card" aria-labelledby="your-picks">
        <h2 id="your-picks">Your Daily Picks</h2>
        <div id="beverage-inputs" class="twocol"></div>
      </section>

      <!-- Packages -->
      <section class="card" aria-labelledby="packages-title">
        <h2 id="packages-title">Beverage Packages</h2>
        <div class="tiny muted" id="packages-expl" style="margin:-.35rem 0 .5rem"></div>
        <div id="package-cards" class="pkg-grid"></div>
      </section>
    </section>

    <!-- RIGHT RAIL -->
    <aside class="rail" aria-label="Related">
      <section class="card" aria-labelledby="rec-title">
        <h3 id="rec-title">Recommended Reading</h3>
        <ul style="list-style:none;margin:0;padding:0">
          <li style="margin:.5rem 0"><a href="/articles/should-you-buy-the-deluxe-package.html" data-prefetch="hover">Should you buy the Deluxe package?</a></li>
          <li style="margin:.5rem 0"><a href="/articles/how-gratuities-work-on-drink-packages.html" data-prefetch="hover">How drink gratuities really work</a></li>
          <li style="margin:.5rem 0"><a href="/articles/mocktails-and-kids-soda-plans.html" data-prefetch="hover">Mocktails & kids’ soda plans</a></li>
        </ul>
      </section>

      <section class="card" aria-labelledby="author-title">
        <h3 id="author-title">About the Author</h3>
        <article class="rail-item" role="article">
          <a class="thumb" href="/authors/ken-baker.html" data-prefetch="hover" style="display:block;width:96px;height:96px;border-radius:12px;overflow:hidden">
            <picture>
              <source srcset="/authors/img/ken1.webp?v=3.010.070" type="image/webp">
              <source srcset="/authors/img/ken1.jpg?v=3.010.070" type="image/jpeg">
              <img src="/authors/img/ken1.png?v=3.010.070" width="96" height="96" alt="Ken Baker" style="width:100%;height:100%;object-fit:cover">
            </picture>
          </a>
          <div class="meta">
            <h4><a href="/authors/ken-baker.html" data-prefetch="hover">Ken Baker</a></h4>
            <p class="tiny">Traveler, pastor, storyteller. Writing toward calmer seas for every cruiser.</p>
            <p class="tiny"><a href="/solo.html" data-prefetch="hover">Solo</a> · <a href="/travel.html" data-prefetch="hover">Travel</a></p>
          </div>
        </article>
      </section>
    </aside>
  </main>

  <footer class="wrap" role="contentinfo">
    © 2025 In the Wake — A Cruise Traveler’s Logbook ·
    <a href="/accessibility.html">Accessibility &amp; WCAG 2.1 AA Commitment</a>
    <p class="tiny" style="margin-top:.5rem;text-align:center">Soli Deo Gloria — may every pixel and paragraph bear His reflection. This site is offered as worship to God.</p>
  </footer>

  <!-- ===== Sharebar (mount-only; script hydrates) ===== -->
  <script src="/assets/js/sharebar.js?v=3.010.071" defer></script>

  <!-- ===== SW helper (defines window.itwSeedSW) ===== -->
  <script src="/assets/js/site-cache.js?v=3.010.104" defer></script>

  <!-- ===== Hover prefetch hydrator ===== -->
  <script>
  (function(){
    function seed(urls, priority='low'){ try{ window.itwSeedSW && window.itwSeedSW(urls, priority); }catch(_){ } }
    const primed=new Set();
    function onHover(e){
      const a=e.currentTarget; const href=a.getAttribute('href'); if(!href||primed.has(href)) return;
      primed.add(href); seed([href],'low');
    }
    function wire(){
      document.querySelectorAll('[data-prefetch="hover"]').forEach(a=>{
        a.addEventListener('mouseenter', onHover, {once:true, passive:true});
        a.addEventListener('focus', onHover, {once:true, passive:true});
      });
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', wire); else wire();
    window.itwWarmDataset = (url)=> url && seed([url],'high');
  })();
  </script>

  <!-- ===== Calculator ===== -->
  <script>
  (function(){
    "use strict";
    const PAGE_VERSION='v3.010.104';

    // ---- State ----
    const state={
      days:7,
      epsilon:0.02, // tie threshold
      items:new Map(), // id -> {meta, qtyPerDay}
      order:[],
      sets:{soda:new Set(), refresh:new Set(), alcohol:new Set()},
      packages:new Map(), // id -> {meta}
      lineId:'', lineTitle:''
    };

    // ---- Elements ----
    const els={
      inputsHost:document.getElementById('beverage-inputs'),
      packageHost:document.getElementById('package-cards'),
      packagesTitle:document.getElementById('packages-title'),
      packagesExpl:document.getElementById('packages-expl'),
      totals:document.getElementById('totals'),
      totalsLine:document.getElementById('totals-line'),
      days:document.getElementById('days'),
      pillRccl:document.getElementById('pill-rccl'),
    };

    // ---- Utils ----
    const fmt = n => Number.isFinite(n) ? ('$'+Math.abs(n).toFixed(2)).replace(/^/,(n<0?'-':'')) : '$?.??';
    const getLS=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch(_){return d;}};
    const setLS=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch(_){}};
    const debounce=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

    function sanitizedHTML(str=''){ const div=document.createElement('div'); div.innerHTML=str; div.querySelectorAll('script,style').forEach(n=>n.remove()); return div.innerHTML; }

    // ---- Render Inputs ----
    function renderInputs(){
      const html = state.order.map(id=>{
        const it=state.items.get(id);
        const priceNote = it.meta.free ? '<span class="tiny muted">(included · $0)</span>' :
          `<span class="tiny" style="font-weight:700">avg ${fmt(it.meta.avgPrice)}</span>`;
        return `
          <div class="input-card">
            <label for="qty-${id}">${it.meta.name}</label>
            <div>
              <input id="qty-${id}" type="number" inputmode="decimal" pattern="[0-9]*" min="0" step="1" value="${it.qtyPerDay||0}" data-item="${id}" aria-describedby="help-${id}" />
              <div id="help-${id}" class="tiny muted">${priceNote}${it.meta.notes?` · ${it.meta.notes}`:''}</div>
            </div>
          </div>`;
      }).join('');
      els.inputsHost.innerHTML = html;

      els.inputsHost.querySelectorAll('input[type="number"]').forEach(inp=>{
        const onInput = ()=>{
          const id=inp.dataset.item; const ent=state.items.get(id);
          const val=Number(inp.value);
          const valid = Number.isFinite(val) && val>=0;
          inp.setAttribute('aria-invalid', valid?'false':'true');
          ent.qtyPerDay = valid ? Math.floor(val) : 0;
          computeAndRender();
        };
        inp.addEventListener('input', debounce(onInput,150));
      });
    }

    // ---- Packages ----
    function pkgPriceDisplay(pmeta){
      const key='pkgOverride:'+state.lineId+':'+(pmeta.id||pmeta.name);
      const ov=getLS(key,null);
      const base = Number(pmeta.price ?? pmeta.avg ?? (pmeta.priceRange?.[0] ?? 0));
      const value = ov!=null ? Number(ov) : base;
      return { value, overridden: ov!=null };
    }

    function renderPackages(view){
      const frag=document.createDocumentFragment();
      state.packages.forEach(p=>{
        const {value,overridden}=pkgPriceDisplay(p.meta);
        const range = p.meta.priceRange ? ` (${fmt(p.meta.priceRange[0])}–${fmt(p.meta.priceRange[1])})` : '';
        const includeVal = view.includedDaily[p.meta.id] ?? 0;
        const strategyCost = view[p.meta.id+'Daily'] ?? null;

        const el=document.createElement('article'); el.className=`pkg card ${view.bestIds.has(p.meta.id)?'highlight':''}`;
        el.innerHTML = `
          <span class="ribbon" role="status" style="display:${view.bestIds.has(p.meta.id)?'inline-block':'none'}">Best value</span>
          <header>
            <div><strong>${p.meta.name}</strong> <span class="tiny muted">${range}</span></div>
            <div class="price">${fmt(value)}/day</div>
          </header>
          <div class="tiny" style="margin:.1rem 0 .4rem">
            Included value (your picks): <strong>${fmt(includeVal)}</strong> /day
            ${strategyCost!=null?`<span class="muted">· With this package you’d pay <strong>${fmt(strategyCost)}</strong> /day</span>`:''}
          </div>
          <button class="edit-btn" data-edit="${p.meta.id}" type="button">${overridden?'Edit Price (overridden)':'Edit Price'}</button>
          ${Array.isArray(p.meta.description)&&p.meta.description.length
            ? `<ul class="tiny" style="margin:.5rem 0 0 1.25rem">${p.meta.description.map(d=>`<li>${d}</li>`).join('')}</ul>` : ''}`;
        frag.appendChild(el);
      });
      els.packageHost.innerHTML=''; els.packageHost.appendChild(frag);

      els.packageHost.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id=btn.dataset.edit;
          const key='pkgOverride:'+state.lineId+':'+id;
          const pmeta=state.packages.get(id).meta;
          const suggested=getLS(key,null) ?? Number(pmeta.price ?? pmeta.avg ?? (pmeta.priceRange?.[0] ?? 0));
          const val=await showOverrideModal(suggested);
          if(val==null) return;
          const num=Number(val);
          if(!Number.isFinite(num)||num<0){ alert('Please enter a valid non-negative number.'); return; }
          setLS(key,num); computeAndRender();
        });
      });
    }

    // ---- Math ----
    function computeAndRender(){
      let dailyTotal=0, sodaSpend=0, refreshSpend=0, alcoholSpend=0;

      state.items.forEach((it,id)=>{
        const spend=(it.meta.avgPrice||0) * (it.qtyPerDay||0);
        dailyTotal += spend;
        if(state.sets.soda.has(id)) sodaSpend += spend;
        if(state.sets.refresh.has(id)) refreshSpend += spend;
        if(state.sets.alcohol.has(id)) alcoholSpend += spend;
      });

      const days=Math.max(1, Number(els.days.value)||1);
      state.days=days;
      els.totals.textContent=`Daily total (à la carte): ${fmt(dailyTotal)} · Trip total: ${fmt(dailyTotal*days)}`;
      els.totalsLine.textContent=`Tip: Override package prices to match the sale you see in your planner.`;

      const need = (pid)=> (state.packages.get(pid)?.meta)||null;
      const prices = {
        soda:        need('soda')        ? pkgPriceDisplay(need('soda')).value : Infinity,
        refreshment: need('refreshment') ? pkgPriceDisplay(need('refreshment')).value : Infinity,
        deluxe:      need('deluxe')      ? pkgPriceDisplay(need('deluxe')).value : Infinity,
      };

      const noneDaily    = dailyTotal;
      const sodaDaily    = prices.soda        + (dailyTotal - sodaSpend);
      const refreshDaily = prices.refreshment + alcoholSpend; // refresh covers non-alcohol set only
      const deluxeDaily  = prices.deluxe; // deluxe covers all

      const includedDaily = { soda:sodaSpend, refreshment:refreshSpend, deluxe:dailyTotal };

      const entries = [
        {id:'none', cost:noneDaily, rank:0},
        {id:'soda', cost:sodaDaily, rank:1},
        {id:'refreshment', cost:refreshDaily, rank:2},
        {id:'deluxe', cost:deluxeDaily, rank:3},
      ].sort((a,b)=>{
        if(Math.abs(a.cost-b.cost) <= state.epsilon) return b.rank - a.rank; // prefer more inclusive on tie
        return a.cost - b.cost;
      });
      const bestCost=entries[0].cost;
      const bestIds=new Set(entries.filter(e=>Math.abs(e.cost-bestCost)<=state.epsilon).map(e=>e.id));

      renderPackages({ noneDaily,sodaDaily,refreshDaily,deluxeDaily,includedDaily,bestIds });
    }

    // ---- Dataset Loader (JSON authoritative) ----
    function parseRange(s){
      if(!s||typeof s!=='string') return null;
      const m=s.match(/(\d+(?:\.\d+)?)\s*[-–]\s*(\d+(?:\.\d+)?)/);
      if(m){ const a=Number(m[1]), b=Number(m[2]); if(Number.isFinite(a)&&Number.isFinite(b)) return [Math.min(a,b),Math.max(a,b)]; }
      const single=Number(s); return Number.isFinite(single) ? [single,single] : null;
    }

    async function loadDataset(src){
      try{
        const url = src.includes('?') ? (src+'&v='+encodeURIComponent(PAGE_VERSION)) : (src+'?v='+encodeURIComponent(PAGE_VERSION));
        const r=await fetch(url,{cache:'default',credentials:'omit'});
        if(!r.ok) throw new Error('Bad response');
        const data=await r.json();

        // Titles / text
        state.lineId=data.lineId || data.line || 'unknown-line';
        state.lineTitle=data.text?.lineTitle || data.text?.line || 'Cruise Line';
        els.packagesTitle.textContent=data.text?.packagesTitle || (state.lineTitle+' Beverage Packages');
        els.packagesExpl.innerHTML=sanitizedHTML(data.text?.packagesExplHtml || '');

        // Epsilon
        if(typeof data.rules?.epsilon === 'number') state.epsilon=data.rules.epsilon;

        // Items
        state.items=new Map();
        (data.items||[]).forEach(it=>{
          state.items.set(it.id,{
            meta:{
              id:it.id,
              name:it.label||it.name||it.id,
              avgPrice:Number(it.price||it.avgPrice||0),
              free:!!it.free,
              notes:it.notes||'',
            },
            qtyPerDay:0
          });
        });

        // Input order: paid desc then free alpha
        const paid=[], free=[];
        state.items.forEach((v,k)=> (v.meta.free?free:paid).push([k,v]));
        paid.sort((a,b)=> b[1].meta.avgPrice - a[1].meta.avgPrice);
        free.sort((a,b)=> a[1].meta.name.localeCompare(b[1].meta.name));
        state.order=[...paid.map(x=>x[0]), ...free.map(x=>x[0])];

        // Sets (defaults when missing; Starbucks not included; spiked coffee not included)
        const DEFAULT_REFRESH = ['soda','specialty_coffee','tea','juice','mocktail','bottled_water'];
        state.sets={
          soda:    new Set(data.sets?.soda    || ['soda']),
          refresh: new Set((data.sets?.refresh && data.sets.refresh.length)? data.sets.refresh : DEFAULT_REFRESH),
          alcohol: new Set(data.sets?.alcohol || []),
        };

        // Packages
        state.packages=new Map();
        const pkgObj=data.packages||{};
        // canonical ids we support in UI
        const idMap={soda:'soda', refreshment:'refreshment', deluxe:'deluxe'};
        Object.entries(pkgObj).forEach(([jsonId,p])=>{
          const id = idMap[jsonId] || jsonId;
          const priceNum = Number(p.price ?? p.avg ?? 0);
          const pr = p.range ? parseRange(p.range) : (Number.isFinite(priceNum)? [priceNum,priceNum] : null);
          state.packages.set(id,{ meta:{
            id, name:p.name||jsonId, price:priceNum, avg:priceNum, priceRange:pr,
            description:Array.isArray(p.includes)?p.includes.slice():[],
          }});
        });

        // Warm dataset in SW
        window.itwWarmDataset && window.itwWarmDataset(src);

        renderInputs();
        computeAndRender();
      }catch(err){
        console.warn('Dataset load failed:', err?.message||err);
        els.packagesExpl.textContent='Could not load data. Try refreshing the page.';
      }
    }

    // ---- Events ----
    els.days.addEventListener('input', debounce(()=>{ 
      const v=Number(els.days.value); els.days.setAttribute('aria-invalid', (Number.isFinite(v)&&v>=1)?'false':'true');
      computeAndRender();
    },150));

    document.getElementById('pill-rccl').addEventListener('click',(e)=>{
      document.querySelectorAll('.pill-row .pill').forEach(p=>p.setAttribute('aria-current','false'));
      e.currentTarget.setAttribute('aria-current','true');
      const src=e.currentTarget.getAttribute('data-src');
      window.itwWarmDataset && window.itwWarmDataset(src);
      loadDataset(src);
    });

    // ---- Inline modal for price override ----
    function ensureModal(){
      if(document.getElementById('override-modal')) return;
      const div=document.createElement('div');
      div.id='override-modal'; div.className='modal';
      div.innerHTML=`
        <div class="sheet">
          <h3 style="margin-top:0">Override price per day</h3>
          <input id="override-input" type="number" inputmode="decimal" step="0.01" placeholder="e.g., 58.00" style="width:100%;padding:.5rem;border:1px solid var(--rope);border-radius:10px">
          <div class="row">
            <button class="btn" id="override-cancel" type="button">Cancel</button>
            <button class="btn primary" id="override-save" type="button">Save</button>
          </div>
        </div>`;
      document.body.appendChild(div);
    }
    function showOverrideModal(current){
      ensureModal();
      const modal=document.getElementById('override-modal');
      const input=document.getElementById('override-input');
      const cancel=document.getElementById('override-cancel');
      const save=document.getElementById('override-save');
      input.value = (Number.isFinite(Number(current))? Number(current).toFixed(2) : '');
      modal.classList.add('open');
      input.focus({preventScroll:true});
      return new Promise(res=>{
        const cleanup=()=>{ modal.classList.remove('open'); cancel.onclick=save.onclick=null; input.onkeydown=null; };
        cancel.onclick=()=>{ cleanup(); res(null); };
        save.onclick=()=>{ const v=Number(input.value); cleanup(); res(v); };
        input.onkeydown=(e)=>{ if(e.key==='Enter'){ e.preventDefault(); save.click(); } if(e.key==='Escape'){ e.preventDefault(); cancel.click(); } };
      });
    }

    // ---- Boot ----
    const src=els.pillRccl?.getAttribute('data-src');
    if(src) loadDataset(src);
  })();
  </script>

  <!-- ===== Scoped Nav Behavior (click-only, a11y) ===== -->
  <script>
  (function(){
    const root=document.querySelector('.itw-nav'); if(!root) return;
    const items=[...root.querySelectorAll('.nav-item[aria-haspopup]')];

    function setOpen(group,on){ group.classList.toggle('open',!!on); const btn=group.querySelector('button[aria-controls]'); if(btn) btn.setAttribute('aria-expanded', on?'true':'false'); }
    function closeAll(except=null){ items.forEach(g=>{ if(g!==except) setOpen(g,false); }); }
    function firstFocusable(el){ return el && el.querySelector('a,button,[tabindex]:not([tabindex="-1"])'); }

    items.forEach(group=>{
      const btn=group.querySelector('button[aria-controls]'); const menu=group.querySelector('.menu'); if(!btn||!menu) return;

      btn.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); const open=group.classList.contains('open'); closeAll(group); setOpen(group,!open); if(!open){ (firstFocusable(menu)||btn).focus({preventScroll:true}); }});
      btn.addEventListener('keydown',(e)=>{ if(e.key==='ArrowDown'||e.key==='ArrowUp'){ e.preventDefault(); setOpen(group,true); (firstFocusable(menu)||btn).focus({preventScroll:true}); } else if(e.key==='Escape'){ setOpen(group,false); btn.focus({preventScroll:true}); }});
      group.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ setOpen(group,false); btn.focus({preventScroll:true}); }});
      menu.addEventListener('focusout',()=>{ setTimeout(()=>{ if(!group.contains(document.activeElement)) setOpen(group,false); },0); });
    });

    document.addEventListener('click',(e)=>{ if(!e.target.closest('.itw-nav')) closeAll(); });
    window.addEventListener('blur',()=> closeAll());
  })();
  </script>

  <!-- ===== Sharebar hydrate ===== -->
  <script>
    (function(){
      if(!document.getElementById('sharebar')) return;
      if(typeof window.initSharebar==='function'){ window.initSharebar('#sharebar'); }
      else{ window.addEventListener('load',()=>window.initSharebar&&window.initSharebar('#sharebar')); }
    })();
  </script>

  <!-- ===== Service Worker registration (apex only) ===== -->
  <script>
  (function(){
    const PROD=/^cruisinginthewake\.com$/i.test(location.hostname);
    if(!PROD||!('serviceWorker' in navigator)) return;
    const SW_URL='/sw.js?v=20.1'; // keep aligned with your shipped SW version
    navigator.serviceWorker.register(SW_URL,{scope:'/'}).catch(err=>console.warn('[SW register]',err));
  })();
  </script>

  <!-- Signature -->
  <!-- Soli Deo Gloria · Steward: abondservant · Path: /drink-packages.html · Version: v3.010.104 -->
</body>
</html>
