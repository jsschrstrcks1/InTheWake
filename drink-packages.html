<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Drink Packages Calculator — In the Wake</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Versioning / Standards -->
  <meta name="page:version" content="v3.010.104">
  <meta name="version" content="v3.010.104">
  <meta name="standards:baseline" content="3.009">
  <meta name="referrer" content="no-referrer">
  <meta name="theme-color" content="#083041">

  <!-- Canonical & OpenGraph (static, no race) -->
  <link rel="canonical" href="https://cruisinginthewake.com/drink-packages.html">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Drink Packages Calculator — In the Wake">
  <meta property="og:description" content="Enter your daily drinks and we’ll compare à-la-carte vs. packages.">
  <meta property="og:url" content="https://cruisinginthewake.com/drink-packages.html">
  <meta property="og:image" content="https://cruisinginthewake.com/assets/index_hero.jpg?v=3.010.104">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Drink Packages Calculator — In the Wake">
  <meta name="twitter:description" content="A quick way to check if a cruise drink package pays off for you.">
  <meta name="twitter:image" content="https://cruisinginthewake.com/assets/index_hero.jpg?v=3.010.104">

  <!-- JSON-LD (static, no race) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"Drink Packages Calculator",
    "url":"https://cruisinginthewake.com/drink-packages.html",
    "description":"Compare à-la-carte drink costs vs package prices on your cruise.",
    "isPartOf": { "@type":"WebSite", "name":"In the Wake", "url":"https://cruisinginthewake.com/" }
  }
  </script>

  <!-- Site CSS (version-coupled) -->
  <link rel="stylesheet" href="/assets/styles.css?v=3.010.104">

  <style>
    /* Page-scoped add-ons (global in /assets/styles.css) */
    :root{
      --ink:#0a3d62; --muted:#5f6b72; --bg:#f7f9fa; --card:#ffffff; --line:#dfe7ea; --accent:#0e6e8e; --good:#0b7a43;
      --bad:#9b1c1c;
    }
    html, body { overflow-x:hidden; background:var(--bg); color:var(--ink); }
    .wrap{ max-width: 1140px; margin:0 auto; padding:0 1rem; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line); background:#fff;
    }
    .skip{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
    .skip:focus{ position:static; width:auto; height:auto; padding:.4rem .6rem; background:#083041; color:#fff; border-radius:8px; margin:.5rem; }
    .brand{ display:flex; align-items:center; gap:.5rem; padding:.75rem 0; }
    .brand a{ color:inherit; text-decoration:none; font-weight:700; }

    nav[aria-label="Primary"] a{ text-decoration:none; color:var(--ink); padding:.5rem .65rem; border-radius:8px; }
    nav[aria-label="Primary"] a:hover, nav[aria-label="Primary"] a:focus { background:rgba(14,110,142,.08); }

    header.page{ padding:1.25rem 0 1rem; }

    /* 12-col grid with sticky right rail */
    .grid{ display:grid; grid-template-columns:repeat(12, 1fr); gap:1rem; align-items:start; }
    .col-7{ grid-column: span 7; }
    .col-5{ grid-column: span 5; position: sticky; top: 1rem; align-self:start; }
    @media (max-width: 980px){
      .col-7, .col-5 { grid-column: 1 / -1; position: static; }
    }

    .muted{ color:var(--muted) }
    .tiny{ font-size:.88rem }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:12px;
      padding:1rem; box-shadow:0 1px 2px rgba(10,61,98,0.04);
    }
    .pill-row{ display:flex; gap:.5rem; flex-wrap:wrap; margin:.35rem 0 .75rem }
    .pill{
      border:1px solid var(--line); background:#fff; color:var(--ink);
      padding:.5rem .8rem; border-radius:999px; cursor:pointer; font-weight:600; min-height:44px;
    }
    .pill[aria-selected="true"]{ background:var(--accent); color:#fff; border-color:var(--accent) }

    /* Calculator */
    .calc-row{ display:grid; grid-template-columns:1fr auto; gap:.5rem; align-items:center; }
    input[type="number"]{
      width:6rem; font:inherit; padding:.55rem .6rem; border-radius:8px;
      border:1px solid var(--line); background:#fff;
    }
    input[type="number"][aria-invalid="true"]{ border-color:var(--bad); }
    #beverage-inputs .card{ margin-bottom:.6rem }
    #package-cards{ display:grid; gap:.75rem }
    @media (min-width:720px){ #package-cards{ grid-template-columns:repeat(3, 1fr) } }
    article.pkg{ position:relative; overflow:hidden }
    .pkg .ribbon{
      position:absolute; top:.75rem; right:-.5rem; transform:rotate(12deg);
      background:var(--good); color:#fff; padding:.25rem .65rem; border-radius:6px;
      font-size:.8rem; box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
    .pkg.highlight{ outline:2px solid var(--good); outline-offset:2px; }
    .pkg header{ display:flex; align-items:flex-start; justify-content:space-between; gap:.65rem; margin-bottom:.35rem }
    .pkg header .price{ white-space:nowrap }

    button{
      background:#fff; border:1px solid var(--line); border-radius:999px; padding:.5rem .8rem;
      color:var(--ink); font-weight:600; cursor:pointer; min-height:44px;
    }
    button.inline{ border-radius:8px }
    button.override{ border-color:var(--accent); color:var(--accent); }
    button.override:hover{ background:rgba(14,110,142,.06) }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

    /* Rails */
    .rail-block + .rail-block{ margin-top:1rem }
    .rail-block h3{ margin:.25rem 0 .5rem; font-size:1rem }
    .rail-list{ list-style:none; margin:0; padding:0 }
    .rail-list li + li{ margin-top:.5rem }
    .rail-list a{ color:var(--ink); text-decoration:none; }
    .rail-list a:hover{ text-decoration:underline; }

    /* Share cluster */
    .share-row{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.5rem }
    .share-row .share{ display:inline-flex; align-items:center; gap:.4rem; padding:.5rem .8rem; border:1px solid var(--line); border-radius:10px; background:#fff; text-decoration:none; color:var(--ink); }
    .share small{ font-weight:700 }

    /* Price override modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:999; }
    .modal{ background:#fff; border-radius:12px; max-width:360px; width:90%; padding:1rem; border:1px solid var(--line); box-shadow:0 6px 28px rgba(0,0,0,.15); }
    .modal h3{ margin:.25rem 0 .25rem }
    .modal .row{ display:grid; grid-template-columns:1fr; gap:.5rem; margin-top:.5rem }
    .modal input{ width:100%; padding:.6rem .65rem; border:1px solid var(--line); border-radius:8px; font:inherit; }
    .modal .actions{ display:flex; justify-content:flex-end; gap:.5rem; margin-top:.75rem }
  </style>

  <script>
    // www -> apex guard (prod only), minimal and dev-safe
    (function(){
      var h = location.hostname;
      if (h === 'www.cruisinginthewake.com') {
        location.replace('https://cruisinginthewake.com' + location.pathname + location.search + location.hash);
      }
    })();
  </script>
</head>

<body>
  <div class="topbar wrap" role="navigation" aria-label="Site">
    <a class="skip" href="#main">Skip to main content</a>
    <div class="brand">
      <a href="/" data-portal-nav="home">In the Wake</a>
    </div>
    <nav aria-label="Primary">
      <a href="/planning.html" data-portal-nav="planning">Planning</a>
      <a href="/ports.html" data-portal-nav="ports">Ports</a>
      <a href="/restaurants.html" data-portal-nav="dining">Dining</a>
      <a href="/drink-packages.html" aria-current="page">Drinks</a>
    </nav>
  </div>

  <header class="page wrap" role="banner">
    <h1 style="margin:0 0 .35rem">Beverage Calculator</h1>
    <p class="muted tiny">Pick your daily drinks and we’ll compare à-la-carte vs. packages.</p>

    <!-- Share cluster -->
    <div class="share-row" aria-label="Share this calculator">
      <a class="share" id="share-x" href="#" rel="noopener"><small>Share</small> X</a>
      <a class="share" id="share-fb" href="#" rel="noopener"><small>Share</small> Facebook</a>
      <a class="share" id="share-wa" href="#" rel="noopener"><small>Share</small> WhatsApp</a>
      <a class="share" id="share-mail" href="#" rel="noopener"><small>Send</small> Email</a>
      <button class="share inline" id="share-copy" type="button"><small>Copy</small> Link</button>
    </div>

    <!-- Line tabs -->
    <div class="pill-row" role="tablist" aria-label="Cruise line" id="line-tabs">
      <button id="pill-rccl" class="pill" data-src="/assets/data/lines/royal-caribbean.json"
              role="tab" aria-selected="true" aria-controls="calc-panel">Royal Caribbean</button>
      <!-- Future tabs -->
      <!-- <button class="pill" data-src="/assets/data/lines/carnival.json" role="tab" aria-selected="false" aria-controls="calc-panel">Carnival</button> -->
    </div>

    <div class="calc-row" style="max-width:420px">
      <label for="days"><strong>Trip length</strong></label>
      <input id="days" type="number" inputmode="decimal" pattern="[0-9]*" min="1" step="1" value="7" aria-describedby="days-help" />
    </div>
    <div id="days-help" class="tiny muted" style="margin-top:.25rem">People often book 5–7 nights. Adjust as needed.</div>
    <div id="totals" class="tiny" aria-live="polite" style="margin-top:.35rem"></div>
    <div id="totals-line" class="tiny muted" aria-live="polite" style="margin-top:.15rem"></div>
  </header>

  <main id="main" class="wrap" role="main">
    <div class="grid">
      <!-- Main column (calculator) -->
      <section class="col-7" aria-labelledby="calc-heading" id="calc-panel" role="tabpanel">
        <h2 id="calc-heading" class="sr-only">Your picks</h2>
        <div id="beverage-inputs"></div>

        <h2 id="packages-title" style="margin-top:.6rem">Beverage Packages</h2>
        <div class="tiny muted" id="packages-expl" style="margin:-.35rem 0 .5rem"></div>
        <div id="package-cards"></div>
      </section>

      <!-- Right rail (articles & author rails) -->
      <aside class="col-5" aria-labelledby="rail-heading">
        <h2 id="rail-heading" class="sr-only">Related</h2>

        <!-- Article Rail -->
        <div class="rail-block card" id="rail-articles" data-rail="articles">
          <h3>Recommended Reading</h3>
          <ul class="rail-list">
            <li><a href="/articles/should-you-buy-the-deluxe-package.html" data-prefetch="hover">Should you buy the Deluxe package?</a></li>
            <li><a href="/articles/how-gratuities-work-on-drink-packages.html" data-prefetch="hover">How drink gratuities really work</a></li>
            <li><a href="/articles/mocktails-and-kids-soda-plans.html" data-prefetch="hover">Mocktails & kids’ soda plans</a></li>
          </ul>
        </div>

        <!-- Author Rail -->
        <div class="rail-block card" id="rail-author" data-rail="author">
          <h3>About the Author</h3>
          <p class="tiny muted">Pastor, coder, cruiser. I test these tools so you don’t waste money onboard.</p>
          <p class="tiny"><a href="/about-us.html" data-prefetch="hover">About us</a></p>
        </div>
      </aside>
    </div>
  </main>

  <footer class="wrap muted tiny" role="contentinfo" style="padding:1.25rem 0 2rem">
    © In the Wake — <a href="/accessibility.html">Accessibility</a>
  </footer>

  <!-- Inline override modal -->
  <div id="override-modal" class="modal-backdrop" aria-hidden="true" aria-labelledby="ov-title" role="dialog">
    <div class="modal" role="document">
      <h3 id="ov-title">Override package price (per person per day)</h3>
      <div class="row">
        <label class="tiny muted" for="override-input">USD</label>
        <input id="override-input" type="number" inputmode="decimal" step="0.01" min="0" placeholder="e.g., 58.00">
        <div id="override-error" class="tiny" style="color:var(--bad); display:none">Enter a valid non-negative number.</div>
      </div>
      <div class="actions">
        <button id="override-cancel" class="inline" type="button">Cancel</button>
        <button id="override-save" class="inline" style="background:var(--accent); color:#fff" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Runtime seed helper (must be before calculator) -->
  <script src="/assets/js/site-cache.js?v=3.010.104" defer></script>

  <script>
  (function(){
    "use strict";

    const PAGE_VERSION = document.querySelector('meta[name="page:version"]').content || 'v0';

    // ---------- Hover prefetch (rails, author, etc.) ----------
    function wireHoverPrefetch(){
      const seed = (urls) => { try{ window.itwSeedSW && window.itwSeedSW(urls, 'low'); }catch(_){ } };
      const linkHrefs = new Set();
      function onOver(e){
        const a = e.currentTarget;
        const href = a.getAttribute('href');
        if (!href || linkHrefs.has(href)) return;
        linkHrefs.add(href);
        seed([href]);
      }
      document.querySelectorAll('[data-prefetch="hover"]').forEach(a=>{
        a.addEventListener('mouseenter', onOver, { once:true, passive:true });
        a.addEventListener('focus', onOver, { once:true, passive:true });
      });
    }

    // ---------- Social share ----------
    function wireShare(){
      const getURL = ()=> location.origin + location.pathname + location.search;
      const title = 'Drink Packages Calculator — In the Wake';

      function openWin(url){ window.open(url, '_blank', 'noopener,noreferrer'); }
      document.getElementById('share-x').onclick = (e)=>{ e.preventDefault(); openWin('https://twitter.com/intent/tweet?text=' + encodeURIComponent(title) + '&url=' + encodeURIComponent(getURL())); };
      document.getElementById('share-fb').onclick = (e)=>{ e.preventDefault(); openWin('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(getURL())); };
      document.getElementById('share-wa').onclick = (e)=>{ e.preventDefault(); openWin('https://api.whatsapp.com/send?text=' + encodeURIComponent(title + ' ' + getURL())); };
      document.getElementById('share-mail').onclick = (e)=>{ e.preventDefault(); location.href = 'mailto:?subject=' + encodeURIComponent(title) + '&body=' + encodeURIComponent(getURL()); };
      document.getElementById('share-copy').onclick = async (e)=>{
        try{
          await navigator.clipboard.writeText(getURL());
          e.currentTarget.textContent = 'Copied!';
          setTimeout(()=> e.currentTarget.textContent = 'Copy Link', 1200);
        }catch(_){}
      };
      // Web Share API (progressive)
      if (navigator.share){
        document.getElementById('share-copy').insertAdjacentHTML('afterend', '<button class="share inline" id="share-native" type="button"><small>Share</small> App</button>');
        document.getElementById('share-native').onclick = ()=> navigator.share({ title, url: getURL() }).catch(()=>{});
      }
    }

    // ---------- Tabs (line pills) a11y ----------
    function wireTabs(){
      const list = document.getElementById('line-tabs');
      const tabs = Array.from(list.querySelectorAll('[role="tab"]'));
      function setSelected(idx){
        tabs.forEach((t,i)=> t.setAttribute('aria-selected', i===idx ? 'true' : 'false'));
        tabs[idx].focus();
        tabs[idx].click();
      }
      list.addEventListener('keydown', (e)=>{
        const i = tabs.findIndex(t=>t===document.activeElement);
        if (i<0) return;
        if (e.key==='ArrowRight'){ e.preventDefault(); setSelected((i+1)%tabs.length); }
        else if (e.key==='ArrowLeft'){ e.preventDefault(); setSelected((i-1+tabs.length)%tabs.length); }
        else if (e.key==='Home'){ e.preventDefault(); setSelected(0); }
        else if (e.key==='End'){ e.preventDefault(); setSelected(tabs.length-1); }
      });
    }

    // ---------- Calculator core ----------
    const state = {
      days: 7,
      epsilon: 0.02,
      items: new Map(),           // id -> { meta, qtyPerDay }
      order: [],
      sets: { soda: new Set(), refresh: new Set(), alcohol: new Set() },
      packages: new Map(),        // 'soda' | 'refreshment' | 'deluxe'
      lineId: '',
      lineTitle: ''
    };

    const els = {
      inputsHost:  document.getElementById('beverage-inputs'),
      packageHost: document.getElementById('package-cards'),
      packagesTitle: document.getElementById('packages-title'),
      packagesExpl: document.getElementById('packages-expl'),
      totals:      document.getElementById('totals'),
      totalsLine:  document.getElementById('totals-line'),
      days:        document.getElementById('days'),
      pillRccl:    document.getElementById('pill-rccl'),
      modal:       document.getElementById('override-modal'),
      modalInput:  document.getElementById('override-input'),
      modalErr:    document.getElementById('override-error'),
      modalSave:   document.getElementById('override-save'),
      modalCancel: document.getElementById('override-cancel')
    };

    const fmt = n => {
      if (!Number.isFinite(n)) return '$?.??';
      const s = Math.abs(n).toFixed(2);
      return (n < 0 ? '-$' : '$') + s;
    };
    const getLS = (k,d)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch(_){ return d; } };
    const setLS = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } };
    const seedSW = (urls, priority='normal')=>{ try{ if (window.itwSeedSW) window.itwSeedSW(urls, priority); }catch(_){} };

    function sanitizedHTML(str=''){
      const div = document.createElement('div'); div.innerHTML = str;
      div.querySelectorAll('script,style').forEach(n=>n.remove());
      return div.innerHTML;
    }

    // URL state sync (shareable)
    function syncURLFromState(){
      const params = new URLSearchParams();
      params.set('days', String(state.days));
      state.items.forEach((it, id)=>{ if ((it.qtyPerDay||0) > 0) params.set(id, String(it.qtyPerDay)); });
      const qs = params.toString();
      history.replaceState(null, '', location.pathname + (qs ? '?' + qs : '') + location.hash);
    }
    function restoreStateFromURL(){
      const params = new URLSearchParams(location.search);
      if (params.has('days')) {
        const d = Math.max(1, parseInt(params.get('days')||'1',10));
        els.days.value = state.days = d;
      }
      state.items.forEach((it, id)=>{
        if (params.has(id)) {
          const q = Math.max(0, parseInt(params.get(id)||'0',10));
          it.qtyPerDay = q;
        }
      });
    }

    // Debounce helper
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a), ms); }; }

    function renderInputs(){
      els.inputsHost.innerHTML = state.order.map(id=>{
        const it = state.items.get(id);
        const priceNote = it.meta.free
          ? '<span class="muted">(included · $0)</span>'
          : `<span class="price tiny">avg ${fmt(it.meta.avgPrice)}</span>`;
        return `
          <div class="card" style="padding:.7rem .8rem">
            <div class="calc-row">
              <label for="qty-${id}">${it.meta.name}</label>
              <input id="qty-${id}" type="number" inputmode="decimal" pattern="[0-9]*"
                     min="0" step="1" value="${it.qtyPerDay||0}" data-item="${id}" aria-describedby="help-${id}" />
              <div class="tiny muted" id="help-${id}">${priceNote}</div>
            </div>
            ${it.meta.notes ? `<div class="tiny muted" style="margin-top:.35rem">${it.meta.notes}</div>` : ``}
          </div>`;
      }).join('');

      const onInput = debounce((inp)=>{
        const id = inp.dataset.item;
        const v = inp.value.trim();
        const n = v === '' ? 0 : Number(v);
        const valid = Number.isFinite(n) && n >= 0;
        inp.setAttribute('aria-invalid', valid ? 'false' : 'true');
        if (!valid) return;
        const ent = state.items.get(id);
        ent.qtyPerDay = Math.max(0, Math.floor(n));
        computeAndRender();
        syncURLFromState();
      }, 150);

      els.inputsHost.querySelectorAll('input[type="number"]').forEach(inp=>{
        inp.addEventListener('input', ()=>onInput(inp));
      });
    }

    function pkgPriceDisplay(pmeta){
      const key = 'pkgOverride:'+state.lineId+':'+(pmeta.id || pmeta.name);
      const ov = getLS(key, null);
      // choose: override → explicit price → range min → 0
      const basePrice = Number(pmeta.price ?? (pmeta.priceRange?.[0]) ?? 0);
      const value = ov!=null ? Number(ov) : basePrice;
      return { value, overridden: ov!=null, key };
    }

    function renderPackages(view){
      const frag = document.createDocumentFragment();

      state.packages.forEach(p=>{
        const { value, overridden, key } = pkgPriceDisplay(p.meta);
        const range = (Array.isArray(p.meta.priceRange) && p.meta.priceRange.length === 2)
          ? (p.meta.priceRange[0] === p.meta.priceRange[1]
              ? ` (${fmt(p.meta.priceRange[0])})`
              : ` (${fmt(p.meta.priceRange[0])}–${fmt(p.meta.priceRange[1])})`)
          : '';

        const includeVal = view.includedDaily[p.meta.id] ?? 0;
        const strategyCost = view[p.meta.id+'Daily'] ?? null;

        const el = document.createElement('article');
        el.className = `pkg card ${view.bestIds.has(p.meta.id)?'highlight':''}`;
        el.id = `pkg-${p.meta.id}`;
        el.setAttribute('aria-live','polite');

        const descList = Array.isArray(p.meta.description)&&p.meta.description.length
          ? `<ul class="tiny" style="margin:.5rem 0 0 1.25rem">${p.meta.description.map(d=>`<li>${d}</li>`).join('')}</ul>`
          : '';

        el.innerHTML = `
          <span class="ribbon" role="status" style="display:${view.bestIds.has(p.meta.id)?'inline-block':'none'}">Best value</span>
          <header>
            <div><strong>${p.meta.name}</strong> <span class="tiny muted">${range}</span></div>
            <div class="price" data-price="${p.meta.id}">${fmt(value)}</div>
          </header>
          <div class="body">
            <div class="tiny" style="margin:.1rem 0 .4rem">
              Included value (your picks): <strong>${fmt(includeVal)}</strong> /day
              ${strategyCost!=null ? `<span class="muted">· With this package you’d pay <strong>${fmt(strategyCost)}</strong> /day</span>` : ``}
            </div>
            <button class="pill override" data-ov="${p.meta.id}" data-ovkey="${key}" type="button">${overridden?'Edit Price (overridden)':'Edit Price'}</button>
            ${descList}
          </div>`;

        frag.appendChild(el);
      });

      els.packageHost.innerHTML = '';
      els.packageHost.appendChild(frag);

      // inline override editor
      els.packageHost.querySelectorAll('button[data-ov]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.dataset.ov;
          const key = btn.dataset.ovkey;
          const pmeta = state.packages.get(id).meta;
          const suggested = getLS(key, null) ?? Number(pmeta.price ?? (pmeta.priceRange?.[0]) ?? 0);
          const val = await showOverrideModal(suggested);
          if (val == null) return;
          const num = Number(val);
          if (!Number.isFinite(num) || num<0) return;
          setLS(key, num);
          computeAndRender();
        });
      });
    }

    function computeAndRender(){
      let dailyTotal = 0;
      let sodaSpend = 0, refreshNonAlcoholSpend = 0, alcoholSpend = 0;

      state.items.forEach((it,id)=>{
        const spend = (it.meta.avgPrice||0) * (it.qtyPerDay||0);
        dailyTotal += spend;
        if (state.sets.soda.has(id))     sodaSpend += spend;
        if (state.sets.refresh.has(id))  refreshNonAlcoholSpend += spend;
        if (state.sets.alcohol.has(id))  alcoholSpend += spend;
      });

      const days = Math.max(1, parseInt(els.days.value||'1',10));
      state.days = days;
      const tripTotal = dailyTotal * days;
      els.totals.textContent = `Daily total (à la carte): ${fmt(dailyTotal)} · Trip total: ${fmt(tripTotal)}`;
      els.totalsLine.textContent = `Tip: You can override package prices to match the sale you see in your planner.`;
      syncURLFromState();

      const pkg = {};
      ['soda','refreshment','deluxe'].forEach(pid=>{
        const meta = state.packages.get(pid)?.meta;
        pkg[pid] = meta ? pkgPriceDisplay(meta).value : Infinity;
      });

      const noneDaily    = dailyTotal;
      const sodaDaily    = (pkg.soda) + (dailyTotal - sodaSpend);
      const refreshDaily = (pkg.refreshment) + alcoholSpend; // refresh covers refresh set only
      const deluxeDaily  = (pkg.deluxe); // deluxe covers all

      const includedDaily = {
        soda: sodaSpend,
        refreshment: refreshNonAlcoholSpend,
        deluxe: dailyTotal
      };

      const entries = [
        {id:'none',        cost:noneDaily,       rank:0},
        {id:'soda',        cost:sodaDaily,       rank:1},
        {id:'refreshment', cost:refreshDaily,    rank:2},
        {id:'deluxe',      cost:deluxeDaily,     rank:3}
      ];

      entries.sort((a,b)=>{
        if (Math.abs(a.cost-b.cost) <= state.epsilon) return b.rank - a.rank; // prefer more inclusive on tie
        return a.cost - b.cost;
      });
      const bestCost = entries[0].cost;
      const bestIds = new Set(entries.filter(e=>Math.abs(e.cost-bestCost) <= state.epsilon).map(e=>e.id));

      renderPackages({ noneDaily, sodaDaily, refreshDaily, deluxeDaily, includedDaily, bestIds });
    }

    function parseRange(s){
      if (!s) return null;
      if (typeof s === 'number' && Number.isFinite(s)) return [s, s];
      if (typeof s !== 'string') return null;
      const m = s.match(/(\d+(?:\.\d+)?)\s*[-–]\s*(\d+(?:\.\d+)?)/);
      if (m) {
        const a = Number(m[1]), b = Number(m[2]);
        if (Number.isFinite(a) && Number.isFinite(b)) return [Math.min(a,b), Math.max(a,b)];
      }
      const single = Number(s);
      return Number.isFinite(single) ? [single, single] : null;
    }

    // Fallback refresh classifier when JSON omits sets.refresh
    function buildRefreshFallbackSet(){
      const want = ['soda','specialty coffee','coffee','tea','juice','mocktail','bottled water','bottle water','water bottle'];
      const block = ['starbucks']; // exclude Starbucks
      const alcoholHints = ['irish coffee','baileys','rum','whiskey','bourbon','liqueur'];
      const set = new Set();
      state.items.forEach((it,id)=>{
        const name = (it.meta.name || '').toLowerCase();
        const include = want.some(w => name.includes(w));
        const excluded = block.some(w => name.includes(w)) || alcoholHints.some(w => name.includes(w));
        if (include && !excluded) set.add(id);
      });
      return set;
    }

    async function loadDataset(src){
      try{
        let data = null;
        if (src && src.startsWith('#')){
          const tag = document.querySelector(src);
          if (!tag) throw new Error('missing inline JSON');
          data = JSON.parse(tag.textContent);
        }else{
          const sep = src.includes('?') ? '&' : '?';
          const r = await fetch(src + sep + 'v=' + PAGE_VERSION, { cache:'default', credentials:'omit' });
          if(!r.ok) throw new Error('Bad response ' + r.status);
          data = await r.json();
        }

        // Titles / text
        state.lineId   = data.lineId || data.line || 'unknown-line';
        state.lineTitle= data.text?.lineTitle || data.text?.line || 'Cruise Line';
        els.packagesTitle.textContent = data.text?.packagesTitle || (state.lineTitle + ' Beverage Packages');
        els.packagesExpl.innerHTML = sanitizedHTML(data.text?.packagesExplHtml || '');

        // epsilon override
        if (typeof data.rules?.epsilon === 'number') state.epsilon = data.rules.epsilon;

        // Items
        state.items = new Map();
        (data.items || []).forEach(it=>{
          state.items.set(it.id, {
            meta: {
              id: it.id,
              name: it.label || it.name || it.id,
              avgPrice: Number(it.price || it.avgPrice || 0),
              free: !!it.free,
              notes: it.notes || ''
            },
            qtyPerDay: 0
          });
        });

        // Input order: paid desc, then free alpha
        const paid = [], free = [];
        state.items.forEach((v,k)=> (v.meta.free?free:paid).push([k,v]));
        paid.sort((a,b)=> (b[1].meta.avgPrice - a[1].meta.avgPrice));
        free.sort((a,b)=> a[1].meta.name.localeCompare(b[1].meta.name));
        state.order = [...paid.map(x=>x[0]), ...free.map(x=>x[0])];

        // Sets
        state.sets = {
          soda:    new Set(data.sets?.soda    || ['soda']), // minimal default
          refresh: new Set(data.sets?.refresh || Array.from(buildRefreshFallbackSet())),
          alcohol: new Set(data.sets?.alcohol || [])
        };

        // Packages (JSON is authoritative); normalize single price to range
        state.packages = new Map();
        const pkgObj = data.packages || {};
        const idMap = { soda: 'soda', refreshment: 'refreshment', deluxe: 'deluxe' };
        Object.entries(pkgObj).forEach(([jsonId, p]) => {
          const canonicalId = idMap[jsonId] || jsonId;
          const pr = parseRange(p.range ?? p.price);
          state.packages.set(canonicalId, {
            meta: {
              id: canonicalId,
              name: p.name || jsonId,
              price: Number(p.price ?? p.avg ?? (Array.isArray(pr) ? pr[0] : 0)),
              priceRange: pr || null,
              description: Array.isArray(p.includes) ? p.includes.slice() : []
            }
          });
        });

        // Prefill from URL (after items exist)
        restoreStateFromURL();

        // Render + seed dataset softly
        renderInputs();
        computeAndRender();
        if (typeof src === 'string') seedSW([src], 'low');
      }catch(err){
        console.warn('Dataset load failed:', err?.message||err);
        els.packagesExpl.textContent = 'Could not load data. Try refreshing the page.';
      }
    }

    // ------- Override modal -------
    function showOverrideModal(current){
      els.modalInput.value = (Number.isFinite(current) && current>=0) ? String(current) : '';
      els.modal.style.display = 'flex';
      els.modal.setAttribute('aria-hidden','false');
      els.modalInput.focus();

      return new Promise(resolve=>{
        function close(v){
          els.modal.style.display = 'none';
          els.modal.setAttribute('aria-hidden','true');
          els.modalErr.style.display = 'none';
          resolve(v);
        }
        function onSave(){
          const v = els.modalInput.value.trim();
          const n = Number(v);
          if (!Number.isFinite(n) || n<0){
            els.modalErr.style.display = 'block';
            return;
          }
          cleanup(); close(n);
        }
        function onCancel(){ cleanup(); close(null); }
        function onKey(e){ if (e.key==='Escape'){ e.preventDefault(); onCancel(); } }

        function cleanup(){
          els.modalSave.removeEventListener('click', onSave);
          els.modalCancel.removeEventListener('click', onCancel);
          document.removeEventListener('keydown', onKey, true);
        }
        els.modalSave.addEventListener('click', onSave);
        els.modalCancel.addEventListener('click', onCancel);
        document.addEventListener('keydown', onKey, true);
      });
    }

    // ------- Events -------
    els.days.addEventListener('input', debounce(()=>{
      const v = els.days.value.trim();
      const n = Number(v);
      const valid = Number.isFinite(n) && n >= 1;
      els.days.setAttribute('aria-invalid', valid ? 'false' : 'true');
      if (!valid) return;
      state.days = Math.floor(n);
      computeAndRender();
      syncURLFromState();
    }, 150));

    document.getElementById('pill-rccl').addEventListener('click', (e)=>{
      document.querySelectorAll('#line-tabs [role="tab"]').forEach(p=>p.setAttribute('aria-selected','false'));
      e.currentTarget.setAttribute('aria-selected','true');
      const src = e.currentTarget.getAttribute('data-src');
      seedSW([src], 'high');
      loadDataset(src);
    });

    // ------- Boot -------
    document.addEventListener('DOMContentLoaded', ()=>{
      wireHoverPrefetch();
      wireShare();
      wireTabs();
      const src = els.pillRccl?.getAttribute('data-src');
      if (src) loadDataset(src);
    });

  })();
  </script>

  <!-- Hidden Invocation / Dedication -->
  <!-- Soli Deo Gloria -->
</body>
</html>
