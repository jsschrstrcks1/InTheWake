<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="version" content="10.0.0"/>
<title>Royal Caribbean Drink Package Calculator 2025 | Is It Worth It?</title>
<meta name="description" content="Compare Soda, Refreshment, Deluxe, and Coffee Card vs √†-la-carte with live break-even chart. Free Royal Caribbean drink calculator with Crown & Anchor support."/>
<link rel="canonical" href="https://cruisinginthewake.com/drink-calculator.html"/>

<!-- OpenGraph / Twitter -->
<meta property="og:type" content="website">
<meta property="og:title" content="Royal Caribbean Drink Package Calculator 2025">
<meta property="og:description" content="Break-even chart + sea/port day weighting. Find out if a package saves money.">
<meta property="og:url" content="https://cruisinginthewake.com/drink-calculator.html">
<meta property="og:image" content="https://cruisinginthewake.com/assets/social/drink-calculator-2025.jpg">
<meta name="twitter:card" content="summary_large_image">

<!-- Breadcrumb JSON-LD -->
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[
  {"@type":"ListItem","position":1,"name":"Home","item":"https://cruisinginthewake.com/"},
  {"@type":"ListItem","position":2,"name":"Drink Calculator","item":"https://cruisinginthewake.com/drink-calculator.html"}
]}
</script>

<!-- Favicon / PWA -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/in_the_wake_icon_32x32.png">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0e6e8e">

<!-- Performance -->
<link rel="preconnect" href="https://api.frankfurter.app">
<link rel="preconnect" href="https://api.exchangerate.host">
<link rel="dns-prefetch" href="https://api.exchangerate.host">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<!-- Chart.js with fallback -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer onerror="this.onerror=null;this.src='/assets/vendor/chart.umd.min.js?v=10.0.0'"></script>


<!-- Critical CSS -->
<style>
:root{
  --sea:#0a3d62; --foam:#e6f4f8; --rope:#d9b382; --ink:#083041; --sky:#f7fdff; --accent:#0e6e8e;
  --bd:#e5e7eb;
  --shadow:0 6px 22px rgba(8,48,65,.08);
  --shadow-lg:0 10px 28px rgba(8,48,65,.14);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;overflow-x:hidden}
html{scrollbar-gutter:stable both-edges}
body{font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--sky)}
a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
img{max-width:100%;height:auto;display:block}
.wrap{max-width:1100px;margin:0 auto;padding:20px 14px 36px}
.card{background:#fff;border:2px solid var(--rope);border-radius:14px;padding:1rem;margin:.8rem 0;box-shadow:var(--shadow)}
h1,h2,h3,h4{color:var(--sea);margin:.5rem 0} 
.tiny{font-size:.88rem;color:#456}
.muted{color:#525a66}
.small{font-size:.9rem}
.row{display:grid;grid-template-columns:1fr 140px;align-items:center;gap:10px;padding:10px 0;border-bottom:1px dashed var(--bd)}
.row:last-child{border-bottom:0}
.controls-inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{cursor:pointer;padding:8px 12px;border:1px solid var(--bd);border-radius:8px;background:#0f172a;color:#fff;font-weight:700;min-height:44px;font-size:1rem}
.btn.ghost{background:#fff;color:#0f172a}

/* Skip link */
.skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
.skip-link:focus{left:.75rem;top:.5rem;width:auto;height:auto;background:#0e6e8e;color:#fff;border-radius:10px;padding:.35rem .6rem;z-index:2000}

/* Header */
.hero-header{position:relative;border-bottom:6px double var(--rope);background:#eaf6f6;z-index:0;overflow:visible}
.navbar{
  max-width:1100px;margin:0 auto;display:flex;align-items:flex-end;gap:.6rem;
  padding:.5rem .9rem .35rem;position:relative;z-index:2000;overflow:visible;
}
.brand{display:flex;align-items:flex-end;gap:.6rem}
.brand img{height:28px;width:auto}
.version-badge{font-size:.72rem;opacity:.8}

/* NAV */
.itw-nav{
  flex:1 1 auto;min-width:0;display:flex;align-items:center;justify-content:center;
  gap:.45rem;white-space:nowrap;overflow:visible;padding-inline:.75rem;
}
.itw-nav .nav-item{position:relative}
.itw-nav .chip{
  display:inline-flex;align-items:center;gap:.35rem;padding:.35rem .7rem;border-radius:10px;background:#fff;
  border:1px solid var(--rope);color:var(--accent);font-size:.9rem;line-height:1.2;cursor:pointer;text-decoration:none;
}
.itw-nav .chip[aria-current="page"]{outline:3px dashed var(--rope);outline-offset:2px}

.itw-nav .menu{
  position:absolute;left:0;top:calc(100% + 4px);
  min-width:240px;background:#fff;border:1px solid var(--rope);border-radius:12px;
  box-shadow:var(--shadow-lg);padding:.6rem;z-index:100;
  display:none;visibility:hidden;opacity:0;pointer-events:none;
}
.itw-nav .nav-item.open > .menu{
  display:block;visibility:visible;opacity:1;pointer-events:auto;
}
.itw-nav .menu .label{font-weight:600;color:#234;margin:.15rem .2rem .35rem;font-size:.9rem}
.itw-nav .menu a{display:block;padding:.45rem .6rem;border-radius:.6rem;color:var(--ink);text-decoration:none}
.itw-nav .menu a:hover{background:#f2f7fa}

.hero{
  position:relative;width:100%;min-height:clamp(200px,24vw,340px);
  background:url('/assets/index_hero.jpg?v=10.0.0') 50% 50%/cover no-repeat;
  display:flex;align-items:flex-end;overflow-x:clip;z-index:0;
}
.hero-compass{position:absolute;right:min(3vw,1rem);top:.5rem;width:86px;opacity:.95;z-index:2}
.hero-title{position:absolute;left:min(3vw,1rem);bottom:clamp(.6rem,2vw,1.4rem);z-index:3;display:flex;align-items:flex-end;gap:.6rem;text-shadow:0 2px 6px rgba(0,0,0,.45)}
.hero-title .logo{display:block;width:clamp(189px,23.1vw,378px);max-width:min(45vw,520px)}
.tagline{
  position:absolute;left:min(3vw,1rem);bottom:clamp(.55rem,1.6vw,1.1rem);
  font-weight:700;letter-spacing:.2px;color:#e6f4f8;
  font-size:clamp(.9rem,1.5vw,1.35rem);white-space:nowrap;z-index:3;
}
.hero-credit{position:absolute;right:.85rem;bottom:.85rem;z-index:4}
.hero-credit .pill{display:inline-block;padding:.45rem .7rem;border-radius:999px;background:#fff;border:1px solid var(--rope);font-weight:600;color:#0a3d62;box-shadow:0 1.5px 6px rgba(8,48,65,.15)}

/* Grid */
.calculator-grid{display:grid;gap:1.2rem}
@media(min-width:1060px){.calculator-grid{grid-template-columns:minmax(0,1fr) 360px}}

/* Banner/Badge */
.banner{background:var(--foam);border:2px solid var(--rope);border-radius:10px;padding:.75rem 1rem;margin:.75rem 0}
.badge{display:inline-block;padding:.35rem .7rem;border-radius:999px;background:#10b981;color:#fff;font-weight:700;font-size:.9rem}

/* Loading */
.loading{text-align:center;padding:2rem;color:#64748b}
.loading::after{
  content:'';display:inline-block;width:2rem;height:2rem;
  border:3px solid #cbd5e1;border-top-color:var(--accent);border-radius:50%;
  animation:spin 0.8s linear infinite;margin-left:0.5rem;vertical-align:middle;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Chart */
#breakeven-wrap{max-width:780px;margin-inline:auto;overflow-x:clip;contain:inline-size;position:relative}
#breakeven-chart{max-width:100%;width:100%!important;height:320px}
#best-stamp{
  position:absolute;top:-10px;right:8px;
  background:#10b981;color:#063;border:2px solid #065f46;border-radius:999px;
  padding:.25rem .5rem;font-weight:800;font-size:.8rem;
  box-shadow:0 4px 12px rgba(0,0,0,.12);display:none;z-index:3;
}

/* Category breakdown */
.category-summary{margin:12px 0;padding:12px;background:#e6f4f8;border-radius:8px;border:1px solid #d9b382}
.category-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;font-size:.95rem}

/* Package cards */
.package-card{position:relative;border:2px solid var(--rope);border-radius:12px;padding:1rem;background:#fff;margin:.5rem 0}
.package-card.winner{border-color:#10b981;box-shadow:0 0 16px rgba(16,185,129,.3)}
.package-card.winner::before{
  content:'üèÜ Best Value';position:absolute;right:0;top:0;
  background:#10b981;color:#fff;padding:.25rem .5rem;font-size:.8rem;font-weight:700;
  border-bottom-left-radius:8px;
}
.package-card .price{font-size:1.4rem;color:var(--accent);font-weight:700}

/* Rail */
.author-avatar{display:block;width:72px;height:72px;border-radius:16px;object-fit:cover;flex:0 0 72px}
.rail-list{display:grid;gap:1rem}

/* SR only */
.sr-only{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}

/* Quiz modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:9999}
.modal.active{display:flex}
.modal-content{background:#fff;border-radius:12px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;padding:2rem}
.modal-close{position:absolute;top:1rem;right:1rem;background:transparent;border:0;font-size:1.5rem;cursor:pointer}
#breakeven-wrap {
  max-width: 780px;
  margin-inline: auto;
  overflow: hidden; /* ADD THIS */
  contain: layout;
  position: relative;
}

#breakeven-chart {
  max-width: 100%;
  width: 100% !important;
  height: 320px !important; /* ADD THIS */
}
  #breakeven-wrap {
  max-width: 780px;
  margin-inline: auto;
  overflow: hidden !important; /* Force hide overflow */
  contain: layout;
  position: relative;
}

#breakeven-chart {
  max-width: 100%;
  width: 100% !important;
  height: 320px !important;
  display: block;
}

/* Prevent infinite scroll on drink inputs table */
.drinks-table-wrap,
.drinks-grid {
  overflow-x: auto; /* Allow horizontal scroll if needed */
  overflow-y: visible;
  max-width: 100%;
}

/* Last input shouldn't cause infinite scroll */
[data-input="spirits"] {
  margin-bottom: 0;
}
</style>

<!-- Inline calculator-specific styles (replaces calculator.css) -->
<style>
/* Additional calculator-specific styles that were in calculator.css */
.coffee-card-explainer{
  background:#fef3c7;
  border:2px solid #f59e0b;
  border-radius:10px;
  padding:1rem;
  margin:1rem 0;
}
.coffee-card-explainer h4{
  margin-top:0;
  color:#92400e;
}
.coffee-card-explainer .punch-info{
  display:grid;
  gap:.5rem;
  font-size:.9rem;
  margin:.75rem 0;
}
.coffee-card-explainer .punch-row{
  display:grid;
  grid-template-columns:auto 1fr;
  gap:.5rem;
  align-items:center;
}
.coffee-card-explainer .punch-badge{
  display:inline-block;
  background:#f59e0b;
  color:#fff;
  padding:.2rem .5rem;
  border-radius:6px;
  font-weight:700;
  font-size:.85rem;
}
</style>
</head>

<body>
<noscript>
  <div style="position:fixed;top:0;left:0;right:0;z-index:10000;padding:1rem;background:#fef3c7;border-bottom:3px solid #f59e0b;text-align:center;font-weight:700">
    ‚ö†Ô∏è This calculator requires JavaScript. Please enable it and reload.
  </div>
</noscript>

<a href="#content" class="skip-link">Skip to main content</a>

<!-- ARIA Live Regions -->
<div id="a11y-status" role="status" aria-live="polite" aria-atomic="true" class="sr-only"></div>
<div id="a11y-alerts" role="alert" aria-live="assertive" aria-atomic="true" class="sr-only"></div>

<!-- HEADER -->
<header class="hero-header" role="banner">
  <div class="navbar">
    <div class="brand">
      <img src="/assets/logo_wake.png?v=10.0.0" width="256" height="64" alt="In the Wake wordmark">
      <span class="tiny version-badge">v10.0.0</span>
    </div>

    <nav class="itw-nav" aria-label="Primary">
      <div class="nav-item"><a class="chip" href="/">Home</a></div>

      <div class="nav-item" data-dropdown>
        <button class="chip" type="button" aria-expanded="false" aria-haspopup="true">
          Planning <span class="caret">‚ñæ</span>
        </button>
        <div class="menu" role="menu">
          <div class="label tiny">Plan your cruise</div>
          <a href="/planning.html" role="menuitem">Planning (overview)</a>
          <a href="/ports.html" role="menuitem">Ports</a>
          <a href="/restaurants.html" role="menuitem">Restaurants & Menus</a>
          <a href="/ships.html" role="menuitem">Ships</a>
          <a href="/drink-packages.html" role="menuitem">Drink Packages</a>
          <a href="/cruise-lines.html" role="menuitem">Cruise Lines</a>
          <a href="/packing-lists.html" role="menuitem">Packing Lists</a>
          <a href="/accessibility.html" role="menuitem">Accessibility</a>
        </div>
      </div>

      <div class="nav-item" data-dropdown>
        <button class="chip" type="button" aria-expanded="false" aria-haspopup="true">
          Travel <span class="caret">‚ñæ</span>
        </button>
        <div class="menu" role="menu">
          <div class="label tiny">On the move</div>
          <a href="/travel.html" role="menuitem">Travel (overview)</a>
          <a href="/solo.html" role="menuitem">Solo</a>
        </div>
      </div>

      <div class="nav-item"><a class="chip" href="/about-us.html">About</a></div>
    </nav>
  </div>

  <div class="hero" role="img" aria-label="Ship wake at sunrise">
    <img class="hero-compass" src="/assets/compass_rose.svg?v=10.0.0" width="180" height="180" alt="" aria-hidden="true">
    <div class="hero-title">
      <img class="logo" src="/assets/logo_wake.png?v=10.0.0" width="560" height="144" alt="In the Wake">
      <div class="tagline">A Cruise Traveler's Logbook</div>
    </div>
    <div class="hero-credit">
      <a class="pill" href="https://www.flickersofmajesty.com" target="_blank" rel="noopener">Photo ¬© Flickers of Majesty</a>
    </div>
  </div>
</header>

<main class="wrap calculator-grid" id="content">
  <!-- LEFT -->
  <div>
    <div class="loading" id="loading-state">
      <span>Loading calculator</span>
    </div>
    
    <section id="calculator-app" style="display:none;">
      <h1>Royal Caribbean Drink Package Calculator</h1>
      
      <div class="banner" role="status" aria-live="polite">
        <span id="best-chip" class="badge">Calculating...</span>
        <span id="best-text" class="small"></span>
      </div>
      
      <p id="fallback-banner" hidden class="small" style="background:#fff7ed;border:1px solid #fed7aa;border-radius:6px;padding:.5rem">
        ‚ö†Ô∏è Live prices unavailable; using defaults
      </p>

      <p id="offline-rates-chip" hidden class="small" style="background:#fef3c7;border:1px solid #fcd34d;border-radius:6px;padding:.5rem">
        ‚ö†Ô∏è Offline exchange rates (may be stale)
      </p>
      
      <!-- Quiz CTA -->
      <div class="card" style="background:#e0f2fe;border-color:#0284c7">
        <h3 style="margin-top:0">üéØ Not sure what you drink?</h3>
        <p class="small">Take our 60-second quiz to get personalized recommendations.</p>
        <button class="btn" type="button" id="quiz-open-btn">Start Quiz</button>
      </div>
      
      <section class="card inputs">
        <h2>
          <span id="totals">Calculating...</span>
          <small class="tiny"> ‚Äî includes 18% gratuity</small>
        </h2>
        
        <!-- Currency -->
        <div class="controls-inline">
          <label for="currency-select">Display currency</label>
          <select id="currency-select">
            <option value="USD">USD $</option>
            <option value="GBP">GBP ¬£</option>
            <option value="EUR">EUR ‚Ç¨</option>
            <option value="CAD">CAD $</option>
            <option value="AUD">AUD $</option>
          </select>
          <span id="fx-note" class="tiny muted"></span>
        </div>
        
        <hr style="border:0;border-top:1px dashed var(--bd);margin:12px 0"/>
        
        <!-- Presets -->
        <div class="controls-inline" style="margin-bottom:12px">
          <strong class="small">Quick presets:</strong>
          <button class="btn ghost" data-preset="light">Light Drinker</button>
          <button class="btn ghost" data-preset="moderate">Moderate</button>
          <button class="btn ghost" data-preset="party">Party Mode</button>
          <button class="btn ghost" data-preset="coffee">Coffee Lover</button>
          <button class="btn ghost" data-preset="nonalc">Non-Alcoholic</button>
        </div>
        <div id="preset-explanation" style="display:none;margin-top:1rem;background:#e6f4f8;border:2px solid #0e6e8e;border-radius:10px;padding:1rem;">
5  <h4 style="margin-top:0;">üìã <span id="preset-name">Preset</span> Breakdown</h4>
6  <p class="small" id="preset-desc" style="color:#456;"></p>
7  <div id="preset-drinks" style="display:grid;gap:.5rem;margin-top:.75rem;"></div>
8  <p class="tiny muted" style="margin-top:.75rem;border-top:1px dashed #cbd5e1;padding-top:.75rem;">
9    <strong>üí° Tip:</strong> These are averages. Adjust any field above to match your exact preferences.
10  </p>
11</div>
        <hr style="border:0;border-top:1px dashed var(--bd);margin:12px 0"/>
        
        <!-- Basic Inputs -->
        <div class="row">
          <label for="input-days">Cruise days</label>
          <input id="input-days" type="text" inputmode="numeric" value="7" data-input="days">
        </div>
        
        <div class="row">
          <label for="input-seadays">Sea days</label>
          <input id="input-seadays" type="text" inputmode="numeric" value="3" data-input="seadays">
        </div>
        
        <!-- Sea Day Weighting -->
        <details open>
          <summary style="cursor:pointer;font-weight:700;margin:12px 0">Sea/Port Variability</summary>
          <div class="row">
            <label>
              <input type="checkbox" id="sea-toggle" checked data-input="seaapply">
              Apply weighting
            </label>
            <div class="controls-inline">
              <label for="sea-weight">¬±%</label>
              <input id="sea-weight" type="range" min="0" max="40" value="20" data-input="seaweight">
              <span id="sea-weight-val">20%</span>
            </div>
          </div>
        </details>
        
        <!-- Group -->
        <details open>
          <summary style="cursor:pointer;font-weight:700;margin:12px 0">Group in stateroom</summary>
          <div class="row">
            <label for="input-adults">Adults (21+)</label>
            <input id="input-adults" type="text" inputmode="numeric" value="1" data-input="adults">
          </div>
          <div class="row">
            <label for="input-minors">Minors (under 21)</label>
            <input id="input-minors" type="text" inputmode="numeric" value="0" data-input="minors">
          </div>
        </details>
        
        <!-- Vouchers (Crown & Anchor) -->
        <!-- ENHANCED CROWN & ANCHOR VOUCHERS SECTION -->
<!-- Replace your existing Crown & Anchor section with this -->

<details id="cna-vouchers">
  <summary style="cursor:pointer;font-weight:700;margin:12px 0">
    üëë Crown & Anchor Vouchers
    <span class="badge" style="background:#d4af37;color:#000;margin-left:.5rem;font-size:.8rem;">Diamond+ Members</span>
  </summary>
  
  <div class="banner" style="background:#fff9e6;border:2px solid #d4af37;margin:.75rem 0;">
    <h4 style="margin-top:0;color:#a67c00;">üíé Loyalty Drink Vouchers</h4>
    <p class="small"><strong>Got 80+ cruise nights?</strong> You're probably Diamond or higher! These vouchers add up FAST.</p>
    
    <div style="display:grid;gap:.75rem;margin:1rem 0;">
      <!-- Diamond Tier -->
      <div style="background:#fff;border:2px solid #d4af37;border-radius:8px;padding:.75rem;">
        <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.25rem;">
          <span style="font-size:1.2rem;">üíé</span>
          <strong style="color:#6b5d00;font-size:1rem;">Diamond</strong>
          <span class="tiny muted">(80-174 nights)</span>
        </div>
        <p class="small" style="margin:.25rem 0;"><strong style="color:#d4af37;">4 drink vouchers per day</strong>, loaded on your SeaPass</p>
        <p class="tiny muted" style="margin:.25rem 0;">= $32/day in free drinks ($224/week cruise)</p>
      </div>
      
      <!-- Diamond Plus Tier -->
      <div style="background:#fff;border:2px solid #c9b037;border-radius:8px;padding:.75rem;">
        <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.25rem;">
          <span style="font-size:1.2rem;">üíéüíé</span>
          <strong style="color:#8b6914;font-size:1rem;">Diamond Plus</strong>
          <span class="tiny muted">(175-699 nights)</span>
        </div>
        <p class="small" style="margin:.25rem 0;"><strong style="color:#c9b037;">5 drink vouchers per day</strong>, loaded on your SeaPass</p>
        <p class="tiny muted" style="margin:.25rem 0;">= $40/day in free drinks ($280/week cruise)</p>
      </div>
      
      <!-- Pinnacle Tier -->
      <div style="background:#fff;border:2px solid #b8860b;border-radius:8px;padding:.75rem;">
        <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.25rem;">
          <span style="font-size:1.2rem;">üëë</span>
          <strong style="color:#654321;font-size:1rem;">Pinnacle</strong>
          <span class="tiny muted">(700+ nights)</span>
        </div>
        <p class="small" style="margin:.25rem 0;"><strong style="color:#b8860b;">5 drink vouchers per day</strong>, loaded on your SeaPass</p>
        <p class="tiny muted" style="margin:.25rem 0;">= $40/day in free drinks ($280/week cruise)</p>
      </div>
    </div>
    
    <div style="background:#fffacd;border:1px solid #d4af37;border-radius:6px;padding:.75rem;margin-top:1rem;">
      <p class="small" style="margin:0;"><strong>üí° Pro tip:</strong> If you're not sure whether you're Diamond, you're probably not (yet!). Check your Crown & Anchor number on royal caribbean.com or the app.</p>
      <p class="tiny muted" style="margin:.5rem 0 0;">Each voucher = <strong>$8.00</strong> toward any beverage (alcoholic or non-alcoholic).</p>
    </div>
  </div>
  
  <!-- Voucher Inputs -->
  <div class="row">
    <label for="input-voucher-adult">
      Adult vouchers/day
      <span class="tiny muted">(4 for Diamond, 5 for Diamond+/Pinnacle)</span>
    </label>
    <input id="input-voucher-adult" type="text" inputmode="numeric" value="0" data-input="voucher-adult" min="0" max="10" placeholder="0-5">
  </div>
  
  <div class="row">
    <label for="input-voucher-minor">
      Minor vouchers/day
      <span class="tiny muted">(rarely applicable)</span>
    </label>
    <input id="input-voucher-minor" type="text" inputmode="numeric" value="0" data-input="voucher-minor" min="0" max="10" placeholder="0">
  </div>
  
  <!-- Deluxe Cap Info -->
  <p class="tiny muted" style="margin-top:1rem;">
    <strong>Deluxe package cap:</strong> 
    <span id="cap-badge" style="display:inline-block;padding:.2rem .4rem;background:#fef3c7;border:1px solid #fcd34d;border-radius:4px;font-weight:700">$14.00</span>
    <span> per drink before gratuity. Drinks over this, you pay the difference.</span>
  </p>
</details>
        
        <!-- Coffee Card Option -->
        <details id="coffee-card-section">
          <summary style="cursor:pointer;font-weight:700;margin:12px 0">
            ‚òï Coffee Card Option
            <span class="tiny muted">(alternative to packages)</span>
          </summary>
          
          <div class="coffee-card-explainer">
            <h4>‚òï Caf√© Select Coffee Card</h4>
            <p class="small">Prepaid punch card for 15 specialty coffees at ~$31 + gratuity</p>
            
            <div class="punch-info">
              <div class="punch-row">
                <span class="punch-badge">1 PUNCH</span>
                <span>Small espresso drinks, hot chocolate</span>
              </div>
              <div class="punch-row">
                <span class="punch-badge">2 PUNCHES</span>
                <span>Large drinks, iced beverages, extra shots</span>
              </div>
            </div>
            
            <p class="tiny muted"><strong>Note:</strong> Card can be shared among cabin guests. Not valid at licensed Starbucks stores but works at "We Proudly Serve" Starbucks locations. Unused punches roll over to future cruises. Can save up to 50% vs. paying individually.</p>
          </div>
          
          <div class="row">
            <label for="input-coffee-cards">Coffee Cards</label>
            <input id="input-coffee-cards" type="text" inputmode="numeric" value="0" data-input="coffee-cards" min="0">
          </div>
          
          <div class="row">
            <label for="input-coffee-punches-per-day">Avg punches/day</label>
            <input id="input-coffee-punches-per-day" type="text" inputmode="decimal" value="0" data-input="coffee-punches" min="0" max="5" step="0.5">
          </div>
        </details>
        
        <!-- Drinks -->
        <details open>
          <summary style="cursor:pointer;font-weight:700;margin:12px 0">Daily drinks (average)</summary>
          <div class="row"><label>Soda</label><input data-input="soda" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Specialty coffee</label><input data-input="coffee" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Premium tea</label><input data-input="teaprem" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Fresh juice</label><input data-input="freshjuice" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Mocktail</label><input data-input="mocktail" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Energy drink</label><input data-input="energy" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Milkshake</label><input data-input="milkshake" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Bottled water</label><input data-input="bottledwater" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Beer</label><input data-input="beer" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Wine</label><input data-input="wine" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Cocktail</label><input data-input="cocktail" type="text" inputmode="decimal" value="0"></div>
          <div class="row"><label>Spirits</label><input data-input="spirits" type="text" inputmode="decimal" value="0"></div>
        </details>
        
        <!-- Chart -->
        <div id="breakeven-wrap" style="margin-top:18px">
          <div id="best-stamp" aria-hidden="true">Best value</div>
          <canvas id="breakeven-chart" aria-describedby="chart-desc"></canvas>
          
          <!-- Screen Reader Table -->
          <table id="chart-desc" class="sr-only">
            <caption>Daily cost comparison</caption>
            <thead><tr><th>Option</th><th>Cost per day</th></tr></thead>
            <tbody>
              <tr><td>√Ä-la-carte</td><td id="sr-alc">$0.00</td></tr>
              <tr><td>Coffee Card</td><td id="sr-coffee">$0.00</td></tr>
              <tr><td>Soda</td><td id="sr-soda">$0.00</td></tr>
              <tr><td>Refreshment</td><td id="sr-refresh">$0.00</td></tr>
              <tr><td>Deluxe</td><td id="sr-deluxe">$0.00</td></tr>
            </tbody>
          </table>
          
          <div id="range-note" class="tiny muted"></div>
          <p class="tiny muted" style="margin-top:.5rem">
            <strong>How to read this chart:</strong> Lower bar = better value for your drinking habits.
          </p>
        </div>
        
        <!-- Policy Note -->
        <div id="policy-note" class="banner" hidden style="background:#fef3c7;border-color:#fcd34d">
          <strong>‚ö†Ô∏è Royal Caribbean Policy:</strong>
          <span id="policy-text"></span>
        </div>
        
        <!-- Category Breakdown -->
        <div id="category-breakdown" class="category-summary" hidden>
          <h4 style="margin-top:0">üí∞ Where Your Money Goes (per day)</h4>
          <div class="category-grid" id="category-grid"></div>
        </div>
        
        <!-- Actions -->
        <div class="controls-inline" style="margin-top:16px">
          <button class="btn" type="button" onclick="window.print()">Print Results</button>
          <button class="btn ghost" type="button" id="share-btn">Share</button>
          <button class="btn" type="button" id="reset-btn">Reset</button>
        </div>
      </section>
      
      <!-- Group Breakdown -->
      <section class="card" id="group-breakdown" hidden>
        <h2>Group Breakdown (Per Person)</h2>
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#f1f5f9"><th style="padding:.5rem;text-align:left">Traveler</th><th style="padding:.5rem">Package</th><th style="padding:.5rem">Daily</th><th style="padding:.5rem">Trip</th></tr>
          </thead>
          <tbody id="group-table-body"></tbody>
        </table>
      </section>

      <!-- Email CTA -->
      <section class="card" id="email-cta" hidden style="background:#e0f2fe;border-color:#0284c7">
        <h3 style="margin-top:0">üìß Save Your Results</h3>
        <p class="small">Get this breakdown emailed for easy reference later.</p>
        <form id="email-form" style="display:grid;gap:.5rem">
          <input type="email" name="email" placeholder="you@example.com" required style="padding:.5rem;border:1px solid var(--bd);border-radius:6px">
          <input type="hidden" name="savings" id="email-savings">
          <input type="hidden" name="recommendation" id="email-rec">
          <input type="hidden" name="days" id="email-days">
          <button class="btn" type="submit">Email Me</button>
        </form>
      </section>
    </section>
  </div>

  <!-- RIGHT RAIL -->
  <aside class="rail" role="complementary">
    <!-- Package Cards -->
    <section>
      <h3>Package Comparison</h3>
      
      <div class="package-card" data-card="coffee">
        <h4>‚òï Coffee Card</h4>
        <div class="price" data-pkg-price="coffee">$31.00</div>
        <p class="small">15 punches (~$2.07/punch)</p>
        <p class="tiny muted">Specialty coffees, sharable</p>
      </div>
      
      <div class="package-card" data-card="soda">
        <h4>Classic Soda</h4>
        <div class="price" data-pkg-price="soda">$13.99</div>
        <p class="small">per person, per day</p>
        <p class="tiny muted">Fountain soda, Coca-Cola Freestyle</p>
        <div class="tiny" data-inc="soda">Includes: $0/day</div>
      </div>
      
      <div class="package-card" data-card="refresh">
        <h4>Refreshment</h4>
        <div class="price" data-pkg-price="refresh">$34.00</div>
        <p class="small">per person, per day</p>
        <p class="tiny muted">Non-alcoholic specialty drinks</p>
        <div class="tiny" data-inc="refresh">Includes: $0/day</div>
      </div>
      
      <div class="package-card" data-card="deluxe">
        <h4>Deluxe (Alcoholic)</h4>
        <div class="price" data-pkg-price="deluxe">$85.00</div>
        <p class="small">per person, per day</p>
        <p class="tiny muted">Cocktails, beer, wine up to $14/drink</p>
        <div class="tiny" data-inc="deluxe">Includes: $0/day</div>
        <div class="tiny" id="overcap-est" style="color:#dc2626">Over-cap: $0/day</div>
      </div>
    </section>
    
    <!-- Author -->
    <section class="card" id="author-card">
      <h3>About the Author</h3>
      <div style="display:flex;gap:.75rem;align-items:center">
        <a href="/authors/ken-baker.html" style="flex:0 0 72px">
          <picture>
            <source srcset="/authors/img/ken1.webp?v=10.0.0" type="image/webp">
            <img class="author-avatar" src="/authors/img/ken1.jpg?v=10.0.0" width="72" height="72" alt="Ken Baker">
          </picture>
        </a>
        <div>
          <h4 style="margin:0 0 .25rem"><a href="/authors/ken-baker.html">Ken Baker</a></h4>
          <p class="tiny" style="margin:0">Founder of In the Wake; writer and editor of the logbook.</p>
          <p class="tiny" style="margin:.25rem 0 0">
            <a href="https://www.flickersofmajesty.com" target="_blank" rel="noopener">Flickers of Majesty</a>
          </p>
        </div>
      </div>
    </section>

    <!-- Recent Articles -->
    <section class="card">
      <h3>Recent Articles</h3>
      <div id="recent-rail" class="rail-list"></div>
      <p id="recent-rail-fallback" class="tiny" style="display:none">Loading articles‚Ä¶</p>
    </section>
  </aside>
</main>

<!-- Quiz Modal -->
<!-- REPLACE the existing quiz-modal div with this improved version -->
<!-- It has working step navigation, skip button, and better UX -->

<div id="quiz-modal" class="modal">
  <div class="modal-content" style="position:relative;">
    <button class="modal-close" id="quiz-close-btn" aria-label="Close quiz">&times;</button>
    
    <div id="quiz-content">
      <h2 style="margin-top:0;">Find Your Perfect Package üéØ</h2>
      <p class="small" style="color:#64748b;margin-bottom:1.5rem;">Answer 3 quick questions to get a personalized recommendation</p>
      
      <!-- Step 1 -->
      <div id="quiz-step-1" class="quiz-step">
        <p><strong>Question 1 of 3:</strong> What type of cruise are you taking?</p>
        <div class="controls-inline" style="flex-direction:column;align-items:stretch;gap:.75rem;margin-top:1rem;">
          <button class="btn ghost" data-quiz-answer="family" style="text-align:left;padding:1rem;">
            <strong>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Vacation</strong><br>
            <span class="tiny">Traveling with kids and family</span>
          </button>
          <button class="btn ghost" data-quiz-answer="party" style="text-align:left;padding:1rem;">
            <strong>üéâ Party / Celebration</strong><br>
            <span class="tiny">Bachelor/bachelorette, birthday, or friends trip</span>
          </button>
          <button class="btn ghost" data-quiz-answer="romantic" style="text-align:left;padding:1rem;">
            <strong>üíë Romantic Getaway</strong><br>
            <span class="tiny">Couples cruise, honeymoon, or anniversary</span>
          </button>
          <button class="btn ghost" data-quiz-answer="solo" style="text-align:left;padding:1rem;">
            <strong>üß≥ Solo Adventure</strong><br>
            <span class="tiny">Traveling alone and meeting new people</span>
          </button>
        </div>
      </div>
      
      <!-- Step 2 -->
      <div id="quiz-step-2" class="quiz-step" style="display:none;">
        <p><strong>Question 2 of 3:</strong> How much do you typically drink per day?</p>
        <div class="controls-inline" style="flex-direction:column;align-items:stretch;gap:.75rem;margin-top:1rem;">
          <button class="btn ghost" data-quiz-answer="light" style="text-align:left;padding:1rem;">
            <strong>ü•§ Light (1-2 drinks)</strong><br>
            <span class="tiny">Occasional sipper, mostly water/soda</span>
          </button>
          <button class="btn ghost" data-quiz-answer="moderate" style="text-align:left;padding:1rem;">
            <strong>üç∑ Moderate (3-4 drinks)</strong><br>
            <span class="tiny">Social drinker, wine with dinner</span>
          </button>
          <button class="btn ghost" data-quiz-answer="heavy" style="text-align:left;padding:1rem;">
            <strong>üçª Heavy (5+ drinks)</strong><br>
            <span class="tiny">Party mode, multiple drinks per day</span>
          </button>
        </div>
      </div>
      
      <!-- Step 3 -->
      <div id="quiz-step-3" class="quiz-step" style="display:none;">
        <p><strong>Question 3 of 3:</strong> What's your beverage preference?</p>
        <div class="controls-inline" style="flex-direction:column;align-items:stretch;gap:.75rem;margin-top:1rem;">
          <button class="btn ghost" data-quiz-answer="cocktails" style="text-align:left;padding:1rem;">
            <strong>üçπ Cocktails</strong><br>
            <span class="tiny">Margaritas, pi√±a coladas, mixed drinks</span>
          </button>
          <button class="btn ghost" data-quiz-answer="beer-wine" style="text-align:left;padding:1rem;">
            <strong>üç∫ Beer & Wine</strong><br>
            <span class="tiny">Casual drinks, not fancy cocktails</span>
          </button>
          <button class="btn ghost" data-quiz-answer="coffee" style="text-align:left;padding:1rem;">
            <strong>‚òï Coffee & Specialty Drinks</strong><br>
            <span class="tiny">Lattes, cappuccinos, mocktails</span>
          </button>
          <button class="btn ghost" data-quiz-answer="nonalc" style="text-align:left;padding:1rem;">
            <strong>üö´ Non-Alcoholic Only</strong><br>
            <span class="tiny">Soda, juice, mocktails, no alcohol</span>
          </button>
        </div>
      </div>
      
      <!-- Result -->
      <div id="quiz-result" class="quiz-step" style="display:none;">
        <div style="background:#e6f4f8;border:2px solid #0e6e8e;border-radius:10px;padding:1.5rem;margin:1rem 0;">
          <h3 style="margin-top:0;color:#0a3d62;">‚ú® Your Recommendation</h3>
          <p id="quiz-recommendation" style="font-size:1.1rem;line-height:1.6;"></p>
        </div>
        <button class="btn" id="quiz-apply-btn" style="width:100%;margin-top:1rem;">Apply These Settings & Calculate</button>
      </div>
      
      <!-- Skip button always visible -->
      <div style="margin-top:1.5rem;padding-top:1rem;border-top:1px solid #e5e7eb;text-align:center;">
        <button class="btn ghost" id="quiz-skip-btn" style="background:transparent;border:0;text-decoration:underline;color:#64748b;">
          Skip quiz ‚Äî I'll enter my own drinks
        </button>
      </div>
    </div>
  </div>
</div>

<footer class="wrap" role="contentinfo" style="border-top:2px solid var(--bd);padding-top:1.5rem;text-align:center">
  <p>¬© 2025 In the Wake. All rights reserved.</p>
  <p class="tiny"><a href="/terms.html">Terms</a> | <a href="/privacy.html">Privacy</a></p>
  <p class="tiny">Soli Deo Gloria ‚Äî every pixel offered in worship to God.</p>
</footer>

<!-- JAVASCRIPT - FIXED PATHS -->

<!-- JAVASCRIPT - FIXED LOAD ORDER -->

<!-- 1. Math module (needs type="module") -->
<script src="/assets/js/calculator-math.js" type="module"></script>

<!-- 2. Core app -->
<script src="/assets/js/drink-calculator.app.js" defer></script>

<!-- 3. UI bridge (MUST come before UI) -->
<script src="/assets/js/calculator.ui-bridge.js" defer></script>

<!-- 4. UI layer -->
<script src="/assets/js/calculator-ui.js" defer></script>

<!-- ============================================
     INTEGRATED FUNCTIONALITY SCRIPTS
     Consolidated from multiple inline scripts
     ============================================ -->

<!-- NAV DROPDOWN BEHAVIOR -->
<script>
(function(){
  const items = document.querySelectorAll('[data-dropdown]');
  if(!items.length) return;

  function closeAll(except){
    items.forEach(item => {
      if(item === except) return;
      item.classList.remove('open');
      const btn = item.querySelector('button');
      if(btn) btn.setAttribute('aria-expanded', 'false');
    });
  }

  items.forEach(item => {
    const btn = item.querySelector('button');
    const menu = item.querySelector('.menu');
    if(!btn || !menu) return;

    btn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const isOpen = item.classList.contains('open');
      closeAll(item);
      if(!isOpen){
        item.classList.add('open');
        btn.setAttribute('aria-expanded', 'true');
      }
    });

    document.addEventListener('click', (e) => {
      if(!item.contains(e.target)){
        item.classList.remove('open');
        btn.setAttribute('aria-expanded', 'false');
      }
    });

    btn.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){
        item.classList.remove('open');
        btn.setAttribute('aria-expanded', 'false');
        btn.focus();
      }
    });
  });
  
  console.log('[Nav] ‚úì Dropdown behavior initialized');
})();
</script>

<!-- CHART SIZING & SCROLL PREVENTION -->
<script>
(function(){
  const wrap = document.getElementById('breakeven-wrap');
  const canvas = document.getElementById('breakeven-chart');
  
  if(!wrap || !canvas) return;
  
  // Prevent infinite scrolling
  wrap.style.overflow = 'hidden';
  wrap.style.maxWidth = '780px';
  wrap.style.contain = 'layout';
  
  canvas.removeAttribute('width');
  canvas.removeAttribute('height');

  function tuneChart(c){
    try{
      if (!c || !c.options) return;
      c.options.responsive = true;
      c.options.maintainAspectRatio = false;
      c.resize();
    }catch(_){}
  }

  function tryHook(){
    const c = (window.ITW && window.ITW.chart) || canvas.__chartist || canvas._chart || null;
    if (c && typeof c.resize === 'function'){ tuneChart(c); return true; }
    return false;
  }

  const resizeChart = () => {
    const wrapWidth = wrap.clientWidth;
    canvas.style.width = wrapWidth + 'px';
    canvas.style.height = '320px';
    
    if(window.ITW && window.ITW.chart && typeof window.ITW.chart.resize === 'function') {
      window.ITW.chart.resize();
    }
  };

  tryHook();
  resizeChart();

  let tries = 0;
  const t = setInterval(()=>{ if (tryHook() || ++tries > 20) clearInterval(t); }, 150);

  new ResizeObserver(()=>{ tryHook(); }).observe(wrap);
  window.addEventListener('resize', resizeChart);
  
  console.log('[Chart] ‚úì Sizing and scroll prevention active');
})();
</script>

<!-- WINNER RING & BEST VALUE STAMP -->
<script>
(function(){
  const cv = document.getElementById('breakeven-chart');
  const stamp = document.getElementById('best-stamp');
  if (!cv || !stamp) return;

  const WINNER = { idx: null };
  const ringPlugin = {
    id: 'itwWinnerRing',
    afterDatasetsDraw(chart, _args, _opts){
      if (WINNER.idx==null) return;
      const ctx = chart.ctx;
      let el = null;
      chart.data.datasets.some(ds=>{
        const m = chart.getDatasetMeta(chart.data.datasets.indexOf(ds));
        const e = (m && m.data && m.data[WINNER.idx]) ? m.data[WINNER.idx] : null;
        if (e){ el = e; return true; }
      });
      if (!el || !el.x || !el.y || !el.width) return;
      const {x, y, width, height} = el.getProps(['x','y','width','height'], true);
      ctx.save();
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 4;
      ctx.setLineDash([6,4]);
      const pad = 6;
      ctx.strokeRect(x - width/2 - pad, y - height - pad, width + pad*2, height + pad*2);
      ctx.restore();
    }
  };

  function pickWinner(chart){
    const ds = chart.data.datasets || [];
    const N = (ds[0]?.data?.length) || 0;
    let best = {labelIdx:null, value:Infinity};

    for(let i=0;i<N;i++){
      let minAtI = Infinity;
      ds.forEach(d => {
        const v = (Array.isArray(d.data) && typeof d.data[i]==='number') ? d.data[i] : Infinity;
        if (v > 0 && v < minAtI) minAtI = v;
      });
      if (minAtI < best.value){ best = {labelIdx:i, value:minAtI}; }
    }
    WINNER.idx = best.labelIdx;
    if (WINNER.idx==null){ stamp.style.display='none'; return; }

    stamp.style.display = '';
  }

  function hookChart(){
    const chart = (window.ITW && window.ITW.chart) || cv._chart || cv.__chartist || null;
    if (!chart || !chart.data) return false;
    if (!chart.config.plugins) chart.config.plugins = [];
    if (!chart.config.plugins.includes(ringPlugin)) chart.config.plugins.push(ringPlugin);
    pickWinner(chart);
    chart.update();
    if (!window.addEventListener._itwWinnerBound){
      document.addEventListener('itw:calc-updated', ()=>{ try{ pickWinner(chart); chart.update(); }catch(_){}} );
      window.addEventListener._itwWinnerBound = true;
    }
    return true;
  }

  let attempts = 0;
  const t = setInterval(()=>{ if (hookChart() || ++attempts>20) clearInterval(t); }, 150);
  
  console.log('[Winner Ring] ‚úì Initialized');
})();
</script>

<!-- RECENT ARTICLES WITH IMAGE FALLBACK -->
<script>
(async function(){
  const rail = document.getElementById('recent-rail');
  const fallback = document.getElementById('recent-rail-fallback');
  if(!rail) return;

  const FORCE_IMG = "https://cruisinginthewake.com/assets/articles/top-20-questions/cover.jpg";
  
  function normalizePath(u){
    try{
      const url = new URL(u, location.href);
      let p = url.pathname.toLowerCase();
      p = p.replace(/\/index\.html$/,'/');
      p = p.replace(/^\/(solo|travel)\/articles\/([a-z0-9\-]+)\.html$/,'/$1/$2.html');
      p = p.replace(/\/+$/,'/');
      return p;
    }catch(_){ return String(u||"").toLowerCase(); }
  }
  
  function isTop20(href){
    const p = normalizePath(href);
    return /\/articles\/top-20-questions\/$/.test(p) || /top-20/.test(p);
  }

  try{
    const res = await fetch('/assets/data/articles/index.json?v=10.0.0', {cache:'no-cache'});
    if(!res.ok) throw new Error('Failed');
    const data = await res.json();
    const items = (data.articles || data || []).slice(0,6);
    
    rail.innerHTML = items.map(item => {
      const href = item.url || item.path || '#';
      const title = item.title || 'Article';
      let img = item.image || '/assets/index_hero.jpg?v=10.0.0';
      
      if(isTop20(href) || isTop20(title)){
        img = FORCE_IMG;
      }
      
      return `
        <a class="card" style="display:grid;grid-template-columns:72px 1fr;gap:.6rem;align-items:center;text-decoration:none" href="${href}">
          <div style="width:72px;height:48px;overflow:hidden;border-radius:10px;background:#eef4f6">
            <img src="${img}" alt="" loading="lazy" style="width:100%;height:100%;object-fit:cover">
          </div>
          <div class="tiny" style="color:var(--ink)">${title}</div>
        </a>`;
    }).join('');
    
    if(fallback) fallback.style.display='none';
    console.log('[Recent Articles] ‚úì Loaded');
  }catch(e){
    if(fallback) fallback.style.display='';
    console.warn('[Recent Articles] Failed to load:', e);
  }
})();
</script>

<!-- PRESET BUTTONS -->
<script>
(function(){
  const PRESETS = {
    light: { soda:2, coffee:2, teaprem:1, freshjuice:2, mocktail:2, bottledwater:3, wine:1, cocktail:0.5, beer:0, spirits:0, energy:0, milkshake:0 },
    moderate: { soda:1, coffee:2, beer:2, wine:2, cocktail:2, bottledwater:2, teaprem:0, freshjuice:1, mocktail:0, energy:0, milkshake:0, spirits:0 },
    party: { soda:1, coffee:1, energy:1, beer:3, wine:1, cocktail:5, spirits:2, bottledwater:2, teaprem:0, freshjuice:0, mocktail:0, milkshake:0 },
    coffee: { coffee:4, teaprem:1, freshjuice:1, mocktail:1, wine:1, bottledwater:2, soda:0, beer:0, cocktail:1, spirits:0, energy:0, milkshake:0 },
    nonalc: { soda:2, coffee:3, teaprem:1, freshjuice:2, mocktail:2, milkshake:1, bottledwater:3, beer:0, wine:0, cocktail:0, spirits:0, energy:0 }
  };
  
  function initPresets() {
    if(!window.ITW || !window.ITW.store) {
      setTimeout(initPresets, 100);
      return;
    }
    
    document.querySelectorAll('[data-preset]').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.dataset.preset;
        const preset = PRESETS[key];
        if(!preset) return;
        
        console.log('[Presets] Applying:', key);
        
        const inputs = window.ITW.store.get('inputs');
        const drinks = {...inputs.drinks};
        
        Object.entries(preset).forEach(([k, v]) => {
          drinks[k] = v;
        });
        
        window.ITW.store.patch('inputs', {...inputs, drinks});
        
        if(window.ITW.scheduleCalc) {
          window.ITW.scheduleCalc();
        }
        
        const status = document.getElementById('a11y-status');
        if(status) {
          status.textContent = `Applied ${key} drinker preset`;
        }
        
        console.log('[Presets] ‚úì Applied', key);
      });
    });
    
    console.log('[Presets] ‚úì Ready');
  }
  
  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPresets);
  } else {
    initPresets();
  }
})();
</script>

<!-- PRESET EXPLANATION DISPLAY -->
<script>
(function(){
  const PRESET_INFO = {
    light: {
      name: 'Light Drinker ü•§',
      desc: 'Perfect for casual sippers who want some variety without overdoing it.',
      drinks: { soda: 2, coffee: 2, teaprem: 1, freshjuice: 2, mocktail: 2, bottledwater: 3, wine: 1, cocktail: 0.5 }
    },
    moderate: {
      name: 'Moderate Drinker üç∑',
      desc: 'Social drinking throughout the day - coffee in the morning, beers by the pool, wine with dinner.',
      drinks: { soda: 1, coffee: 2, beer: 2, wine: 2, cocktail: 2, bottledwater: 2, freshjuice: 1 }
    },
    party: {
      name: 'Party Mode üéâ',
      desc: 'Living it up! Morning coffee, energy drinks, multiple beers, cocktails, and spirits at night.',
      drinks: { soda: 1, coffee: 1, energy: 1, beer: 3, wine: 1, cocktail: 5, spirits: 2, bottledwater: 2 }
    },
    coffee: {
      name: 'Coffee Lover ‚òï',
      desc: 'All about specialty coffees and teas. Fresh juice, mocktails, and maybe some wine to relax.',
      drinks: { coffee: 4, teaprem: 1, freshjuice: 1, mocktail: 1, wine: 1, bottledwater: 2, cocktail: 1 }
    },
    nonalc: {
      name: 'Non-Alcoholic üö´üç∫',
      desc: 'Enjoying the cruise without alcohol! Sodas, coffees, juices, mocktails, milkshakes, and water.',
      drinks: { soda: 2, coffee: 3, teaprem: 1, freshjuice: 2, mocktail: 2, milkshake: 1, bottledwater: 3 }
    }
  };
  
  const DRINK_LABELS = {
    soda: 'Fountain Soda', coffee: 'Premium Coffee', teaprem: 'Specialty Tea',
    freshjuice: 'Fresh Juice/Smoothie', mocktail: 'Mocktail', energy: 'Energy Drink',
    milkshake: 'Milkshake', bottledwater: 'Bottled Water', beer: 'Beer',
    wine: 'Wine (glass)', cocktail: 'Cocktail', spirits: 'Spirits/Shot'
  };
  
  function showPresetExplanation(key) {
    const info = PRESET_INFO[key];
    if (!info) return;
    
    const explanation = document.getElementById('preset-explanation');
    const name = document.getElementById('preset-name');
    const desc = document.getElementById('preset-desc');
    const drinksDiv = document.getElementById('preset-drinks');
    
    if (!explanation || !name || !desc || !drinksDiv) return;
    
    name.textContent = info.name;
    desc.textContent = info.desc;
    
    drinksDiv.innerHTML = '';
    Object.entries(info.drinks).forEach(([drink, qty]) => {
      if (qty > 0) {
        const label = DRINK_LABELS[drink] || drink;
        const item = document.createElement('div');
        item.style.cssText = 'background:#fff;padding:.5rem .75rem;border-radius:6px;border:1px solid #cbd5e1;display:flex;justify-content:space-between;';
        item.innerHTML = `<span>${label}</span><span style="color:#0e6e8e;font-weight:700;">${qty} / day</span>`;
        drinksDiv.appendChild(item);
      }
    });
    
    explanation.style.display = 'block';
    setTimeout(() => explanation.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
  }
  
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-preset]');
    if (btn) {
      setTimeout(() => showPresetExplanation(btn.dataset.preset), 200);
    }
  });
  
  console.log('[Preset Explanation] ‚úì Ready');
})();
</script>

<!-- QUIZ MODAL -->
<script>
(function(){
  const modal = document.getElementById('quiz-modal');
  const openBtn = document.getElementById('quiz-open-btn');
  const closeBtn = document.getElementById('quiz-close-btn');
  const skipBtn = document.getElementById('quiz-skip-btn');
  const applyBtn = document.getElementById('quiz-apply-btn');
  
  if(!modal) return;
  
  let quizAnswers = { type: '', drinking: '', preference: '' };
  let currentStep = 1;
  
  function showStep(step) {
    document.querySelectorAll('.quiz-step').forEach(s => s.style.display = 'none');
    const stepEl = document.getElementById(`quiz-step-${step}`);
    if(stepEl) stepEl.style.display = 'block';
    currentStep = step;
  }
  
  function closeQuiz() {
    modal.classList.remove('active');
    quizAnswers = { type: '', drinking: '', preference: '' };
    setTimeout(() => showStep(1), 300);
  }
  
  function applyQuizResult() {
    const presets = {
      'family-light-nonalc': { soda:2, coffee:2, freshjuice:2, mocktail:1, bottledwater:3, beer:0, wine:0, cocktail:0, spirits:0 },
      'party-heavy-cocktails': { coffee:1, beer:3, wine:1, cocktail:5, spirits:2, bottledwater:2 },
      'romantic-moderate-cocktails': { coffee:2, wine:3, cocktail:2, bottledwater:2 },
      'default': { soda:1, coffee:2, beer:2, wine:1, cocktail:2, bottledwater:2 }
    };
    
    const key = `${quizAnswers.type}-${quizAnswers.drinking}-${quizAnswers.preference}`;
    const preset = presets[key] || presets['default'];
    
    if(window.ITW && window.ITW.store) {
      const inputs = window.ITW.store.get('inputs');
      const drinks = {...inputs.drinks};
      
      Object.keys(drinks).forEach(k => drinks[k] = 0);
      Object.entries(preset).forEach(([k, v]) => { drinks[k] = v; });
      
      window.ITW.store.patch('inputs', {...inputs, drinks});
      
      if(window.ITW.scheduleCalc) {
        window.ITW.scheduleCalc();
      }
    }
    
    closeQuiz();
  }
  
  if(openBtn) openBtn.addEventListener('click', () => modal.classList.add('active'));
  if(closeBtn) closeBtn.addEventListener('click', closeQuiz);
  if(skipBtn) skipBtn.addEventListener('click', closeQuiz);
  if(applyBtn) applyBtn.addEventListener('click', applyQuizResult);
  
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-quiz-answer]');
    if(!btn || !modal.classList.contains('active')) return;
    
    const answer = btn.dataset.quizAnswer;
    
    if(currentStep === 1) {
      quizAnswers.type = answer;
      showStep(2);
    } else if(currentStep === 2) {
      quizAnswers.drinking = answer;
      showStep(3);
    } else if(currentStep === 3) {
      quizAnswers.preference = answer;
      
      const rec = document.getElementById('quiz-recommendation');
      if(rec) {
        rec.textContent = 'Based on your answers, we recommend trying the Deluxe Package for the best value!';
      }
      
      const resultStep = document.getElementById('quiz-result');
      if(resultStep) resultStep.style.display = 'block';
    }
  });
  
  modal.addEventListener('click', (e) => {
    if(e.target === modal) closeQuiz();
  });
  
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape' && modal.classList.contains('active')) {
      closeQuiz();
    }
  });
  
  console.log('[Quiz] ‚úì Ready');
})();
</script>

<!-- SHARE & RESET BUTTONS -->
<script>
(function(){
  const shareBtn = document.getElementById('share-btn');
  const resetBtn = document.getElementById('reset-btn');
  
  if(shareBtn){
    shareBtn.addEventListener('click', () => {
      if(window.ITW && window.ITW.shareScenario){
        window.ITW.shareScenario();
      } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
          alert('URL copied to clipboard!');
        });
      }
    });
  }
  
  if(resetBtn){
    resetBtn.addEventListener('click', () => {
      if(window.ITW && window.ITW.resetInputs){
        window.ITW.resetInputs();
      } else {
        location.reload();
      }
    });
  }
  
  console.log('[Share/Reset] ‚úì Buttons wired');
})();
</script>

<!-- SERVICE WORKER -->
<script>
(function(){
  if('serviceWorker' in navigator){
    const ver = '10.0.0';
    navigator.serviceWorker.register(`/sw.js?v=${ver}`).then(reg => {
      console.log('[SW] ‚úì Registered');
      navigator.serviceWorker.addEventListener('message', (e) => {
        if(e.data?.type === 'DATA_REFRESHED' && window.ITW?.refreshDataset){
          window.ITW.refreshDataset();
        }
      });
    }).catch(err => console.warn('[SW] Registration failed:', err));
  }
})();
</script>

  <!-- INPUT WIRING -->
<script>
(function() {
  function wireInputs() {
    if (!window.ITW || !window.ITW.store || !window.ITW.scheduleCalc) {
      setTimeout(wireInputs, 100);
      return;
    }
    
    const inputs = document.querySelectorAll('[data-input]');
    
    inputs.forEach(input => {
      input.addEventListener('change', () => {
        window.ITW.scheduleCalc();
      });
      
      input.addEventListener('blur', () => {
        window.ITW.scheduleCalc();
      });
    });
    
    console.log('[Input Wiring] ‚úì Wired', inputs.length, 'inputs');
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', wireInputs);
  } else {
    wireInputs();
  }
})();
</script>

<!-- ROBUST INITIALIZATION - REPLACES DEFAULTS + FORCE CALC -->
<script>
(function() {
  console.log('[Init] üîÑ Starting robust initialization...');
  
  let attempts = 0;
  const MAX_ATTEMPTS = 50;
  
  function initializeStore() {
    attempts++;
    
    // Wait for ITW and store
    if (!window.ITW?.store || typeof window.ITW.store.get !== 'function') {
      if (attempts < MAX_ATTEMPTS) {
        setTimeout(initializeStore, 100);
      } else {
        console.error('[Init] ‚ùå Store never loaded');
      }
      return;
    }
    
    console.log('[Init] ‚úì Store found');
    
    // Define complete default structure
    const DEFAULTS = {
      days: 7,
      seaDays: 3,
      adults: 2,
      minors: 0,
      seaApply: true,
      seaWeight: 20,
      coffeeCards: 0,
      coffeePunches: 0,
      voucherAdult: 0,
      voucherMinor: 0,
      drinks: {
        soda: 0,
        coffee: 0,
        teaprem: 0,
        freshjuice: 0,
        mocktail: 0,
        energy: 0,
        milkshake: 0,
        bottledwater: 0,
        beer: 0,
        wine: 0,
        cocktail: 0,
        spirits: 0
      }
    };
    
    // Get current state
    let current;
    try {
      current = window.ITW.store.get('inputs');
    } catch (e) {
      console.warn('[Init] Failed to get inputs:', e);
      current = null;
    }
    
    // Check if we need to initialize or repair
    const needsInit = !current 
      || typeof current !== 'object'
      || !current.drinks 
      || typeof current.drinks !== 'object'
      || current.days === undefined
      || current.days === 0;
    
    if (needsInit) {
      console.log('[Init] üî® Initializing with defaults...');
      
      try {
        // Use set instead of patch for initial load
        window.ITW.store.set('inputs', DEFAULTS);
        console.log('[Init] ‚úì Defaults set via .set()');
      } catch (e) {
        console.error('[Init] set() failed, trying patch:', e);
        try {
          window.ITW.store.patch('inputs', DEFAULTS);
          console.log('[Init] ‚úì Defaults set via .patch()');
        } catch (e2) {
          console.error('[Init] ‚ùå Both methods failed:', e2);
          return;
        }
      }
    } else {
      console.log('[Init] ‚úì Data already valid');
    }
    
    // Wait for store to settle, then trigger calculation
    setTimeout(triggerCalculation, 300);
  }
  
  function triggerCalculation() {
    console.log('[Init] üéØ Triggering calculation...');
    
    // Verify data one more time
    try {
      const inputs = window.ITW.store.get('inputs');
      if (!inputs?.drinks) {
        console.error('[Init] ‚ùå Data still broken after init');
        return;
      }
      console.log('[Init] ‚úì Data structure verified');
    } catch (e) {
      console.error('[Init] Verification failed:', e);
      return;
    }
    
    // Try scheduleCalc
    try {
      if (window.ITW?.scheduleCalc) {
        window.ITW.scheduleCalc();
        console.log('[Init] ‚úì scheduleCalc() called');
      }
    } catch (e) {
      console.error('[Init] scheduleCalc failed:', e);
    }
    
    // Also dispatch event
    setTimeout(() => {
      try {
        document.dispatchEvent(new CustomEvent('itw:calc-update'));
        console.log('[Init] ‚úì Event dispatched');
      } catch (e) {
        console.error('[Init] Event failed:', e);
      }
    }, 100);
    
    // And input change trigger
    setTimeout(() => {
      try {
        const daysInput = document.querySelector('[data-input="days"]');
        if (daysInput) {
          daysInput.dispatchEvent(new Event('change', { bubbles: true }));
          console.log('[Init] ‚úì Input change triggered');
        }
      } catch (e) {
        console.error('[Init] Input trigger failed:', e);
      }
    }, 200);
  }
  
  // Wire up input changes
  document.addEventListener('change', (e) => {
    if (e.target.hasAttribute('data-input')) {
      setTimeout(() => {
        if (window.ITW?.scheduleCalc) {
          window.ITW.scheduleCalc();
        }
      }, 50);
    }
  });
  
  // Start initialization after everything loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => setTimeout(initializeStore, 1500));
  } else {
    setTimeout(initializeStore, 1500);
  }
  
  console.log('[Init] ‚úì Initialization scheduled');
})();
</script>
<!-- Share Bar -->
<script src="https://cruisinginthewake.com/assets/js/share-bar.js?v=10.0.0"></script>
<!-- SHOW CALCULATOR AFTER LOAD -->
<script>
window.addEventListener('load', () => {
  setTimeout(() => {
    const loading = document.getElementById('loading-state');
    const app = document.getElementById('calculator-app');
    if(loading) loading.style.display = 'none';
    if(app) app.style.display = 'block';
    
    console.log('[App] ‚úì Calculator displayed');
  }, 500);
});
</script>

<!-- Soli Deo Gloria ¬∑ v10.0.0 -->
</body>
</html>
