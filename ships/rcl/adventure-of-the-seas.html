// Logbook (robust fetch + schema tolerance)
(async function initLogbook(){
  const mount = document.getElementById('logbook'); if(!mount) return;

  const JSON_URLS = [
    'https://www.cruisinginthewake.com/ships/rcl/assets/adventure.json',
    '/ships/rcl/assets/adventure.json',
    'https://www.cruisinginthewake.com/assets/data/adventure.json',
    '/assets/data/adventure.json'
  ];

  async function fetchFirst(urls){
    for (const u of urls){
      try{
        const r = await fetch(u, { cache:'no-store' });
        if (r.ok) return await r.json();
      }catch(e){}
    }
    return null;
  }

  const data = await fetchFirst(JSON_URLS);
  if(!data){
    mount.innerHTML = '<p class="small">Stories will cast off shortly (data source unreachable).</p>';
    return;
  }

  // Accept either data.personas or data.items
  const personas = Array.isArray(data.personas) ? data.personas
                  : Array.isArray(data.items)    ? data.items
                  : [];

  if(!personas.length){
    mount.innerHTML = '<p class="small">Stories will cast off shortly (no stories found).</p>';
    return;
  }

  const params = new URLSearchParams(location.search);
  const selId = params.get('id');
  let idx = personas.findIndex(p => String(p.id||'') === String(selId||''));
  if (idx < 0) idx = 0;

  function md(html){
    return (String(html||''))
      .replace(/^###?\s+(.+)$/gm, (m, t)=> `<h3>${t}</h3>`)
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>')
      .replace(/\n{2,}/g,'</p><p>')
      .replace(/\n/g,'<br/>')
      .replace(/(https?:\/\/[^\s)]+)(?=\s|$)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>')
      .replace(/^<p><\/p>/,'');
  }

  function render(i){
    const p = personas[i]; if(!p) return;
    const port = p.nav_port || {};
    const star = p.nav_starboard || {};

    const header = `
      <h3 class="persona-title">${p.title||p.name||'Guest Story'}</h3>
      <p class="tiny"><strong>${p.persona_label||p.role||''}</strong></p>
    `;

    const fuelCard = `
      <div class="voyage-tips-wrapper">
        <div class="card voyage-tips center" aria-label="Voyage planning tips">
          <h2 class="card-title">Fuel Your Voyage</h2>
          <div class="card-content">
            <h3><a href="https://www.cruisinginthewake.com/drink-packages.html#deluxe">Drink Packages</a></h3>
            <ul>
              <li><a href="https://www.cruisinginthewake.com/drink-packages.html#deluxe">Deluxe Beverage Package</a></li>
              <li><a href="https://www.cruisinginthewake.com/drink-packages.html#refreshment">Refreshment Package</a></li>
              <li><a href="https://www.cruisinginthewake.com/drink-packages.html#soda">Soda Package</a></li>
            </ul>
            <h3><a href="https://www.royalcaribbean.com/faq/questions/unlimited-dining-package" target="_blank" rel="noopener">Premium & Specialty Dining</a></h3>
            <ul>
              <li><a href="https://www.royalcaribbean.com/faq/questions/unlimited-dining-package" target="_blank" rel="noopener">Unlimited Dining Package</a></li>
              <li><a href="https://www.royalcaribbean.com/experience/cruise-dining/specialty-restaurants" target="_blank" rel="noopener">Royal Caribbean Premium Dining</a></li>
            </ul>
            <h3><a href="https://www.cruisinginthewake.com/packing-lists.html">Pack Like a Pro</a></h3>
            <ul>
              <li>Shawl for chilly theater nights</li>
              <li>Swimwear for pool deck</li>
              <li>Comfortable shoes for shore tours</li>
            </ul>
            <div class="button-group" aria-label="Voyage planning links">
              <a href="https://www.cruisinginthewake.com/drink-packages.html" class="btn">View Drink Options</a>
              <a href="https://www.cruisinginthewake.com/packing-lists.html" class="btn">Packing Guide</a>
            </div>
          </div>
        </div>
      </div>`;

    const mdRaw = p.markdown || p.body || p.content || '';
    const parts = mdRaw.split(/\n##\s+Dining\s*\n/i);
    const html = parts.length > 1
      ? md(parts[0]) + '<h3>Dining</h3>' + md(parts[1]) + fuelCard
      : (()=>{
          const cut = Math.floor(mdRaw.length * 0.55);
          return md(mdRaw.slice(0, cut)) + fuelCard + md(mdRaw.slice(cut));
        })();

    const nav = `
      <div class="button-group" style="justify-content:space-between; margin-top:1rem">
        <a class="btn" href="${port.url||'#'}" aria-label="Previous perspective (port side)">${port.label||'⟵ Previous perspective'}</a>
        <a class="btn" href="${star.url||'#'}" aria-label="Next perspective (starboard side)">${star.label||'Next perspective ⟶'}</a>
      </div>`;

    mount.innerHTML = header + '<p class="tiny" style="margin-top:.2rem">Use the Port/Starboard buttons to sail between perspectives.</p><div class="story-body">' + html + '</div>' + nav;

    Array.from(mount.querySelectorAll('.button-group a')).forEach(a=>{
      const u = new URL(a.href, location.href);
      if(u.origin===location.origin && u.pathname===location.pathname && u.searchParams.get('id')){
        a.addEventListener('click', (ev)=>{ ev.preventDefault(); const id=u.searchParams.get('id'); history.replaceState(null,'',u.toString()); const idx2 = Math.max(0, personas.findIndex(pp => String(pp.id||'')===String(id))); render(idx2); });
      }
    });
  }

  render(idx);
})();
