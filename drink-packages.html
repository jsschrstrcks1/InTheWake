<!doctype html>
<html lang="en">
<head>
  <!--
    Soli Deo Gloria — every pixel and paragraph offered in gratitude.
    Page: /drink-packages.html · v3.010.105 (Unification Pass)
    Baseline: Home header visuals + Planning portal’d nav behavior
    Standards: Every Page v3.010 · Unified Nav v3.010 · Right-Rail v3.008.025 · A11y/WCAG Addendum v3.100
  -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="version" content="3.010.105"/>
  <title>Drink Packages Calculator — In the Wake (v3.010.105)</title>
  <link rel="canonical" href="https://cruisinginthewake.com/drink-packages.html"/>

  <!-- Social / SEO -->
  <meta name="description" content="Figure out whether a cruise drink package is worth it. Enter your daily drinks and compare à-la-carte vs. packages."/>
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Drink Packages Calculator — In the Wake"/>
  <meta property="og:description" content="Enter your daily drinks; we’ll compare à-la-carte vs. packages."/>
  <meta property="og:url" content="https://cruisinginthewake.com/drink-packages.html"/>
  <meta property="og:image" content="https://cruisinginthewake.com/assets/index_hero.jpg?v=3.010.105"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="Drink Packages Calculator — In the Wake"/>
  <meta name="twitter:description" content="A quick way to check if a cruise drink package pays off for you."/>
  <meta name="twitter:image" content="https://cruisinginthewake.com/assets/index_hero.jpg?v=3.010.105"/>

  <!-- Inline CSS (Home header visuals + Planning cards/rails) -->
  <style>
    :root{
      --sea:#0a3d62;--foam:#e6f4f8;--rope:#d9b382;--ink:#083041;--sky:#f7fdff;--accent:#0e6e8e;
      --shadow:0 2px 6px rgba(8,48,65,.08);--shadow-lg:0 10px 28px rgba(8,48,65,.14);
      --good:#0b7a43; --line:#d9e6eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden;background:var(--sky);color:var(--ink)}
    html{scrollbar-gutter:stable both-edges}
    body{font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    img{max-width:100%;height:auto;display:block}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:0 auto;padding:20px 14px 36px}
    .tiny{font-size:.9rem;color:#456}.muted{opacity:.85}.center{text-align:center}
    .pill{display:inline-block;padding:.45rem .75rem;border:1px solid var(--rope);border-radius:999px;background:#fff;line-height:1.1}
    .card{background:#fff;border:2px solid var(--rope);border-radius:14px;padding:1rem;box-shadow:var(--shadow);margin:.9rem 0;position:relative;overflow:hidden}
    .card.watermark::after{content:"";position:absolute;inset:0;margin:auto;width:min(60%,360px);height:min(60%,360px);
      background:url('/assets/watermark.png?v=3.010.071') center/contain no-repeat;opacity:.06;pointer-events:none}
    h1,h2,h3,h4{color:var(--sea);margin:.25rem 0 .5rem}

    /* Header / hero EXACTLY like Home */
    .hero-header{position:relative;z-index:0;border-bottom:6px double var(--rope);background:#eaf6f6}
    .navbar{max-width:1100px;margin:0 auto;display:flex;gap:.6rem;padding:.35rem .9rem .75rem;align-items:center;min-height:56px;background:#eaf6f6}
    .brand{display:flex;align-items:center;gap:.6rem}
    .brand img{height:40px;width:auto;display:block}
    .version-badge{font-size:.72rem;opacity:.8;margin-left:.35rem}
    .skip{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip:focus{position:static;width:auto;height:auto;padding:.35rem .6rem;margin-left:.5rem;border-radius:10px;background:#083041;color:#fff}

    /* Portal’d nav visuals (Planning) */
    .itw-nav{display:flex;gap:.5rem;flex:1 1 auto;align-items:center;justify-content:center;white-space:nowrap;overflow:visible;padding-inline:.75rem}
    .itw-nav .nav-item{position:relative}
    .itw-nav .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.35rem .7rem;border-radius:10px;background:#fff;
      border:1px solid var(--rope);color:var(--accent);font-size:.95rem;cursor:pointer}
    .itw-nav .chip[aria-current="page"]{outline:3px dashed var(--rope);outline-offset:2px;box-shadow:0 0 0 3px rgba(200,163,106,.15) inset}
    .itw-nav .menu{position:absolute;left:0;top:100%;transform:translateY(.35rem);min-width:240px;max-width:min(90vw,360px);
      background:#fff;border:1px solid var(--rope);border-radius:12px;box-shadow:var(--shadow-lg);padding:.6rem;display:none;visibility:hidden;opacity:0;pointer-events:none;z-index:100;transition:opacity .18s ease}
    .itw-nav .nav-item.open>.menu{display:block;visibility:visible;opacity:1;pointer-events:auto}
    .itw-nav .menu .label{font-weight:600;color:#234;margin:.15rem .2rem .35rem;font-size:.9rem}
    .itw-nav .menu a{display:block;padding:.45rem .6rem;border-radius:.6rem;color:var(--ink)}
    .itw-nav .menu a:hover{background:#f2f7fa;text-decoration:none}

    /* Hero */
    .hero{position:relative;width:100%;min-height:clamp(200px,24vw,340px);
      background:url('/assets/index_hero.jpg?v=3.010.071') center 38%/cover no-repeat; /* NO color filter */
      display:flex;align-items:flex-end;overflow:hidden;margin-top:.15rem;z-index:0}
    .hero-title{position:absolute;left:min(3vw,1rem);bottom:clamp(.6rem,2vw,1.4rem);display:flex;flex-direction:column;align-items:flex-start;gap:.35rem;text-shadow:0 2px 6px rgba(0,0,0,.45)}
    .hero-title .logo{width:clamp(189px,23.1vw,378px);max-width:min(90vw,520px);filter:drop-shadow(0 3px 8px rgba(0,0,0,.45))}
    .tagline{font-weight:700;letter-spacing:.2px;color:#e6f4f8;font-size:clamp(.9rem,1.5vw,1.35rem);white-space:nowrap}
    .hero-compass{position:absolute;right:min(3vw,1rem);top:.5rem;width:86px;opacity:.95;filter:invert(39%) sepia(9%) saturate(1063%) hue-rotate(151deg) brightness(92%) contrast(89%)}
    .hero-credit{position:absolute;right:.85rem;bottom:.85rem;z-index:2}

    /* Layout: content + rail like Planning */
    .grid{display:grid;gap:1.2rem}
    @media(min-width:1060px){.grid{grid-template-columns:minmax(0,1fr) 360px}}
    .rail .rail-item{display:grid;grid-template-columns:96px 1fr;gap:.75rem;margin:.6rem 0}
    .rail .rail-item .thumb{display:block;width:96px;height:96px;border-radius:12px;overflow:hidden;background:#f0f4f7}
    .rail .rail-item img{width:100%;height:100%;object-fit:cover;border-radius:12px}

    /* Calculator visuals */
    .calc-header{display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap}
    .tag{display:inline-block;padding:.35rem .65rem;border-radius:999px;border:1px solid var(--rope);background:#fff}
    .trip-card{display:grid;grid-template-columns:auto 88px 1fr;gap:.6rem;align-items:center}
    .trip-card input[type="number"]{width:88px;padding:.45rem .55rem;border-radius:10px;border:2px solid var(--rope);background:#fff;font:inherit}
    .inputs-grid{display:grid;gap:1rem}
    @media(min-width:860px){.inputs-grid{grid-template-columns:repeat(3,1fr)}}
    .beverage-card .row{display:grid;grid-template-columns:1fr 90px;gap:.5rem;align-items:center;margin:.4rem 0}
    .beverage-card input[type=number]{width:90px;padding:.35rem .5rem;border-radius:10px;border:2px solid var(--rope);background:#fff;font:inherit}
    .price-note{font-size:.85rem;color:#456}

    /* Packages */
    .pkg-grid{display:grid;gap:1rem}
    @media(min-width:860px){.pkg-grid{grid-template-columns:repeat(3,1fr)}}
    article.pkg{position:relative;overflow:visible;border-radius:14px;border:2px solid var(--rope);box-shadow:var(--shadow);background:#fff}
    article.pkg header{display:flex;align-items:flex-start;justify-content:space-between;gap:.6rem;padding:1rem 1rem .35rem}
    article.pkg .body{padding:0 1rem 1rem}
    .pkg .price{white-space:nowrap}
    .pkg.best{outline:3px solid var(--good);outline-offset:3px}
    .ribbon{position:absolute;top:.5rem;left:.5rem;background:var(--good);color:#fff;padding:.22rem .6rem;border-radius:8px;font-size:.8rem;box-shadow:0 2px 6px rgba(0,0,0,.12);transform:rotate(-8deg)}
    .btn{display:inline-block;background:#fff;border:1px solid var(--rope);border-radius:999px;padding:.4rem .7rem;font-weight:600;cursor:pointer}
    .btn:hover{background:#f7f9fb}

    footer.wrap{font-size:.92rem}
  </style>
</head>

<body class="page">
  <a class="skip" href="#content">Skip to main content</a>

  <!-- Header (Home visuals) + portal’d nav behavior -->
  <header class="hero-header" role="banner" style="padding-top:.15rem">
    <div class="navbar">
      <div class="brand">
        <img src="/assets/logo_wake.png?v=3.010.070" width="256" height="64" alt="In the Wake">
        <span class="tiny version-badge">v3.010.105</span>
      </div>
      <nav class="itw-nav" aria-label="Primary">
        <div class="nav-item"><a class="chip" href="/">Home</a></div>

        <div class="nav-item" aria-haspopup="menu">
          <button class="chip" type="button" aria-expanded="false" aria-haspopup="menu" aria-controls="menu-planning">
            Planning <span class="caret">▾</span>
          </button>
          <div id="menu-planning" class="menu" aria-label="Planning">
            <div class="label tiny">Plan your cruise</div>
            <a href="/planning.html">Planning (overview)</a>
            <a href="/ports.html">Ports</a>
            <a href="/restaurants.html">Restaurants &amp; Menus</a>
            <a href="/ships.html">Ships</a>
            <a href="/drink-packages.html" aria-current="page">Drink Packages</a>
            <a href="/cruise-lines.html">Cruise Lines</a>
            <a href="/packing-lists.html">Packing Lists</a>
            <a href="/accessibility.html">Accessibility</a>
          </div>
        </div>

        <div class="nav-item" aria-haspopup="menu">
          <button class="chip" type="button" aria-expanded="false" aria-haspopup="menu" aria-controls="menu-travel">
            Travel <span class="caret">▾</span>
          </button>
          <div id="menu-travel" class="menu" aria-label="Travel">
            <div class="label tiny">On the move</div>
            <a href="/travel.html">Travel (overview)</a>
            <a href="/solo.html">Solo</a>
          </div>
        </div>

        <div class="nav-item"><a class="chip" href="/about-us.html">About</a></div>
      </nav>
    </div>

    <div class="hero" role="img" aria-label="Ship wake at sunrise">
      <div class="hero-title">
        <img class="logo" src="/assets/logo_wake.png?v=3.010.070" width="256" height="64" alt="In the Wake">
        <div class="tagline">A Cruise Traveler’s Logbook</div>
      </div>
      <img class="hero-compass" src="/assets/compass_rose.svg?v=3.010.070" width="180" height="180" alt="" aria-hidden="true">
      <div class="hero-credit">
        <a class="pill" href="https://instagram.com/flickersofmajesty" target="_blank" rel="noopener">Photo © Flickers of Majesty</a>
      </div>
    </div>
  </header>

  <!-- Sharebar mount (optional) -->
  <div id="sharebar" class="wrap" aria-label="Share this page"></div>

  <main id="content" class="wrap grid" role="main">
    <!-- LEFT: Calculator -->
    <section aria-labelledby="calc-title">
      <div class="card watermark">
        <div class="calc-header">
          <h1 id="calc-title" style="margin:.2rem 0">Beverage Calculator</h1>
          <span class="tag">Royal Caribbean</span>
        </div>
        <p class="muted tiny" style="margin:.2rem 0 .4rem">Pick your daily drinks and we’ll compare à-la-carte vs. packages.</p>

        <section class="card trip-card" aria-label="Trip length">
          <strong style="white-space:nowrap">Trip length</strong>
          <input id="days" type="number" inputmode="decimal" pattern="[0-9]*" min="1" step="1" value="7" aria-describedby="days-help totals totals-line"/>
          <div class="tiny muted">People often book 5–7 nights. Adjust as needed.</div>
          <div class="tiny" id="totals" style="grid-column:1 / -1;margin-top:.25rem"></div>
          <div class="tiny muted" id="totals-line" style="grid-column:1 / -1"></div>
        </section>

        <!-- Inputs in column cards -->
        <h2 style="margin:.6rem 0">Your Daily Picks</h2>
        <div class="inputs-grid" id="inputs-grid">
          <!-- columns built by JS -->
        </div>
      </div>

      <!-- Packages card -->
      <div class="card" aria-labelledby="pkg-title">
        <h2 id="pkg-title" style="margin:.2rem 0">Royal Caribbean Beverage Packages</h2>
        <ul class="tiny" style="margin:.25rem 0 1rem">
          <li>Package prices already include gratuity.</li>
          <li>À-la-carte purchases add 18% gratuity automatically.</li>
          <li>Deluxe covers everything up to the menu cap (pay the difference above).</li>
        </ul>

        <div class="pkg-grid" id="package-cards" aria-live="polite"></div>
      </div>
    </section>

    <!-- RIGHT RAIL (exactly like Planning) -->
    <aside class="rail" aria-label="Right rail">
      <section class="card" aria-labelledby="rec-title">
        <h3 id="rec-title">Recommended Reading</h3>
        <div class="rail">
          <article class="rail-item" role="article">
            <a class="thumb" href="/articles/should-you-buy-the-deluxe-package.html" data-prefetch="hover">
              <img src="/assets/placeholders/article-thumb.jpg" alt="">
            </a>
            <div class="meta">
              <h4><a href="/articles/should-you-buy-the-deluxe-package.html" data-prefetch="hover">Should you buy the Deluxe package?</a></h4>
            </div>
          </article>
          <article class="rail-item" role="article">
            <a class="thumb" href="/articles/how-gratuities-work-on-drink-packages.html" data-prefetch="hover">
              <img src="/assets/placeholders/article-thumb.jpg" alt="">
            </a>
            <div class="meta">
              <h4><a href="/articles/how-gratuities-work-on-drink-packages.html" data-prefetch="hover">How drink gratuities really work</a></h4>
            </div>
          </article>
          <article class="rail-item" role="article">
            <a class="thumb" href="/articles/mocktails-and-kids-soda-plans.html" data-prefetch="hover">
              <img src="/assets/placeholders/article-thumb.jpg" alt="">
            </a>
            <div class="meta">
              <h4><a href="/articles/mocktails-and-kids-soda-plans.html" data-prefetch="hover">Mocktails &amp; kids’ soda plans</a></h4>
            </div>
          </article>
        </div>
      </section>

      <section class="card" aria-labelledby="author-title">
        <h3 id="author-title">About the Author</h3>
        <article class="rail-item" role="article">
          <a class="thumb" href="/authors/ken-baker.html">
            <img src="/authors/img/ken1.jpg?v=3.010.070" alt="Ken Baker">
          </a>
          <div class="meta">
            <h4><a href="/authors/ken-baker.html">Ken Baker</a></h4>
            <p class="tiny muted">Pastor, coder, cruiser. I test these tools so you don’t waste money onboard.</p>
            <p class="tiny"><a href="/solo.html">Solo</a> · <a href="/travel.html">Travel</a></p>
          </div>
        </article>
      </section>
    </aside>
  </main>

  <footer class="wrap" role="contentinfo">
    © 2025 In the Wake — <a href="/accessibility.html">Accessibility &amp; WCAG 2.1 AA Commitment</a>
    <p class="tiny center" style="margin-top:.5rem">Soli Deo Gloria.</p>
  </footer>

  <!-- site-cache (defines window.itwSeedSW) + sharebar -->
  <script src="/assets/js/site-cache.js" defer></script>
  <script src="/assets/js/sharebar.js?v=3.010.070" defer></script>

  <script>
  (function(){
    "use strict";
    // ---------------- Portal’d nav behavior (Planning) ----------------
    const root = document.querySelector('.itw-nav');
    if(root){
      const items = [...root.querySelectorAll('.nav-item[aria-haspopup]')];
      const setOpen=(g,on)=>{ g.classList.toggle('open',!!on); const b=g.querySelector('button[aria-controls]'); if(b) b.setAttribute('aria-expanded',on?'true':'false'); };
      const closeAll=(ex=null)=>items.forEach(g=>{ if(g!==ex) setOpen(g,false); });
      const firstFocusable=el=>el && el.querySelector('a,button,[tabindex]:not([tabindex="-1"])');
      items.forEach(group=>{
        const btn=group.querySelector('button[aria-controls]'); const menu=group.querySelector('.menu'); if(!btn||!menu) return;
        btn.addEventListener('click',e=>{ e.preventDefault(); e.stopPropagation(); const open=group.classList.contains('open'); closeAll(group); setOpen(group,!open); if(!open){ (firstFocusable(menu)||btn).focus({preventScroll:true}); }});
        btn.addEventListener('keydown',e=>{ if(e.key==='ArrowDown'||e.key==='ArrowUp'){ e.preventDefault(); setOpen(group,true); (firstFocusable(menu)||btn).focus({preventScroll:true}); } else if(e.key==='Escape'){ setOpen(group,false); btn.focus({preventScroll:true}); }});
        group.addEventListener('keydown',e=>{ if(e.key==='Escape'){ setOpen(group,false); btn.focus({preventScroll:true}); }});
        menu.addEventListener('focusout',()=>{ setTimeout(()=>{ if(!group.contains(document.activeElement)) setOpen(group,false); },0); });
      });
      document.addEventListener('click',e=>{ if(!e.target.closest('.itw-nav')) closeAll(); });
      window.addEventListener('blur',()=>closeAll());
    }

    // ---------------- Hover prefetch (seed SW) ----------------
    const seed=(urls,priority='normal')=>{ try{ if(window.itwSeedSW) window.itwSeedSW(urls,priority); }catch(_){ } };
    function onOver(e){
      const a=e.currentTarget; const href=a.getAttribute('href'); if(!href) return;
      if(!onOver._set) onOver._set=new Set();
      if(onOver._set.has(href)) return; onOver._set.add(href);
      seed([href],'low');
    }
    document.querySelectorAll('[data-prefetch="hover"]').forEach(a=>{
      a.addEventListener('mouseenter',onOver,{once:true,passive:true});
      a.addEventListener('focus',onOver,{once:true,passive:true});
    });

    // ---------------- Calculator ----------------
    const els = {
      inputsGrid: document.getElementById('inputs-grid'),
      packageCards: document.getElementById('package-cards'),
      totals: document.getElementById('totals'),
      totalsLine: document.getElementById('totals-line'),
      days: document.getElementById('days')
    };

    const state = {
      days: 7,
      epsilon: 0.02,          // ~2 cents tolerance, but we still show a single winner
      items: new Map(),       // id -> {meta, qtyPerDay}
      order: [],
      cols: [[],[],[]],       // column assignment for inputs
      sets: { soda:new Set(), refresh:new Set(), alcohol:new Set() },
      packages: new Map(),    // id -> {meta}
      lineId: 'royal-caribbean'
    };

    const fmt = n => Number.isFinite(n) ? ('$' + Math.abs(n).toFixed(2)).replace('$-','$-') : '$?.??';
    const getLS=(k,d)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch(_){ return d; } };
    const setLS=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } };

    const DATA_URL = '/assets/data/lines/royal-caribbean.json';

    function normalizedRange(price, rangeStr){
      if (Array.isArray(rangeStr) && rangeStr.length===2) return rangeStr;
      if (typeof rangeStr==='string'){
        const m = rangeStr.match(/(\d+(?:\.\d+)?)\s*[-–]\s*(\d+(?:\.\d+)?)/);
        if (m) return [Number(m[1]), Number(m[2])];
      }
      const p = Number(price);
      return Number.isFinite(p) ? [p,p] : null;
    }

    function defaultRefreshSetIfEmpty(){
      // default: soda, specialty coffee, tea, juice, mocktails, bottled water
      if (state.sets.refresh.size===0){
        ['soda','premium-coffee','premium-tea','fresh-juice','mocktail','bottled-water'].forEach(id=>state.sets.refresh.add(id));
      }
    }

    function buildInputs(){
      // 3 columns; sort by price desc for paid, then freebies alpha
      const paid=[], free=[];
      state.items.forEach((v,k)=> (v.meta.free?free:paid).push([k,v]));
      paid.sort((a,b)=> b[1].meta.avgPrice - a[1].meta.avgPrice);
      free.sort((a,b)=> a[1].meta.name.localeCompare(b[1].meta.name));
      state.order = [...paid.map(x=>x[0]), ...free.map(x=>x[0])];

      // allocate to 3 columns round-robin
      state.cols=[[],[],[]];
      state.order.forEach((id,i)=> state.cols[i%3].push(id));

      // render
      els.inputsGrid.innerHTML = '';
      state.cols.forEach(col=>{
        const card = document.createElement('div');
        card.className = 'card beverage-card';
        col.forEach(id=>{
          const it = state.items.get(id);
          const priceNote = it.meta.free ? '<span class="price-note">(included · $0)</span>'
                           : `<span class="price-note">avg ${fmt(it.meta.avgPrice)}</span>`;
          const row = document.createElement('div');
          row.className='row';
          row.innerHTML = `
            <label for="qty-${id}">${it.meta.name}<div>${priceNote}</div></label>
            <input id="qty-${id}" type="number" inputmode="decimal" pattern="[0-9]*" min="0" step="1" value="${it.qtyPerDay||0}" data-item="${id}">`;
          card.appendChild(row);
        });
        els.inputsGrid.appendChild(card);
      });

      els.inputsGrid.querySelectorAll('input[type="number"]').forEach(inp=>{
        let t;
        inp.addEventListener('input', ()=>{
          clearTimeout(t);
          t=setTimeout(()=>{
            const id = inp.dataset.item;
            const ent = state.items.get(id);
            const n = Number(inp.value);
            ent.qtyPerDay = Number.isFinite(n)&&n>=0 ? Math.floor(n) : 0;
            computeAndRender();
          },140);
        });
      });
    }

    function pkgPriceDisplay(pmeta){
      const key='pkgOverride:'+state.lineId+':'+pmeta.id;
      const ov = getLS(key,null);
      const base = Number(pmeta.price ?? pmeta.avg ?? (pmeta.priceRange?.[0] ?? 0));
      const value = ov!=null ? Number(ov) : base;
      return { value, overridden: ov!=null };
    }

    function renderPackages(view){
      const host = els.packageCards;
      host.innerHTML='';
      const ids=['soda','refreshment','deluxe'].filter(id=>state.packages.has(id));
      ids.forEach(id=>{
        const p = state.packages.get(id);
        const { value, overridden } = pkgPriceDisplay(p.meta);
        const includeVal = view.includedDaily[id] ?? 0;
        const strategyCost = view[id+'Daily'] ?? null;
        const range = p.meta.priceRange ? ` (${fmt(p.meta.priceRange[0])}–${fmt(p.meta.priceRange[1])})` : '';
        const best = view.bestId===id;
        const el = document.createElement('article');
        el.className = 'pkg' + (best?' best':'');
        el.innerHTML = `
          ${best?'<span class="ribbon" role="status">Best value</span>':''}
          <header>
            <div><strong>${p.meta.name}</strong></div>
            <div class="price" data-price="${id}">${fmt(value)}/day</div>
          </header>
          <div class="body tiny" style="margin:.1rem 0 .4rem">
            Included value (your picks): <strong>${fmt(includeVal)}</strong> /day
            ${strategyCost!=null?` · With this package you’d pay <strong>${fmt(strategyCost)}</strong> /day` : ''}
          </div>
          <div class="body">
            <button class="btn" data-ov="${id}" type="button">${overridden?'Edit Price (overridden)':'Edit Price'}</button>
            ${Array.isArray(p.meta.description)&&p.meta.description.length
              ? `<ul class="tiny" style="margin:.6rem 0 0 1.1rem">${p.meta.description.map(d=>`<li>${d}</li>`).join('')}</ul>` : ''
            }
          </div>`;
        host.appendChild(el);
      });

      host.querySelectorAll('button[data-ov]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.ov;
          const key='pkgOverride:'+state.lineId+':'+id;
          const pmeta=state.packages.get(id).meta;
          const suggested = getLS(key,null) ?? (Number(pmeta.price ?? pmeta.avg ?? pmeta.priceRange?.[0] ?? 0));
          const v = prompt('Enter your package price per person per day (USD).', String(suggested));
          if (v==null) return;
          const num=Number(v);
          if (!Number.isFinite(num)||num<0){ alert('Please enter a valid non-negative number.'); return; }
          setLS(key,num);
          computeAndRender();
        });
      });
    }

    function computeAndRender(){
      // spend buckets
      let dailyTotal=0, sodaSpend=0, refreshSpend=0, alcoholSpend=0;

      state.items.forEach((it,id)=>{
        const spend = (it.meta.avgPrice||0) * (it.qtyPerDay||0);
        dailyTotal += spend;
        if (state.sets.soda.has(id)) sodaSpend += spend;
        if (state.sets.refresh.has(id)) refreshSpend += spend;
        if (state.sets.alcohol.has(id)) alcoholSpend += spend;
      });

      const days = Math.max(1, parseInt(els.days.value||'1',10));
      state.days = days;
      els.totals.textContent = `Daily total (à la carte): ${fmt(dailyTotal)} · Trip total: ${fmt(dailyTotal*days)}`;
      els.totalsLine.textContent = `Tip: Override package prices to match the sale you see in your planner.`;

      const pkg = {};
      ['soda','refreshment','deluxe'].forEach(pid=>{
        const meta = state.packages.get(pid)?.meta;
        pkg[pid] = meta ? pkgPriceDisplay(meta).value : Infinity;
      });

      // Strategy costs
      const noneDaily    = dailyTotal;
      const sodaDaily    = pkg.soda + (dailyTotal - sodaSpend);
      const refreshDaily = pkg.refreshment + alcoholSpend;   // refresh covers refreshSpend
      const deluxeDaily  = pkg.deluxe;                       // deluxe covers all

      const includedDaily = { soda:sodaSpend, refreshment:refreshSpend, deluxe:dailyTotal };

      // Winner — we enforce single winner: break ties by higher inclusivity: deluxe > refresh > soda > none
      const entries = [
        {id:'none',        cost:noneDaily,       rank:0},
        {id:'soda',        cost:sodaDaily,       rank:1},
        {id:'refreshment', cost:refreshDaily,    rank:2},
        {id:'deluxe',      cost:deluxeDaily,     rank:3}
      ].filter(e=>Number.isFinite(e.cost));

      entries.sort((a,b)=>{
        const diff=a.cost-b.cost;
        if (Math.abs(diff) <= state.epsilon) return b.rank - a.rank; // prefer more inclusive on tie
        return diff;
      });
      const bestId = entries[0]?.id || 'none';

      renderPackages({ noneDaily, sodaDaily, refreshDaily, deluxeDaily, includedDaily, bestId });
    }

    async function loadDataset(){
      try{
        const r = await fetch(DATA_URL + '?v=' + (document.querySelector('meta[name="version"]')?.content||'v'), { cache:'default', credentials:'omit' });
        if (!r.ok) throw new Error('Bad response');
        const data = await r.json();

        state.lineId = data.lineId || data.line || 'royal-caribbean';

        // items
        state.items = new Map();
        (data.items||[]).forEach(it=>{
          state.items.set(it.id, {
            meta:{
              id:it.id,
              name: it.label || it.name || it.id,
              avgPrice: Number(it.price || it.avgPrice || 0),
              free: !!it.free
            },
            qtyPerDay:0
          });
        });

        // sets (authoritative), with default for refresh if missing
        state.sets={
          soda:    new Set(data.sets?.soda    || ['soda']),
          refresh: new Set(data.sets?.refresh || []),
          alcohol: new Set(data.sets?.alcohol || [])
        };
        defaultRefreshSetIfEmpty();

        // packages (normalize price/range)
        state.packages = new Map();
        const pkgObj=data.packages||{};
        Object.keys(pkgObj).forEach(k=>{
          const p=pkgObj[k];
          const pr=normalizedRange(p.price, p.range);
          state.packages.set(k, {
            meta:{
              id:k,
              name:p.name||k,
              price: Number(p.price ?? p.avg ?? 0),
              priceRange: pr,
              description: Array.isArray(p.includes)? p.includes.slice() : []
            }
          });
        });

        buildInputs();
        computeAndRender();
      }catch(err){
        console.error('Dataset load failed:', err);
        els.packageCards.innerHTML = `<div class="tiny muted">Could not load data. Try refreshing.</div>`;
      }
    }

    // events
    els.days.addEventListener('input', ()=>{ state.days = Math.max(1, parseInt(els.days.value||'1',10)); computeAndRender(); });

    // boot
    loadDataset();

    // Sharebar hydrate if present
    (function(){
      if(!document.getElementById('sharebar')) return;
      if(typeof window.initSharebar==='function'){ window.initSharebar('#sharebar'); }
      else{ window.addEventListener('load',()=>window.initSharebar&&window.initSharebar('#sharebar')); }
    })();
  })();
  </script>
</body>
</html>
