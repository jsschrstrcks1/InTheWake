<script>
(async function initVideos(){
  const wrap = document.getElementById('featuredVideos'); if(!wrap) return;

  // ðŸ‘‡ set the page slug
  const slug = 'enchantment-of-the-seas';

  // 1) Put the ship-specific JSON FIRST so it wins.
  const sources = [
    `/assets/data/videos/rcl/${slug}.json?v=${Date.now()}`,          // <- our per-ship canonical
    'https://www.cruisinginthewake.com/assets/data/rc_ship_videos.json',
    'https://www.cruisinginthewake.com/assets/data/video_sources.json',
    `https://www.cruisinginthewake.com/assets/data/videos/rcl/${slug}.json`,
    `https://www.cruisinginthewake.com/assets/data/videos/${slug}.json`,
    `https://www.cruisinginthewake.com/ships/rcl/assets/${slug.replace(/-of-the-seas$/,'')}_videos.json`
  ];

  // Accept both our master schema + your legacy arrays
  const CATEGORY_ORDER = ['top ten','ship walk through','suite','accessible','balcony','oceanview','interior'];

  function normCat(s){
    s = String(s||'').toLowerCase();
    if(/top\s*10|top\s*ten/.test(s)) return 'top ten';
    if(/walk.?through|tour/.test(s)) return 'ship walk through';
    if(/access/.test(s)) return 'accessible';
    return s.replace(/\s+/g,' ').trim();
  }

  function idFrom(v){
    if(!v) return '';
    if(typeof v === 'string'){
      if(/^[A-Za-z0-9_-]{9,12}$/.test(v)) return v;
      const m1 = v.match(/[?&]v=([\w-]{9,12})/); if(m1) return m1[1];
      const m2 = v.match(/youtu\.be\/([\w-]{9,12})/); if(m2) return m2[1];
      const m3 = v.match(/youtube\.com\/embed\/([\w-]{9,12})/); if(m3) return m3[1];
      return '';
    }
    if(typeof v === 'object'){
      return v.videoId || v.id || v.youtubeId || v.youtube_id || v.yt || v.video_id
          || idFrom(v.url) || idFrom(v.link) || idFrom(v.href) || '';
    }
    return '';
  }

  // Flatten our category-keyed schema into a single, ordered list
  function flattenFromSchema(json){
    if(!json) return [];
    const videosObj = json.videos || json[slug]?.videos || null;
    if(!videosObj) {
      // maybe it's already a flat list somewhere
      const arr = Array.isArray(json) ? json : (json.items || json.list || json[slug] || []);
      return Array.isArray(arr) ? arr : [];
    }

    // Round-robin ordering if present
    if (Array.isArray(json.ordered_round_robin) && json.ordered_round_robin.length){
      const index = new Map();
      // build a quick lookup across all categories
      for(const [cat, list] of Object.entries(videosObj)){
        (list||[]).forEach(v => { const vid=idFrom(v); if(vid) index.set(vid, v); });
      }
      return json.ordered_round_robin
        .map(vid => index.get(vid))
        .filter(Boolean);
    }

    // Otherwise: build grouped lists per category, then do round-robin by rank
    const buckets = CATEGORY_ORDER.map(c => ({
      cat: c, list: (videosObj[c] || videosObj[normCat(c)] || []).slice()
                   .filter(v => idFrom(v)) // require a valid YouTube id
                   .sort((a,b)=> (b.priority||0) - (a.priority||0))
    }));
    // Round-robin
    const out = [];
    let i = 0, added = true;
    while(added){
      added = false;
      for(const b of buckets){
        if(b.list[i]){ out.push(b.list[i]); added = true; }
      }
      i++;
    }
    // append anything in videosObj that didn't map (misc)
    for(const [cat, list] of Object.entries(videosObj)){
      if(!CATEGORY_ORDER.includes(cat)){
        (list||[]).forEach(v=>{ if(idFrom(v)) out.push(v); });
      }
    }
    return out;
  }

  let list = [];
  for(const u of sources){
    try{
      const r = await fetch(u,{cache:'no-store'}); if(!r.ok) continue;
      const j = await r.json();
      let arr = flattenFromSchema(j);
      // If not found at root, try nested keys
      if(!arr.length && j && typeof j==='object'){
        const guess = j[slug] || j.RCL?.[slug] || j.rcl?.[slug] || j.rc?.[slug];
        if(guess) arr = flattenFromSchema(guess);
      }
      arr = (arr||[]).map(v => ({ id:idFrom(v), title: v.title || v.caption || 'Ship video' }))
                     .filter(v => v.id);
      if(arr.length){ list = arr; break; }
    }catch(e){}
  }

  if(!list.length){
    document.getElementById('videoFallback')?.classList.remove('hidden');
    return;
  }

  // Render
  list.forEach(v=>{
    const slide=document.createElement('div'); slide.className='swiper-slide';
    slide.innerHTML = `<iframe title="${(v.title||'Ship video').replace(/"/g,'&quot;')}"
      src="https://www.youtube.com/embed/${v.id}"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen loading="lazy"></iframe>`;
    wrap.appendChild(slide);
  });

  // Boot Swiper (videos only â€“ First Look stays images-only)
  function go(){
    if(!window.Swiper) return setTimeout(go,120);
    new Swiper('.swiper.videos', {
      loop:false, lazy:true, watchOverflow:true,
      pagination:{ el:'.swiper.videos .swiper-pagination', clickable:true },
      navigation:{ nextEl:'.swiper.videos .swiper-button-next', prevEl:'.swiper.videos .swiper-button-prev' },
      a11y:{ enabled:true }
    });
  }
  go();
})();
</script>
